---
id: prd-phase5-plan-commit
version: 1.0.0
created: 2026-01-30
---

# PRD: Phase 5.3 - Plan Commit & Loop Verification

## 背景

Phase 5.2 实现了计划生成，但目前是"作文计划"：
- 任务只有 title/priority，没有 why/evidence
- 计划无法一键落库成可执行任务
- 无法验证 Plan → Task → Evidence 闭环

## 目标

把计划从"文本"升级为"可执行、可追溯、可验证"的系统。

## 交付物

### 5.3a: PlanTask 结构升级

升级 `PlanTask` 接口：

```typescript
interface PlanTask {
  id: string;
  title: string;
  priority: string;
  status: string;
  // 新增字段
  why: string;              // 为什么选这个任务
  expected_evidence: string; // 预期产出什么证据
  source_refs: {            // 来源引用
    type: 'goal' | 'memory' | 'task';
    id: string;
    title?: string;
  }[];
}
```

### 5.3b: Plan Commit 端点

```
POST /api/system/plan/:planId/commit
```

功能：
- 把计划中的 P0 任务落库成 tasks 表记录
- 返回创建的 task IDs
- 可选参数：`limit`（默认 3，最多落几条）

响应：
```json
{
  "success": true,
  "committed_tasks": [
    { "plan_task_id": "...", "task_id": "...", "title": "..." }
  ],
  "plan_id": "plan_daily_20260130"
}
```

### 5.3c: Plan Loop 验收脚本

```bash
scripts/verify-plan-loop.sh
```

验证流程：
1. POST /api/system/plan/generate 生成计划
2. 检查返回的 tasks 有 why + expected_evidence
3. POST /api/system/plan/:planId/commit 落库
4. 验证 /api/tasks 里能看到新任务
5. 输出 PASS/FAIL

## 验收清单

- [ ] PlanTask 每条都有 why + expected_evidence + source_refs
- [ ] POST /api/system/plan/:planId/commit 能落库 P0 任务
- [ ] verify-plan-loop.sh PASS
- [ ] 落库的 task 能关联回 plan_id（可追溯）

## 依赖

- Phase 5.1 Memory Schema (已合并 #92)
- Phase 5.2 Planning Engine (已合并 #93)

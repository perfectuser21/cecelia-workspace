# DoD - OKR 系统三层架构优化

## 验收标准

### 数据库验收

#### businesses 表
- [ ] 表创建成功，包含所有字段（id, name, description, owner, status, created_at, updated_at）
      Test: manual:sql-query
- [ ] 可以插入业务数据（Stock, ZenithJoy）
      Test: manual:sql-insert
- [ ] status 默认值为 'active'
      Test: manual:sql-query

#### departments 表
- [ ] 表创建成功，包含所有字段（id, business_id, name, lead, description, created_at, updated_at）
      Test: manual:sql-query
- [ ] 外键约束正确（business_id → businesses.id）
      Test: manual:sql-constraint
- [ ] CASCADE 删除正确（删除 business 时自动删除关联 departments）
      Test: manual:sql-delete

#### goals 表新增字段
- [ ] scope 字段添加成功
      Test: manual:sql-query
- [ ] cycle 字段添加成功
      Test: manual:sql-query
- [ ] business_id 字段添加成功，外键约束正确
      Test: manual:sql-query
- [ ] department_id 字段添加成功，外键约束正确
      Test: manual:sql-query
- [ ] area_id 字段添加成功，外键约束正确
      Test: manual:sql-query
- [ ] expected_start_date 字段添加成功
      Test: manual:sql-query
- [ ] expected_end_date 字段添加成功
      Test: manual:sql-query
- [ ] actual_start_date 字段添加成功
      Test: manual:sql-query
- [ ] actual_end_date 字段添加成功
      Test: manual:sql-query

#### 索引验收
- [ ] idx_goals_scope 索引创建成功
      Test: manual:sql-index
- [ ] idx_goals_business_id 索引创建成功
      Test: manual:sql-index
- [ ] idx_goals_department_id 索引创建成功
      Test: manual:sql-index
- [ ] idx_goals_area_id 索引创建成功
      Test: manual:sql-index
- [ ] idx_departments_business_id 索引创建成功
      Test: manual:sql-index

### API 验收

#### /api/tasks/businesses
- [ ] GET /api/tasks/businesses 返回所有业务
      Test: manual:api-test
- [ ] GET /api/tasks/businesses/:id 返回单个业务
      Test: manual:api-test
- [ ] POST /api/tasks/businesses 创建业务成功
      Test: manual:api-test
- [ ] PATCH /api/tasks/businesses/:id 更新业务成功
      Test: manual:api-test
- [ ] DELETE /api/tasks/businesses/:id 删除业务成功
      Test: manual:api-test
- [ ] API 返回数据格式正确（包含 id, name, description, owner, status, timestamps）
      Test: manual:api-test

#### /api/tasks/departments
- [ ] GET /api/tasks/departments 返回所有部门
      Test: manual:api-test
- [ ] GET /api/tasks/departments?business_id=xxx 筛选正确
      Test: manual:api-test
- [ ] GET /api/tasks/departments/:id 返回单个部门
      Test: manual:api-test
- [ ] POST /api/tasks/departments 创建部门成功
      Test: manual:api-test
- [ ] PATCH /api/tasks/departments/:id 更新部门成功
      Test: manual:api-test
- [ ] DELETE /api/tasks/departments/:id 删除部门成功
      Test: manual:api-test
- [ ] API 返回数据包含关联的 business 信息
      Test: manual:api-test

#### /api/tasks/goals 增强
- [ ] POST /api/tasks/goals 支持新字段（scope, cycle, business_id 等）
      Test: manual:api-test
- [ ] GET /api/tasks/goals?scope=personal 筛选正确
      Test: manual:api-test
- [ ] GET /api/tasks/goals?business_id=xxx 筛选正确
      Test: manual:api-test
- [ ] GET /api/tasks/goals?department_id=xxx 筛选正确
      Test: manual:api-test
- [ ] GET /api/tasks/goals?area_id=xxx 筛选正确
      Test: manual:api-test
- [ ] API 返回数据包含关联的 business, department, area 信息
      Test: manual:api-test
- [ ] PATCH /api/tasks/goals/:id 支持更新时间字段（expected/actual dates）
      Test: manual:api-test

### 集成验收

#### 三层 OKR 创建流程
- [ ] 可以创建个人 O（scope=personal, cycle=3months）
      Test: manual:workflow
- [ ] 可以创建个人 KR，parent_id 指向个人 O
      Test: manual:workflow
- [ ] 可以创建业务 O，parent_id 指向个人 KR，business_id 关联 Stock
      Test: manual:workflow
- [ ] 可以创建业务 KR，parent_id 指向业务 O
      Test: manual:workflow
- [ ] 可以创建部门 O，parent_id 指向业务 KR，department_id 关联 Content Team
      Test: manual:workflow
- [ ] 通过 API 查询可以追溯层级关系
      Test: manual:workflow

#### 时间追踪验证
- [ ] 可以设置预期开始/结束日期
      Test: manual:workflow
- [ ] 可以设置实际开始/结束日期
      Test: manual:workflow
- [ ] 可以对比预期 vs 实际（延期情况）
      Test: manual:workflow

### 代码质量
- [ ] TypeScript 编译无错误
      Test: contract:build-check
- [ ] Migration 文件格式正确
      Test: manual:code-review
- [ ] Controller 代码符合现有规范
      Test: manual:code-review
- [ ] 路由定义正确
      Test: manual:code-review

### 测试验收
- [ ] npm run build 通过
      Test: contract:build-check
- [ ] 后端服务启动无报错
      Test: manual:server-start
- [ ] 数据库 migration 执行成功
      Test: manual:migration-run

## 非功能需求
- [ ] API 错误处理完善（400/404/500）
      Test: manual:error-handling
- [ ] 数据库事务正确（创建/删除操作原子性）
      Test: manual:transaction
- [ ] 外键约束不会导致孤立数据
      Test: manual:referential-integrity

## 不做的事（明确排除）
- ❌ 不做前端页面（Phase 2）
- ❌ 不做数据迁移（现有 goals 保持不变）
- ❌ 不做 OKR 拆解逻辑（秋米职责）
- ❌ 不做权限控制（暂不需要）

# PRD: TRD 分解器 (Stage 2)

## 背景

Stage 1 已完成 tick + cecelia-run 集成。现在需要实现 TRD 分解器，将大型技术需求文档 (TRD) 自动分解为可执行的任务序列。

## 目标

实现 TRD → PRD → Tasks 的自动分解流程，为 Stage 3 (目标对比) 和 Stage 4 (完整自驱动循环) 奠定基础。

## 功能需求

### 1. TRD 分解 API

```
POST /api/brain/trd/decompose
```

请求体：
```json
{
  "trd_content": "TRD 文本内容",
  "project_id": "项目 ID (可选)",
  "goal_id": "目标 ID (可选)"
}
```

响应：
```json
{
  "success": true,
  "trd_id": "生成的 TRD ID",
  "milestones": [
    {
      "id": "milestone-1",
      "title": "里程碑标题",
      "prds": [
        {
          "id": "prd-1",
          "title": "PRD 标题",
          "content": "PRD 内容",
          "tasks": [
            {
              "id": "task-1",
              "title": "任务标题",
              "depends_on": []
            }
          ]
        }
      ]
    }
  ]
}
```

### 2. 进度追踪 API

```
GET /api/brain/trd/:id/progress
```

响应：
```json
{
  "trd_id": "xxx",
  "total_tasks": 10,
  "completed_tasks": 3,
  "current_task": "task-4",
  "progress_percent": 30,
  "milestones": [
    {
      "id": "milestone-1",
      "status": "in_progress",
      "progress": 50
    }
  ]
}
```

### 3. 分解逻辑

decomposer.js 模块需实现：

1. **parseTRDSections()** - 解析 TRD 文本，提取章节结构
2. **extractMilestones()** - 从章节中识别里程碑
3. **generatePRDs()** - 为每个里程碑生成 PRD
4. **createTasks()** - 从 PRD 生成具体任务
5. **establishDependencies()** - 建立任务间依赖关系

### 4. 数据存储

在现有数据库中新增：

```sql
-- TRD 表
CREATE TABLE IF NOT EXISTS trds (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  content TEXT NOT NULL,
  project_id UUID REFERENCES projects(id),
  goal_id UUID REFERENCES goals(id),
  status VARCHAR(50) DEFAULT 'active',
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

-- TRD-Task 关联表
CREATE TABLE IF NOT EXISTS trd_tasks (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  trd_id UUID REFERENCES trds(id),
  task_id UUID REFERENCES tasks(id),
  milestone VARCHAR(255),
  prd_title VARCHAR(255),
  sequence_order INT,
  created_at TIMESTAMP DEFAULT NOW()
);
```

## 验收标准

1. [ ] POST /api/brain/trd/decompose 接口可用
2. [ ] GET /api/brain/trd/:id/progress 接口可用
3. [ ] 分解后的任务正确存入 tasks 表
4. [ ] 任务间 depends_on 关系正确建立
5. [ ] 进度追踪返回正确的完成百分比

## 技术约束

- 使用现有的 PostgreSQL 数据库
- 复用 tasks 表结构
- 兼容 tick.js 的任务选择逻辑

## 非功能需求

- 分解一个中等规模 TRD (5000 字) 应在 5 秒内完成
- 支持 TRD 内容更新后重新分解

---
id: dod-watchdog-agent-monitor
version: 1.0.0
created: 2026-01-29
updated: 2026-01-29
changelog:
  - 1.0.0: Initial version
---

# DoD: Agent Watchdog

## Acceptance Criteria

### Service Layer
- [x] WatchedAgent interface defined
- [x] registerAgent() registers agent with output file path
- [x] unregisterAgent() removes agent from monitoring
- [x] getAgentStatus() returns current status based on file mtime
- [x] getAllAgentStatuses() returns all monitored agents
- [x] triggerPatrol() spawns cecelia-patrol command
- [x] checkAllAgents() checks all agents and triggers patrol for stale ones
- [x] Background monitor runs every 10 seconds
- [x] startMonitor() / stopMonitor() control background process

### Routes Layer
- [x] POST /api/watchdog/register - registers agent
- [x] GET /api/watchdog/status - returns all agents
- [x] GET /api/watchdog/:agent_id - returns specific agent
- [x] DELETE /api/watchdog/:agent_id - unregisters agent
- [x] POST /api/watchdog/trigger/:agent_id - manual patrol trigger
- [x] POST /api/watchdog/monitor/start - starts monitor
- [x] POST /api/watchdog/monitor/stop - stops monitor
- [x] POST /api/watchdog/check - manual check all agents

### Tests
- [x] 24 tests covering all functionality
- [x] Agent registration tests
- [x] Agent unregistration tests
- [x] Status detection tests (healthy/stale)
- [x] Monitor control tests
- [x] Configuration tests
- [x] Edge case tests

### Integration
- [x] Routes registered in server.ts
- [x] Monitor starts automatically on server start
- [x] TypeScript compiles without errors
- [x] Build succeeds

## Verification Commands

```bash
# Run tests
cd /home/xx/dev/cecelia-workspace/apps/core
npm test -- src/watchdog

# Type check
npm run typecheck

# Build
npm run build

# Test API (after server running)
curl -X POST http://localhost:5212/api/watchdog/register \
  -H "Content-Type: application/json" \
  -d '{"agent_id":"test-1","output_file":"/tmp/test.output","timeout":120}'

curl http://localhost:5212/api/watchdog/status
```

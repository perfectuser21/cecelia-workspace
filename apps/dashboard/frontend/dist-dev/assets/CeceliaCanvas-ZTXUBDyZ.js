import{r as a,j as u,L as G,bp as W,bq as H}from"./index-DjV-74X0.js";import{c as E,T as B}from"./tldraw-btmlWyqr.js";import"./index-B0zmCYrs.js";const K=[{type:"function",name:"canvas_draw_shape",description:"在画布上绘制形状。支持矩形、圆形、箭头、线条等。",parameters:{type:"object",properties:{shape:{type:"string",enum:["rectangle","ellipse","arrow","line","text"],description:"形状类型"},x:{type:"number",description:"X 坐标",default:200},y:{type:"number",description:"Y 坐标",default:200},width:{type:"number",description:"宽度",default:200},height:{type:"number",description:"高度",default:100},color:{type:"string",description:"颜色",default:"blue"},text:{type:"string",description:"文本内容（用于 text 类型）"}},required:["shape"]}},{type:"function",name:"canvas_add_text",description:"在画布上添加文本",parameters:{type:"object",properties:{text:{type:"string",description:"文本内容"},x:{type:"number",description:"X 坐标",default:200},y:{type:"number",description:"Y 坐标",default:200},size:{type:"string",enum:["s","m","l","xl"],default:"m"}},required:["text"]}},{type:"function",name:"canvas_draw_flowchart",description:"绘制流程图。提供节点和连接，自动布局。",parameters:{type:"object",properties:{nodes:{type:"array",items:{type:"object",properties:{id:{type:"string"},label:{type:"string"},type:{type:"string",enum:["start","end","process","decision"]}}},description:"节点列表"},edges:{type:"array",items:{type:"object",properties:{from:{type:"string"},to:{type:"string"},label:{type:"string"}}},description:"连接列表"}},required:["nodes","edges"]}},{type:"function",name:"canvas_clear",description:"清空画布",parameters:{type:"object",properties:{},required:[]}},{type:"function",name:"cecelia_create_task",description:"创建开发任务",parameters:{type:"object",properties:{title:{type:"string",description:"任务标题"},description:{type:"string",description:"任务描述"}},required:["title","description"]}},{type:"function",name:"cecelia_list_tasks",description:"列出所有任务",parameters:{type:"object",properties:{},required:[]}},{type:"function",name:"cecelia_health_check",description:"检查系统状态",parameters:{type:"object",properties:{},required:[]}}],Q=`你是 Cecelia，一个运行在 VPS 上的 AI 开发助手，配合万能画布工作。

你的能力：
1. 画布操作：canvas_draw_shape, canvas_add_text, canvas_draw_flowchart, canvas_clear
2. 任务管理：cecelia_create_task, cecelia_list_tasks
3. 系统状态：cecelia_health_check

当用户想要可视化想法时：
- "画一个流程图" → 使用 canvas_draw_flowchart
- "画一个矩形/圆形" → 使用 canvas_draw_shape
- "写点文字" → 使用 canvas_add_text
- "清空画布" → 使用 canvas_clear

规则：
- 必须通过工具执行操作
- 用简洁的中文回复
- 画图时选择合适的位置和颜色`;function ae(){const[g,I]=a.useState(!1),[w,b]=a.useState(!1),[C,y]=a.useState(""),[k,j]=a.useState(""),[v,Y]=a.useState(""),[A,V]=a.useState("shimmer"),[Z,X]=a.useState(!1),[ee,U]=a.useState(null),O=a.useRef(null),i=a.useRef(null),T=a.useRef(null),N=a.useRef(null),x=a.useRef(null),R=a.useCallback(s=>{const e=x.current;if(console.log("[drawShape] editorRef.current:",e,"args:",s),!e)return console.error("[drawShape] Editor not ready!"),{success:!1,error:"Editor not ready"};const{shape:c,x:t=200,y:n=200,width:m=200,height:p=100,color:d="blue",text:o}=s,r=E();try{switch(c){case"rectangle":e.createShape({id:r,type:"geo",x:t,y:n,props:{geo:"rectangle",w:m,h:p,color:d}}),e.zoomToFit({animation:{duration:200}});break;case"ellipse":console.log("[drawShape] Creating ellipse at",t,n,"size",m,p),e.createShape({id:r,type:"geo",x:t,y:n,props:{geo:"ellipse",w:m,h:p,color:d}}),e.zoomToFit({animation:{duration:200}}),console.log("[drawShape] Ellipse created with id:",r);const f=e.getCurrentPageShapes();console.log("[drawShape] Current page shapes:",f.length,f);break;case"text":e.createShape({id:r,type:"text",x:t,y:n,props:{text:o||"Text",color:d,size:"m"}});break;case"arrow":e.createShape({id:r,type:"arrow",x:t,y:n,props:{color:d}});break}return{success:!0,shape_id:r}}catch(f){return{success:!1,error:String(f)}}},[]),J=a.useCallback(s=>{const e=x.current;if(!e)return{success:!1,error:"Editor not ready"};const{text:c,x:t=200,y:n=200,size:m="m"}=s,p=E();try{return e.createShape({id:p,type:"text",x:t,y:n,props:{text:c,size:m}}),{success:!0,shape_id:p}}catch(d){return{success:!1,error:String(d)}}},[]),L=a.useCallback(s=>{const e=x.current;if(!e)return{success:!1,error:"Editor not ready"};const{nodes:c=[],edges:t=[]}=s,n=new Map,m=100,p=100,d=150,o=60,r=200,f=120;try{return c.forEach((l,h)=>{const S=Math.floor(h/3),_=h%3,z=m+_*r,M=p+S*f,F=E();e.createShape({id:F,type:"geo",x:z,y:M,props:{geo:l.type==="decision"?"diamond":"rectangle",w:d,h:o,color:l.type==="start"?"green":l.type==="end"?"red":"blue",text:l.label}}),n.set(l.id,{x:z+d/2,y:M+o/2,shapeId:F})}),t.forEach(l=>{const h=n.get(l.from),S=n.get(l.to);if(h&&S){const _=E();e.createShape({id:_,type:"arrow",props:{color:"black",start:{x:h.x,y:h.y+o/2},end:{x:S.x,y:S.y-o/2}}})}}),e.zoomToFit({animation:{duration:200}}),{success:!0,nodes_created:c.length,edges_created:t.length}}catch(l){return{success:!1,error:String(l)}}},[]),P=a.useCallback(()=>{const s=x.current;if(!s)return{success:!1,error:"Editor not ready"};try{const e=s.getCurrentPageShapeIds();return s.deleteShapes([...e]),{success:!0}}catch(e){return{success:!1,error:String(e)}}},[]),D=a.useCallback(async(s,e,c)=>{console.log("Tool call:",s,e),console.log("[handleToolCall] drawShape function:",typeof R,R);let t;switch(s){case"canvas_draw_shape":console.log("[handleToolCall] Calling drawShape..."),t=R(e),console.log("[handleToolCall] drawShape result:",t);break;case"canvas_add_text":t=J(e);break;case"canvas_draw_flowchart":t=L(e);break;case"canvas_clear":t=P();break;case"cecelia_create_task":{t=await(await fetch("/api/cecelia/tasks",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)})).json();break}case"cecelia_list_tasks":{t=await(await fetch("/api/cecelia/runs")).json();break}case"cecelia_health_check":{t=await(await fetch("/api/cecelia/health")).json();break}default:t={error:`Unknown tool: ${s}`}}return i.current&&i.current.readyState==="open"&&(i.current.send(JSON.stringify({type:"conversation.item.create",item:{type:"function_call_output",call_id:c,output:JSON.stringify(t)}})),i.current.send(JSON.stringify({type:"response.create"}))),t},[R,J,L,P]),$=a.useCallback(async()=>{var s;if(!(g||w)){b(!0),y("正在连接..."),j("");try{const e=new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"}]});O.current=e;const c=document.createElement("audio");c.autoplay=!0,T.current=c,e.ontrack=o=>{c.srcObject=o.streams[0]};const t=await navigator.mediaDevices.getUserMedia({audio:!0});N.current=t,e.addTrack(t.getTracks()[0]);const n=e.createDataChannel("oai-events");i.current=n,n.onopen=()=>{b(!1),I(!0),y("已连接，请说话...");const o={type:"session.update",session:{instructions:Q,tools:K,tool_choice:"auto",input_audio_transcription:{model:"whisper-1"}}};console.log("[Cecelia] session.update:",JSON.stringify(o,null,2)),n.send(JSON.stringify(o))},n.onmessage=o=>{var f;const r=JSON.parse(o.data);if(console.log("[Cecelia] 收到消息:",r.type),(r.type.includes("session")||r.type.includes("error")||r.type.includes("function")||r.type.includes("response"))&&console.log("[Cecelia] 详情:",r),r.type==="error"&&(console.error("Realtime error:",r),y("错误: "+(((f=r.error)==null?void 0:f.message)||JSON.stringify(r.error)))),r.type==="input_audio_buffer.speech_started"&&(y("正在听..."),j("")),r.type==="input_audio_buffer.speech_stopped"&&y("处理中..."),r.type==="conversation.item.input_audio_transcription.completed"&&y("你: "+r.transcript),r.type==="response.output_audio_transcript.delta"&&j(l=>l+(r.delta||"")),r.type==="response.function_call_arguments.done"){const{call_id:l,name:h,arguments:S}=r;try{const _=JSON.parse(S);y(`正在执行: ${h}...`),D(h,_,l)}catch(_){console.error("Failed to parse function args:",_)}}},await e.setLocalDescription(),await new Promise(o=>{e.iceGatheringState==="complete"?o():(e.onicegatheringstatechange=()=>{e.iceGatheringState==="complete"&&o()},setTimeout(o,3e3))});const p=await(await fetch("/api/cecelia/realtime-sdp",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({sdp:(s=e.localDescription)==null?void 0:s.sdp,model:"gpt-4o-realtime-preview-2024-12-17"})})).json();if(!p.success)throw console.error("SDP exchange error:",p.error),new Error(`SDP exchange failed: ${p.error}`);const d=p.sdp;await e.setRemoteDescription({type:"answer",sdp:d})}catch(e){console.error("Failed to start voice:",e),y("启动失败: "+(e instanceof Error?e.message:String(e))),b(!1),q()}}},[g,w,A,D]),q=a.useCallback(()=>{var s,e,c;(s=i.current)==null||s.close(),i.current=null,(e=N.current)==null||e.getTracks().forEach(t=>t.stop()),N.current=null,(c=O.current)==null||c.close(),O.current=null,T.current&&(T.current.srcObject=null,T.current=null),I(!1),b(!1)},[]);return a.useCallback(()=>{!v.trim()||!i.current||i.current.readyState!=="open"||(i.current.send(JSON.stringify({type:"conversation.item.create",item:{type:"message",role:"user",content:[{type:"input_text",text:v}]}})),i.current.send(JSON.stringify({type:"response.create"})),y("你: "+v),j(""),Y(""))},[v]),a.useCallback(s=>{V(s),g&&i.current&&i.current.readyState==="open"&&i.current.send(JSON.stringify({type:"session.update",session:{audio:{output:{voice:s}}}})),X(!1)},[g]),console.log("[CeceliaCanvas] Render - transcript:",C,"aiResponse:",k,"isListening:",g),u.jsxs("div",{style:{position:"absolute",top:0,left:0,right:0,bottom:0,display:"flex",flexDirection:"column"},children:[u.jsx("div",{style:{flex:1,position:"relative"},children:u.jsx(B,{onMount:s=>{console.log("[Tldraw] Editor mounted"),x.current=s,U(s)}})}),u.jsxs("div",{style:{height:70,padding:"10px 16px",backgroundColor:"#0f172a",borderTop:"1px solid #334155",display:"flex",alignItems:"center",justifyContent:"center",gap:12,flexShrink:0},children:[(C||k)&&u.jsxs("div",{style:{flex:1,maxWidth:400,padding:"6px 12px",backgroundColor:"rgba(30, 41, 59, 0.9)",borderRadius:8,fontSize:12},children:[C&&u.jsx("span",{style:{color:"#94a3b8"},children:C}),k&&u.jsx("span",{style:{color:"#c4b5fd",marginLeft:8},children:k})]}),u.jsx("button",{onClick:g?q:$,disabled:w,style:{width:50,height:50,borderRadius:"50%",border:"none",cursor:w?"wait":"pointer",backgroundColor:g?"#ef4444":w?"#475569":"#7c3aed",display:"flex",alignItems:"center",justifyContent:"center"},children:w?u.jsx(G,{className:"w-6 h-6 text-white animate-spin"}):g?u.jsx(W,{className:"w-6 h-6 text-white"}):u.jsx(H,{className:"w-6 h-6 text-white"})})]})]})}export{ae as default};

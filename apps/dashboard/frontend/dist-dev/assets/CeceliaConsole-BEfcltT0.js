import{r as i,j as e,d as f,L as p,H as y,aM as b,R as g,a0 as j,a1 as N}from"./index-sd6rvxIJ.js";function k({messages:s,isLoading:n,onSendMessage:r}){const[l,c]=i.useState(""),d=i.useRef(null);i.useEffect(()=>{var t;(t=d.current)==null||t.scrollIntoView({behavior:"smooth"})},[s]);const a=t=>{t.preventDefault(),!(!l.trim()||n)&&(r(l.trim()),c(""))};return e.jsxs("div",{className:"flex flex-col h-full",children:[e.jsxs("div",{className:"flex-1 overflow-y-auto p-4 space-y-4",children:[s.map(t=>{var o;return e.jsx("div",{className:`flex ${t.role==="user"?"justify-end":"justify-start"}`,children:e.jsxs("div",{className:`max-w-[80%] rounded-lg px-4 py-2 ${t.role==="user"?"bg-blue-500 text-white":"bg-gray-100 dark:bg-gray-800 text-gray-900 dark:text-white"}`,children:[e.jsx("div",{className:"whitespace-pre-wrap",children:t.content}),((o=t.actionResult)==null?void 0:o.taskId)&&e.jsxs("div",{className:"mt-2 text-xs opacity-80",children:["任务 ID: ",t.actionResult.taskId]}),e.jsx("div",{className:"text-xs opacity-60 mt-1",children:t.timestamp.toLocaleTimeString()})]})},t.id)}),n&&e.jsx("div",{className:"flex justify-start",children:e.jsx("div",{className:"bg-gray-100 dark:bg-gray-800 rounded-lg px-4 py-2",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-2 h-2 bg-blue-500 rounded-full animate-bounce"}),e.jsx("div",{className:"w-2 h-2 bg-blue-500 rounded-full animate-bounce [animation-delay:0.2s]"}),e.jsx("div",{className:"w-2 h-2 bg-blue-500 rounded-full animate-bounce [animation-delay:0.4s]"})]})})}),e.jsx("div",{ref:d})]}),e.jsx("form",{onSubmit:a,className:"p-4 border-t border-gray-200 dark:border-gray-700",children:e.jsxs("div",{className:"flex gap-2",children:[e.jsx("input",{type:"text",value:l,onChange:t=>c(t.target.value),placeholder:"输入消息...",disabled:n,className:"flex-1 px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-900 dark:text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500"}),e.jsx("button",{type:"submit",disabled:n||!l.trim(),className:"px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 disabled:opacity-50 disabled:cursor-not-allowed transition-colors",children:e.jsx(f,{className:"w-5 h-5"})})]})})]})}function v(){var d;const[s,n]=i.useState(null),[r,l]=i.useState(!0);if(i.useEffect(()=>{const a=async()=>{try{const x=await(await fetch("/api/cecelia/overview")).json();x.success&&n(x)}catch(o){console.error("Failed to fetch overview:",o)}finally{l(!1)}};a();const t=setInterval(a,1e4);return()=>clearInterval(t)},[]),r)return e.jsx("div",{className:"p-4 flex items-center justify-center",children:e.jsx(p,{className:"w-6 h-6 animate-spin text-gray-400"})});const c=((d=s==null?void 0:s.recent_runs)==null?void 0:d.filter(a=>a.status==="running"))||[];return e.jsxs("div",{className:"p-4",children:[e.jsx("h3",{className:"text-sm font-semibold text-gray-900 dark:text-white mb-3",children:"任务状态"}),e.jsxs("div",{className:"grid grid-cols-3 gap-2 mb-4",children:[e.jsxs("div",{className:"bg-blue-50 dark:bg-blue-900/30 rounded-lg p-2 text-center",children:[e.jsx("div",{className:"text-lg font-bold text-blue-600 dark:text-blue-400",children:(s==null?void 0:s.running)||0}),e.jsx("div",{className:"text-xs text-gray-500 dark:text-gray-400",children:"运行中"})]}),e.jsxs("div",{className:"bg-green-50 dark:bg-green-900/30 rounded-lg p-2 text-center",children:[e.jsx("div",{className:"text-lg font-bold text-green-600 dark:text-green-400",children:(s==null?void 0:s.completed)||0}),e.jsx("div",{className:"text-xs text-gray-500 dark:text-gray-400",children:"已完成"})]}),e.jsxs("div",{className:"bg-red-50 dark:bg-red-900/30 rounded-lg p-2 text-center",children:[e.jsx("div",{className:"text-lg font-bold text-red-600 dark:text-red-400",children:(s==null?void 0:s.failed)||0}),e.jsx("div",{className:"text-xs text-gray-500 dark:text-gray-400",children:"失败"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("h4",{className:"text-xs font-medium text-gray-500 dark:text-gray-400 uppercase",children:"运行中的任务"}),c.length===0?e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:"暂无运行中的任务"}):c.map(a=>e.jsxs("div",{className:"bg-gray-50 dark:bg-gray-800 rounded-lg p-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(p,{className:"w-4 h-4 animate-spin text-blue-500"}),e.jsx("span",{className:"text-sm font-medium text-gray-900 dark:text-white truncate",children:a.feature_branch})]}),e.jsx("div",{className:"text-xs text-gray-500 dark:text-gray-400 mt-1",children:a.project}),a.current_checkpoint&&e.jsx("div",{className:"text-xs text-blue-500 mt-1",children:a.current_checkpoint})]},a.id))]})]})}const w={task_created:g,task_updated:g,task_completed:N,task_failed:j,checkpoint_updated:g,chat_message:b,heartbeat:y},S={task_created:"任务创建",task_updated:"任务更新",task_completed:"任务完成",task_failed:"任务失败",checkpoint_updated:"检查点更新",chat_message:"聊天消息",heartbeat:"心跳"},_={task_created:"text-blue-500",task_updated:"text-yellow-500",task_completed:"text-green-500",task_failed:"text-red-500",checkpoint_updated:"text-purple-500",chat_message:"text-gray-500",heartbeat:"text-gray-300"};function C({events:s}){const n=s.filter(r=>r.type!=="heartbeat").slice(-20);return e.jsxs("div",{className:"p-4",children:[e.jsx("h3",{className:"text-sm font-semibold text-gray-900 dark:text-white mb-3",children:"事件流"}),e.jsx("div",{className:"space-y-2",children:n.length===0?e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:"等待事件..."}):n.map((r,l)=>{const c=w[r.type]||g,d=S[r.type]||r.type,a=_[r.type]||"text-gray-500",t=new Date(r.timestamp).toLocaleTimeString();return e.jsxs("div",{className:"flex items-start gap-2 text-sm",children:[e.jsx(c,{className:`w-4 h-4 mt-0.5 ${a}`}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("span",{className:"font-medium text-gray-900 dark:text-white",children:d}),e.jsx("span",{className:"text-xs text-gray-500 dark:text-gray-400 ml-2",children:t}),typeof r.data=="object"&&r.data!==null&&e.jsxs("div",{className:"text-xs text-gray-500 dark:text-gray-400 truncate",children:[JSON.stringify(r.data).slice(0,50),"..."]})]})]},`${r.timestamp}-${l}`)})})]})}function E(s){const[n,r]=i.useState([]),[l,c]=i.useState(!1),[d,a]=i.useState(null);return i.useEffect(()=>{let t=null,o=null;const x=()=>{try{t=new EventSource(s),t.onopen=()=>{c(!0),a(null),console.log("SSE connected")},t.onmessage=m=>{try{const u=JSON.parse(m.data);r(h=>[...h,u].slice(-100))}catch(u){console.error("Failed to parse SSE event:",u)}},t.onerror=()=>{c(!1),a("Connection lost"),t==null||t.close(),o=setTimeout(x,5e3)}}catch{a("Failed to connect"),c(!1)}};return x(),()=>{t==null||t.close(),o&&clearTimeout(o)}},[s]),{events:n,isConnected:l,error:d}}function R(){const[s,n]=i.useState([{id:"1",role:"assistant",content:`你好！我是 Cecelia，你的 AI 开发助手。我可以帮你：

1. 创建开发任务（如"帮我实现 xxx 功能"）
2. 查看任务状态
3. 管理开发流程

有什么我可以帮你的吗？`,timestamp:new Date}]),[r,l]=i.useState(!1),{events:c,isConnected:d}=E("/api/cecelia/stream"),a=i.useCallback(async t=>{const o={id:Date.now().toString(),role:"user",content:t,timestamp:new Date};n(x=>[...x,o]),l(!0);try{const m=await(await fetch("/api/cecelia/chat",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({message:t})})).json(),u={id:(Date.now()+1).toString(),role:"assistant",content:m.reply||"抱歉，出了点问题。",timestamp:new Date,intent:m.intent,actionResult:m.actionResult};n(h=>[...h,u])}catch{const m={id:(Date.now()+1).toString(),role:"assistant",content:"抱歉，无法连接到服务器。请稍后重试。",timestamp:new Date};n(u=>[...u,m])}finally{l(!1)}},[]);return e.jsxs("div",{className:"h-full flex flex-col",children:[e.jsxs("div",{className:"flex items-center justify-between px-6 py-4 border-b border-gray-200 dark:border-gray-700",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900 dark:text-white",children:"Cecelia Console"}),e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:"AI 开发助手 - 通过对话创建和管理开发任务"})]}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsxs("span",{className:`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${d?"bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200":"bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200"}`,children:[e.jsx("span",{className:`w-2 h-2 mr-1.5 rounded-full ${d?"bg-green-500":"bg-red-500"}`}),d?"已连接":"未连接"]})})]}),e.jsxs("div",{className:"flex-1 flex overflow-hidden",children:[e.jsx("div",{className:"flex-1 flex flex-col min-w-0",children:e.jsx(k,{messages:s,isLoading:r,onSendMessage:a})}),e.jsxs("div",{className:"w-80 border-l border-gray-200 dark:border-gray-700 flex flex-col overflow-hidden",children:[e.jsx("div",{className:"flex-1 min-h-0 overflow-y-auto border-b border-gray-200 dark:border-gray-700",children:e.jsx(v,{})}),e.jsx("div",{className:"flex-1 min-h-0 overflow-y-auto",children:e.jsx(C,{events:c})})]})]})]})}export{R as default};

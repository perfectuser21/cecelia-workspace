import{r as o,j as t,z as Ue,v as kt,aN as Jt,C as Qt,y as un,F as as,Y as ls,X as rs,aW as fn,aX as mn,x as os,a2 as wt,aY as es,s as ts,I as pn,aZ as gn,a_ as bn,L as yn,O as jn,aU as vn,aV as wn,a$ as Nn,b0 as kn,b1 as Cn,b2 as Sn,b3 as Mn,b4 as En,b5 as Dn,b6 as $n,b7 as zn,b8 as In,b9 as Tn,_ as Pn}from"./index-A9akftxR.js";const Fe=150,Ke=100,oe=10;function An({nodes:y,edges:r,viewBox:x,canvasSize:m,onPanTo:D}){const L=o.useRef(null),[U,_]=o.useState(!1),R=o.useCallback(()=>{const f=y.filter(Y=>typeof Y.x=="number"&&typeof Y.y=="number");if(f.length===0)return{minX:0,minY:0,maxX:m.width,maxY:m.height};const M=Math.min(...f.map(Y=>Y.x),x.x),N=Math.min(...f.map(Y=>Y.y),x.y),z=Math.max(...f.map(Y=>Y.x+(Y.width||150)),x.x+x.width),A=Math.max(...f.map(Y=>Y.y+(Y.height||50)),x.y+x.height);return{minX:M,minY:N,maxX:z,maxY:A}},[y,x,m]),P=o.useCallback(()=>{const f=R(),M=f.maxX-f.minX+oe*2,N=f.maxY-f.minY+oe*2,z=(Fe-oe*2)/M,A=(Ke-oe*2)/N;return Math.min(z,A,1)},[R]),F=o.useCallback((f,M)=>{const N=R(),z=P(),A=(Fe-(N.maxX-N.minX+oe*2)*z)/2,Y=(Ke-(N.maxY-N.minY+oe*2)*z)/2,T=(f-A-oe*z)/z+N.minX,G=(M-Y-oe*z)/z+N.minY;return{x:T,y:G}},[R,P]),Z=o.useCallback((f,M)=>{const N=R(),z=P(),A=(Fe-(N.maxX-N.minX+oe*2)*z)/2,Y=(Ke-(N.maxY-N.minY+oe*2)*z)/2,T=(f-N.minX)*z+A+oe*z,G=(M-N.minY)*z+Y+oe*z;return{x:T,y:G}},[R,P]),ie=o.useCallback(f=>{if(!L.current)return;const M=L.current.getBoundingClientRect(),N=f.clientX-M.left,z=f.clientY-M.top,A=F(N,z);D(A.x-x.width/2,A.y-x.height/2)},[F,D,x.width,x.height]),K=o.useCallback(f=>{f.stopPropagation(),_(!0)},[]),te=o.useCallback(f=>{if(!U||!L.current)return;const M=L.current.getBoundingClientRect(),N=f.clientX-M.left,z=f.clientY-M.top,A=F(N,z);D(A.x-x.width/2,A.y-x.height/2)},[U,F,D,x.width,x.height]),v=o.useCallback(()=>{_(!1)},[]),u=o.useCallback(()=>{_(!1)},[]);o.useEffect(()=>{if(U){const f=()=>_(!1);return window.addEventListener("mouseup",f),()=>window.removeEventListener("mouseup",f)}},[U]);const j=o.useCallback(f=>{const M=y.find(N=>N.id===f);return!M||typeof M.x!="number"||typeof M.y!="number"?null:{x:M.x+(M.width||150)/2,y:M.y+(M.height||50)/2}},[y]),$=P();R();const S={x:Z(x.x,x.y).x,y:Z(x.x,x.y).y,width:x.width*$,height:x.height*$};return t.jsxs("div",{className:"absolute bottom-28 left-3 w-[150px] h-[100px] bg-slate-800/90 border border-slate-600 rounded-lg overflow-hidden shadow-lg backdrop-blur-sm z-10",children:[t.jsxs("svg",{ref:L,width:"100%",height:"100%",onClick:ie,onMouseMove:te,onMouseUp:v,onMouseLeave:u,style:{cursor:U?"grabbing":"pointer"},children:[t.jsx("rect",{width:Fe,height:Ke,fill:"transparent"}),r.map((f,M)=>{const N=j(f.from),z=j(f.to);if(!N||!z)return null;const A=Z(N.x,N.y),Y=Z(z.x,z.y);return t.jsx("line",{x1:A.x,y1:A.y,x2:Y.x,y2:Y.y,stroke:"#64748b",strokeWidth:.5,pointerEvents:"none"},`edge-${M}`)}),y.filter(f=>typeof f.x=="number"&&typeof f.y=="number").map(f=>{const M=Z(f.x,f.y),N=Math.max((f.width||150)*$,4),z=Math.max((f.height||50)*$,3);return t.jsx("rect",{x:M.x,y:M.y,width:N,height:z,rx:1,fill:f.color||"#3b82f6",opacity:.8,pointerEvents:"none"},f.id)}),t.jsx("rect",{x:S.x,y:S.y,width:S.width,height:S.height,fill:"rgba(59, 130, 246, 0.1)",stroke:"#3b82f6",strokeWidth:1.5,strokeDasharray:"4 2",style:{cursor:U?"grabbing":"grab"},onMouseDown:K}),S.width>20&&S.height>15&&t.jsx("circle",{cx:S.x+S.width/2,cy:S.y+S.height/2,r:3,fill:"#3b82f6",pointerEvents:"none"})]}),t.jsx("div",{className:"absolute top-1 left-2 text-[10px] text-slate-500 font-medium pointer-events-none",children:"Mini Map"})]})}const Yn=[{keys:["Cmd/Ctrl","C"],desc:"å¤åˆ¶"},{keys:["Cmd/Ctrl","V"],desc:"ç²˜è´´"},{keys:["Cmd/Ctrl","Z"],desc:"æ’¤é”€"},{keys:["Cmd/Ctrl","Shift","Z"],desc:"é‡åš"},{keys:["Delete"],desc:"åˆ é™¤"},{keys:["Shift","ç‚¹å‡»"],desc:"å¤šé€‰"},{keys:["æ‹–æ‹½ç©ºç™½"],desc:"æ¡†é€‰"},{keys:["æ»šè½®"],desc:"ç¼©æ”¾"},{keys:["Shift","æ‹–æ‹½"],desc:"å¹³ç§»ç”»å¸ƒ"},{keys:["åŒå‡»èŠ‚ç‚¹"],desc:"ç¼–è¾‘æ–‡å­—"},{keys:["?"],desc:"æ˜¾ç¤ºå¸®åŠ©"}];function Xn({isOpen:y,onClose:r}){const x=o.useCallback(m=>{m.key==="Escape"&&r()},[r]);return o.useEffect(()=>{if(y)return document.addEventListener("keydown",x),()=>document.removeEventListener("keydown",x)},[y,x]),y?t.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 animate-fade-in",onClick:r,children:t.jsxs("div",{className:"bg-slate-800 border border-slate-600 rounded-xl p-6 max-w-md w-full mx-4 shadow-2xl animate-scale-in",onClick:m=>m.stopPropagation(),children:[t.jsx("h2",{className:"text-lg font-semibold text-slate-100 mb-4",children:"å¿«æ·é”®"}),t.jsx("div",{className:"space-y-2",children:Yn.map(({keys:m,desc:D})=>t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsx("span",{className:"text-slate-300",children:D}),t.jsx("div",{className:"flex gap-1",children:m.map(L=>t.jsx("kbd",{className:"px-2 py-1 bg-slate-700 text-slate-200 text-xs rounded border border-slate-600",children:L},L))})]},D))}),t.jsx("button",{onClick:r,className:"mt-4 w-full py-2 bg-slate-700 hover:bg-slate-600 text-slate-200 rounded-lg transition-colors",children:"å…³é—­"})]})}):null}const Ct={startX:100,startY:100,nodeSpacingH:200,nodeSpacingV:150,iterations:100};function Ln(y,r,x){const m={...Ct,...x};if(y.length===0)return[];if(y.length===1)return[{...y[0],x:m.startX,y:m.startY}];const D=new Map,L=new Map;y.forEach((v,u)=>{const j=v.x!==0||v.y!==0;D.set(v.id,{x:j?v.x:m.startX+Math.random()*300-150,y:j?v.y:m.startY+Math.random()*300-150}),L.set(v.id,{vx:0,vy:0})}),new Set(r.map(v=>`${v.from}-${v.to}`));const U=5e3,_=.01,R=.9,P=50;for(let v=0;v<m.iterations;v++){const u=new Map;y.forEach(j=>u.set(j.id,{fx:0,fy:0}));for(let j=0;j<y.length;j++)for(let $=j+1;$<y.length;$++){const S=y[j],f=y[$],M=D.get(S.id),N=D.get(f.id),z=N.x-M.x,A=N.y-M.y,Y=Math.max(Math.sqrt(z*z+A*A),P),T=U/(Y*Y),G=z/Y*T,E=A/Y*T,W=u.get(S.id),Ye=u.get(f.id);W.fx-=G,W.fy-=E,Ye.fx+=G,Ye.fy+=E}r.forEach(j=>{const $=D.get(j.from),S=D.get(j.to);if(!$||!S)return;const f=S.x-$.x,M=S.y-$.y,N=Math.sqrt(f*f+M*M);if(N<P)return;const z=N*_,A=f/N*z,Y=M/N*z,T=u.get(j.from),G=u.get(j.to);T&&(T.fx+=A,T.fy+=Y),G&&(G.fx-=A,G.fy-=Y)}),y.forEach(j=>{const $=D.get(j.id),S=L.get(j.id),f=u.get(j.id);S.vx=(S.vx+f.fx)*R,S.vy=(S.vy+f.fy)*R;const M=50,N=Math.sqrt(S.vx*S.vx+S.vy*S.vy);N>M&&(S.vx=S.vx/N*M,S.vy=S.vy/N*M),$.x+=S.vx,$.y+=S.vy})}const F=Array.from(D.values()),Z=F.reduce((v,u)=>v+u.x,0)/F.length,ie=F.reduce((v,u)=>v+u.y,0)/F.length,K=m.startX-Z,te=m.startY-ie;return y.map(v=>{const u=D.get(v.id);return{...v,x:Math.round(u.x+K),y:Math.round(u.y+te)}})}function Rn(y,r){const x={...Ct,...r};if(y.length===0)return[];const m=Math.ceil(Math.sqrt(y.length));Math.ceil(y.length/m);const D=Math.max(...y.map(R=>R.width)),L=Math.max(...y.map(R=>R.height)),U=D+x.nodeSpacingH,_=L+x.nodeSpacingV;return y.map((R,P)=>{const F=P%m,Z=Math.floor(P/m);return{...R,x:x.startX+F*U,y:x.startY+Z*_}})}function Hn(y,r){const x={...Ct,...r};if(y.length===0)return[];if(y.length===1)return[{...y[0],x:x.startX,y:x.startY}];const m=Math.max(...y.map(_=>Math.max(_.width,_.height))),D=y.length*(m+x.nodeSpacingH)/(2*Math.PI),L=Math.max(D,200),U=2*Math.PI/y.length;return y.map((_,R)=>{const P=-Math.PI/2+R*U;return{..._,x:Math.round(x.startX+L*Math.cos(P)),y:Math.round(x.startY+L*Math.sin(P))}})}function Wn(y){const r=new Date(y),m=new Date().getTime()-r.getTime(),D=Math.floor(m/6e4),L=Math.floor(m/36e5),U=Math.floor(m/864e5);return D<1?"åˆšåˆš":D<60?`${D} åˆ†é’Ÿå‰`:L<24?`${L} å°æ—¶å‰`:U<7?`${U} å¤©å‰`:r.toLocaleDateString("zh-CN")}function On({projects:y,currentProjectId:r,onSelectProject:x,onCreateProject:m,onDeleteProject:D,onRenameProject:L,isCollapsed:U,onToggleCollapse:_}){var G;const[R,P]=o.useState(null),[F,Z]=o.useState(null),[ie,K]=o.useState(""),[te,v]=o.useState(null),u=o.useRef(null),j=o.useRef(null),$=[...y].sort((E,W)=>new Date(W.updatedAt).getTime()-new Date(E.updatedAt).getTime()).slice(0,5);o.useEffect(()=>{const E=W=>{j.current&&!j.current.contains(W.target)&&P(null)};if(R)return document.addEventListener("mousedown",E),()=>document.removeEventListener("mousedown",E)},[R]),o.useEffect(()=>{F&&u.current&&(u.current.focus(),u.current.select())},[F]);const S=o.useCallback((E,W)=>{E.preventDefault(),E.stopPropagation(),P({id:W,x:E.clientX,y:E.clientY})},[]),f=o.useCallback(E=>{Z(E.id),K(E.name),P(null)},[]),M=o.useCallback(()=>{F&&ie.trim()&&L(F,ie.trim()),Z(null),K("")},[F,ie,L]),N=o.useCallback(()=>{Z(null),K("")},[]),z=o.useCallback(E=>{E.key==="Enter"?M():E.key==="Escape"&&N()},[M,N]),A=o.useCallback(E=>{v(E),P(null)},[]),Y=o.useCallback(()=>{te&&(D(te),v(null))},[te,D]),T=o.useCallback(()=>{v(null)},[]);return U?t.jsxs("div",{className:"w-12 h-full border-r border-slate-700/50 flex flex-col items-center py-3 gap-2",style:{background:"linear-gradient(180deg, #1e2a5e 0%, #1e1b4b 100%)"},children:[t.jsx("button",{onClick:_,className:"p-2 rounded-lg hover:bg-slate-800 text-slate-400 hover:text-slate-200 transition-colors",title:"å±•å¼€ä¾§è¾¹æ ",children:t.jsx(Ue,{size:18})}),t.jsx("div",{className:"w-8 h-px bg-slate-700 my-1"}),t.jsx("button",{onClick:m,className:"p-2 rounded-lg hover:bg-slate-800 text-slate-400 hover:text-blue-400 transition-colors",title:"æ–°å»ºé¡¹ç›®",children:t.jsx(kt,{size:18})}),t.jsx("button",{className:"p-2 rounded-lg text-slate-400 cursor-default",title:"é¡¹ç›®åˆ—è¡¨",children:t.jsx(Jt,{size:18})}),t.jsx("button",{className:"p-2 rounded-lg text-slate-400 cursor-default",title:"æœ€è¿‘é¡¹ç›®",children:t.jsx(Qt,{size:18})})]}):t.jsxs("div",{className:"w-60 h-full border-r border-slate-700/50 flex flex-col",style:{background:"linear-gradient(180deg, #1e2a5e 0%, #1e1b4b 100%)"},children:[t.jsxs("div",{className:"flex items-center justify-between px-3 py-3 border-b border-slate-700",children:[t.jsxs("div",{className:"flex items-center gap-2 text-slate-200 font-medium",children:[t.jsx(Jt,{size:18,className:"text-slate-400"}),t.jsx("span",{children:"é¡¹ç›®ç®¡ç†"})]}),t.jsx("button",{onClick:_,className:"p-1.5 rounded hover:bg-slate-800 text-slate-400 hover:text-slate-200 transition-colors",title:"æ”¶èµ·ä¾§è¾¹æ ",children:t.jsx(un,{size:16})})]}),t.jsx("div",{className:"px-3 py-2",children:t.jsxs("button",{onClick:m,className:"w-full flex items-center justify-center gap-2 px-3 py-2 rounded-lg bg-blue-600 hover:bg-blue-500 text-white text-sm font-medium transition-colors",children:[t.jsx(kt,{size:16}),"æ–°å»ºé¡¹ç›®"]})}),t.jsxs("div",{className:"flex-1 overflow-y-auto",children:[t.jsxs("div",{className:"px-3 py-2",children:[t.jsxs("div",{className:"text-xs text-slate-500 font-medium mb-2 flex items-center gap-1.5",children:[t.jsx(as,{size:12}),"æ‰€æœ‰é¡¹ç›® (",y.length,")"]}),t.jsx("div",{className:"space-y-1",children:y.length===0?t.jsx("div",{className:"text-sm text-slate-500 py-4 text-center",children:"æš‚æ— é¡¹ç›®"}):y.map(E=>t.jsx("div",{className:`group relative flex items-center px-2 py-2 rounded-lg cursor-pointer transition-colors ${r===E.id?"bg-blue-600/20 text-blue-400":"hover:bg-slate-800 text-slate-300"}`,onClick:()=>x(E.id),onContextMenu:W=>S(W,E.id),children:F===E.id?t.jsxs("div",{className:"flex-1 flex items-center gap-1",children:[t.jsx("input",{ref:u,type:"text",value:ie,onChange:W=>K(W.target.value),onKeyDown:z,onBlur:M,className:"flex-1 bg-slate-800 border border-slate-600 rounded px-2 py-1 text-sm text-slate-200 focus:outline-none focus:border-blue-500",onClick:W=>W.stopPropagation()}),t.jsx("button",{onClick:W=>{W.stopPropagation(),M()},className:"p-1 text-green-400 hover:text-green-300",children:t.jsx(ls,{size:14})}),t.jsx("button",{onClick:W=>{W.stopPropagation(),N()},className:"p-1 text-red-400 hover:text-red-300",children:t.jsx(rs,{size:14})})]}):t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:"flex-1 min-w-0",children:[t.jsx("div",{className:"text-sm truncate",children:E.name}),t.jsx("div",{className:"text-xs text-slate-500 flex items-center gap-2",children:t.jsxs("span",{children:[E.nodeCount," èŠ‚ç‚¹"]})})]}),t.jsx("button",{onClick:W=>{W.stopPropagation(),S(W,E.id)},className:"opacity-0 group-hover:opacity-100 p-1 rounded hover:bg-slate-700 text-slate-400 hover:text-slate-200 transition-all",children:t.jsx(fn,{size:14})})]})},E.id))})]}),$.length>0&&t.jsxs("div",{className:"px-3 py-2 border-t border-slate-800",children:[t.jsxs("div",{className:"text-xs text-slate-500 font-medium mb-2 flex items-center gap-1.5",children:[t.jsx(Qt,{size:12}),"æœ€è¿‘ç¼–è¾‘"]}),t.jsx("div",{className:"space-y-1",children:$.map(E=>t.jsx("div",{className:`flex items-center px-2 py-1.5 rounded-lg cursor-pointer transition-colors ${r===E.id?"bg-blue-600/10 text-blue-400":"hover:bg-slate-800/50 text-slate-400"}`,onClick:()=>x(E.id),children:t.jsxs("div",{className:"flex-1 min-w-0",children:[t.jsx("div",{className:"text-xs truncate",children:E.name}),t.jsx("div",{className:"text-[10px] text-slate-600",children:Wn(E.updatedAt)})]})},`recent-${E.id}`))})]})]}),t.jsxs("div",{className:"px-3 py-2 border-t border-slate-700 text-xs text-slate-500",children:["å…± ",y.length," ä¸ªé¡¹ç›®"]}),R&&t.jsxs("div",{ref:j,className:"fixed bg-slate-800 border border-slate-600 rounded-lg shadow-xl py-1 z-50 min-w-[120px]",style:{left:R.x,top:R.y},children:[t.jsxs("button",{onClick:()=>{const E=y.find(W=>W.id===R.id);E&&f(E)},className:"w-full flex items-center gap-2 px-3 py-1.5 text-sm text-slate-300 hover:bg-slate-700 transition-colors",children:[t.jsx(mn,{size:14}),"é‡å‘½å"]}),t.jsxs("button",{onClick:()=>A(R.id),className:"w-full flex items-center gap-2 px-3 py-1.5 text-sm text-red-400 hover:bg-slate-700 transition-colors",children:[t.jsx(os,{size:14}),"åˆ é™¤"]})]}),te&&t.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50",children:t.jsxs("div",{className:"bg-slate-800 border border-slate-600 rounded-lg shadow-xl p-4 max-w-sm mx-4",children:[t.jsx("h3",{className:"text-lg font-medium text-slate-200 mb-2",children:"ç¡®è®¤åˆ é™¤"}),t.jsxs("p",{className:"text-sm text-slate-400 mb-4",children:['ç¡®å®šè¦åˆ é™¤é¡¹ç›® "',(G=y.find(E=>E.id===te))==null?void 0:G.name,'" å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚']}),t.jsxs("div",{className:"flex justify-end gap-2",children:[t.jsx("button",{onClick:T,className:"px-3 py-1.5 text-sm rounded-lg bg-slate-700 hover:bg-slate-600 text-slate-300 transition-colors",children:"å–æ¶ˆ"}),t.jsx("button",{onClick:Y,className:"px-3 py-1.5 text-sm rounded-lg bg-red-600 hover:bg-red-500 text-white transition-colors",children:"åˆ é™¤"})]})]})})]})}const ke="https://dashboard.zenjoymedia.media",ss=["#1e40af","#2563eb","#3b82f6","#60a5fa","#93c5fd","#bfdbfe"],_n=y=>ss[Math.min(y,ss.length-1)],fe={feature:{label:"Feature",color:"#3b82f6",bgColor:"#3b82f620",desc:"åŠŸèƒ½æ¨¡å—"},code:{label:"Code",color:"#10b981",bgColor:"#10b98120",desc:"ä»£ç å®žçŽ°"},annotation:{label:"æ³¨é‡Š",color:"#fbbf24",bgColor:"#fbbf2415",desc:"ä¾¿ç­¾æ³¨é‡Š"},module:{label:"Module",color:"#3b82f6",bgColor:"#3b82f620",desc:"åŠŸèƒ½æ¨¡å—"},logic:{label:"Logic",color:"#8b5cf6",bgColor:"#8b5cf620",desc:"é€»è¾‘å±‚"}},Nt={rounded:{label:"åœ†è§’çŸ©å½¢",icon:"â–¢"},rect:{label:"çŸ©å½¢",icon:"â–¬"},pill:{label:"èƒ¶å›Š",icon:"â¬­"},diamond:{label:"è±å½¢",icon:"â—†"}},Ce={none:{label:"æ— ç®­å¤´",icon:"â€•"},"arrow-end":{label:"â†’",icon:"â†’"},"arrow-start":{label:"â†",icon:"â†"},"arrow-both":{label:"â†”",icon:"â†”"}},Se={solid:{label:"å®žçº¿"},dashed:{label:"è™šçº¿"}},Ae=["#3b82f6","#10b981","#f59e0b","#ef4444","#8b5cf6","#06b6d4"],ns=["#f472b6","#a78bfa","#60a5fa","#34d399","#fbbf24","#fb923c"];function Un({embedded:y=!1}){const[r,x]=o.useState([]),[m,D]=o.useState([]),[L,U]=o.useState(new Map),[_,R]=o.useState([]),[P,F]=o.useState(null),[Z,ie]=o.useState(!1),[K,te]=o.useState([]),v=K.length>0?K[K.length-1]:null,[u,j]=o.useState(new Set),[$,S]=o.useState(null),[f,M]=o.useState(null),[N,z]=o.useState(!1),[A,Y]=o.useState(null),[T,G]=o.useState(null),[E,W]=o.useState(null),[Ye,St]=o.useState(null),[ye,Be]=o.useState(null),[Ve,Mt]=o.useState({x:0,y:0}),[qe,Ze]=o.useState(new Map),[is,Et]=o.useState([]),[X,Xe]=o.useState(null),[Le,Me]=o.useState({x:0,y:0}),[ne,Je]=o.useState(null),[O,me]=o.useState(1),[ae,je]=o.useState({x:0,y:0}),[Qe,Dt]=o.useState(!1),[et,cs]=o.useState({x:0,y:0}),[tt,$t]=o.useState("rounded"),[st,ds]=o.useState(Ae[0]),[nt,hs]=o.useState("arrow-end"),[at,xs]=o.useState("solid"),[zt,Gn]=o.useState("#64748b"),[Fn,Re]=o.useState(!1),[pe,Ee]=o.useState("idle"),[lt,us]=o.useState(!1),[fs,De]=o.useState(!1),[$e,rt]=o.useState(null),[ze,ms]=o.useState([]),[ge,ot]=o.useState(-1),[ps,it]=o.useState(!1),[ct,dt]=o.useState(null),[ht,It]=o.useState(""),[xt,Tt]=o.useState(null),[Ie,gs]=o.useState({x:0,y:0,width:0,height:0}),[bs,He]=o.useState(!1),[Pt,At]=o.useState(!1),[ve,Yt]=o.useState(null),[re,we]=o.useState(new Set),[he,Xt]=o.useState("horizontal"),le=o.useRef(null),ut=o.useRef(null),We=o.useRef(null);o.useEffect(()=>{ct&&We.current&&setTimeout(()=>{var e,s;(e=We.current)==null||e.focus(),(s=We.current)==null||s.select()},0)},[ct]),o.useEffect(()=>{const e=()=>us(!!document.fullscreenElement);return document.addEventListener("fullscreenchange",e),()=>document.removeEventListener("fullscreenchange",e)},[]),o.useEffect(()=>{De(!0)},[r,m]),o.useEffect(()=>{if(ps){it(!1);return}const e=ze.slice(0,ge+1);e.push({nodes:[...r],edges:[...m]}),e.length>50&&e.shift(),ms(e),ot(e.length-1)},[r,m]);const ys=o.useCallback(()=>{!document.fullscreenElement&&ut.current?ut.current.requestFullscreen():document.fullscreenElement&&document.exitFullscreen()},[]),ce=o.useCallback((e,s)=>{if(!le.current)return{x:0,y:0};const n=le.current.getBoundingClientRect();return{x:(e-n.left-ae.x)/O,y:(s-n.top-ae.y)/O}},[ae,O]),xe=o.useCallback((e,s)=>{const n=e.x+e.width/2,a=e.y+e.height/2;switch(s){case"top":return{x:n,y:e.y};case"right":return{x:e.x+e.width,y:a};case"bottom":return{x:n,y:e.y+e.height};case"left":return{x:e.x,y:a}}},[]),Lt=o.useCallback((e,s,n)=>{const a=`node-${Date.now()}`,l={id:a,x:e??100+r.length*50%400,y:s??100+Math.floor(r.length/4)*80,width:120,height:50,name:`èŠ‚ç‚¹ ${r.length+1}`,shape:n??tt,color:st};x([...r,l]),j(new Set([a]))},[r,tt,st]),js=o.useCallback(e=>{e.preventDefault();const s=e.dataTransfer.getData("application/whiteboard-shape");if(s){const n=s,a=ce(e.clientX,e.clientY);Lt(a.x-60,a.y-25,n)}},[ce,Lt]),vs=o.useCallback(e=>{e.preventDefault(),e.dataTransfer.dropEffect="copy"},[]);o.useCallback(e=>{x(s=>s.filter(n=>n.id!==e)),D(s=>s.filter(n=>n.from!==e&&n.to!==e)),j(s=>{const n=new Set(s);return n.delete(e),n})},[]);const ft=o.useCallback(()=>{if(u.size===0)return;const e=Array.from(u);x(s=>s.filter(n=>!e.includes(n.id))),D(s=>s.filter(n=>!e.includes(n.from)&&!e.includes(n.to))),j(new Set)},[u]),Oe=o.useCallback((e,s,n,a)=>{e===n||m.some(d=>d.from===e&&d.fromAnchor===s&&d.to===n&&d.toAnchor===a)||D([...m,{id:`edge-${Date.now()}`,from:e,fromAnchor:s,to:n,toAnchor:a,lineType:nt,lineStyle:at,color:zt}])},[m,nt,at,zt]),mt=o.useCallback(e=>{D(s=>s.filter(n=>n.id!==e)),$===e&&S(null)},[$]);o.useEffect(()=>{const e=s=>{var a;const n=(a=document.activeElement)==null?void 0:a.tagName.toLowerCase();if(!(n==="input"||n==="textarea")){if((s.key==="Delete"||s.key==="Backspace")&&(u.size>0?ft():$&&mt($)),(s.metaKey||s.ctrlKey)&&s.key==="c"){if(s.preventDefault(),u.size>0){const l=r.filter(c=>u.has(c.id)),d=m.filter(c=>u.has(c.from)&&u.has(c.to));rt({nodes:l.map(c=>({...c})),edges:d.map(c=>({...c}))})}else if($){const l=m.find(d=>d.id===$);l&&rt({nodes:[],edges:[{...l}]})}}if((s.metaKey||s.ctrlKey)&&s.key==="v"&&(s.preventDefault(),$e&&$e.nodes.length>0)){const l=new Map,d=$e.nodes.map(i=>{const h=`node-${Date.now()}-${Math.random().toString(36).slice(2,6)}`;return l.set(i.id,h),{...i,id:h,x:i.x+30,y:i.y+30}}),c=$e.edges.map(i=>({...i,id:`edge-${Date.now()}-${Math.random().toString(36).slice(2,6)}`,from:l.get(i.from)||i.from,to:l.get(i.to)||i.to})).filter(i=>l.has(i.from)&&l.has(i.to));x(i=>[...i,...d]),D(i=>[...i,...c]),j(new Set(d.map(i=>i.id)))}if((s.metaKey||s.ctrlKey)&&s.key==="a"&&(s.preventDefault(),j(new Set(r.map(l=>l.id)))),s.key==="Escape"&&(j(new Set),S(null),He(!1)),(s.key==="?"||s.shiftKey&&s.key==="/")&&(s.preventDefault(),He(!0)),(s.metaKey||s.ctrlKey)&&s.key==="z"&&!s.shiftKey&&(s.preventDefault(),ge>0)){it(!0);const l=ze[ge-1];x(l.nodes),D(l.edges),ot(ge-1)}if((s.metaKey||s.ctrlKey)&&s.key==="z"&&s.shiftKey&&(s.preventDefault(),ge<ze.length-1)){it(!0);const l=ze[ge+1];x(l.nodes),D(l.edges),ot(ge+1)}}};return document.addEventListener("keydown",e),()=>document.removeEventListener("keydown",e)},[u,$,r,m,$e,ze,ge,ft,mt]);const ws=o.useCallback(e=>{$&&D(m.map(s=>s.id===$?{...s,lineType:e}:s))},[$,m]),Ns=o.useCallback(e=>{$&&D(m.map(s=>s.id===$?{...s,color:e}:s))},[$,m]),ks=o.useCallback(e=>{$&&D(m.map(s=>s.id===$?{...s,lineStyle:e}:s))},[$,m]),Rt=o.useCallback((e,s,n,a)=>{D(m.map(l=>l.id!==e?l:s==="from"?{...l,from:n,fromAnchor:a}:{...l,to:n,toAnchor:a}))},[m]),Cs=o.useCallback(()=>{confirm("ç¡®å®šæ¸…ç©ºç”»å¸ƒï¼Ÿ")&&(x([]),D([]),j(new Set),S(null))},[]),Ss=o.useCallback(e=>{r.some(n=>n.parentId===e.id)&&(St(e.id),setTimeout(()=>{St(null),te(n=>[...n,e.id]),we(n=>new Set([...n,e.id])),j(new Set),S(null),_e(!0)},300))},[r]),Ht=o.useCallback((e,s)=>{x(r.map(n=>n.id===e?{...n,name:s}:n)),dt(null)},[r]),Ms=o.useCallback((e,s)=>{if(e.button!==0)return;if(e.stopPropagation(),e.detail===2){dt(s.id),It(s.name);return}const n=ce(e.clientX,e.clientY);if(e.shiftKey){j(a=>{const l=new Set(a);return l.has(s.id)?l.delete(s.id):l.add(s.id),l}),S(null);return}if(u.has(s.id)){const a=new Map;u.forEach(l=>{const d=r.find(c=>c.id===l);d&&a.set(l,{x:n.x-d.x,y:n.y-d.y})}),Ze(a),Be(s.id),Mt({x:n.x-s.x,y:n.y-s.y})}else j(new Set([s.id])),Be(s.id),Mt({x:n.x-s.x,y:n.y-s.y}),Ze(new Map([[s.id,{x:n.x-s.x,y:n.y-s.y}]]));S(null)},[ce,u,r]),Es=o.useCallback((e,s,n)=>{e.stopPropagation(),e.preventDefault();const a=ce(e.clientX,e.clientY);Xe({nodeId:s,anchor:n}),Me(a)},[ce]),Ds=o.useCallback((e,s)=>{X&&X.nodeId!==e&&Oe(X.nodeId,X.anchor,e,s),Xe(null)},[X,Oe]),$s=o.useCallback(e=>{const s=e.target;if(!(s.tagName!=="rect"&&s.tagName!=="svg")){if(X){Xe(null);return}if(e.button===1||e.altKey){Dt(!0),cs({x:e.clientX-ae.x,y:e.clientY-ae.y});return}if(e.button===0){const n=ce(e.clientX,e.clientY);e.shiftKey||j(new Set),S(null),z(!0),M({startX:n.x,startY:n.y,endX:n.x,endY:n.y})}}},[X,ae,ce]),pt=o.useCallback((e,s)=>{let a=null;for(const l of r)if(l.id!==s)for(const d of["top","right","bottom","left"]){const c=xe(l,d),i=Math.sqrt((c.x-e.x)**2+(c.y-e.y)**2);i<35&&(!a||i<a.dist)&&(a={nodeId:l.id,anchor:d,dist:i})}return a},[r,xe]),zs=o.useCallback(e=>{const s=ce(e.clientX,e.clientY);if(N&&f){M({...f,endX:s.x,endY:s.y});return}if(X){Me(s);const n=pt(s,X.nodeId);G(n?{nodeId:n.nodeId,anchor:n.anchor}:null)}if(ne){Me(s);const n=m.find(a=>a.id===ne.edgeId);if(n){const a=ne.end==="from"?n.to:n.from,l=pt(s,a);G(l?{nodeId:l.nodeId,anchor:l.anchor}:null)}}if(xt){const n=(e.clientX-Ie.x)/O,a=(e.clientY-Ie.y)/O,l=Math.max(60,Ie.width+n),d=Math.max(30,Ie.height+a);x(r.map(c=>c.id===xt.nodeId?{...c,width:l,height:d}:c))}if(Qe)je({x:e.clientX-et.x,y:e.clientY-et.y});else if(ye){const n=r.find(c=>c.id===ye);if(!n)return;let a=s.x-Ve.x,l=s.y-Ve.y;a-n.x,l-n.y;const d=[];if(u.size===1){const i=a+n.width/2,h=l+n.height/2,p=a+n.width,I=l+n.height;for(const k of r){if(u.has(k.id))continue;const b=k.x+k.width/2,g=k.y+k.height/2,w=k.x+k.width,C=k.y+k.height;Math.abs(i-b)<8?(a=b-n.width/2,d.push({type:"v",pos:b})):Math.abs(a-k.x)<8?(a=k.x,d.push({type:"v",pos:k.x})):Math.abs(p-w)<8&&(a=w-n.width,d.push({type:"v",pos:w})),Math.abs(h-g)<8?(l=g-n.height/2,d.push({type:"h",pos:g})):Math.abs(l-k.y)<8?(l=k.y,d.push({type:"h",pos:k.y})):Math.abs(I-C)<8&&(l=C-n.height,d.push({type:"h",pos:C}))}}Et(d),u.size>1&&qe.size>0?x(r.map(c=>{if(u.has(c.id)){const i=qe.get(c.id);if(i)return{...c,x:s.x-i.x,y:s.y-i.y}}return c})):x(r.map(c=>c.id===ye?{...c,x:a,y:l}:c))}},[X,ne,m,Qe,et,ye,Ve,ce,r,pt,xt,Ie,O,N,f,u,qe]),Wt=o.useCallback(()=>{if(Dt(!1),Be(null),Et([]),Tt(null),Ze(new Map),N&&f){const e=Math.min(f.startX,f.endX),s=Math.max(f.startX,f.endX),n=Math.min(f.startY,f.endY),a=Math.max(f.startY,f.endY),l=new Set;r.forEach(d=>{const c=d.x+d.width/2,i=d.y+d.height/2;c>=e&&c<=s&&i>=n&&i<=a&&l.add(d.id)}),j(d=>{const c=new Set(d);return l.forEach(i=>c.add(i)),c}),z(!1),M(null)}if(X&&(T&&T.nodeId!==X.nodeId&&Oe(X.nodeId,X.anchor,T.nodeId,T.anchor),Xe(null),G(null)),ne){if(T){const e=m.find(s=>s.id===ne.edgeId);if(e){const s=ne.end==="from"?e.to:e.from;T.nodeId!==s&&Rt(ne.edgeId,ne.end,T.nodeId,T.anchor)}}Je(null),G(null)}},[X,T,Oe,ne,m,Rt,N,f,r]),Is=o.useCallback(e=>{if(e.metaKey||e.ctrlKey){e.preventDefault();const s=e.deltaY>0?.95:1.05;me(n=>Math.min(3,Math.max(.3,n*s)))}else e.preventDefault(),je(s=>({x:s.x-e.deltaX,y:s.y-e.deltaY}))},[]),Ts=(e,s,n,a)=>{const{width:l,height:d,shape:c}=e,i=a||e.color||"#3b82f6",h=`${i}20`,p=s?"#fbbf24":n?"#60a5fa":i,I=s?2.5:n?2:1.5;if(e.layerType==="annotation"){const k="#fbbf24",b="rgba(251, 191, 36, 0.08)",g=s?"#fbbf24":n?"#fcd34d":"rgba(251, 191, 36, 0.4)",w=e.attachPosition||"top-left";let C="";return w==="top-right"||w==="bottom-right"?C=`-8,${d/2-6} 0,${d/2} -8,${d/2+6}`:C=`${l+8},${d/2-6} ${l},${d/2} ${l+8},${d/2+6}`,t.jsxs("g",{children:[t.jsx("rect",{width:l,height:d,rx:6,fill:b,stroke:g,strokeWidth:s?2:1,strokeDasharray:s?void 0:"4 2"}),e.attachedTo&&t.jsx("polygon",{points:C,fill:b,stroke:g,strokeWidth:1,strokeDasharray:"4 2"}),t.jsx("text",{x:6,y:14,fontSize:10,fill:k,style:{pointerEvents:"none"},children:"ðŸ“"})]})}switch(c){case"rect":return t.jsx("rect",{width:l,height:d,fill:h,stroke:p,strokeWidth:I});case"rounded":return t.jsx("rect",{width:l,height:d,rx:8,fill:h,stroke:p,strokeWidth:I});case"pill":return t.jsx("rect",{width:l,height:d,rx:d/2,fill:h,stroke:p,strokeWidth:I});case"diamond":return t.jsx("polygon",{points:`${l/2},0 ${l},${d/2} ${l/2},${d} 0,${d/2}`,fill:h,stroke:p,strokeWidth:I})}},Ps=e=>{const s=["top","right","bottom","left"];return A===e.id||u.has(e.id)||X!==null||ne!==null?s.map(a=>{const l=xe(e,a),d=l.x-e.x,c=l.y-e.y,i=(T==null?void 0:T.nodeId)===e.id&&(T==null?void 0:T.anchor)===a,h=(X==null?void 0:X.nodeId)===e.id&&(X==null?void 0:X.anchor)===a,p=X&&X.nodeId!==e.id;return t.jsx("circle",{cx:d,cy:c,r:i||h?7:5,fill:h?"#10b981":i?"#60a5fa":p?"#94a3b8":"#64748b",stroke:"#1e293b",strokeWidth:2,style:{cursor:"crosshair"},onMouseDown:I=>Es(I,e.id,a),onMouseUp:()=>Ds(e.id,a),onMouseEnter:()=>G({nodeId:e.id,anchor:a}),onMouseLeave:()=>G(null)},a)}):null},As=e=>{const s=r.find(V=>V.id===e.from),n=r.find(V=>V.id===e.to);if(!s||!n)return null;const a=xe(s,e.fromAnchor),l=xe(n,e.toAnchor),d=l.x-a.x,c=l.y-a.y,i=Math.min(Math.abs(d),Math.abs(c),60)+30;let h=a.x,p=a.y,I=l.x,k=l.y;switch(e.fromAnchor){case"top":p-=i;break;case"right":h+=i;break;case"bottom":p+=i;break;case"left":h-=i;break}switch(e.toAnchor){case"top":k-=i;break;case"right":I+=i;break;case"bottom":k+=i;break;case"left":I-=i;break}const b=`M ${a.x} ${a.y} C ${h} ${p}, ${I} ${k}, ${l.x} ${l.y}`,g=$===e.id,w=e.lineType||"arrow-end",B=(e.lineStyle||"solid")==="dashed"?"6 4":void 0,H=(e.color||"#64748b").slice(1);let q,se;switch(w){case"arrow-end":q=`url(#arrowhead-${H})`;break;case"arrow-start":se=`url(#arrowhead-start-${H})`;break;case"arrow-both":q=`url(#arrowhead-${H})`,se=`url(#arrowhead-start-${H})`;break}return t.jsxs("g",{children:[t.jsx("path",{d:b,fill:"none",stroke:"transparent",strokeWidth:12,style:{cursor:"pointer"},onClick:()=>{S(e.id),j(new Set)}}),t.jsx("path",{d:b,fill:"none",stroke:g?"#ef4444":e.color||"#64748b",strokeWidth:g?2.5:2,strokeDasharray:B,markerEnd:q,markerStart:se,pointerEvents:"none"}),g&&t.jsxs(t.Fragment,{children:[t.jsx("circle",{cx:a.x,cy:a.y,r:8,fill:"#ef4444",stroke:"#fff",strokeWidth:2,style:{cursor:"grab"},onMouseDown:V=>{V.stopPropagation(),Je({edgeId:e.id,end:"from"}),Me(a)}}),t.jsx("circle",{cx:l.x,cy:l.y,r:8,fill:"#ef4444",stroke:"#fff",strokeWidth:2,style:{cursor:"grab"},onMouseDown:V=>{V.stopPropagation(),Je({edgeId:e.id,end:"to"}),Me(l)}})]})]},e.id)},Ys=()=>{if(!X)return null;const e=r.find(l=>l.id===X.nodeId);if(!e)return null;const s=xe(e,X.anchor);let n=Le.x,a=Le.y;if(T&&T.nodeId!==X.nodeId){const l=r.find(d=>d.id===T.nodeId);if(l){const d=xe(l,T.anchor);n=d.x,a=d.y}}return t.jsx("line",{x1:s.x,y1:s.y,x2:n,y2:a,stroke:"#10b981",strokeWidth:2,strokeDasharray:"8 4",pointerEvents:"none"})},Xs=()=>{if(!ne)return null;const e=m.find(h=>h.id===ne.edgeId);if(!e)return null;const s=ne.end==="from"?"to":"from",n=s==="from"?e.from:e.to,a=s==="from"?e.fromAnchor:e.toAnchor,l=r.find(h=>h.id===n);if(!l)return null;const d=xe(l,a);let c=Le.x,i=Le.y;if(T){const h=r.find(p=>p.id===T.nodeId);if(h){const p=xe(h,T.anchor);c=p.x,i=p.y}}return t.jsx("line",{x1:d.x,y1:d.y,x2:c,y2:i,stroke:"#f59e0b",strokeWidth:2,strokeDasharray:"8 4",pointerEvents:"none"})},de=o.useCallback(async()=>{try{const s=await(await fetch(`${ke}/api/v1/panorama/projects`)).json();s.projects&&R(s.projects)}catch{}},[]),[Ot,_e]=o.useState(!1),[_t,Gt]=o.useState(!1),gt=o.useCallback(async e=>{try{Re(!0);const n=await(await fetch(`${ke}/api/v1/panorama/projects/${e}`)).json();if(n.project){const a=n.project;x(a.nodes||[]),D(a.edges||[]),F(e),te([]),we(new Set),De(!1),_e(!0)}}catch{}finally{Re(!1)}},[]),Ls=o.useCallback(async()=>{if(P)try{Ee("saving"),Re(!0),await fetch(`${ke}/api/v1/panorama/projects/${P}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({nodes:r,edges:m})}),Ee("saved"),De(!1),de(),setTimeout(()=>Ee("idle"),2e3)}catch{Ee("error"),setTimeout(()=>Ee("idle"),2e3)}finally{Re(!1)}},[P,r,m,de]),Rs=o.useCallback(async()=>{try{const s=await(await fetch(`${ke}/api/v1/panorama/projects`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:`æ–°é¡¹ç›® ${_.length+1}`})})).json();s.project&&(await de(),gt(s.project.id))}catch{}},[_.length,de,gt]),Hs=o.useCallback(async e=>{try{await fetch(`${ke}/api/v1/panorama/projects/${e}`,{method:"DELETE"}),await de(),P===e&&(F(null),x([]),D([]))}catch{}},[P,de]),Ws=o.useCallback(async(e,s)=>{try{await fetch(`${ke}/api/v1/panorama/projects/${e}/name`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:s})}),await de()}catch{}},[de]);o.useEffect(()=>{de()},[de]),o.useEffect(()=>{if(Ot&&r.length>0){_e(!1);const e=new Set;r.forEach(b=>{r.some(g=>g.parentId===b.id)&&e.add(b.id)}),we(e);const s=he==="horizontal",n=s?200:100,a=s?30:40,l=50,d=150,c=80,i=80,h=[],p=b=>{const g=s?l:d;if(!e.has(b))return g;const w=r.filter(B=>B.parentId===b);if(w.length===0)return g;const C=w.reduce((B,H)=>B+p(H.id)+a,-a);return Math.max(g,C)},I=(b,g,w,C)=>{if(!r.find(se=>se.id===b))return;const q=w+(C-(s?l:d))/2;if(s?h.push({id:b,x:g,y:q}):h.push({id:b,x:q,y:g}),e.has(b)){const se=r.filter(V=>V.parentId===b);if(se.length>0){const V=g+(s?d:l)+n;let ue=w;se.forEach(be=>{const Pe=p(be.id);I(be.id,V,ue,Pe),ue+=Pe+a})}}},k=v;if(k){const b=p(k);I(k,c,i,b)}else{const b=r.filter(w=>!w.parentId);if(b.length===0)return;let g=i;b.forEach(w=>{const C=p(w.id);I(w.id,c,g,C),g+=C+a*2})}h.length>0&&(x(b=>b.map(g=>{const w=h.find(C=>C.id===g.id);return w?{...g,x:w.x,y:w.y}:g})),setTimeout(()=>Gt(!0),50))}},[Ot,r,v,he]);const Ft=o.useCallback(()=>{if(r.length===0||!le.current)return;const e=Math.min(...r.map(H=>H.x)),s=Math.min(...r.map(H=>H.y)),n=Math.max(...r.map(H=>H.x+H.width)),a=Math.max(...r.map(H=>H.y+H.height)),l=n-e,d=a-s,c=le.current.getBoundingClientRect(),i=c.width,h=c.height,p=40,I=(i-p*2)/l,k=(h-p*2)/d,b=Math.min(Math.max(I,k,.8),1.2),g=(e+n)/2,w=(s+a)/2,C=i/2-g*b,B=h/2-w*b;me(b),je({x:C,y:B})},[r]);o.useEffect(()=>{_t&&(Gt(!1),Ft())},[_t,Ft]),o.useEffect(()=>{if(!le.current||r.length===0)return;let e=0;const s=new ResizeObserver(n=>{const a=n[0];if(!a)return;const l=a.contentRect.width;if(e&&Math.abs(l-e)>10){const d=l-e;je(c=>({...c,x:c.x+d/2}))}e=l});return s.observe(le.current),()=>s.disconnect()},[r.length]);const Os=o.useCallback(e=>{u.size!==0&&x(r.map(s=>u.has(s.id)?{...s,color:e}:s))},[u,r]),J=o.useCallback(()=>r.filter(e=>u.has(e.id)),[r,u]),_s=o.useCallback(()=>{const e=J();if(e.length<2)return;const s=Math.min(...e.map(n=>n.x));x(r.map(n=>u.has(n.id)?{...n,x:s}:n))},[J,r,u]),Gs=o.useCallback(()=>{const e=J();if(e.length<2)return;const s=e.reduce((n,a)=>n+a.x+a.width/2,0)/e.length;x(r.map(n=>u.has(n.id)?{...n,x:s-n.width/2}:n))},[J,r,u]),Fs=o.useCallback(()=>{const e=J();if(e.length<2)return;const s=Math.max(...e.map(n=>n.x+n.width));x(r.map(n=>u.has(n.id)?{...n,x:s-n.width}:n))},[J,r,u]),Ks=o.useCallback(()=>{const e=J();if(e.length<2)return;const s=Math.min(...e.map(n=>n.y));x(r.map(n=>u.has(n.id)?{...n,y:s}:n))},[J,r,u]),Us=o.useCallback(()=>{const e=J();if(e.length<2)return;const s=e.reduce((n,a)=>n+a.y+a.height/2,0)/e.length;x(r.map(n=>u.has(n.id)?{...n,y:s-n.height/2}:n))},[J,r,u]),Bs=o.useCallback(()=>{const e=J();if(e.length<2)return;const s=Math.max(...e.map(n=>n.y+n.height));x(r.map(n=>u.has(n.id)?{...n,y:s-n.height}:n))},[J,r,u]),Vs=o.useCallback(()=>{const e=J();if(e.length<3)return;const s=[...e].sort((h,p)=>h.x-p.x),n=s[0].x,a=s[s.length-1].x+s[s.length-1].width,l=s.reduce((h,p)=>h+p.width,0),d=(a-n-l)/(s.length-1);let c=n;const i=new Map;s.forEach((h,p)=>{i.set(h.id,c),c+=h.width+d}),x(r.map(h=>{const p=i.get(h.id);return p!==void 0?{...h,x:p}:h}))},[J,r]),qs=o.useCallback(()=>{const e=J();if(e.length<3)return;const s=[...e].sort((h,p)=>h.y-p.y),n=s[0].y,a=s[s.length-1].y+s[s.length-1].height,l=s.reduce((h,p)=>h+p.height,0),d=(a-n-l)/(s.length-1);let c=n;const i=new Map;s.forEach((h,p)=>{i.set(h.id,c),c+=h.height+d}),x(r.map(h=>{const p=i.get(h.id);return p!==void 0?{...h,y:p}:h}))},[J,r]),Zs=o.useCallback(()=>{if(u.size<2)return;const e=`group-${Date.now()}`,s=ns[L.size%ns.length],n=`Group ${L.size+1}`;U(a=>{const l=new Map(a);return l.set(e,{name:n,color:s}),l}),x(r.map(a=>u.has(a.id)?{...a,groupId:e}:a))},[u,r,L.size]),Js=o.useCallback(e=>{x(r.map(s=>s.groupId===e?{...s,groupId:void 0}:s)),U(s=>{const n=new Map(s);return n.delete(e),n})},[r]),Qs=o.useCallback(e=>{const s=r.filter(n=>n.groupId===e).map(n=>n.id);j(new Set(s))},[r]),en=o.useCallback(()=>{if(u.size===0)return null;const e=r.filter(n=>u.has(n.id));if(new Set(e.map(n=>n.groupId).filter(Boolean)).size===1){const n=e[0].groupId,a=r.filter(l=>l.groupId===n);if(a.length===e.length&&a.every(l=>u.has(l.id)))return n||null}return null},[u,r]),bt=o.useCallback(e=>{if(v&&e.id===v||(e.parentId||null)===v)return!0;const s=[];let n=e.parentId;for(;n;){s.unshift(n);const l=r.find(d=>d.id===n);if(!l)break;n=l.parentId}let a=!1;for(const l of s){const d=r.find(c=>c.id===l);if(!d||((d.parentId||null)===v&&(a=!0),a&&!re.has(l)))return!1}return a},[r,v,re]),Q=r.filter(bt),Ge=m.filter(e=>{if(v&&e.to===v)return!1;const s=r.find(a=>a.id===e.from),n=r.find(a=>a.id===e.to);return s&&n&&bt(s)&&bt(n)}),yt=o.useCallback(e=>{let s=0,n=r.find(a=>a.id===e);for(;n!=null&&n.parentId;)s++,n=r.find(a=>a.id===n.parentId);return s},[r]),ee=o.useCallback(e=>{if(e.layerType==="code")return fe.code.color;if(e.layerType==="feature"||e.layerType==="module"||e.layerType==="logic"){const s=yt(e.id);return _n(s)}return e.color||"#3b82f6"},[yt]),Kt=o.useCallback(e=>{const s=he==="horizontal",n=s?200:100,a=s?30:40,l=50,d=150,c=80,i=80,h=[],p=g=>{const w=s?l:d;if(!e.has(g))return w;const C=r.filter(H=>H.parentId===g);if(C.length===0)return w;const B=C.reduce((H,q)=>H+p(q.id)+a,-a);return Math.max(w,B)},I=(g,w,C,B)=>{if(!r.find(V=>V.id===g))return;const se=C+(B-(s?l:d))/2;if(s?h.push({id:g,x:w,y:se}):h.push({id:g,x:se,y:w}),e.has(g)){const V=r.filter(ue=>ue.parentId===g);if(V.length>0){const ue=w+(s?d:l)+n;let be=C;V.forEach(Pe=>{const Zt=p(Pe.id);I(Pe.id,ue,be,Zt),be+=Zt+a})}}};if(v&&r.find(w=>w.id===v)){const w=p(v);return I(v,c,i,w),h}const k=r.filter(g=>(g.parentId||null)===v);if(k.length===0)return[];let b=i;return k.forEach(g=>{const w=p(g.id);I(g.id,c,b,w),b+=w+a*2}),h},[r,v,he]),Ne=o.useCallback(e=>{const s=Kt(e);s.length>0&&x(n=>n.map(a=>{const l=s.find(d=>d.id===a.id);return l?{...a,x:l.x,y:l.y}:a}))},[Kt]),Ut=o.useCallback(e=>{const s=re.has(e),n=new Set(re);if(s){n.delete(e);const a=l=>{r.filter(d=>d.parentId===l).forEach(d=>{n.delete(d.id),a(d.id)})};a(e)}else n.add(e);we(n),setTimeout(()=>Ne(n),0)},[r,re,Ne]),tn=o.useCallback(()=>{const e=new Set;r.forEach(s=>{r.some(n=>n.parentId===s.id)&&e.add(s.id)}),we(e),setTimeout(()=>Ne(e),0)},[r,Ne]),sn=o.useCallback(()=>{we(new Set),setTimeout(()=>Ne(new Set),0)},[Ne]),Bt=o.useCallback(e=>{r.filter(n=>n.parentId===e).length>0&&(te([...K,e]),we(n=>new Set([...n,e])),j(new Set),S(null),_e(!0))},[r,K]),nn=o.useCallback(()=>{K.length>0&&(te(K.slice(0,-1)),j(new Set),S(null))},[K]),Vt=o.useCallback(e=>{te(K.slice(0,e)),j(new Set),S(null)},[K]),an=o.useCallback(e=>{const s=[];let n=r.find(a=>a.id===e);for(;n;)s.unshift(n),n=n.parentId?r.find(a=>a.id===n.parentId):void 0;return s},[r]),qt=o.useCallback(e=>r.some(s=>s.parentId===e),[r]),jt=o.useCallback(e=>{Yt(e),At(!0)},[]),ln=o.useCallback(()=>{At(!1),Yt(null)},[]),rn=o.useCallback((e,s)=>{x(r.map(n=>n.id===e?{...n,description:s}:n))},[r]),vt=o.useCallback(e=>r.filter(s=>s.parentId===e),[r]),on=o.useCallback(e=>{const s=r.find(d=>d.id===e);if(!s)return;const n=vt(e),a=`node-${Date.now()}`,l={id:a,x:s.x+s.width+80,y:s.y+n.length*70,width:120,height:50,name:`å­èŠ‚ç‚¹ ${n.length+1}`,shape:s.shape,color:s.color,parentId:e};x([...r,l]),D([...m,{id:`edge-${Date.now()}`,from:e,fromAnchor:"right",to:a,toAnchor:"left",lineType:"arrow-end",lineStyle:"solid",color:s.color}])},[r,m,vt]),Te=o.useCallback(()=>{if(r.length===0)return;const e=he==="horizontal",s=e?200:100,n=e?40:50,a=55,l=150,d=80,c=80,i=new Map,h=new Set;r.forEach(k=>{r.some(b=>b.parentId===k.id)&&h.add(k.id)});const p=k=>{const b=e?a:l;if(!h.has(k))return b;const g=r.filter(C=>C.parentId===k);if(g.length===0)return b;const w=g.reduce((C,B)=>C+p(B.id)+n,-n);return Math.max(b,w)},I=(k,b,g,w)=>{if(!r.find(q=>q.id===k))return;const H=g+(w-(e?a:l))/2;if(e?i.set(k,{x:b,y:H}):i.set(k,{x:H,y:b}),h.has(k)){const q=r.filter(se=>se.parentId===k);if(q.length>0){const se=b+(e?l:a)+s;let V=g;q.forEach(ue=>{const be=p(ue.id);I(ue.id,se,V,be),V+=be+n})}}};if(v){const k=p(v);I(v,d,c,k)}else{const k=r.filter(g=>!g.parentId);let b=c;k.forEach(g=>{const w=p(g.id);I(g.id,d,b,w),b+=w+n*2})}x(k=>k.map(b=>{const g=i.get(b.id);return g?{...b,x:g.x,y:g.y}:b})),je({x:0,y:0}),me(1)},[r,v,he]);o.useCallback(()=>{if(!v)return;const e=n=>{const a=r.filter(d=>d.parentId===n),l=[...a];return a.forEach(d=>{l.push(...e(d.id))}),l},s=e(v);s.length!==0&&(x(r.map(n=>s.some(a=>a.id===n.id)?{...n,parentId:v}:n)),setTimeout(()=>Te(),100))},[v,r,Te]),o.useCallback(()=>{if(Q.length===0)return;const e=Q.map(a=>({id:a.id,x:a.x,y:a.y,width:a.width,height:a.height})),s=Ge.map(a=>({from:a.from,to:a.to})),n=Ln(e,s,{startX:400,startY:300});x(r.map(a=>{const l=n.find(d=>d.id===a.id);return l?{...a,x:l.x,y:l.y}:a}))},[Q,Ge,r]),o.useCallback(()=>{if(Q.length===0)return;const e=Q.map(n=>({id:n.id,x:n.x,y:n.y,width:n.width,height:n.height})),s=Rn(e,{startX:100,startY:100,nodeSpacingH:50,nodeSpacingV:50});x(r.map(n=>{const a=s.find(l=>l.id===n.id);return a?{...n,x:a.x,y:a.y}:n}))},[Q,r]),o.useCallback(()=>{if(Q.length===0)return;const e=Q.map(n=>({id:n.id,x:n.x,y:n.y,width:n.width,height:n.height})),s=Hn(e,{startX:400,startY:300});x(r.map(n=>{const a=s.find(l=>l.id===n.id);return a?{...n,x:a.x,y:a.y}:n}))},[Q,r]);const cn=o.useCallback((e,s)=>{je({x:-e*O,y:-s*O})},[O]),dn=o.useCallback(()=>{if(!le.current)return{x:0,y:0,width:800,height:600};const e=le.current.getBoundingClientRect();return{x:-ae.x/O,y:-ae.y/O,width:e.width/O,height:e.height/O}},[ae,O]),hn=o.useCallback(()=>{const e=_.find(d=>d.id===P),s={title:(e==null?void 0:e.name)||"ç™½æ¿",nodes:r.map(d=>({...d})),edges:m.map(d=>({...d})),exportedAt:new Date().toISOString()},n=new Blob([JSON.stringify(s,null,2)],{type:"application/json"}),a=URL.createObjectURL(n),l=document.createElement("a");l.href=a,l.download=`whiteboard-${Date.now()}.json`,l.click(),URL.revokeObjectURL(a)},[r,m,_,P]),xn=o.useCallback(async()=>{if(!le.current||r.length===0)return;const e=40,s=Math.min(...r.map(C=>C.x))-e,n=Math.min(...r.map(C=>C.y))-e,a=Math.max(...r.map(C=>C.x+C.width))+e,l=Math.max(...r.map(C=>C.y+C.height))+e,d=a-s,c=l-n,i="http://www.w3.org/2000/svg",h=document.createElementNS(i,"svg");h.setAttribute("width",String(d)),h.setAttribute("height",String(c)),h.setAttribute("viewBox",`${s} ${n} ${d} ${c}`);const p=document.createElementNS(i,"rect");p.setAttribute("x",String(s)),p.setAttribute("y",String(n)),p.setAttribute("width",String(d)),p.setAttribute("height",String(c)),p.setAttribute("fill","#0f172a"),h.appendChild(p);const I=le.current.querySelector("g[transform]");if(I){const C=I.cloneNode(!0);C.setAttribute("transform",""),h.appendChild(C)}const k=new XMLSerializer().serializeToString(h),b=new Blob([k],{type:"image/svg+xml;charset=utf-8"}),g=URL.createObjectURL(b),w=new window.Image;w.onload=()=>{const C=document.createElement("canvas");C.width=d*2,C.height=c*2;const B=C.getContext("2d");B&&(B.scale(2,2),B.drawImage(w,0,0),C.toBlob(H=>{if(H){const q=document.createElement("a");q.href=URL.createObjectURL(H),q.download=`whiteboard-${Date.now()}.png`,q.click()}},"image/png")),URL.revokeObjectURL(g)},w.src=g},[r]);return t.jsxs("div",{ref:ut,className:`flex relative bg-slate-900 ${y?"h-full w-full":"h-screen"} ${lt?"fixed inset-0 z-50":""}`,children:[t.jsx(On,{projects:_,currentProjectId:P,onSelectProject:gt,onCreateProject:Rs,onDeleteProject:Hs,onRenameProject:Ws,isCollapsed:Z,onToggleCollapse:()=>ie(!Z)}),t.jsx("div",{className:"flex-1 flex min-w-0 h-full overflow-hidden",children:t.jsxs("div",{className:"flex-1 flex flex-col min-w-0 h-full",children:[t.jsxs("div",{className:`h-12 flex-shrink-0 flex items-center gap-1 px-2 border-b border-indigo-500/20 min-w-0 relative z-30 ${y?"bg-slate-900/40 backdrop-blur-sm":"bg-slate-900/40"}`,children:[K.length>0&&t.jsxs("div",{className:"flex items-center gap-1 mr-2",children:[t.jsx("button",{onClick:nn,className:"flex items-center gap-1 px-2 py-1 text-xs text-slate-300 bg-slate-900/60 border border-indigo-500/30 rounded hover:bg-indigo-500/20",children:"â† è¿”å›ž"}),t.jsxs("div",{className:"flex items-center gap-1 text-xs text-slate-400",children:[t.jsx("button",{onClick:()=>Vt(0),className:"hover:text-slate-200",children:"æ ¹"}),K.map((e,s)=>{const n=r.find(a=>a.id===e);return t.jsxs(wt.Fragment,{children:[t.jsx(Ue,{className:"w-3 h-3"}),t.jsx("button",{onClick:()=>Vt(s+1),className:"hover:text-slate-200 max-w-[80px] truncate",title:n==null?void 0:n.name,children:(n==null?void 0:n.name)||e})]},e)})]}),t.jsx("div",{className:"w-px h-6 bg-slate-700/50 ml-2"})]}),t.jsx("div",{className:"flex items-center gap-0.5 p-0.5 bg-slate-900/60 border border-indigo-500/30 rounded-lg min-w-0 overflow-hidden",children:Object.keys(Nt).map(e=>t.jsx("div",{draggable:!0,onDragStart:s=>{$t(e),s.dataTransfer.setData("application/whiteboard-shape",e),s.dataTransfer.effectAllowed="copy"},onClick:()=>$t(e),className:`w-8 h-8 flex items-center justify-center text-base rounded cursor-grab active:cursor-grabbing transition-all ${tt===e?"bg-blue-500/20 text-blue-300":"text-slate-400 hover:text-slate-200 hover:bg-slate-700/50"}`,title:`${Nt[e].label} - æ‹–åˆ°ç”»å¸ƒ`,children:Nt[e].icon},e))}),t.jsx("div",{className:"flex items-center gap-0.5 p-0.5 bg-slate-900/60 border border-indigo-500/30 rounded-lg min-w-0 overflow-hidden",children:Ae.map(e=>t.jsx("button",{onClick:()=>ds(e),className:`w-6 h-6 rounded-full border-2 transition-all ${st===e?"border-white scale-110":"border-transparent hover:scale-105"}`,style:{backgroundColor:e}},e))}),t.jsx("div",{className:"w-px h-5 bg-slate-700/50"}),t.jsx("div",{className:"flex items-center gap-0.5 p-0.5 bg-slate-900/60 border border-indigo-500/30 rounded-lg",children:Object.keys(Ce).map(e=>t.jsx("button",{onClick:()=>hs(e),className:`w-8 h-8 flex items-center justify-center text-base rounded transition-all ${nt===e?"bg-blue-500/20 text-blue-300":"text-slate-400 hover:text-slate-200 hover:bg-slate-700/50"}`,title:Ce[e].label,children:Ce[e].icon},e))}),t.jsx("div",{className:"flex items-center gap-0.5 p-0.5 bg-slate-900/60 border border-indigo-500/30 rounded-lg",children:Object.keys(Se).map(e=>t.jsx("button",{onClick:()=>xs(e),className:`px-2 h-8 flex items-center justify-center text-xs rounded transition-all ${at===e?"bg-blue-500/20 text-blue-300":"text-slate-400 hover:text-slate-200 hover:bg-slate-700/50"}`,title:Se[e].label,children:Se[e].label},e))}),t.jsx("div",{className:"flex-1"}),t.jsxs("div",{className:"flex items-center gap-1 px-1.5 py-0.5 bg-slate-900/60 border border-indigo-500/30 rounded-lg",children:[t.jsx("button",{onClick:()=>me(e=>Math.max(.3,e*.8)),className:"p-1 text-slate-400 hover:text-slate-200",children:t.jsx(es,{className:"w-4 h-4"})}),t.jsxs("span",{className:"text-xs text-slate-400 w-10 text-center",children:[Math.round(O*100),"%"]}),t.jsx("button",{onClick:()=>me(e=>Math.min(3,e*1.25)),className:"p-1 text-slate-400 hover:text-slate-200",children:t.jsx(ts,{className:"w-4 h-4"})})]}),r.length>0&&t.jsx("button",{onClick:Cs,className:"px-2 py-1 text-xs text-red-400 bg-slate-800/50 border border-slate-700/50 rounded hover:bg-red-500/10",children:"æ¸…ç©º"}),t.jsxs("div",{className:"flex items-center gap-0.5 p-0.5 bg-slate-900/60 border border-indigo-500/30 rounded-lg",children:[t.jsx("button",{onClick:xn,disabled:r.length===0,className:"p-1.5 text-slate-400 hover:text-slate-200 disabled:opacity-30",title:"å¯¼å‡º PNG",children:t.jsx(pn,{className:"w-4 h-4"})}),t.jsx("button",{onClick:hn,disabled:r.length===0,className:"p-1.5 text-slate-400 hover:text-slate-200 disabled:opacity-30",title:"å¯¼å‡º JSON",children:t.jsx(gn,{className:"w-4 h-4"})})]}),t.jsxs("div",{className:"flex-shrink-0 flex items-center gap-1 bg-slate-800/50 border border-slate-700/50 rounded-lg p-0.5",children:[t.jsx("button",{onClick:()=>{Xt("horizontal"),setTimeout(Te,50)},className:`px-2 py-1 text-xs rounded transition-colors ${he==="horizontal"?"bg-blue-600 text-white":"text-slate-400 hover:text-slate-200"}`,title:"æ°´å¹³å¸ƒå±€ï¼šçˆ¶â†’å­ä»Žå·¦åˆ°å³",children:"å·¦â†’å³"}),t.jsx("button",{onClick:()=>{Xt("vertical"),setTimeout(Te,50)},className:`px-2 py-1 text-xs rounded transition-colors ${he==="vertical"?"bg-blue-600 text-white":"text-slate-400 hover:text-slate-200"}`,title:"åž‚ç›´å¸ƒå±€ï¼šçˆ¶â†’å­ä»Žä¸Šåˆ°ä¸‹",children:"ä¸Šâ†’ä¸‹"}),t.jsx("div",{className:"w-px h-4 bg-slate-600"}),t.jsx("button",{onClick:Te,disabled:Q.length===0,className:"px-2 py-1 text-xs text-green-400 hover:bg-green-500/20 rounded disabled:opacity-30",title:"é‡æ–°æ•´ç†å¸ƒå±€",children:"æ•´ç†"})]}),t.jsxs("div",{className:"flex-shrink-0 flex items-center gap-1 bg-slate-800/50 border border-slate-700/50 rounded-lg p-0.5",children:[t.jsx("button",{onClick:tn,disabled:Q.length===0,className:"px-2 py-1 text-xs text-green-400 hover:bg-green-500/20 rounded disabled:opacity-30",title:"å±•å¼€æ‰€æœ‰å­èŠ‚ç‚¹",children:"å±•å¼€"}),t.jsx("div",{className:"w-px h-4 bg-slate-600"}),t.jsx("button",{onClick:sn,disabled:re.size===0,className:"px-2 py-1 text-xs text-orange-400 hover:bg-orange-500/20 rounded disabled:opacity-30",title:"æ”¶èµ·æ‰€æœ‰å­èŠ‚ç‚¹",children:"æ”¶èµ·"})]}),t.jsxs("div",{className:"flex items-center gap-1 px-2 py-1 bg-slate-900/60 border border-indigo-500/30 rounded-lg",children:[t.jsx("button",{onClick:()=>me(e=>Math.max(.3,e*.8)),className:"p-1 text-slate-400 hover:text-slate-200",title:"ç¼©å°",children:t.jsx(es,{className:"w-4 h-4"})}),t.jsxs("span",{className:"text-xs text-slate-400 w-12 text-center",children:[Math.round(O*100),"%"]}),t.jsx("button",{onClick:()=>me(e=>Math.min(3,e*1.25)),className:"p-1 text-slate-400 hover:text-slate-200",title:"æ”¾å¤§",children:t.jsx(ts,{className:"w-4 h-4"})}),t.jsx("div",{className:"w-px h-4 bg-slate-700 mx-1"}),t.jsx("button",{onClick:()=>{me(1),je({x:0,y:0})},className:"px-1.5 py-0.5 text-xs text-slate-400 hover:text-slate-200",title:"é‡ç½®è§†å›¾",children:"1:1"})]}),t.jsx("button",{onClick:()=>He(!0),className:"p-1.5 text-slate-400 bg-slate-800/50 border border-slate-700/50 rounded hover:text-slate-200",title:"å¿«æ·é”®å¸®åŠ© (?)",children:t.jsx(bn,{className:"w-4 h-4"})}),t.jsxs("div",{className:"relative",children:[t.jsxs("button",{onClick:Ls,disabled:pe==="saving"||!P,className:`flex items-center gap-1 px-2 py-1 text-xs rounded transition-all ${P?pe==="saved"?"bg-green-500/20 text-green-300 border border-green-500/30":pe==="error"?"bg-red-500/20 text-red-300 border border-red-500/30":"bg-slate-800/50 text-slate-300 border border-slate-700/50 hover:bg-slate-700/50":"bg-slate-800/30 text-slate-500 border border-slate-700/30 cursor-not-allowed"}`,title:P?"ä¿å­˜":"è¯·å…ˆé€‰æ‹©æˆ–åˆ›å»ºé¡¹ç›®",children:[pe==="saving"?t.jsx(yn,{className:"w-3.5 h-3.5 animate-spin"}):pe==="saved"?t.jsx(ls,{className:"w-3.5 h-3.5"}):t.jsx(jn,{className:"w-3.5 h-3.5"}),pe==="saving"?"ä¿å­˜ä¸­":pe==="saved"?"å·²ä¿å­˜":"ä¿å­˜"]}),fs&&pe==="idle"&&P&&t.jsx("span",{className:"absolute -top-0.5 -right-0.5 w-2 h-2 bg-amber-400 rounded-full"})]}),!y&&t.jsx("button",{onClick:ys,className:"p-1.5 text-slate-400 bg-slate-800/50 border border-slate-700/50 rounded hover:text-slate-200",title:lt?"é€€å‡ºå…¨å±":"å…¨å±",children:lt?t.jsx(vn,{className:"w-4 h-4"}):t.jsx(wn,{className:"w-4 h-4"})})]}),t.jsxs("div",{className:"flex-1 flex flex-col min-h-0",children:[t.jsx("div",{className:"flex-1 relative overflow-hidden bg-slate-900",children:t.jsxs("svg",{ref:le,width:"100%",height:"100%",style:{cursor:Qe||ye?"grabbing":X?"crosshair":"default"},onWheel:Is,onMouseDown:$s,onMouseMove:zs,onMouseUp:Wt,onMouseLeave:Wt,onDrop:js,onDragOver:vs,children:[t.jsxs("defs",{children:[t.jsx("pattern",{id:"grid",width:30*O,height:30*O,patternUnits:"userSpaceOnUse",children:t.jsx("path",{d:`M ${30*O} 0 L 0 0 0 ${30*O}`,fill:"none",stroke:"rgba(71,85,105,0.15)",strokeWidth:"1"})}),[...Ae,"#64748b"].map(e=>t.jsxs(wt.Fragment,{children:[t.jsx("marker",{id:`arrowhead-${e.slice(1)}`,markerWidth:"12",markerHeight:"8",refX:"10",refY:"4",orient:"auto",children:t.jsx("polygon",{points:"0 0, 12 4, 0 8",fill:e})}),t.jsx("marker",{id:`arrowhead-start-${e.slice(1)}`,markerWidth:"12",markerHeight:"8",refX:"2",refY:"4",orient:"auto-start-reverse",children:t.jsx("polygon",{points:"0 0, 12 4, 0 8",fill:e})})]},e))]}),t.jsx("rect",{width:"100%",height:"100%",fill:"url(#grid)"}),t.jsxs("g",{transform:`translate(${ae.x}, ${ae.y}) scale(${O})`,children:[Ge.map(As),Q.filter(e=>e.parentId&&re.has(e.parentId)).map(e=>{if(v&&e.id===v)return null;const s=Q.find(I=>I.id===e.parentId);if(!s)return null;const n=ee(s),a=he==="horizontal";let l,d,c,i,h,p;if(a){l=s.x+s.width,d=s.y+s.height/2,c=e.x,i=e.y+e.height/2;const I=(l+c)/2;h=`M ${l} ${d} C ${I} ${d}, ${I} ${i}, ${c} ${i}`,p=`${c},${i} ${c-8},${i-4} ${c-8},${i+4}`}else{l=s.x+s.width/2,d=s.y+s.height,c=e.x+e.width/2,i=e.y;const I=(d+i)/2;h=`M ${l} ${d} C ${l} ${I}, ${c} ${I}, ${c} ${i}`,p=`${c},${i} ${c-4},${i-8} ${c+4},${i-8}`}return t.jsxs("g",{children:[t.jsx("path",{d:h,fill:"none",stroke:n,strokeWidth:2,strokeOpacity:.5,strokeDasharray:"6 4"}),t.jsx("polygon",{points:p,fill:n,fillOpacity:.7})]},`expand-edge-${s.id}-${e.id}`)}),Ys(),Xs(),is.map((e,s)=>e.type==="v"?t.jsx("line",{x1:e.pos,y1:-1e4,x2:e.pos,y2:1e4,stroke:"#f472b6",strokeWidth:1,strokeDasharray:"4 4",pointerEvents:"none"},s):t.jsx("line",{x1:-1e4,y1:e.pos,x2:1e4,y2:e.pos,stroke:"#f472b6",strokeWidth:1,strokeDasharray:"4 4",pointerEvents:"none"},s)),Q.map(e=>{const s=u.has(e.id),n=A===e.id,a=ct===e.id,l=e.groupId?L.get(e.groupId):null,d=qt(e.id),c=Ye===e.id;return d&&r.filter(i=>i.parentId===e.id).length,t.jsxs("g",{transform:`translate(${e.x}, ${e.y})`,onMouseDown:i=>Ms(i,e),onDoubleClick:()=>Ss(e),onMouseEnter:i=>{if(Y(e.id),le.current){const h=le.current.getBoundingClientRect(),p=h.left+ae.x+(e.x+e.width+10)*O,I=h.top+ae.y+e.y*O;W({x:p,y:I})}},onMouseLeave:()=>{Y(null),W(null)},style:{cursor:d?"pointer":ye===e.id?"grabbing":"grab"},children:[d&&n&&!c&&t.jsx("rect",{x:-6,y:-6,width:e.width+12,height:e.height+12,rx:14,fill:"none",stroke:ee(e),strokeWidth:2,opacity:.6,pointerEvents:"none",children:t.jsx("animate",{attributeName:"opacity",values:"0.3;0.7;0.3",dur:"1.5s",repeatCount:"indefinite"})}),c&&t.jsxs("rect",{x:-8,y:-8,width:e.width+16,height:e.height+16,rx:16,fill:"none",stroke:"#22c55e",strokeWidth:3,pointerEvents:"none",children:[t.jsx("animate",{attributeName:"opacity",values:"1;0",dur:"0.3s",fill:"freeze"}),t.jsx("animate",{attributeName:"stroke-width",values:"3;6",dur:"0.3s",fill:"freeze"})]}),l&&t.jsx("rect",{x:-6,y:-6,width:e.width+12,height:e.height+12,rx:14,fill:`${l.color}15`,stroke:l.color,strokeWidth:2,strokeDasharray:"6 3",pointerEvents:"none"}),s&&t.jsx("rect",{x:-4,y:-4,width:e.width+8,height:e.height+8,rx:12,fill:"none",stroke:"#fbbf24",strokeWidth:2}),Ts(e,s,n,ee(e)),a?t.jsx("foreignObject",{x:4,y:e.height/2-12,width:e.width-8,height:24,children:t.jsx("input",{ref:We,autoFocus:!0,value:ht,onChange:i=>It(i.target.value),onBlur:()=>Ht(e.id,ht),onKeyDown:i=>{i.key==="Enter"&&Ht(e.id,ht),i.key==="Escape"&&dt(null)},onMouseDown:i=>i.stopPropagation(),onClick:i=>i.stopPropagation(),style:{width:"100%",background:"transparent",border:"none",color:"#f1f5f9",fontSize:12,textAlign:"center",outline:"none"}})}):t.jsx("foreignObject",{x:8,y:e.layerType?14:4,width:e.width-16,height:e.height-(e.layerType?18:8),children:t.jsx("div",{style:{height:"100%",display:"flex",alignItems:"center",justifyContent:"center"},children:t.jsx("div",{style:{fontSize:12,fontWeight:600,color:"#f1f5f9",textAlign:"center",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},children:e.name})})}),Ps(e),s&&!a&&u.size===1&&t.jsx("rect",{x:e.width-6,y:e.height-6,width:12,height:12,fill:"#3b82f6",stroke:"#fff",strokeWidth:1,rx:2,style:{cursor:"se-resize"},onMouseDown:i=>{i.stopPropagation(),Tt({nodeId:e.id,corner:"se"}),gs({x:i.clientX,y:i.clientY,width:e.width,height:e.height})}}),l&&t.jsxs("g",{transform:`translate(${e.width-8}, -8)`,style:{cursor:"pointer"},onClick:i=>{i.stopPropagation(),e.groupId&&Qs(e.groupId)},onMouseDown:i=>i.stopPropagation(),children:[t.jsx("circle",{r:10,fill:l.color,stroke:"#1e293b",strokeWidth:2}),t.jsx("text",{x:0,y:4,fill:"#fff",fontSize:10,fontWeight:600,textAnchor:"middle",style:{pointerEvents:"none"},children:"G"}),t.jsx("title",{children:"Click to select entire group"})]}),d&&t.jsxs("g",{transform:`translate(${e.width+4}, ${e.height/2})`,style:{cursor:"pointer"},onClick:i=>{i.stopPropagation(),Ut(e.id)},onMouseDown:i=>i.stopPropagation(),children:[t.jsx("circle",{r:10,fill:re.has(e.id)?ee(e):"#1e293b",stroke:ee(e),strokeWidth:2}),t.jsx("text",{x:0,y:4,fill:re.has(e.id)?"#fff":ee(e),fontSize:14,fontWeight:600,textAnchor:"middle",style:{pointerEvents:"none"},children:re.has(e.id)?"âˆ’":"+"}),t.jsxs("title",{children:[re.has(e.id)?"æ”¶èµ·å­èŠ‚ç‚¹":"å±•å¼€å­èŠ‚ç‚¹"," (åŒå‡»è¿›å…¥)"]})]}),e.layerType&&t.jsxs("g",{transform:"translate(-8, -8)",children:[t.jsx("rect",{x:-22,y:-8,width:44,height:16,rx:8,fill:ee(e),stroke:"#1e293b",strokeWidth:1.5}),t.jsx("text",{x:0,y:4,fill:"#fff",fontSize:9,fontWeight:600,textAnchor:"middle",style:{pointerEvents:"none"},children:fe[e.layerType].label}),t.jsx("title",{children:fe[e.layerType].desc})]}),e.layerType==="code"&&e.filePath&&t.jsxs("g",{transform:`translate(8, ${e.height+6})`,style:{cursor:"pointer"},onClick:i=>{i.stopPropagation(),navigator.clipboard.writeText(e.filePath||"")},children:[t.jsx("text",{fill:"#10b981",fontSize:9,style:{pointerEvents:"none"},children:e.filePath.length>30?"..."+e.filePath.slice(-27):e.filePath}),t.jsxs("title",{children:["ç‚¹å‡»å¤åˆ¶è·¯å¾„: ",e.filePath]})]}),s&&u.size===1&&t.jsxs("g",{transform:`translate(${l?e.width-28:e.width-8}, -8)`,style:{cursor:"pointer"},onClick:i=>{i.stopPropagation(),jt(e.id)},onMouseDown:i=>i.stopPropagation(),children:[t.jsx("circle",{r:10,fill:"#3b82f6",stroke:"#1e293b",strokeWidth:2}),t.jsx("text",{x:0,y:4,fill:"#fff",fontSize:11,fontWeight:600,textAnchor:"middle",style:{pointerEvents:"none"},children:"i"}),t.jsx("title",{children:"æŸ¥çœ‹è¯¦æƒ… / æ·»åŠ å­èŠ‚ç‚¹"})]})]},e.id)}),f&&t.jsx("rect",{x:Math.min(f.startX,f.endX),y:Math.min(f.startY,f.endY),width:Math.abs(f.endX-f.startX),height:Math.abs(f.endY-f.startY),fill:"rgba(59, 130, 246, 0.1)",stroke:"#3b82f6",strokeWidth:1,strokeDasharray:"4 2",pointerEvents:"none"}),r.length===0&&t.jsxs("g",{transform:"translate(200, 120)",children:[t.jsx("rect",{x:-140,y:-60,width:280,height:120,rx:12,fill:"rgba(30,41,59,0.8)",stroke:"rgba(71,85,105,0.5)",strokeWidth:1,strokeDasharray:"4 2"}),t.jsx("text",{x:0,y:-15,fill:"#94a3b8",fontSize:13,textAnchor:"middle",children:"ç™½æ¿æ˜¯ç©ºçš„"}),t.jsx("text",{x:0,y:10,fill:"#64748b",fontSize:11,textAnchor:"middle",children:"æ‹–æ‹½ä¸Šæ–¹å½¢çŠ¶åˆ°è¿™é‡Œå¼€å§‹"}),t.jsx("text",{x:0,y:35,fill:"#64748b",fontSize:11,textAnchor:"middle",children:"ä»Žé”šç‚¹æ‹–å‡ºè¿žçº¿"})]})]})]})}),u.size>1&&t.jsxs("div",{className:"absolute bottom-20 left-1/2 -translate-x-1/2 flex flex-col gap-3 px-4 py-3 bg-slate-900/95 backdrop-blur-xl border border-indigo-500/30 rounded-xl shadow-2xl z-10",children:[t.jsxs("div",{className:"flex items-center justify-between gap-4",children:[t.jsxs("span",{className:"text-sm text-slate-300",children:["å·²é€‰ä¸­ ",u.size," ä¸ªèŠ‚ç‚¹"]}),t.jsx("button",{onClick:()=>j(new Set),className:"text-xs text-slate-400 hover:text-slate-200",children:"å–æ¶ˆé€‰æ‹©"})]}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(Nn,{className:"w-4 h-4 text-slate-400"}),t.jsx("span",{className:"text-sm text-slate-300 w-12",children:"é¢œè‰²:"}),t.jsx("div",{className:"flex items-center gap-1",children:Ae.map(e=>t.jsx("button",{onClick:()=>Os(e),className:"w-5 h-5 rounded-full border-2 border-transparent hover:border-white hover:scale-110 transition-all",style:{backgroundColor:e},title:`è®¾ç½®é¢œè‰² ${e}`},e))})]}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("span",{className:"text-sm text-slate-300 w-12",children:"å¯¹é½:"}),t.jsxs("div",{className:"flex items-center gap-0.5 p-0.5 bg-slate-700/50 rounded-lg",children:[t.jsx("button",{onClick:_s,className:"p-1.5 text-slate-400 hover:text-slate-200 hover:bg-slate-600 rounded",title:"å·¦å¯¹é½",children:t.jsx(kn,{className:"w-4 h-4"})}),t.jsx("button",{onClick:Gs,className:"p-1.5 text-slate-400 hover:text-slate-200 hover:bg-slate-600 rounded",title:"æ°´å¹³å±…ä¸­",children:t.jsx(Cn,{className:"w-4 h-4"})}),t.jsx("button",{onClick:Fs,className:"p-1.5 text-slate-400 hover:text-slate-200 hover:bg-slate-600 rounded",title:"å³å¯¹é½",children:t.jsx(Sn,{className:"w-4 h-4"})}),t.jsx("div",{className:"w-px h-5 bg-slate-600 mx-1"}),t.jsx("button",{onClick:Ks,className:"p-1.5 text-slate-400 hover:text-slate-200 hover:bg-slate-600 rounded",title:"é¡¶éƒ¨å¯¹é½",children:t.jsx(Mn,{className:"w-4 h-4"})}),t.jsx("button",{onClick:Us,className:"p-1.5 text-slate-400 hover:text-slate-200 hover:bg-slate-600 rounded",title:"åž‚ç›´å±…ä¸­",children:t.jsx(En,{className:"w-4 h-4"})}),t.jsx("button",{onClick:Bs,className:"p-1.5 text-slate-400 hover:text-slate-200 hover:bg-slate-600 rounded",title:"åº•éƒ¨å¯¹é½",children:t.jsx(Dn,{className:"w-4 h-4"})})]}),u.size>=3&&t.jsxs(t.Fragment,{children:[t.jsx("div",{className:"w-px h-5 bg-slate-600 mx-1"}),t.jsxs("div",{className:"flex items-center gap-0.5 p-0.5 bg-slate-700/50 rounded-lg",children:[t.jsx("button",{onClick:Vs,className:"p-1.5 text-slate-400 hover:text-slate-200 hover:bg-slate-600 rounded",title:"æ°´å¹³ç­‰é—´è·åˆ†å¸ƒ",children:t.jsx($n,{className:"w-4 h-4"})}),t.jsx("button",{onClick:qs,className:"p-1.5 text-slate-400 hover:text-slate-200 hover:bg-slate-600 rounded",title:"åž‚ç›´ç­‰é—´è·åˆ†å¸ƒ",children:t.jsx(zn,{className:"w-4 h-4"})})]})]})]}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("span",{className:"text-sm text-slate-300 w-12",children:"åˆ†ç»„:"}),(()=>{const e=en();if(e){const s=L.get(e);return t.jsxs("button",{onClick:()=>Js(e),className:"flex items-center gap-1.5 px-3 py-1.5 text-sm text-orange-400 bg-slate-700/50 hover:bg-orange-500/20 rounded-lg transition-all",title:"è§£æ•£å½“å‰ç»„",children:[t.jsx(In,{className:"w-3.5 h-3.5"}),"è§£æ•£ç»„",s&&t.jsx("span",{className:"w-3 h-3 rounded-full ml-1",style:{backgroundColor:s.color}})]})}else return t.jsxs("button",{onClick:Zs,className:"flex items-center gap-1.5 px-3 py-1.5 text-sm text-purple-400 bg-slate-700/50 hover:bg-purple-500/20 rounded-lg transition-all",title:"å°†é€‰ä¸­èŠ‚ç‚¹åˆ›å»ºä¸ºä¸€ç»„",children:[t.jsx(Tn,{className:"w-3.5 h-3.5"}),"åˆ›å»ºç»„"]})})()]}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsxs("button",{onClick:()=>{const e=r.filter(n=>u.has(n.id)),s=m.filter(n=>u.has(n.from)&&u.has(n.to));rt({nodes:e.map(n=>({...n})),edges:s.map(n=>({...n}))})},className:"flex items-center gap-1.5 px-3 py-1.5 text-sm text-slate-300 bg-slate-700/50 hover:bg-slate-600 rounded-lg transition-all",title:"å¤åˆ¶ (Cmd+C)",children:[t.jsx(Pn,{className:"w-3.5 h-3.5"}),"å¤åˆ¶"]}),t.jsxs("button",{onClick:ft,className:"flex items-center gap-1.5 px-3 py-1.5 text-sm text-red-400 bg-slate-700/50 hover:bg-red-500/20 rounded-lg transition-all",title:"åˆ é™¤ (Delete)",children:[t.jsx(os,{className:"w-3.5 h-3.5"}),"åˆ é™¤"]})]})]}),$&&t.jsxs("div",{className:"absolute bottom-20 left-1/2 -translate-x-1/2 flex flex-col gap-2 px-4 py-3 bg-slate-900/95 backdrop-blur-xl border border-indigo-500/30 rounded-xl shadow-2xl z-10",onMouseDown:e=>e.stopPropagation(),children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("span",{className:"text-sm text-slate-300 w-16",children:"ç®­å¤´:"}),Object.keys(Ce).map(e=>{const s=m.find(l=>l.id===$),a=((s==null?void 0:s.lineType)||"arrow-end")===e;return t.jsx("button",{onClick:l=>{l.stopPropagation(),l.preventDefault(),ws(e)},className:`px-3 py-1.5 text-sm rounded-lg transition-all ${a?"bg-blue-500 text-white":"text-slate-400 hover:text-white hover:bg-slate-700"}`,title:Ce[e].label,children:Ce[e].icon},e)})]}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("span",{className:"text-sm text-slate-300 w-16",children:"æ ·å¼:"}),Object.keys(Se).map(e=>{const s=m.find(l=>l.id===$),a=((s==null?void 0:s.lineStyle)||"solid")===e;return t.jsx("button",{onClick:l=>{l.stopPropagation(),l.preventDefault(),ks(e)},className:`px-3 py-1.5 text-sm rounded-lg transition-all ${a?"bg-blue-500 text-white":"text-slate-400 hover:text-white hover:bg-slate-700"}`,title:Se[e].label,children:Se[e].label},e)}),t.jsx("div",{className:"w-px h-6 bg-slate-600 mx-1"}),t.jsx("div",{className:"flex items-center gap-1",children:[...Ae,"#64748b"].map(e=>{const s=m.find(l=>l.id===$),a=((s==null?void 0:s.color)||"#64748b")===e;return t.jsx("button",{onClick:l=>{l.stopPropagation(),l.preventDefault(),Ns(e)},className:`w-5 h-5 rounded-full border-2 transition-all ${a?"border-white scale-110":"border-transparent hover:scale-105"}`,style:{backgroundColor:e},title:`çº¿æ¡é¢œè‰² ${e}`},e)})}),t.jsx("div",{className:"w-px h-6 bg-slate-600 mx-1"}),t.jsx("button",{onClick:e=>{e.stopPropagation(),e.preventDefault(),mt($)},className:"px-3 py-1.5 text-sm text-red-400 hover:text-white hover:bg-red-500 rounded-lg transition-all",children:"åˆ é™¤"})]})]}),Q.length>0&&t.jsx(An,{nodes:Q.map(e=>({id:e.id,x:e.x,y:e.y,width:e.width,height:e.height,color:e.color})),edges:Ge.map(e=>({from:e.from,to:e.to})),viewBox:dn(),canvasSize:{width:2e3,height:1500},onPanTo:cn}),A&&E&&!ye&&!X&&(()=>{const e=r.find(s=>s.id===A);return!e||!e.description?null:t.jsx("div",{className:"fixed z-50 pointer-events-none",style:{left:E.x,top:E.y,transform:"translateY(-50%)",maxWidth:280},children:t.jsxs("div",{className:"bg-slate-900/95 backdrop-blur-sm border border-slate-700/50 rounded-lg shadow-xl p-3",children:[t.jsx("div",{className:"absolute left-0 top-1/2 -translate-x-full -translate-y-1/2",style:{width:0,height:0,borderTop:"6px solid transparent",borderBottom:"6px solid transparent",borderRight:"6px solid rgba(51, 65, 85, 0.8)"}}),t.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[t.jsx("div",{className:"w-2 h-2 rounded-full",style:{backgroundColor:ee(e)}}),t.jsx("span",{className:"text-sm font-medium text-slate-200 truncate",children:e.name}),e.layerType&&t.jsx("span",{className:"text-xs px-1.5 py-0.5 rounded",style:{backgroundColor:`${ee(e)}30`,color:ee(e)},children:fe[e.layerType].label})]}),t.jsx("div",{className:"text-xs text-slate-400 leading-relaxed line-clamp-3",children:e.description}),qt(e.id)&&t.jsxs("div",{className:"mt-2 text-xs text-slate-500",children:["åŒ…å« ",r.filter(s=>s.parentId===e.id).length," ä¸ªå­èŠ‚ç‚¹"]})]})})})()]}),u.size===1&&(()=>{const e=r.find(c=>c.id===[...u][0]);if(!e)return null;const s=e.parentId?r.find(c=>c.id===e.parentId):null,n=r.filter(c=>c.parentId===e.id),a=m.filter(c=>c.from===e.id),l=m.filter(c=>c.to===e.id),d=yt(e.id);return t.jsx("div",{className:"flex-shrink-0 border-t border-indigo-500/30 bg-slate-900/80 px-5 py-8 relative z-40",children:t.jsxs("div",{className:"max-w-6xl mx-auto",children:[t.jsxs("div",{className:"flex items-center gap-3 mb-3",children:[t.jsx("div",{className:"w-3 h-3 rounded",style:{backgroundColor:ee(e)}}),t.jsx("h3",{className:"text-base font-semibold text-white",children:e.name}),e.layerType&&t.jsx("span",{className:"px-2 py-0.5 text-xs rounded",style:{backgroundColor:`${ee(e)}30`,color:ee(e)},children:fe[e.layerType].label}),s&&t.jsxs("span",{className:"text-xs text-slate-500 cursor-pointer hover:text-slate-300",onClick:()=>j(new Set([s.id])),children:["â† ",s.name]})]}),t.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[t.jsxs("div",{className:"space-y-2",children:[t.jsx("div",{className:"text-xs text-slate-500 font-medium",children:"ç»“æž„"}),t.jsxs("div",{className:"flex flex-wrap gap-2",children:[t.jsxs("span",{className:"px-2 py-1 bg-slate-800 rounded text-xs text-slate-300",children:["æ·±åº¦ ",d]}),n.length>0&&t.jsxs("span",{className:"px-2 py-1 bg-blue-900/50 rounded text-xs text-blue-300 cursor-pointer hover:bg-blue-800/50",onClick:()=>Bt(e.id),children:[n.length," å­èŠ‚ç‚¹"]}),(a.length>0||l.length>0)&&t.jsxs("span",{className:"px-2 py-1 bg-purple-900/50 rounded text-xs text-purple-300",children:[a.length,"å‡º / ",l.length,"å…¥"]})]})]}),t.jsxs("div",{className:"space-y-2",children:[t.jsx("div",{className:"text-xs text-slate-500 font-medium",children:"ä¾èµ–å…³ç³»"}),a.length>0||l.length>0?t.jsxs("div",{className:"flex flex-wrap gap-1",children:[a.slice(0,3).map(c=>{const i=r.find(h=>h.id===c.to);return i&&t.jsxs("span",{className:"px-2 py-1 bg-slate-800 rounded text-xs text-slate-300 cursor-pointer hover:bg-slate-700",onClick:()=>j(new Set([i.id])),children:["â†’ ",i.name]},c.id)}),l.slice(0,3).map(c=>{const i=r.find(h=>h.id===c.from);return i&&t.jsxs("span",{className:"px-2 py-1 bg-slate-800 rounded text-xs text-slate-300 cursor-pointer hover:bg-slate-700",onClick:()=>j(new Set([i.id])),children:["â† ",i.name]},c.id)}),a.length+l.length>6&&t.jsxs("span",{className:"px-2 py-1 text-xs text-slate-500",children:["+",a.length+l.length-6," æ›´å¤š"]})]}):t.jsx("span",{className:"text-xs text-slate-500 italic",children:"æ— è¿žæŽ¥"})]}),t.jsx("div",{className:"space-y-2",children:e.layerType==="code"&&e.filePath?t.jsxs(t.Fragment,{children:[t.jsx("div",{className:"text-xs text-slate-500 font-medium",children:"æ–‡ä»¶"}),t.jsxs("div",{className:"flex items-center gap-2 px-2 py-1 bg-slate-800 rounded text-green-400 cursor-pointer hover:bg-slate-700 w-fit",onClick:()=>navigator.clipboard.writeText(e.filePath||""),title:"ç‚¹å‡»å¤åˆ¶",children:[t.jsx(as,{size:12}),t.jsx("span",{className:"font-mono text-xs truncate max-w-[200px]",children:e.filePath})]})]}):t.jsxs(t.Fragment,{children:[t.jsx("div",{className:"text-xs text-slate-500 font-medium",children:"æè¿°"}),t.jsx("div",{className:"text-xs text-slate-300 line-clamp-2",children:e.description||t.jsx("span",{className:"text-slate-500 italic",children:"æ— "})})]})})]})]})})})()]})}),!Pt&&(()=>{const e=A?r.find(c=>c.id===A):u.size===1?r.find(c=>c.id===[...u][0]):null;if(!e)return null;const s=r.filter(c=>c.parentId===e.id),n=s.length,a=re.has(e.id);e.parentId&&r.find(c=>c.id===e.parentId);const l=an(e.id),d=m.filter(c=>c.from===e.id||c.to===e.id);return t.jsxs("div",{className:"w-60 flex-shrink-0 h-full max-h-full border-l border-indigo-500/20 flex flex-col overflow-hidden relative z-20",style:{background:"linear-gradient(180deg, #1e2a5e 0%, #1e1b4b 100%)"},children:[t.jsxs("div",{className:"flex-1 overflow-y-auto p-4",children:[t.jsxs("div",{className:"flex items-center gap-2 mb-4 pb-3 border-b border-slate-700/50",children:[t.jsx("div",{className:"w-3 h-3 rounded",style:{backgroundColor:ee(e)}}),t.jsx("span",{className:"text-sm font-medium text-white truncate",children:e.name}),e.layerType&&t.jsx("span",{className:"text-xs text-slate-400 ml-auto",children:fe[e.layerType].label})]}),l.length>1&&t.jsxs("div",{className:"mb-4",children:[t.jsx("div",{className:"text-xs text-slate-500 mb-1",children:"è·¯å¾„"}),t.jsxs("div",{className:"flex items-center gap-1 text-xs text-slate-400 flex-wrap",children:[l.slice(0,-1).map((c,i)=>t.jsxs(wt.Fragment,{children:[t.jsx("span",{className:"hover:text-slate-200 cursor-pointer",onClick:()=>j(new Set([c.id])),children:c.name}),t.jsx(Ue,{size:10})]},c.id)),t.jsx("span",{className:"text-slate-200",children:e.name})]})]}),n>0&&t.jsxs("div",{className:"mb-4",children:[t.jsxs("div",{className:"text-sm text-slate-500 mb-2 font-medium",children:["å­èŠ‚ç‚¹ (",n,") ",a&&t.jsx("span",{className:"text-green-400",children:"å·²å±•å¼€"})]}),t.jsxs("div",{className:"space-y-2 max-h-40 overflow-y-auto",children:[s.slice(0,8).map(c=>t.jsxs("div",{className:"flex items-center gap-2 px-3 py-2 bg-slate-800/50 rounded-lg cursor-pointer hover:bg-slate-700/50",onClick:()=>j(new Set([c.id])),children:[c.layerType&&t.jsx("span",{className:"w-2 h-2 rounded-full",style:{backgroundColor:ee(c)}}),t.jsx("span",{className:"text-sm text-slate-300 truncate",children:c.name}),r.some(i=>i.parentId===c.id)&&t.jsxs("span",{className:"text-xs text-slate-500 ml-auto",children:["+",r.filter(i=>i.parentId===c.id).length]})]},c.id)),n>8&&t.jsxs("div",{className:"text-xs text-slate-500 text-center py-1",children:["è¿˜æœ‰ ",n-8," ä¸ª..."]})]})]}),d.length>0&&t.jsxs("div",{className:"mb-4",children:[t.jsx("div",{className:"text-sm text-slate-500 mb-2 font-medium",children:"è¿žæŽ¥å…³ç³»"}),t.jsx("div",{className:"text-xs text-slate-400 space-y-1",children:d.slice(0,5).map(c=>{const i=c.from===e.id,h=r.find(p=>p.id===(i?c.to:c.from));return h?t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("span",{className:"text-slate-500",children:i?"â†’":"â†"}),t.jsx("span",{className:"text-slate-400 hover:text-slate-200 cursor-pointer",onClick:()=>j(new Set([h.id])),children:h.name})]},c.id):null})})]})]}),n>0&&t.jsxs("div",{className:"p-5 border-t border-slate-700 space-y-3",children:[t.jsx("button",{onClick:()=>Ut(e.id),className:`w-full py-3 text-white text-sm font-medium rounded-lg transition-colors ${a?"bg-orange-500 hover:bg-orange-600":"bg-green-500 hover:bg-green-600"}`,children:a?"æ”¶èµ·å­èŠ‚ç‚¹ â†‘":"å±•å¼€å­èŠ‚ç‚¹ â†“"}),t.jsx("button",{onClick:()=>Bt(e.id),className:"w-full py-3 bg-blue-500 hover:bg-blue-600 text-white text-sm font-medium rounded-lg transition-colors",children:"è¿›å…¥æŸ¥çœ‹è¯¦æƒ… â†’"})]})]})})(),Pt&&ve&&(()=>{const e=r.find(n=>n.id===ve);if(!e)return null;const s=vt(ve);return t.jsxs("div",{className:"w-80 flex-shrink-0 h-full max-h-full border-l border-indigo-500/30 flex flex-col overflow-hidden",style:{background:"linear-gradient(180deg, #1e2a5e 0%, #1e1b4b 100%)"},children:[t.jsxs("div",{className:"flex items-center justify-between px-4 py-3 border-b border-indigo-500/30",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("div",{className:"w-3 h-3 rounded",style:{backgroundColor:ee(e)}}),t.jsx("span",{className:"font-medium text-slate-200",children:e.name})]}),t.jsx("button",{onClick:ln,className:"p-1 text-slate-400 hover:text-slate-200 rounded hover:bg-slate-700",children:t.jsx(rs,{size:18})})]}),t.jsxs("div",{className:"flex-1 overflow-y-auto p-4 space-y-4",children:[t.jsxs("div",{children:[t.jsx("label",{className:"block text-xs text-slate-400 mb-1.5",children:"å±‚çº§ç±»åž‹"}),t.jsx("div",{className:"grid grid-cols-2 gap-1.5",children:["feature","code"].map(n=>t.jsx("button",{onClick:()=>{x(a=>a.map(l=>l.id===ve?{...l,layerType:n}:l)),De(!0)},className:`px-2 py-1.5 text-xs rounded-lg border transition-all ${e.layerType===n?"border-transparent text-white":"border-slate-600 text-slate-400 hover:border-slate-500"}`,style:e.layerType===n?{backgroundColor:fe[n].color}:{},children:fe[n].label},n))}),e.layerType&&t.jsx("p",{className:"text-xs text-slate-500 mt-1.5",children:fe[e.layerType].desc})]}),e.layerType==="code"&&t.jsxs("div",{children:[t.jsx("label",{className:"block text-xs text-slate-400 mb-1.5",children:"æ–‡ä»¶è·¯å¾„"}),t.jsx("input",{type:"text",value:e.filePath||"",onChange:n=>{x(a=>a.map(l=>l.id===ve?{...l,filePath:n.target.value}:l)),De(!0)},placeholder:"src/pages/Whiteboard.tsx:100",className:"w-full px-3 py-2 bg-slate-900 border border-slate-600 rounded-lg text-sm text-slate-200 placeholder-slate-500 focus:outline-none focus:border-green-500"})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-xs text-slate-400 mb-1.5",children:"æè¿° / å¤‡æ³¨"}),t.jsx("textarea",{value:e.description||"",onChange:n=>rn(ve,n.target.value),placeholder:"æ·»åŠ æè¿°...",className:"w-full h-24 px-3 py-2 bg-slate-900 border border-slate-600 rounded-lg text-sm text-slate-200 placeholder-slate-500 resize-none focus:outline-none focus:border-blue-500"})]}),t.jsxs("div",{children:[t.jsxs("div",{className:"flex items-center justify-between mb-2",children:[t.jsxs("label",{className:"text-xs text-slate-400",children:["å­èŠ‚ç‚¹ (",s.length,")"]}),t.jsxs("button",{onClick:()=>on(ve),className:"flex items-center gap-1 px-2 py-1 text-xs text-blue-400 hover:text-blue-300 hover:bg-slate-700 rounded",children:[t.jsx(kt,{size:14}),"æ·»åŠ "]})]}),t.jsx("div",{className:"space-y-1",children:s.length===0?t.jsx("div",{className:"text-sm text-slate-500 py-3 text-center border border-dashed border-slate-600 rounded-lg",children:"æš‚æ— å­èŠ‚ç‚¹"}):s.map(n=>t.jsxs("div",{className:"flex items-center gap-2 px-3 py-2 bg-slate-900 rounded-lg cursor-pointer hover:bg-slate-700 group",onClick:()=>{j(new Set([n.id])),jt(n.id)},children:[t.jsx("div",{className:"w-2 h-2 rounded",style:{backgroundColor:n.color||"#3b82f6"}}),t.jsx("span",{className:"flex-1 text-sm text-slate-300 truncate",children:n.name}),t.jsx(Ue,{size:14,className:"text-slate-500 group-hover:text-slate-300"})]},n.id))})]}),e.parentId&&(()=>{const n=r.find(a=>a.id===e.parentId);return n?t.jsxs("div",{children:[t.jsx("label",{className:"block text-xs text-slate-400 mb-1.5",children:"çˆ¶èŠ‚ç‚¹"}),t.jsxs("div",{className:"flex items-center gap-2 px-3 py-2 bg-slate-900 rounded-lg cursor-pointer hover:bg-slate-700",onClick:()=>{j(new Set([n.id])),jt(n.id)},children:[t.jsx("div",{className:"w-2 h-2 rounded",style:{backgroundColor:n.color||"#3b82f6"}}),t.jsx("span",{className:"text-sm text-slate-300",children:n.name})]})]}):null})(),t.jsxs("div",{className:"pt-2 border-t border-slate-700",children:[t.jsx("label",{className:"block text-xs text-slate-400 mb-1.5",children:"èŠ‚ç‚¹ä¿¡æ¯"}),t.jsxs("div",{className:"text-xs text-slate-500 space-y-1",children:[t.jsxs("div",{children:["ID: ",e.id]}),t.jsxs("div",{children:["ä½ç½®: (",Math.round(e.x),", ",Math.round(e.y),")"]}),t.jsxs("div",{children:["å¤§å°: ",e.width," Ã— ",e.height]})]})]})]})]})})(),t.jsx(Xn,{isOpen:bs,onClose:()=>He(!1)})]})}export{Un as default};

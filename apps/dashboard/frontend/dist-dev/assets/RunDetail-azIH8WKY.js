import{a7 as z,r as m,j as e,R as L,ab as w,G as I,aA as J,W as O,o as E,C as Q,Z as U,aL as W,L as h,Y as u,a0 as g,aF as X,z as Y}from"./index-BfzjYRpn.js";const V=.015;function ae(){const{runId:o}=z(),[t,F]=m.useState(null),[y,M]=m.useState([]),[p,P]=m.useState([]),[_,K]=m.useState(!0),j=async()=>{var s;if(o)try{const n=await(await fetch(`/api/cecelia/runs/${o}`)).json();if(n.success&&(F(n.run),n.checkpoints&&M(n.checkpoints.map(a=>({id:a.checkpoint_id,name:a.name,status:a.status}))),(s=n.run)!=null&&s.project)){const l=await(await fetch("/api/cecelia/overview?limit=100")).json();if(l.success){const x=n.run.feature_branch||"",H=A(x),Z=l.recent_runs.filter(v=>v.id===o||v.project!==n.run.project?!1:H.some(q=>{var T;return(T=v.feature_branch)==null?void 0:T.toLowerCase().includes(q.toLowerCase())}));P(Z.slice(0,5))}}}catch(r){console.error(r)}finally{K(!1)}},A=s=>s.replace(/^(cp-|feature\/|feat\/|fix\/)/,"").replace(/^\d+-/,"").replace(/-\d+$/,"").split(/[-_]/).filter(a=>a.length>2&&!/^\d+$/.test(a));m.useEffect(()=>{j();const s=setInterval(j,5e3);return()=>clearInterval(s)},[o]);const B=()=>{if(!(t!=null&&t.started_at))return null;const s=new Date(t.started_at).getTime(),n=(t.updated_at?new Date(t.updated_at).getTime():Date.now())-s,a=Math.floor(n/6e4),l=Math.floor(a/60);return l>0?`${l}h ${a%60}m`:`${a}m`};if(_)return e.jsx("div",{className:"min-h-screen bg-[#191919] flex items-center justify-center",children:e.jsx(L,{className:"w-5 h-5 text-gray-400 animate-spin"})});if(!t)return e.jsx("div",{className:"min-h-screen bg-[#191919]",children:e.jsxs("div",{className:"max-w-5xl mx-auto px-6 py-8",children:[e.jsxs(w,{to:"/cecelia",className:"text-gray-400 hover:text-white flex items-center gap-2 text-sm",children:[e.jsx(I,{className:"w-4 h-4"})," Engine 工作台"]}),e.jsx("div",{className:"text-gray-500 text-center py-12",children:"任务不存在"})]})});const c=t.steps||[],i=y.length>0?y:(()=>{const s=t.total_checkpoints||6,r=t.completed_checkpoints||0;return Array.from({length:s},(n,a)=>({id:`CP-0${a+1}`,name:void 0,status:a<r?"done":"pending"}))})(),f=c.filter(s=>s.status==="done").length,$=c.findIndex(s=>s.status==="in_progress"),N=$>=0?c[$]:null,b=i.filter(s=>s.status==="done").length,k=i.findIndex(s=>s.status==="in_progress");k>=0&&i[k];const C=s=>{if(!s)return null;const r=new Date(s),n=r.getMonth()+1,a=r.getDate(),l=r.getHours().toString().padStart(2,"0"),x=r.getMinutes().toString().padStart(2,"0");return`${n}/${a} ${l}:${x}`},R=C(t.started_at),D=t.status==="completed"||t.status==="failed"?C(t.updated_at):null,d=t.token_usage||0,G=(d>0?d:5e4)/1e3*V,S=B();return e.jsx("div",{className:"min-h-screen bg-[#191919]",children:e.jsxs("div",{className:"max-w-5xl mx-auto px-6 py-8",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsxs(w,{to:`/cecelia/project/${encodeURIComponent(t.project)}`,className:"text-gray-400 hover:text-white flex items-center gap-2 text-sm",children:[e.jsx(I,{className:"w-4 h-4"})," ",t.project]}),e.jsx("button",{onClick:j,className:"p-2 text-gray-500 hover:text-white rounded-lg hover:bg-white/5",children:e.jsx(L,{className:`w-4 h-4 ${_?"animate-spin":""}`})})]}),e.jsxs("div",{className:"mb-6",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-2",children:[t.status==="running"&&e.jsx("span",{className:"w-3 h-3 bg-blue-500 rounded-full animate-pulse"}),t.status==="completed"&&e.jsx("span",{className:"w-3 h-3 bg-green-500 rounded-full"}),t.status==="failed"&&e.jsx("span",{className:"w-3 h-3 bg-red-500 rounded-full"}),t.status==="pending"&&e.jsx("span",{className:"w-3 h-3 bg-gray-500 rounded-full"}),e.jsx("h1",{className:"text-3xl font-bold text-white tracking-tight",children:t.prd_title||t.feature_branch})]}),e.jsxs("div",{className:"flex items-center gap-4 text-sm text-gray-400 mt-2",children:[e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(J,{className:"w-4 h-4"}),t.feature_branch]}),t.pr_url&&e.jsxs("a",{href:t.pr_url,target:"_blank",rel:"noopener noreferrer",className:"text-blue-400 hover:underline flex items-center gap-1",children:[e.jsx(O,{className:"w-4 h-4"})," Pull Request"]})]})]}),e.jsxs("div",{className:"bg-gradient-to-r from-[#1a1a2e] to-[#16213e] rounded-2xl p-5 border border-[#2a2a4a] mb-8",children:[e.jsxs("div",{className:"flex items-center gap-6 mb-4 pb-4 border-b border-[#303030]",children:[R&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(E,{className:"w-4 h-4 text-cyan-400"}),e.jsx("span",{className:"text-gray-400 text-sm",children:"开始"}),e.jsx("span",{className:"text-cyan-400 font-medium",children:R})]}),D&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(E,{className:"w-4 h-4 text-orange-400"}),e.jsx("span",{className:"text-gray-400 text-sm",children:"结束"}),e.jsx("span",{className:"text-orange-400 font-medium",children:D})]}),S&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Q,{className:"w-4 h-4 text-blue-400"}),e.jsx("span",{className:"text-gray-400 text-sm",children:"时长"}),e.jsx("span",{className:"text-white font-medium",children:S})]})]}),e.jsxs("div",{className:"flex items-center gap-6",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(U,{className:"w-4 h-4 text-purple-400"}),e.jsx("span",{className:"text-gray-400 text-sm",children:"Tokens"}),e.jsx("span",{className:"text-purple-400 font-medium",children:d>0?d>1e6?`${(d/1e6).toFixed(1)}M`:`${(d/1e3).toFixed(0)}K`:"~50K"}),d===0&&e.jsx("span",{className:"text-gray-600 text-xs",children:"(估算)"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(W,{className:"w-4 h-4 text-yellow-400"}),e.jsx("span",{className:"text-gray-400 text-sm",children:"成本"}),e.jsxs("span",{className:"text-yellow-400 font-medium",children:["$",G.toFixed(2)]}),d===0&&e.jsx("span",{className:"text-gray-600 text-xs",children:"(估算)"})]}),t.status==="running"&&N&&e.jsxs("div",{className:"flex items-center gap-2 ml-auto",children:[e.jsx(h,{className:"w-4 h-4 text-blue-400 animate-spin"}),e.jsxs("span",{className:"text-blue-400 font-medium",children:["Step ",N.id,": ",N.name]})]})]})]}),i.length>0&&e.jsxs("div",{className:"mb-8",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h2",{className:"text-lg font-semibold text-white",children:"Checkpoints"}),e.jsxs("span",{className:"text-sm text-gray-500",children:[b,"/",i.length," 完成"]})]}),e.jsxs("div",{className:"bg-[#202020] rounded-2xl border border-[#303030] p-6",children:[e.jsx("div",{className:"mb-6",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"flex-1 h-3 bg-[#404040] rounded-full overflow-hidden",children:e.jsx("div",{className:"h-full bg-gradient-to-r from-green-500 to-green-400 transition-all duration-500",style:{width:`${i.length>0?b/i.length*100:0}%`}})}),e.jsxs("span",{className:"text-sm text-gray-400 w-16 text-right",children:[Math.round(i.length>0?b/i.length*100:0),"%"]})]})}),e.jsx("div",{className:"flex items-center",children:i.map((s,r)=>{const n=s.status==="done",a=s.status==="in_progress",l=s.status==="failed";return e.jsxs("div",{className:"flex items-center flex-1",children:[e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsxs("div",{className:`relative w-16 h-16 rounded-full flex items-center justify-center ${n?"bg-green-500":a?"bg-blue-500":l?"bg-red-500":"bg-[#303030]"}`,children:[a&&e.jsx("div",{className:"absolute -top-1 -right-1 w-5 h-5 bg-yellow-400 rounded-full border-2 border-[#202020] flex items-center justify-center animate-pulse",children:e.jsx("span",{className:"text-xs text-black font-bold",children:"!"})}),n&&e.jsx(u,{className:"w-8 h-8 text-white"}),a&&e.jsx(h,{className:"w-8 h-8 text-white animate-spin"}),l&&e.jsx(g,{className:"w-8 h-8 text-white"}),!n&&!a&&!l&&e.jsx("span",{className:"text-gray-500 font-bold text-xl",children:r+1})]}),e.jsxs("div",{className:"mt-3 text-center",children:[e.jsx("div",{className:`text-sm font-mono font-semibold ${n?"text-green-400":a?"text-blue-400":l?"text-red-400":"text-gray-600"}`,children:s.id}),s.name&&e.jsx("div",{className:`text-xs mt-1 max-w-[100px] leading-tight ${a?"text-white font-medium":n?"text-gray-400":"text-gray-600"}`,children:s.name})]})]}),r<i.length-1&&e.jsx("div",{className:`flex-1 h-1 mx-3 rounded ${n?"bg-green-500":"bg-[#303030]"}`})]},s.id)})})]})]}),e.jsxs("div",{className:"mb-8",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h2",{className:"text-lg font-semibold text-white",children:"Dev 流程"}),e.jsxs("span",{className:"text-sm text-gray-500",children:[f,"/",c.length||9," 完成"]})]}),e.jsxs("div",{className:"bg-[#202020] rounded-2xl border border-[#303030] p-6",children:[e.jsx("div",{className:"mb-6",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"flex-1 h-3 bg-[#404040] rounded-full overflow-hidden",children:e.jsx("div",{className:"h-full bg-gradient-to-r from-green-500 to-green-400 transition-all duration-500",style:{width:`${(c.length||9)>0?f/(c.length||9)*100:0}%`}})}),e.jsxs("span",{className:"text-sm text-gray-400 w-16 text-right",children:[Math.round((c.length||9)>0?f/(c.length||9)*100:0),"%"]})]})}),e.jsx("div",{className:"flex items-center",children:(c.length>0?c:[{id:1,name:"PRD",status:"pending"},{id:2,name:"DoD",status:"pending"},{id:3,name:"Branch",status:"pending"},{id:4,name:"Code",status:"pending"},{id:5,name:"Test",status:"pending"},{id:6,name:"Local",status:"pending"},{id:7,name:"PR",status:"pending"},{id:8,name:"QA",status:"pending"},{id:9,name:"Merge",status:"pending"}]).map((s,r,n)=>{const a=s.status==="done",l=s.status==="in_progress",x=s.status==="failed";return e.jsxs("div",{className:"flex items-center flex-1",children:[e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsxs("div",{className:`relative w-12 h-12 rounded-full flex items-center justify-center ${a?"bg-green-500":l?"bg-blue-500":x?"bg-red-500":"bg-[#303030]"}`,children:[l&&e.jsx("div",{className:"absolute -top-0.5 -right-0.5 w-4 h-4 bg-yellow-400 rounded-full border-2 border-[#202020] animate-pulse"}),a&&e.jsx(u,{className:"w-6 h-6 text-white"}),l&&e.jsx(h,{className:"w-6 h-6 text-white animate-spin"}),x&&e.jsx(g,{className:"w-6 h-6 text-white"}),!a&&!l&&!x&&e.jsx("span",{className:"text-gray-500 font-medium",children:s.id})]}),e.jsx("span",{className:`mt-2 text-xs font-medium ${a?"text-green-400":l?"text-blue-400":x?"text-red-400":"text-gray-600"}`,children:s.name})]}),r<n.length-1&&e.jsx("div",{className:`flex-1 h-0.5 mx-1 rounded ${a?"bg-green-500":"bg-[#303030]"}`})]},s.id)})})]})]}),t.status==="running"&&t.current_action&&e.jsx("div",{className:"mb-8 bg-blue-500/10 border border-blue-500/30 rounded-2xl p-5",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(h,{className:"w-5 h-5 text-blue-400 animate-spin"}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-blue-300 mb-1",children:"当前动作"}),e.jsx("div",{className:"text-white",children:t.current_action})]})]})}),t.status==="completed"&&e.jsxs("div",{className:"mb-8 bg-green-500/10 border border-green-500/30 rounded-2xl p-5 flex items-center gap-3",children:[e.jsx(u,{className:"w-6 h-6 text-green-400"}),e.jsxs("div",{children:[e.jsx("div",{className:"text-green-300 font-medium",children:"任务已完成"}),e.jsx("div",{className:"text-sm text-gray-400 mt-1",children:"所有步骤已通过"})]})]}),t.status==="failed"&&e.jsxs("div",{className:"mb-8 bg-red-500/10 border border-red-500/30 rounded-2xl p-5 flex items-center gap-3",children:[e.jsx(g,{className:"w-6 h-6 text-red-400"}),e.jsxs("div",{children:[e.jsx("div",{className:"text-red-300 font-medium",children:"任务执行失败"}),t.current_action&&e.jsx("div",{className:"text-sm text-gray-400 mt-1",children:t.current_action})]})]}),p.length>0&&e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[e.jsx(X,{className:"w-5 h-5 text-gray-400"}),e.jsx("h2",{className:"text-lg font-semibold text-white",children:"同一 Feature 的其他任务"})]}),e.jsx("div",{className:"bg-[#202020] rounded-2xl border border-[#303030] overflow-hidden",children:p.map((s,r)=>e.jsxs(w,{to:`/cecelia/runs/${s.id}`,className:`flex items-center justify-between px-5 py-4 hover:bg-white/5 transition ${r<p.length-1?"border-b border-[#303030]":""}`,children:[e.jsxs("div",{className:"flex items-center gap-3",children:[s.status==="running"&&e.jsx("span",{className:"w-2 h-2 bg-blue-400 rounded-full animate-pulse"}),s.status==="completed"&&e.jsx(u,{className:"w-4 h-4 text-green-400"}),s.status==="failed"&&e.jsx(g,{className:"w-4 h-4 text-red-400"}),e.jsx("span",{className:s.status==="completed"?"text-gray-300":"text-white",children:s.prd_title||s.feature_branch})]}),e.jsx(Y,{className:"w-4 h-4 text-gray-600"})]},s.id))})]})]})})}export{ae as default};

import{r,j as e,B as H,d as Q,L as G,bn as V,bo as Y,bp as Z,a0 as ee,a1 as te}from"./index-D0DF2d61.js";function se(x){const[h,_]=r.useState([]),[O,i]=r.useState(!1),[k,p]=r.useState(null);return r.useEffect(()=>{let o=null,g=null;const d=()=>{try{o=new EventSource(x),o.onopen=()=>{i(!0),p(null),console.log("SSE connected")},o.onmessage=w=>{try{const b=JSON.parse(w.data);_(m=>[...m,b].slice(-100))}catch(b){console.error("Failed to parse SSE event:",b)}},o.onerror=()=>{i(!1),p("Connection lost"),o==null||o.close(),g=setTimeout(d,5e3)}}catch{p("Failed to connect"),i(!1)}};return d(),()=>{o==null||o.close(),g&&clearTimeout(g)}},[x]),{events:h,isConnected:O,error:k}}const I=["PRD","Branch","DoD","Code","Test","PR","CI","Merge"],v=I.map((x,h)=>({x:120+h*140,y:200}));function ne(){const[x,h]=r.useState([]),[_,O]=r.useState(null),[i,k]=r.useState(!1),[p,o]=r.useState(!1),[g,d]=r.useState(""),[w,b]=r.useState(""),[m,D]=r.useState(""),{events:$,isConnected:P}=se("/api/cecelia/stream"),C=r.useRef(null),f=r.useRef(null),T=r.useRef(null),E=r.useRef(null);r.useEffect(()=>{fetch("/api/cecelia/runs").then(t=>t.json()).then(t=>{t.runs&&h(t.runs)}).catch(console.error)},[]),r.useEffect(()=>{const t=$[$.length-1];if(t&&(t.type==="task_created"||t.type==="task_updated")){const s=t.data;h(l=>l.find(a=>a.id===s.id)?l.map(a=>a.id===s.id?s:a):[...l,s])}},[$]);const K=r.useCallback(async()=>{if(!(i||p)){o(!0),d("正在连接..."),b("");try{const s=await(await fetch("/api/cecelia/realtime-token",{method:"POST"})).json();if(!s.success||!s.token)throw new Error(s.error||"获取 token 失败");const l=s.token;console.log("Got token, setting up WebRTC...");const n=new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"}]});C.current=n;const a=document.createElement("audio");a.autoplay=!0,T.current=a,n.ontrack=y=>{console.log("Received remote track"),a.srcObject=y.streams[0]};const N=await navigator.mediaDevices.getUserMedia({audio:!0});E.current=N,n.addTrack(N.getTracks()[0]),console.log("Added local audio track");const S=n.createDataChannel("oai-events");f.current=S,S.onopen=()=>{console.log("Data channel open"),o(!1),k(!0),d("已连接，请说话..."),S.send(JSON.stringify({type:"session.update",session:{instructions:"你是 Cecelia，AI 开发助手。用简洁的中文回复用户的问题。当用户描述一个功能需求时，帮助他们创建开发任务。",input_audio_transcription:{model:"whisper-1"}}}))},S.onmessage=y=>{var B,F,W;const c=JSON.parse(y.data);if(console.log("DC message:",c.type),c.type==="error"&&(console.error("Realtime error:",c),d("错误: "+(((B=c.error)==null?void 0:B.message)||JSON.stringify(c.error)))),c.type==="input_audio_buffer.speech_started"&&d("正在听..."),c.type==="input_audio_buffer.speech_stopped"&&d("处理中..."),c.type==="conversation.item.input_audio_transcription.completed"&&d("你: "+c.transcript),c.type==="response.audio_transcript.delta"&&b(j=>j+(c.delta||"")),c.type==="response.audio_transcript.done"&&console.log("AI response complete"),c.type==="response.done"){const j=(W=(F=c.response)==null?void 0:F.output)==null?void 0:W[0];if((j==null?void 0:j.type)==="function_call"&&j.name==="create_task"){const z=JSON.parse(j.arguments);U(z.title,z.description)}}},S.onerror=y=>{console.error("Data channel error:",y)};const M=await n.createOffer();await n.setLocalDescription(M),console.log("Created local offer");const R=await fetch("https://api.openai.com/v1/realtime/calls",{method:"POST",headers:{Authorization:`Bearer ${l}`,"Content-Type":"application/sdp"},body:M.sdp});if(!R.ok){const y=await R.text();throw new Error(`SDP exchange failed: ${R.status} - ${y}`)}const q=await R.text();console.log("Got remote answer"),await n.setRemoteDescription({type:"answer",sdp:q}),console.log("WebRTC connection established")}catch(t){console.error("Failed to start voice:",t),d("启动失败: "+(t instanceof Error?t.message:String(t))),o(!1),A()}}},[i,p]),A=r.useCallback(()=>{f.current&&(f.current.close(),f.current=null),E.current&&(E.current.getTracks().forEach(t=>t.stop()),E.current=null),C.current&&(C.current.close(),C.current=null),T.current&&(T.current.srcObject=null,T.current=null),k(!1),o(!1)},[]),J=r.useCallback(()=>{!m.trim()||!f.current||f.current.readyState!=="open"||(f.current.send(JSON.stringify({type:"conversation.item.create",item:{type:"message",role:"user",content:[{type:"input_text",text:m}]}})),f.current.send(JSON.stringify({type:"response.create"})),d("你: "+m),b(""),D(""))},[m]),U=async(t,s)=>{try{const n=await(await fetch("/api/cecelia/tasks",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({title:t,description:s})})).json();h(a=>[...a,n])}catch(l){console.error("Failed to create task:",l)}},L=t=>{switch(t){case"completed":return e.jsx(te,{className:"w-5 h-5 text-green-400"});case"running":return e.jsx(G,{className:"w-5 h-5 text-blue-400 animate-spin"});case"failed":return e.jsx(ee,{className:"w-5 h-5 text-red-400"});default:return e.jsx(Z,{className:"w-5 h-5 text-slate-500"})}},X=t=>{switch(t){case"completed":return"border-green-500 bg-green-500/10";case"running":return"border-blue-500 bg-blue-500/10 ring-2 ring-blue-500/30";case"failed":return"border-red-500 bg-red-500/10";default:return"border-slate-600 bg-slate-800/50"}},u=_||x.find(t=>t.status==="running")||x[0];return e.jsxs("div",{className:"h-full relative overflow-hidden",children:[e.jsx("div",{className:"absolute left-0 top-0 bottom-0 w-64 bg-slate-900/80 backdrop-blur border-r border-indigo-500/20 overflow-y-auto z-10",children:e.jsxs("div",{className:"p-4",children:[e.jsx("h3",{className:"text-sm font-semibold text-slate-300 mb-3",children:"任务列表"}),x.length===0?e.jsx("p",{className:"text-xs text-slate-500",children:"暂无任务，点击麦克风创建"}):e.jsx("div",{className:"space-y-2",children:x.map(t=>e.jsxs("button",{onClick:()=>O(t),className:`w-full text-left p-3 rounded-lg border transition-all ${(u==null?void 0:u.id)===t.id?"border-purple-500 bg-purple-500/10":"border-slate-700 bg-slate-800/50 hover:border-slate-600"}`,children:[e.jsxs("div",{className:"flex items-center gap-2",children:[L(t.status),e.jsx("span",{className:"text-sm text-slate-200 truncate",children:t.branch})]}),e.jsx("div",{className:"text-xs text-slate-500 mt-1",children:t.project})]},t.id))})]})}),e.jsx("div",{className:"ml-64 h-full",children:u?e.jsxs("svg",{className:"w-full h-full",children:[I.slice(0,-1).map((t,s)=>{const l=v[s],n=v[s+1],a=u.currentStep>s;return e.jsx("line",{x1:l.x+50,y1:l.y,x2:n.x-50,y2:n.y,stroke:a?"#8b5cf6":"#334155",strokeWidth:a?3:2,strokeDasharray:a?"":"5,5"},`line-${s}`)}),I.map((t,s)=>{var N;const l=v[s],n=(N=u.checkpoints)==null?void 0:N[s],a=(n==null?void 0:n.status)||(u.currentStep>s?"completed":u.currentStep===s?"running":"pending");return e.jsxs("g",{transform:`translate(${l.x-50}, ${l.y-35})`,children:[e.jsx("rect",{width:100,height:70,rx:12,className:`${X(a)} transition-all duration-300`,style:{stroke:"currentColor",strokeWidth:2}}),e.jsx("foreignObject",{x:38,y:8,width:24,height:24,children:L(a)}),e.jsx("text",{x:50,y:50,textAnchor:"middle",className:"text-sm font-medium fill-slate-200",children:t})]},t)}),e.jsx("text",{x:v[0].x,y:100,className:"text-lg font-bold fill-slate-200",children:u.branch}),e.jsxs("text",{x:v[0].x,y:125,className:"text-sm fill-slate-400",children:[u.project," · ",u.status]})]}):e.jsx("div",{className:"h-full flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx(H,{className:"w-16 h-16 text-slate-600 mx-auto mb-4"}),e.jsx("p",{className:"text-slate-400",children:"点击右下角麦克风开始语音对话"}),e.jsx("p",{className:"text-sm text-slate-500 mt-2",children:"或在下方输入框输入文字"})]})})}),e.jsxs("div",{className:"absolute top-4 right-4 flex items-center gap-2 px-3 py-1.5 rounded-full bg-slate-900/80 border border-slate-700",children:[e.jsx("span",{className:`w-2 h-2 rounded-full ${P?"bg-green-500":"bg-red-500"}`}),e.jsx("span",{className:"text-xs text-slate-400",children:P?"SSE 已连接":"SSE 未连接"})]}),(g||w)&&e.jsx("div",{className:"absolute bottom-32 left-1/2 -translate-x-1/2 max-w-lg w-full px-4",children:e.jsxs("div",{className:"bg-slate-900/90 border border-purple-500/30 rounded-lg p-4 space-y-2",children:[g&&e.jsx("p",{className:"text-sm text-slate-300",children:g}),w&&e.jsxs("p",{className:"text-sm text-purple-300",children:["Cecelia: ",w]})]})}),e.jsx("div",{className:"absolute bottom-20 left-1/2 -translate-x-1/2 max-w-lg w-full px-4",children:e.jsxs("div",{className:"flex gap-2",children:[e.jsx("input",{type:"text",value:m,onChange:t=>D(t.target.value),onKeyDown:t=>t.key==="Enter"&&J(),placeholder:i?"连接中可输入文字...":"点击麦克风或输入文字...",disabled:!i,className:"flex-1 bg-slate-800/80 border border-slate-600 rounded-lg px-4 py-2 text-sm text-slate-200 placeholder-slate-500 focus:outline-none focus:border-purple-500 disabled:opacity-50"}),e.jsx("button",{onClick:J,disabled:!i||!m.trim(),className:"px-4 py-2 bg-purple-600 hover:bg-purple-700 disabled:bg-slate-600 disabled:cursor-not-allowed rounded-lg transition-colors",children:e.jsx(Q,{className:"w-4 h-4 text-white"})})]})}),e.jsx("button",{onClick:i?A:K,disabled:p,className:`w-16 h-16 rounded-full flex items-center justify-center transition-all shadow-2xl z-50 ${i?"bg-red-500 hover:bg-red-600 animate-pulse":p?"bg-slate-600 cursor-wait":"bg-purple-600 hover:bg-purple-700 hover:scale-110"}`,style:{position:"absolute",bottom:"32px",right:"32px",boxShadow:"0 0 30px rgba(147, 51, 234, 0.5)"},children:p?e.jsx(G,{className:"w-7 h-7 text-white animate-spin"}):i?e.jsx(V,{className:"w-7 h-7 text-white"}):e.jsx(Y,{className:"w-7 h-7 text-white"})})]})}export{ne as default};

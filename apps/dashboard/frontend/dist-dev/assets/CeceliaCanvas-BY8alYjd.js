import{r as a,j as d,L as H,bp as B,bq as K}from"./index-BfzjYRpn.js";import{c as O,T as Q}from"./tldraw-CgSctpjD.js";import"./index-BtNwh5yq.js";const Z=[{type:"function",name:"canvas_draw_shape",description:"在画布上绘制形状。支持矩形、圆形、箭头、线条等。",parameters:{type:"object",properties:{shape:{type:"string",enum:["rectangle","ellipse","arrow","line","text"],description:"形状类型"},x:{type:"number",description:"X 坐标",default:200},y:{type:"number",description:"Y 坐标",default:200},width:{type:"number",description:"宽度",default:200},height:{type:"number",description:"高度",default:100},color:{type:"string",description:"颜色",default:"blue"},text:{type:"string",description:"文本内容（用于 text 类型）"}},required:["shape"]}},{type:"function",name:"canvas_add_text",description:"在画布上添加文本",parameters:{type:"object",properties:{text:{type:"string",description:"文本内容"},x:{type:"number",description:"X 坐标",default:200},y:{type:"number",description:"Y 坐标",default:200},size:{type:"string",enum:["s","m","l","xl"],default:"m"}},required:["text"]}},{type:"function",name:"canvas_draw_flowchart",description:"绘制流程图。提供节点和连接，自动布局。",parameters:{type:"object",properties:{nodes:{type:"array",items:{type:"object",properties:{id:{type:"string"},label:{type:"string"},type:{type:"string",enum:["start","end","process","decision"]}}},description:"节点列表"},edges:{type:"array",items:{type:"object",properties:{from:{type:"string"},to:{type:"string"},label:{type:"string"}}},description:"连接列表"}},required:["nodes","edges"]}},{type:"function",name:"canvas_clear",description:"清空画布",parameters:{type:"object",properties:{},required:[]}},{type:"function",name:"cecelia_create_task",description:"创建开发任务",parameters:{type:"object",properties:{title:{type:"string",description:"任务标题"},description:{type:"string",description:"任务描述"}},required:["title","description"]}},{type:"function",name:"cecelia_list_tasks",description:"列出所有任务",parameters:{type:"object",properties:{},required:[]}},{type:"function",name:"cecelia_health_check",description:"检查系统状态",parameters:{type:"object",properties:{},required:[]}}],ee=`你是 Cecelia，一个运行在 VPS 上的 AI 开发助手，配合万能画布工作。

你的能力：
1. 画布操作：canvas_draw_shape, canvas_add_text, canvas_draw_flowchart, canvas_clear
2. 任务管理：cecelia_create_task, cecelia_list_tasks
3. 系统状态：cecelia_health_check

当用户想要可视化想法时：
- "画一个流程图" → 使用 canvas_draw_flowchart
- "画一个矩形/圆形" → 使用 canvas_draw_shape
- "写点文字" → 使用 canvas_add_text
- "清空画布" → 使用 canvas_clear

规则：
- 必须通过工具执行操作
- 用简洁的中文回复
- 画图时选择合适的位置和颜色`;function oe(){const[h,I]=a.useState(!1),[b,S]=a.useState(!1),[x,u]=a.useState(""),[k,C]=a.useState(""),[N,Y]=a.useState(""),[A,V]=a.useState("shimmer"),[te,X]=a.useState(!1),[re,U]=a.useState(null),R=a.useRef(null),i=a.useRef(null),j=a.useRef(null),E=a.useRef(null),w=a.useRef(null),$={blue:"blue",red:"red",green:"green",yellow:"yellow",orange:"orange",violet:"violet",black:"black",grey:"grey",white:"white"},v=a.useCallback(t=>{const e=w.current;if(console.log("[drawShape] args:",t),!e)return console.error("[drawShape] Editor not ready!"),{success:!1,error:"Editor not ready"};const{shape:o,x:s=200,y:n=200,width:m=200,height:l=100,color:y="blue",text:c}=t,r=O(),f=$[y]||"blue";try{switch(o){case"rectangle":e.createShape({id:r,type:"geo",x:Number(s),y:Number(n),props:{geo:"rectangle",w:Number(m),h:Number(l),color:f,fill:"none",dash:"draw",size:"m"}});break;case"ellipse":e.createShape({id:r,type:"geo",x:Number(s),y:Number(n),props:{geo:"ellipse",w:Number(m),h:Number(l),color:f,fill:"none",dash:"draw",size:"m"}});break;case"text":e.createShape({id:r,type:"text",x:Number(s),y:Number(n),props:{text:String(c||"Text"),color:f,size:"m"}});break;case"arrow":e.createShape({id:r,type:"arrow",x:Number(s),y:Number(n),props:{color:f,fill:"none",dash:"draw",size:"m"}});break}return setTimeout(()=>{e.zoomToFit({animation:{duration:200}})},100),{success:!0,shape_id:r}}catch(g){return console.error("[drawShape] Error:",g),{success:!1,error:String(g)}}},[]),J=a.useCallback(t=>{const e=w.current;if(!e)return{success:!1,error:"Editor not ready"};const{text:o,x:s=200,y:n=200,size:m="m"}=t,l=O();try{return e.createShape({id:l,type:"text",x:Number(s),y:Number(n),props:{text:String(o),size:String(m)}}),{success:!0,shape_id:l}}catch(y){return console.error("[addText] Error:",y),{success:!1,error:String(y)}}},[]),z=a.useCallback(t=>{const e=w.current;if(!e)return{success:!1,error:"Editor not ready"};const{nodes:o=[],edges:s=[]}=t,n=new Map,m=100,l=100,y=150,c=60,r=200,f=120,g=p=>p==="start"?"green":p==="end"?"red":"blue";try{return o.forEach((p,T)=>{const _=Math.floor(T/3),W=T%3,q=Number(m+W*r),M=Number(l+_*f),F=O();e.createShape({id:F,type:"geo",x:q,y:M,props:{geo:p.type==="decision"?"diamond":"rectangle",w:Number(y),h:Number(c),color:g(p.type),fill:"none",dash:"draw",size:"m"}}),n.set(p.id,{x:q+y/2,y:M+c/2,shapeId:F})}),setTimeout(()=>{e.zoomToFit({animation:{duration:200}})},100),{success:!0,nodes_created:o.length,edges_skipped:s.length}}catch(p){return console.error("[drawFlowchart] Error:",p),{success:!1,error:String(p)}}},[]),L=a.useCallback(()=>{const t=w.current;if(!t)return{success:!1,error:"Editor not ready"};try{const e=t.getCurrentPageShapeIds();return t.deleteShapes([...e]),{success:!0}}catch(e){return{success:!1,error:String(e)}}},[]),D=a.useCallback(async(t,e,o)=>{console.log("Tool call:",t,e),console.log("[handleToolCall] drawShape function:",typeof v,v);let s;switch(t){case"canvas_draw_shape":console.log("[handleToolCall] Calling drawShape..."),s=v(e),console.log("[handleToolCall] drawShape result:",s);break;case"canvas_add_text":s=J(e);break;case"canvas_draw_flowchart":s=z(e);break;case"canvas_clear":s=L();break;case"cecelia_create_task":{s=await(await fetch("/api/cecelia/tasks",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)})).json();break}case"cecelia_list_tasks":{s=await(await fetch("/api/cecelia/runs")).json();break}case"cecelia_health_check":{s=await(await fetch("/api/cecelia/health")).json();break}default:s={error:`Unknown tool: ${t}`}}return i.current&&i.current.readyState==="open"&&(i.current.send(JSON.stringify({type:"conversation.item.create",item:{type:"function_call_output",call_id:o,output:JSON.stringify(s)}})),i.current.send(JSON.stringify({type:"response.create"}))),s},[v,J,z,L]),G=a.useCallback(async()=>{var t;if(!(h||b)){S(!0),u("正在连接..."),C("");try{const e=new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"}]});R.current=e;const o=document.createElement("audio");o.autoplay=!0,j.current=o,e.ontrack=c=>{o.srcObject=c.streams[0]};const s=await navigator.mediaDevices.getUserMedia({audio:!0});E.current=s,e.addTrack(s.getTracks()[0]);const n=e.createDataChannel("oai-events");i.current=n,n.onopen=()=>{S(!1),I(!0),u("已连接，请说话...");const c={type:"session.update",session:{instructions:ee,tools:Z,tool_choice:"auto",input_audio_transcription:{model:"whisper-1"}}};console.log("[Cecelia] session.update:",JSON.stringify(c,null,2)),n.send(JSON.stringify(c))},n.onmessage=c=>{var f;const r=JSON.parse(c.data);if(console.log("[Cecelia] 收到消息:",r.type),(r.type.includes("session")||r.type.includes("error")||r.type.includes("function")||r.type.includes("response"))&&console.log("[Cecelia] 详情:",r),r.type==="error"&&(console.error("Realtime error:",r),u("错误: "+(((f=r.error)==null?void 0:f.message)||JSON.stringify(r.error)))),r.type==="input_audio_buffer.speech_started"&&(u("正在听..."),C("")),r.type==="input_audio_buffer.speech_stopped"&&u("处理中..."),r.type==="conversation.item.input_audio_transcription.completed"&&u("你: "+r.transcript),r.type==="response.output_audio_transcript.delta"&&C(g=>g+(r.delta||"")),r.type==="response.function_call_arguments.done"){const{call_id:g,name:p,arguments:T}=r;try{const _=JSON.parse(T);u(`正在执行: ${p}...`),D(p,_,g)}catch(_){console.error("Failed to parse function args:",_)}}},await e.setLocalDescription(),await new Promise(c=>{e.iceGatheringState==="complete"?c():(e.onicegatheringstatechange=()=>{e.iceGatheringState==="complete"&&c()},setTimeout(c,3e3))});const l=await(await fetch("/api/cecelia/realtime-sdp",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({sdp:(t=e.localDescription)==null?void 0:t.sdp,model:"gpt-4o-realtime-preview-2024-12-17"})})).json();if(!l.success)throw console.error("SDP exchange error:",l.error),new Error(`SDP exchange failed: ${l.error}`);const y=l.sdp;await e.setRemoteDescription({type:"answer",sdp:y})}catch(e){console.error("Failed to start voice:",e),u("启动失败: "+(e instanceof Error?e.message:String(e))),S(!1),P()}}},[h,b,A,D]),P=a.useCallback(()=>{var t,e,o;(t=i.current)==null||t.close(),i.current=null,(e=E.current)==null||e.getTracks().forEach(s=>s.stop()),E.current=null,(o=R.current)==null||o.close(),R.current=null,j.current&&(j.current.srcObject=null,j.current=null),I(!1),S(!1)},[]);return a.useCallback(()=>{!N.trim()||!i.current||i.current.readyState!=="open"||(i.current.send(JSON.stringify({type:"conversation.item.create",item:{type:"message",role:"user",content:[{type:"input_text",text:N}]}})),i.current.send(JSON.stringify({type:"response.create"})),u("你: "+N),C(""),Y(""))},[N]),a.useCallback(t=>{V(t),h&&i.current&&i.current.readyState==="open"&&i.current.send(JSON.stringify({type:"session.update",session:{audio:{output:{voice:t}}}})),X(!1)},[h]),console.log("[CeceliaCanvas] Render - transcript:",x,"aiResponse:",k,"isListening:",h),d.jsxs("div",{style:{position:"absolute",top:0,left:0,right:0,bottom:0,display:"flex",flexDirection:"column"},children:[d.jsx("div",{style:{flex:1,position:"relative"},children:d.jsx(Q,{onMount:t=>{console.log("[Tldraw] Editor mounted"),w.current=t,U(t)}})}),d.jsxs("div",{style:{height:70,padding:"10px 16px",backgroundColor:"#0f172a",borderTop:"1px solid #334155",display:"flex",alignItems:"center",justifyContent:"center",gap:12,flexShrink:0},children:[(x||k)&&d.jsxs("div",{style:{flex:1,maxWidth:400,padding:"6px 12px",backgroundColor:"rgba(30, 41, 59, 0.9)",borderRadius:8,fontSize:12},children:[x&&d.jsx("span",{style:{color:"#94a3b8"},children:x}),k&&d.jsx("span",{style:{color:"#c4b5fd",marginLeft:8},children:k})]}),d.jsx("button",{onClick:h?P:G,disabled:b,style:{width:50,height:50,borderRadius:"50%",border:"none",cursor:b?"wait":"pointer",backgroundColor:h?"#ef4444":b?"#475569":"#7c3aed",display:"flex",alignItems:"center",justifyContent:"center"},children:b?d.jsx(H,{className:"w-6 h-6 text-white animate-spin"}):h?d.jsx(B,{className:"w-6 h-6 text-white"}):d.jsx(K,{className:"w-6 h-6 text-white"})})]})]})}export{oe as default};

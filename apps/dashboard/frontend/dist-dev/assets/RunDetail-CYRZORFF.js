import{a7 as B,r as d,j as e,R as C,ab as p,G as k,aA as G,W as K,L as b,Y as m,a0 as N,aF as T,z as q}from"./index-X_gQAix8.js";const o=[{id:1,name:"PRD"},{id:2,name:"Branch"},{id:3,name:"QA"},{id:4,name:"DoD"},{id:5,name:"Code"},{id:6,name:"Audit"},{id:7,name:"Test"},{id:8,name:"PR"},{id:9,name:"CI"}];function H(){const{runId:x}=B(),[t,R]=d.useState(null),[l,$]=d.useState([]),[h,D]=d.useState([]),[v,P]=d.useState(!0),u=async()=>{var s;if(x)try{const a=await(await fetch(`/api/cecelia/runs/${x}`)).json();if(a.success&&(R(a.run),$(a.checkpoints||[]),(s=a.run)!=null&&s.project)){const i=await(await fetch("/api/cecelia/overview?limit=100")).json();if(i.success){const j=a.run.feature_branch||"",E=S(j),A=i.recent_runs.filter(f=>f.id===x||f.project!==a.run.project?!1:E.some(F=>{var _;return(_=f.feature_branch)==null?void 0:_.toLowerCase().includes(F.toLowerCase())}));D(A.slice(0,5))}}}catch(n){console.error(n)}finally{P(!1)}},S=s=>s.replace(/^(cp-|feature\/|feat\/|fix\/)/,"").replace(/^\d+-/,"").replace(/-\d+$/,"").split(/[-_]/).filter(r=>r.length>2&&!/^\d+$/.test(r));d.useEffect(()=>{u();const s=setInterval(u,5e3);return()=>clearInterval(s)},[x]);const g=l.findIndex(s=>s.status==="in_progress"),c=g>=0?l[g]:null,I=()=>{if(!c||!t)return l.length>0&&l.every(a=>a.status==="done")?o.map(a=>({...a,status:"done"})):o.map(a=>({...a,status:"pending"}));const s=t.current_step||1;return o.map(n=>({...n,status:n.id<s?"done":n.id===s?"in_progress":"pending"}))};if(v)return e.jsx("div",{className:"min-h-screen bg-[#191919] flex items-center justify-center",children:e.jsx(C,{className:"w-5 h-5 text-gray-400 animate-spin"})});if(!t)return e.jsx("div",{className:"min-h-screen bg-[#191919]",children:e.jsxs("div",{className:"max-w-5xl mx-auto px-6 py-8",children:[e.jsxs(p,{to:"/cecelia",className:"text-gray-400 hover:text-white flex items-center gap-2 text-sm",children:[e.jsx(k,{className:"w-4 h-4"})," Engine 工作台"]}),e.jsx("div",{className:"text-gray-500 text-center py-12",children:"任务不存在"})]})});const w=I(),L=l.filter(s=>s.status==="done").length,y=t.current_step?o.find(s=>s.id===t.current_step):null;return e.jsx("div",{className:"min-h-screen bg-[#191919]",children:e.jsxs("div",{className:"max-w-5xl mx-auto px-6 py-8",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsxs(p,{to:`/cecelia/project/${encodeURIComponent(t.project)}`,className:"text-gray-400 hover:text-white flex items-center gap-2 text-sm",children:[e.jsx(k,{className:"w-4 h-4"})," ",t.project]}),e.jsx("button",{onClick:u,className:"p-2 text-gray-500 hover:text-white rounded-lg hover:bg-white/5",children:e.jsx(C,{className:`w-4 h-4 ${v?"animate-spin":""}`})})]}),e.jsxs("div",{className:"mb-8",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-2",children:[t.status==="running"&&e.jsx("span",{className:"w-3 h-3 bg-blue-500 rounded-full animate-pulse"}),t.status==="completed"&&e.jsx("span",{className:"w-3 h-3 bg-green-500 rounded-full"}),t.status==="failed"&&e.jsx("span",{className:"w-3 h-3 bg-red-500 rounded-full"}),t.status==="pending"&&e.jsx("span",{className:"w-3 h-3 bg-gray-500 rounded-full"}),e.jsx("h1",{className:"text-3xl font-bold text-white tracking-tight",children:t.prd_title||t.feature_branch})]}),e.jsxs("div",{className:"flex items-center gap-4 text-sm text-gray-400 mt-2",children:[e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(G,{className:"w-4 h-4"}),t.feature_branch]}),t.pr_url&&e.jsxs("a",{href:t.pr_url,target:"_blank",rel:"noopener noreferrer",className:"text-blue-400 hover:underline flex items-center gap-1",children:[e.jsx(K,{className:"w-4 h-4"})," Pull Request"]})]})]}),t.status==="running"&&c&&e.jsx("div",{className:"mb-8 bg-blue-500/10 border border-blue-500/30 rounded-2xl p-5",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(b,{className:"w-5 h-5 text-blue-400 animate-spin"}),e.jsxs("div",{children:[e.jsxs("div",{className:"text-white font-medium",children:["正在执行 ",c.checkpoint_id,": ",c.name]}),y&&e.jsxs("div",{className:"text-sm text-blue-400 mt-1",children:["Step ",t.current_step,"/9 - ",y.name,t.current_action&&e.jsxs("span",{className:"text-gray-400 ml-2",children:["· ",t.current_action]})]})]})]}),e.jsxs("div",{className:"text-right",children:[e.jsxs("div",{className:"text-2xl font-bold text-blue-400",children:[g+1,"/",l.length]}),e.jsx("div",{className:"text-xs text-gray-500",children:"Checkpoint"})]})]})}),l.length>0&&e.jsxs("div",{className:"mb-8",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h2",{className:"text-lg font-semibold text-white",children:"Checkpoints"}),e.jsxs("span",{className:"text-sm text-gray-500",children:[L,"/",l.length," 完成"]})]}),e.jsx("div",{className:"bg-[#202020] rounded-2xl border border-[#303030] p-6",children:e.jsx("div",{className:"flex items-center",children:l.map((s,n)=>{const a=s.status==="done",r=s.status==="in_progress",i=s.status==="failed",j=s.status==="pending";return e.jsxs("div",{className:"flex items-center flex-1",children:[e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsxs("div",{className:`w-14 h-14 rounded-full flex items-center justify-center transition relative ${a?"bg-green-500":r?"bg-blue-500":i?"bg-red-500":"bg-[#303030]"}`,children:[r&&e.jsx("div",{className:"absolute -top-1 -right-1 w-4 h-4 bg-yellow-400 rounded-full flex items-center justify-center",children:e.jsx("span",{className:"text-[10px] text-black font-bold",children:"!"})}),a&&e.jsx(m,{className:"w-7 h-7 text-white"}),r&&e.jsx(b,{className:"w-7 h-7 text-white animate-spin"}),i&&e.jsx(N,{className:"w-7 h-7 text-white"}),j&&e.jsx("span",{className:"text-gray-400 font-bold text-lg",children:s.checkpoint_id.replace("CP-0","").replace("CP-","")})]}),e.jsxs("div",{className:"mt-3 text-center",children:[e.jsx("div",{className:`text-xs font-mono font-medium ${a?"text-green-400":r?"text-blue-400":i?"text-red-400":"text-gray-600"}`,children:s.checkpoint_id}),e.jsx("div",{className:`text-sm mt-1 max-w-[80px] leading-tight ${r?"text-white font-medium":a?"text-gray-300":"text-gray-500"}`,children:s.name||""})]})]}),n<l.length-1&&e.jsx("div",{className:`flex-1 h-1 mx-2 rounded ${a?"bg-green-500":"bg-[#303030]"}`})]},s.checkpoint_id)})})})]}),e.jsxs("div",{className:"mb-8",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("h2",{className:"text-lg font-semibold text-white",children:["Dev 流程",c&&e.jsx("span",{className:"text-blue-400 font-mono ml-2",children:c.checkpoint_id})]}),t.status==="running"&&t.current_step&&e.jsxs("span",{className:"text-sm text-blue-400",children:["Step ",t.current_step,"/9"]})]}),e.jsx("div",{className:"bg-[#202020] rounded-2xl border border-[#303030] p-6",children:e.jsx("div",{className:"flex items-center",children:w.map((s,n)=>{const a=s.status==="done",r=s.status==="in_progress",i=s.status==="pending";return e.jsxs("div",{className:"flex items-center flex-1",children:[e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsxs("div",{className:`w-10 h-10 rounded-full flex items-center justify-center transition relative ${a?"bg-green-500":r?"bg-blue-500":"bg-[#303030]"}`,children:[r&&e.jsx("div",{className:"absolute -top-0.5 -right-0.5 w-3 h-3 bg-yellow-400 rounded-full"}),a&&e.jsx(m,{className:"w-5 h-5 text-white"}),r&&e.jsx(b,{className:"w-5 h-5 text-white animate-spin"}),i&&e.jsx("span",{className:"text-gray-500 text-sm font-medium",children:s.id})]}),e.jsx("span",{className:`mt-2 text-xs ${a?"text-green-400":r?"text-blue-400 font-medium":"text-gray-600"}`,children:s.name})]}),n<w.length-1&&e.jsx("div",{className:`flex-1 h-0.5 mx-1 rounded ${a?"bg-green-500":"bg-[#303030]"}`})]},s.id)})})})]}),t.status==="completed"&&e.jsxs("div",{className:"mb-8 bg-green-500/10 border border-green-500/30 rounded-2xl p-5 flex items-center gap-3",children:[e.jsx(m,{className:"w-6 h-6 text-green-400"}),e.jsxs("div",{children:[e.jsx("div",{className:"text-green-300 font-medium",children:"任务已完成"}),e.jsxs("div",{className:"text-sm text-gray-400 mt-1",children:["所有 ",l.length," 个 Checkpoints 已通过"]})]})]}),t.status==="failed"&&e.jsxs("div",{className:"mb-8 bg-red-500/10 border border-red-500/30 rounded-2xl p-5 flex items-center gap-3",children:[e.jsx(N,{className:"w-6 h-6 text-red-400"}),e.jsxs("div",{children:[e.jsx("div",{className:"text-red-300 font-medium",children:"任务执行失败"}),t.current_action&&e.jsx("div",{className:"text-sm text-gray-400 mt-1",children:t.current_action})]})]}),h.length>0&&e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[e.jsx(T,{className:"w-5 h-5 text-gray-400"}),e.jsx("h2",{className:"text-lg font-semibold text-white",children:"相关任务"})]}),e.jsx("div",{className:"bg-[#202020] rounded-2xl border border-[#303030] overflow-hidden",children:h.map((s,n)=>e.jsxs(p,{to:`/cecelia/runs/${s.id}`,className:`flex items-center justify-between px-5 py-4 hover:bg-white/5 transition ${n<h.length-1?"border-b border-[#303030]":""}`,children:[e.jsxs("div",{className:"flex items-center gap-3",children:[s.status==="running"&&e.jsx("span",{className:"w-2 h-2 bg-blue-400 rounded-full animate-pulse"}),s.status==="completed"&&e.jsx(m,{className:"w-4 h-4 text-green-400"}),s.status==="failed"&&e.jsx(N,{className:"w-4 h-4 text-red-400"}),e.jsx("span",{className:s.status==="completed"?"text-gray-300":"text-white",children:s.prd_title||s.feature_branch})]}),e.jsx(q,{className:"w-4 h-4 text-gray-600"})]},s.id))})]})]})})}export{H as default};

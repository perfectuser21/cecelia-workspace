import{r as g,j as e,R as k,A as T,$,_ as S,ax as C,av as A,aq as M,aC as D,C as q}from"./index-B5aDd_jC.js";import{g as I}from"./dev-tracker.api-CFjw6oWP.js";import"./client-2fFfTFJr.js";import"./index-B9ygI19o.js";function L(m,u){const{task:i,steps:a,repo:N,branches:f,quality:l}=m;let x="pending";const c=a.items.find(s=>s.status==="in_progress"),p=a.items.find(s=>s.status==="failed"),j=a.items.every(s=>s.status==="done"||s.status==="skipped");p||l.ci==="failed"?x="failed":j?x="completed":(c||a.current>0)&&(x="running");const v=a.items.filter(s=>s.status==="done"||s.status==="skipped").length,b=Math.round(v/a.total*100),y=c?`Step ${c.id}: ${c.name}`:j?"已完成":p?`Step ${p.id}: ${p.name} (失败)`:`Step ${a.current}: 进行中`,w=new Date(i.createdAt),n=new Date().getTime()-w.getTime(),r=Math.floor(n/6e4),d=r>=60?`${Math.floor(r/60)}h ${r%60}m`:`${r}m`,o=[];for(const s of a.items)if(s.status==="done"&&s.completedAt){const h=new Date(s.completedAt).toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit"});o.push(`[${h}] Step ${s.id}: ${s.name} 完成`)}else if(s.status==="failed"){const h=s.completedAt?new Date(s.completedAt).toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit"}):"--:--";o.push(`[${h}] ❌ Step ${s.id}: ${s.name} 失败`)}else if(s.status==="in_progress"&&s.startedAt){const h=new Date(s.startedAt).toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit"});o.push(`[${h}] Step ${s.id}: ${s.name} 进行中...`)}return{id:String(u+1),name:i.name||f.current,project:N.name,branch:f.current,status:x,progress:b,currentStep:y,startedAt:i.createdAt,duration:d,logs:o.length>0?o:["[--:--] 任务开始"]}}function B(){const[m,u]=g.useState([]),[i,a]=g.useState(null),[N,f]=g.useState(!0),[l,x]=g.useState(null),c=async()=>{try{const t=await I();if(t.success&&t.data){const n=t.data.map((d,o)=>L(d,o));u(n);const r=n.filter(d=>d.status==="running").length;a({cpu:Math.min(30+r*15,95),memory:Math.min(40+r*10,90),activeTasks:r,queuedTasks:n.filter(d=>d.status==="pending").length})}else u([]),a({cpu:10,memory:25,activeTasks:0,queuedTasks:0})}catch{u([]),a({cpu:10,memory:25,activeTasks:0,queuedTasks:0})}finally{f(!1)}};g.useEffect(()=>{c();const t=setInterval(c,3e3);return()=>clearInterval(t)},[]);const p=t=>{switch(t){case"completed":return e.jsx($,{className:"w-5 h-5 text-emerald-500"});case"running":return e.jsx(k,{className:"w-5 h-5 text-cyan-500 animate-spin"});case"failed":return e.jsx(S,{className:"w-5 h-5 text-red-500"});default:return e.jsx(q,{className:"w-5 h-5 text-gray-400"})}},j=t=>{switch(t){case"completed":return"bg-emerald-500";case"running":return"bg-cyan-500";case"failed":return"bg-red-500";default:return"bg-gray-400"}},v=t=>{const n={completed:"bg-emerald-100 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-400",running:"bg-cyan-100 text-cyan-700 dark:bg-cyan-900/30 dark:text-cyan-400",failed:"bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400",pending:"bg-gray-100 text-gray-700 dark:bg-gray-800 dark:text-gray-400"},r={completed:"已完成",running:"运行中",failed:"失败",pending:"等待中"};return e.jsx("span",{className:`px-2 py-1 text-xs font-medium rounded-full ${n[t]||n.pending}`,children:r[t]||t})};if(N)return e.jsx("div",{className:"flex items-center justify-center h-64",children:e.jsx(k,{className:"w-8 h-8 text-cyan-500 animate-spin"})});const b=m.filter(t=>t.status==="running"),y=m.filter(t=>t.status==="completed"),w=m.filter(t=>t.status==="failed");return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:[e.jsx("div",{className:"bg-gradient-to-br from-cyan-500 to-blue-600 rounded-xl p-5 text-white",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(T,{className:"w-8 h-8 opacity-80"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm opacity-80",children:"运行中"}),e.jsx("p",{className:"text-3xl font-bold",children:b.length})]})]})}),e.jsx("div",{className:"bg-gradient-to-br from-emerald-500 to-green-600 rounded-xl p-5 text-white",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx($,{className:"w-8 h-8 opacity-80"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm opacity-80",children:"已完成"}),e.jsx("p",{className:"text-3xl font-bold",children:y.length})]})]})}),e.jsx("div",{className:"bg-gradient-to-br from-red-500 to-rose-600 rounded-xl p-5 text-white",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(S,{className:"w-8 h-8 opacity-80"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm opacity-80",children:"失败"}),e.jsx("p",{className:"text-3xl font-bold",children:w.length})]})]})}),e.jsx("div",{className:"bg-gradient-to-br from-slate-700 to-slate-800 rounded-xl p-5 text-white",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(C,{className:"w-8 h-8 opacity-80"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm opacity-80",children:"服务器"}),e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(A,{className:"w-4 h-4"}),e.jsxs("span",{children:[i==null?void 0:i.cpu,"%"]}),e.jsx("span",{className:"opacity-50",children:"|"}),e.jsxs("span",{children:[i==null?void 0:i.memory,"% RAM"]})]})]})]})})]}),e.jsxs("div",{className:"bg-white dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700 overflow-hidden",children:[e.jsx("div",{className:"p-4 border-b border-slate-200 dark:border-slate-700",children:e.jsxs("h2",{className:"text-lg font-semibold text-slate-900 dark:text-white flex items-center gap-2",children:[e.jsx(M,{className:"w-5 h-5 text-cyan-500"}),"任务列表"]})}),e.jsx("div",{className:"divide-y divide-slate-200 dark:divide-slate-700",children:m.map(t=>e.jsxs("div",{className:"p-4 hover:bg-slate-50 dark:hover:bg-slate-700/50 cursor-pointer transition-colors",onClick:()=>x((l==null?void 0:l.id)===t.id?null:t),children:[e.jsxs("div",{className:"flex items-center gap-4",children:[p(t.status),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-1",children:[e.jsx("span",{className:"font-mono text-sm font-medium text-slate-900 dark:text-white truncate",children:t.name}),v(t.status)]}),e.jsxs("div",{className:"flex items-center gap-4 text-sm text-slate-500 dark:text-slate-400",children:[e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(D,{className:"w-4 h-4"}),t.project]}),e.jsx("span",{children:t.currentStep})]})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"text-sm text-slate-500 dark:text-slate-400",children:t.duration}),t.status==="running"&&e.jsx("div",{className:"w-24 h-2 bg-slate-200 dark:bg-slate-700 rounded-full mt-2 overflow-hidden",children:e.jsx("div",{className:`h-full ${j(t.status)} transition-all`,style:{width:`${t.progress}%`}})})]})]}),(l==null?void 0:l.id)===t.id&&e.jsxs("div",{className:"mt-4 p-4 bg-slate-900 rounded-lg",children:[e.jsx("p",{className:"text-xs text-slate-400 mb-2 font-mono",children:"执行日志"}),e.jsx("div",{className:"space-y-1 font-mono text-sm",children:t.logs.map((n,r)=>e.jsx("p",{className:`${n.includes("❌")?"text-red-400":n.includes("完成")?"text-emerald-400":"text-slate-300"}`,children:n},`${t.id}-log-${r}`))})]})]},t.id))})]})]})}export{B as default};

import{m as S,l as _,r as a,j as e,b as q}from"./index-BrpX3zYB.js";import{a as j}from"./index-B9ygI19o.js";import{A as E}from"./arrow-left-Bu1lvJRd.js";import{L as N}from"./loader-2-D4NEYREP.js";import{C as I}from"./check-circle-BUx3yS5G.js";import{A}from"./alert-circle-9zYQafBP.js";const y="http://localhost:5679/webhook";function T(){const{platform:o,accountId:u}=S(),d=_(),[n,c]=a.useState("idle"),[g,m]=a.useState(null),[h,i]=a.useState(""),[w,b]=a.useState(""),[v,f]=a.useState(!1),l=a.useCallback(async()=>{try{c("loading"),b(""),m(null);const t=(await j.post(`${y}/douyin-login`,{action:"get-qrcode"})).data;let s=t;if(t.stdout&&typeof t.stdout=="string")try{s=JSON.parse(t.stdout)}catch{s=t}if(s.success&&s.qrcode_base64){const x=s.qrcode_base64,k=x.startsWith("data:")?x:`data:image/png;base64,${x}`;m(k),i(s.message||"请使用抖音 APP 扫描二维码登录"),c("showing_qr")}else throw new Error(s.error||"获取二维码失败")}catch(r){console.error("Failed to get QR code:",r),b(r.message||"获取二维码失败，请重试"),c("error")}},[]),p=a.useCallback(async()=>{try{f(!0);const t=(await j.post(`${y}/douyin-login`,{action:"check-status"})).data;let s=t;if(t.stdout&&typeof t.stdout=="string")try{s=JSON.parse(t.stdout)}catch{s=t}return s.success&&s.status==="logged_in"?(c("success"),i("登录成功！Cookie 已保存"),setTimeout(()=>{d("/accounts")},3e3),!0):((s.status==="expired"||s.status==="failed")&&(i("二维码已过期，请重新获取"),m(null),c("idle")),!1)}catch(r){return console.error("Failed to check login status:",r),!1}finally{f(!1)}},[d]);a.useEffect(()=>{if(n==="showing_qr"){const r=setInterval(async()=>{await p()&&clearInterval(r)},3e3),t=setTimeout(()=>{clearInterval(r),n==="showing_qr"&&i("二维码已过期，请点击刷新重新获取")},12e4);return()=>{clearInterval(r),clearTimeout(t)}}},[n,p]),a.useEffect(()=>{o==="douyin"&&l()},[o,l]);const C=r=>({douyin:"抖音",xhs:"小红书",weibo:"微博",toutiao:"今日头条",shipin:"视频号"})[r]||r;return e.jsx("div",{className:"min-h-screen bg-gray-50 flex flex-col items-center justify-center px-4",children:e.jsxs("div",{className:"max-w-md w-full bg-white rounded-lg shadow-lg p-8",children:[e.jsxs("button",{onClick:()=>d("/accounts"),className:"flex items-center text-gray-600 hover:text-gray-900 mb-6",children:[e.jsx(E,{className:"w-4 h-4 mr-2"}),"返回账号管理"]}),e.jsxs("div",{className:"text-center mb-6",children:[e.jsxs("h2",{className:"text-2xl font-bold text-gray-900 mb-2",children:[C(o||"")," 账号登录"]}),u&&e.jsxs("p",{className:"text-gray-600 text-sm",children:["账号: ",u]})]}),e.jsxs("div",{className:"mb-6",children:[n==="idle"&&e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-gray-700 mb-6",children:"点击下方按钮获取登录二维码"}),e.jsx("button",{onClick:l,className:"w-full inline-flex justify-center items-center px-6 py-3 border border-transparent text-base font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700",children:"获取二维码"})]}),n==="loading"&&e.jsxs("div",{className:"text-center py-8",children:[e.jsx(N,{className:"w-12 h-12 animate-spin text-indigo-600 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-700",children:"正在获取二维码..."})]}),n==="showing_qr"&&g&&e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"bg-white border-2 border-gray-200 rounded-lg p-4 mb-4 inline-block",children:e.jsx("img",{src:g,alt:"登录二维码",className:"w-64 h-64 mx-auto"})}),e.jsxs("div",{className:"bg-blue-50 border border-blue-200 rounded-md p-4 mb-4",children:[e.jsx("p",{className:"text-blue-800 font-medium mb-1",children:h}),e.jsx("p",{className:"text-blue-600 text-sm flex items-center justify-center",children:v?e.jsxs(e.Fragment,{children:[e.jsx(N,{className:"w-4 h-4 animate-spin mr-2"}),"正在检查登录状态..."]}):"扫码后将自动检测登录状态"})]}),e.jsxs("button",{onClick:l,className:"inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50",children:[e.jsx(q,{className:"w-4 h-4 mr-2"}),"刷新二维码"]})]}),n==="success"&&e.jsxs("div",{className:"text-center py-8",children:[e.jsx(I,{className:"w-16 h-16 text-green-500 mx-auto mb-4"}),e.jsxs("div",{className:"bg-green-50 border border-green-200 rounded-md p-4 mb-4",children:[e.jsx("p",{className:"text-green-800 font-medium mb-2",children:"登录成功！"}),e.jsx("p",{className:"text-green-700 text-sm",children:h})]}),e.jsx("p",{className:"text-gray-600 text-sm",children:"3 秒后自动跳转回账号管理页面..."})]}),n==="error"&&e.jsxs("div",{className:"text-center py-8",children:[e.jsx(A,{className:"w-16 h-16 text-red-500 mx-auto mb-4"}),e.jsxs("div",{className:"bg-red-50 border border-red-200 rounded-md p-4 mb-4",children:[e.jsx("p",{className:"text-red-800 font-medium mb-2",children:"获取二维码失败"}),e.jsx("p",{className:"text-red-700 text-sm",children:w})]}),e.jsx("button",{onClick:l,className:"w-full inline-flex justify-center items-center px-6 py-3 border border-transparent text-base font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700",children:"重新尝试"})]})]}),o&&o!=="douyin"&&e.jsx("div",{className:"bg-yellow-50 border border-yellow-200 rounded-md p-4",children:e.jsx("p",{className:"text-yellow-800 text-sm",children:"暂时只支持抖音平台的二维码登录，其他平台即将支持。"})})]})})}export{T as default};

import{c as I,r as m,j as e,A as F,a as L,R as q,Z as H,i as Q,F as V}from"./index-BuPFs-8Q.js";import{a as k}from"./client-DyfwnZmM.js";import{L as $}from"./loader-2-CSp6sEpp.js";import{A as Y}from"./alert-circle-DgeeXCFK.js";import{S as ee,U as te}from"./user-BS7EKgN8.js";import{C as se}from"./check-circle-2-ClqW3yBL.js";import{T as W}from"./terminal-Dav_wMy5.js";import{X as re}from"./x-circle-CsqRG8Fn.js";import{T as ae}from"./trash-2-B1dZXkVJ.js";import{C as ne,a as le}from"./cog-Mdqv9Ugv.js";import{P as ie}from"./play-tKO7GA5e.js";import"./index-B9ygI19o.js";/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const de=I("Ban",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"m4.9 4.9 14.2 14.2",key:"1m5liu"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ce=I("Globe",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M12 2a14.5 14.5 0 0 0 0 20 14.5 14.5 0 0 0 0-20",key:"13o1zl"}],["path",{d:"M2 12h20",key:"9i4pu4"}]]),y={getRuns:async()=>(await k.get("/v1/claude-monitor/runs")).data,getEvents:async(s,l=100)=>(await k.get(`/v1/claude-monitor/runs/${s}/events`,{params:{limit:l}})).data,killRun:async s=>{await k.post(`/v1/claude-monitor/runs/${s}/kill`)},deleteRun:async s=>{await k.delete(`/v1/claude-monitor/runs/${s}`)}};function M(s,l){const a=l||Date.now(),r=Math.floor((a-s)/1e3);if(r<60)return`${r}s`;const o=Math.floor(r/60);return o<60?`${o}m ${r%60}s`:`${Math.floor(o/60)}h ${o%60}m`}function oe(s){return new Date(s).toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit",second:"2-digit"})}function U(s){return s.split("/").slice(-2).join("/")||s}function xe(s,l){const a=s/1e6*3+l/1e6*15;return a===0?"-":a<.01?"<$0.01":`$${a.toFixed(2)}`}function S(s){return s===0?"0":s<1e3?String(s):`${(s/1e3).toFixed(1)}k`}function _(s){return s==="terminal"||s==="manual"}function me(s){switch(s){case"Bash":return e.jsx(W,{className:"w-4 h-4"});case"Read":return e.jsx(V,{className:"w-4 h-4"});case"Edit":case"Write":return e.jsx(Q,{className:"w-4 h-4"});case"WebFetch":case"WebSearch":return e.jsx(ce,{className:"w-4 h-4"});default:return e.jsx(H,{className:"w-4 h-4"})}}function ue(s){let l={};try{l=s.payload?JSON.parse(s.payload):{}}catch{}if(s.type==="user.message")return{type:"输入",detail:String(l.text||"").slice(0,100)};if(s.type==="assistant.message")return{type:"回复",detail:String(l.text||"").split(`
`)[0].slice(0,100)};if(s.type.startsWith("step.")){const u=l,c={"step.started":"步骤开始","step.progress":"步骤进度","step.completed":"步骤完成","step.failed":"步骤失败"},i=u.step||"UNKNOWN",g=u.description||u.substep||"";return{type:c[s.type]||"步骤",detail:`${i}: ${g}`}}const a=s.tool_name||"";let r="";return a==="Bash"?r=String(l.command||"").slice(0,60):l.file_path?r=String(l.file_path).split("/").slice(-2).join("/"):l.pattern&&(r=String(l.pattern)),{type:{Bash:"命令",Read:"读取",Edit:"编辑",Write:"写入",Glob:"搜索",Grep:"查找",Task:"子任务",WebFetch:"网页"}[a]||a||"操作",detail:r}}function ge(s){const l=s.filter(c=>c.type.startsWith("step."));if(l.length===0)return null;const a=[],r={PREPARE:"pending",EXECUTE:"pending",CLEANUP:"pending"};let o=null,u="";for(const c of l)try{const i=JSON.parse(c.payload||"{}");if(i.task_id&&(u=i.task_id),!i.step)continue;const g=i.step;if(c.type==="step.started")r[g]="in_progress",o=g,i.substep&&a.push({name:i.substep,description:i.description||"",status:"in_progress",timestamp:c.created_at});else if(c.type==="step.completed"){if(r[g]="completed",i.substep){const p=a.find(b=>b.name===i.substep);p&&(p.status="completed")}}else if(c.type==="step.failed"){if(r[g]="failed",i.substep){const p=a.find(b=>b.name===i.substep);p&&(p.status="failed")}}else c.type==="step.progress"&&i.substep&&a.push({name:i.substep,description:i.description||"",status:"in_progress",timestamp:c.created_at})}catch{}return{task_id:u,steps:r,currentStep:o,substeps:a}}function pe({state:s}){const l={PREPARE:{icon:e.jsx(le,{className:"w-4 h-4"}),label:"准备"},EXECUTE:{icon:e.jsx(ie,{className:"w-4 h-4"}),label:"执行"},CLEANUP:{icon:e.jsx(L,{className:"w-4 h-4"}),label:"清理"}},a=r=>{switch(r){case"completed":return"bg-green-500";case"in_progress":return"bg-blue-500 animate-pulse";case"failed":return"bg-red-500";default:return"bg-gray-300 dark:bg-gray-600"}};return e.jsxs("div",{className:"mt-4 p-4 rounded-xl bg-gradient-to-br from-purple-50 to-violet-50 dark:from-purple-900/20 dark:to-violet-900/20 border border-purple-200 dark:border-purple-800",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[e.jsx(L,{className:"w-4 h-4 text-purple-600 dark:text-purple-400"}),e.jsx("span",{className:"text-sm font-medium text-purple-900 dark:text-purple-300",children:"AI Factory 进度"})]}),e.jsx("div",{className:"flex items-center gap-2 mb-4",children:["PREPARE","EXECUTE","CLEANUP"].map((r,o)=>{const u=l[r],c=s.steps[r],i=s.currentStep===r;return e.jsxs(q.Fragment,{children:[e.jsxs("div",{className:`flex items-center gap-2 px-3 py-2 rounded-lg transition-all ${i?"bg-purple-600 text-white shadow-lg shadow-purple-500/50":c==="completed"?"bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400":c==="failed"?"bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-400":"bg-gray-100 dark:bg-gray-700 text-gray-500 dark:text-gray-400"}`,children:[u.icon,e.jsx("span",{className:"text-xs font-medium",children:u.label}),c==="in_progress"&&e.jsx($,{className:"w-3 h-3 animate-spin ml-1"})]}),o<2&&e.jsx("div",{className:`flex-1 h-0.5 ${a(c)}`})]},r)})}),s.substeps.length>0&&e.jsxs("div",{className:"space-y-1",children:[e.jsx("div",{className:"text-xs text-purple-700 dark:text-purple-300 font-medium mb-2",children:"子步骤:"}),s.substeps.slice(-5).map((r,o)=>e.jsxs("div",{className:"flex items-start gap-2 text-xs p-2 rounded-lg bg-white/50 dark:bg-slate-800/50",children:[e.jsx("div",{className:`w-1.5 h-1.5 rounded-full mt-1.5 flex-shrink-0 ${a(r.status)}`}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"font-medium text-gray-900 dark:text-white truncate",children:r.name}),r.description&&e.jsx("div",{className:"text-gray-600 dark:text-gray-400 truncate",children:r.description})]})]},`${r.name}-${o}`))]})]})}function _e(){var P;const[s,l]=m.useState([]),[a,r]=m.useState(null),[o,u]=m.useState([]),[c,i]=m.useState(!0),[g,p]=m.useState(null),[b,R]=m.useState(null),[j,D]=m.useState("all"),[N,O]=m.useState(""),[B,X]=m.useState(new Set),G=m.useRef(null),J=t=>{X(d=>{const x=new Set(d);return x.has(t)?x.delete(t):x.add(t),x})},h=m.useCallback(async()=>{try{const t=await y.getRuns();if(l(t.runs),p(null),!a&&t.runs.length>0){const d=t.runs.find(x=>x.status==="running");r((d==null?void 0:d.id)||t.runs[0].id)}}catch(t){p(t instanceof Error?t.message:"Error")}finally{i(!1)}},[a]),v=m.useCallback(async t=>{try{const d=await y.getEvents(t,100);u(d.events)}catch{}},[]),K=async t=>{if(confirm("确定终止此会话？")){R(t);try{await y.killRun(t),h()}finally{R(null)}}},z=async t=>{confirm("确定删除？")&&(await y.deleteRun(t),a===t&&r(null),h())},Z=async()=>{const t=s.filter(d=>d.status!=="running");if(!(!t.length||!confirm(`清理 ${t.length} 个已结束会话？`))){for(const d of t)await y.deleteRun(d.id);a&&t.some(d=>d.id===a)&&r(null),h()}};m.useEffect(()=>{h();const t=setInterval(h,3e4);return()=>clearInterval(t)},[h]),m.useEffect(()=>{if(a){v(a);const t=setInterval(()=>v(a),3e3);return()=>clearInterval(t)}},[a,v]);const A=s.filter(t=>{var d;if(j==="running"&&t.status!=="running"||j==="done"&&t.status==="running")return!1;if(N){const x=N.toLowerCase();return t.cwd.toLowerCase().includes(x)||((d=t.title)==null?void 0:d.toLowerCase().includes(x))||t.session_id.includes(x)}return!0}),n=s.find(t=>t.id===a),T=s.filter(t=>t.status==="running").length;return c&&!s.length?e.jsx("div",{className:"flex items-center justify-center h-96",children:e.jsx($,{className:"w-8 h-8 animate-spin text-blue-500"})}):g?e.jsxs("div",{className:"flex flex-col items-center justify-center h-96",children:[e.jsx(Y,{className:"w-12 h-12 text-red-500 dark:text-red-400 mb-4"}),e.jsx("p",{className:"text-red-600 dark:text-red-400 mb-3",children:g}),e.jsx("button",{onClick:h,className:"px-4 py-2 bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-xl hover:from-blue-700 hover:to-blue-800 shadow-lg shadow-blue-500/25 magnetic-btn",children:"重试"})]}):e.jsxs("div",{className:"flex gap-6 h-[calc(100vh-8rem)]",children:[e.jsxs("div",{className:"w-96 flex flex-col bg-white dark:bg-slate-800 rounded-2xl border border-gray-200 dark:border-slate-700 shadow-sm overflow-hidden",children:[e.jsxs("div",{className:"p-4 border-b border-gray-200 dark:border-slate-700",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-8 h-8 bg-gradient-to-br from-purple-500 to-violet-600 rounded-lg flex items-center justify-center shadow-lg shadow-purple-500/25",children:e.jsx(F,{className:"w-4 h-4 text-white"})}),e.jsx("h2",{className:"text-lg font-semibold text-gray-900 dark:text-white",children:"Claude Monitor"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[T>0&&e.jsxs("span",{className:"px-2 py-1 bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400 text-xs rounded-full font-medium",children:[T," 运行中"]}),e.jsx("button",{onClick:Z,className:"text-xs text-gray-500 dark:text-gray-400 hover:text-red-600 dark:hover:text-red-400 transition-colors",children:"清理"})]})]}),e.jsxs("div",{className:"relative mb-3",children:[e.jsx(ee,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400 dark:text-gray-500"}),e.jsx("input",{type:"text",placeholder:"搜索会话...",value:N,onChange:t=>O(t.target.value),className:"w-full pl-10 pr-3 py-2 border border-gray-300 dark:border-slate-600 rounded-xl text-sm bg-white dark:bg-slate-700 text-gray-900 dark:text-white placeholder-gray-400 dark:placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"})]}),e.jsx("div",{className:"flex gap-2",children:["all","running","done"].map(t=>e.jsx("button",{onClick:()=>D(t),className:`flex-1 py-1.5 text-xs rounded-xl transition ${j===t?"bg-gradient-to-r from-blue-600 to-blue-700 text-white font-medium shadow-md shadow-blue-500/25":"bg-gray-100 dark:bg-slate-700 text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-slate-600"}`,children:t==="all"?"全部":t==="running"?"运行中":"已结束"},t))})]}),e.jsx("div",{className:"flex-1 overflow-y-auto",children:A.length===0?e.jsx("div",{className:"p-8 text-center text-gray-500 dark:text-gray-400",children:"暂无会话"}):e.jsx("div",{className:"p-2 space-y-2",children:A.map(t=>{const d=t.id===a,x=t.status==="running",f=_(t.source);return e.jsxs("div",{onClick:()=>r(t.id),className:`p-3 rounded-xl cursor-pointer transition-all border-l-2 ${f?"border-l-blue-500":"border-l-orange-500"} ${d?"bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800":"hover:bg-gray-50 dark:hover:bg-slate-700/50 border border-transparent"}`,children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("div",{className:"flex items-center gap-2 min-w-0 flex-1",children:[x?e.jsx($,{className:"w-3 h-3 text-green-500 animate-spin flex-shrink-0"}):t.status==="done"?e.jsx(se,{className:"w-3 h-3 text-gray-400 dark:text-gray-500 flex-shrink-0"}):e.jsx(de,{className:"w-3 h-3 text-red-400 flex-shrink-0"}),e.jsx("span",{className:`text-xs px-2 py-0.5 rounded-lg flex-shrink-0 ${f?"bg-blue-100 dark:bg-blue-900/40 text-blue-700 dark:text-blue-400":"bg-orange-100 dark:bg-orange-900/40 text-orange-700 dark:text-orange-400"}`,children:f?e.jsx(te,{className:"w-3 h-3 inline"}):e.jsx(W,{className:"w-3 h-3 inline"})}),e.jsx("span",{className:"text-sm font-medium text-gray-900 dark:text-white truncate",children:t.title||U(t.cwd)})]}),e.jsx("span",{className:"text-xs text-gray-500 dark:text-gray-400 flex-shrink-0 ml-2",children:M(t.started_at,t.ended_at)})]}),e.jsxs("div",{className:"flex items-center justify-between text-xs text-gray-500 dark:text-gray-400",children:[e.jsx("span",{className:"truncate",children:U(t.cwd)}),e.jsxs("div",{className:"flex items-center gap-2 flex-shrink-0 ml-2",children:[t.token_input>0||t.token_output>0?e.jsx("span",{children:S(t.token_input+t.token_output)}):null,t.events_count?e.jsxs("span",{children:[t.events_count," 操作"]}):null]})]})]},t.id)})})})]}),e.jsx("div",{className:"flex-1 flex flex-col bg-white dark:bg-slate-800 rounded-2xl border border-gray-200 dark:border-slate-700 shadow-sm overflow-hidden",children:n?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"p-6 border-b border-gray-200 dark:border-slate-700",children:[e.jsxs("div",{className:"flex items-start justify-between mb-4",children:[e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx("span",{className:`px-2.5 py-1 text-xs rounded-lg font-medium ${n.status==="running"?"bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400":n.status==="done"?"bg-gray-100 dark:bg-slate-700 text-gray-700 dark:text-gray-300":"bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-400"}`,children:n.status==="running"?"运行中":n.status==="done"?"已完成":"已取消"}),e.jsxs("span",{className:`px-2.5 py-1 text-xs rounded-lg ${_(n.source)?"bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-400":"bg-orange-100 dark:bg-orange-900/30 text-orange-700 dark:text-orange-400"}`,children:[_(n.source)?"有头":"无头"," · ",n.source]})]}),n.title&&e.jsx("h2",{className:"text-lg font-semibold text-gray-900 dark:text-white truncate mb-1",children:n.title}),e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400 truncate",children:n.cwd})]}),e.jsxs("div",{className:"flex gap-2 ml-4",children:[n.status==="running"&&e.jsxs("button",{onClick:()=>K(n.id),disabled:b===n.id,className:"px-3 py-1.5 bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-400 text-sm rounded-xl hover:bg-red-200 dark:hover:bg-red-900/50 disabled:opacity-50 flex items-center gap-1 transition-colors",children:[e.jsx(re,{className:"w-4 h-4"}),b===n.id?"...":"终止"]}),e.jsxs("button",{onClick:()=>z(n.id),className:"px-3 py-1.5 bg-gray-100 dark:bg-slate-700 text-gray-700 dark:text-gray-300 text-sm rounded-xl hover:bg-gray-200 dark:hover:bg-slate-600 flex items-center gap-1 transition-colors",children:[e.jsx(ae,{className:"w-4 h-4"}),"删除"]})]})]}),e.jsxs("div",{className:"grid grid-cols-6 gap-4 p-4 bg-gray-50 dark:bg-slate-700/50 rounded-xl",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-gray-500 dark:text-gray-400 mb-1",children:"模型"}),e.jsx("div",{className:"text-sm font-medium text-gray-900 dark:text-white truncate",title:n.model||"-",children:((P=n.model)==null?void 0:P.replace("claude-","").replace("-20251101",""))||"-"})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-gray-500 dark:text-gray-400 mb-1",children:"时长"}),e.jsx("div",{className:"text-sm font-medium text-gray-900 dark:text-white",children:M(n.started_at,n.ended_at)})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-gray-500 dark:text-gray-400 mb-1",children:"操作数"}),e.jsx("div",{className:"text-sm font-medium text-gray-900 dark:text-white",children:n.events_count||0})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-gray-500 dark:text-gray-400 mb-1",children:"输入 Token"}),e.jsx("div",{className:"text-sm font-medium text-gray-900 dark:text-white",children:S(n.token_input||0)})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-gray-500 dark:text-gray-400 mb-1",children:"输出 Token"}),e.jsx("div",{className:"text-sm font-medium text-gray-900 dark:text-white",children:S(n.token_output||0)})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-gray-500 dark:text-gray-400 mb-1",children:"预估费用"}),e.jsx("div",{className:"text-sm font-medium text-green-600 dark:text-green-400",children:xe(n.token_input||0,n.token_output||0)})]})]}),e.jsxs("div",{className:"mt-3 text-xs text-gray-400 dark:text-gray-500",children:["Session: ",n.session_id]}),(()=>{const t=ge(o);return t?e.jsx(pe,{state:t}):null})()]}),e.jsxs("div",{className:"flex-1 overflow-hidden flex flex-col",children:[e.jsxs("div",{className:"px-6 py-3 border-b border-gray-200 dark:border-slate-700 flex items-center justify-between",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700 dark:text-gray-200",children:"操作历史"}),e.jsxs("span",{className:"text-xs text-gray-500 dark:text-gray-400",children:[o.length," 条记录"]})]}),e.jsx("div",{ref:G,className:"flex-1 overflow-y-auto p-4",children:o.length===0?e.jsx("div",{className:"text-center text-gray-400 dark:text-gray-500 py-12",children:"暂无记录"}):e.jsx("div",{className:"space-y-2",children:o.map(t=>{const{type:d,detail:x}=ue(t),f=t.type==="user.message",w=t.type==="assistant.message",C=B.has(t.id);let E={};try{E=t.payload?JSON.parse(t.payload):{}}catch{}return e.jsxs("div",{className:`rounded-xl cursor-pointer transition-all ${f?"bg-blue-50 dark:bg-blue-900/20 border-l-2 border-l-blue-500":w?"bg-gray-50 dark:bg-slate-700/50 border-l-2 border-l-gray-400 dark:border-l-gray-500":"bg-white dark:bg-slate-800 hover:bg-gray-50 dark:hover:bg-slate-700 border border-gray-200 dark:border-slate-600"}`,onClick:()=>J(t.id),children:[e.jsxs("div",{className:"px-4 py-3 flex items-start gap-3",children:[e.jsx("span",{className:"text-xs text-gray-400 dark:text-gray-500 w-16 flex-shrink-0 pt-0.5",children:oe(t.created_at)}),e.jsxs("div",{className:"flex items-center gap-2 w-20 flex-shrink-0 text-gray-500 dark:text-gray-400",children:[me(t.tool_name),e.jsx("span",{className:`text-xs ${f?"text-blue-700 dark:text-blue-400 font-medium":w?"text-gray-700 dark:text-gray-300 font-medium":"text-gray-600 dark:text-gray-400"}`,children:d})]}),e.jsx("span",{className:`flex-1 text-sm ${f||w?"text-gray-900 dark:text-white":"text-gray-600 dark:text-gray-300 font-mono"} ${C?"":"truncate"}`,children:x||"-"}),e.jsx(ne,{className:`w-4 h-4 text-gray-400 dark:text-gray-500 flex-shrink-0 transition-transform ${C?"rotate-180":""}`})]}),C&&Object.keys(E).length>0&&e.jsx("div",{className:"px-4 pb-3 pt-0",children:e.jsx("pre",{className:"text-xs text-gray-600 dark:text-gray-300 bg-gray-100 dark:bg-slate-900 p-3 rounded-lg overflow-x-auto max-h-64 overflow-y-auto whitespace-pre-wrap break-words",children:JSON.stringify(E,null,2)})})]},t.id)})})})]})]}):e.jsxs("div",{className:"flex-1 flex flex-col items-center justify-center text-gray-400 dark:text-gray-500",children:[e.jsx(F,{className:"w-16 h-16 mb-4"}),e.jsx("p",{children:"选择一个会话查看详情"})]})})]})}export{_e as default};

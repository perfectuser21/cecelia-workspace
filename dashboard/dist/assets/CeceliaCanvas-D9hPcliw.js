import{r as o,j as i,X as Z,L as ee,ay as te,az as re}from"./index-B6elV0yr.js";import{c as S,T as se}from"./tldraw-Dr0u5YBv.js";import{M as ae}from"./MermaidRenderer-CapVd5DK.js";import{EChartsRenderer as ne}from"./EChartsRenderer-CoIJCxkF.js";import{D3ForceRenderer as oe}from"./D3ForceRenderer-CPnmI6oj.js";import"./index-BJ8OkXaU.js";import"./transform-CHVD-xw7.js";import"./string-DhfnsSdB.js";import"./step-wNkEhWaM.js";import"./ordinal-DILIJJjt.js";import"./init-Dmth1JHB.js";import"./colors-Cc3OSVma.js";const ie=[{type:"function",name:"canvas_draw_shape",description:"在画布上绘制形状。支持矩形、圆形、箭头、线条等。",parameters:{type:"object",properties:{shape:{type:"string",enum:["rectangle","ellipse","arrow","line","text"],description:"形状类型"},x:{type:"number",description:"X 坐标",default:200},y:{type:"number",description:"Y 坐标",default:200},width:{type:"number",description:"宽度",default:200},height:{type:"number",description:"高度",default:100},color:{type:"string",description:"颜色",default:"blue"},text:{type:"string",description:"文本内容（用于 text 类型）"}},required:["shape"]}},{type:"function",name:"canvas_add_text",description:"在画布上添加文本",parameters:{type:"object",properties:{text:{type:"string",description:"文本内容"},x:{type:"number",description:"X 坐标",default:200},y:{type:"number",description:"Y 坐标",default:200},size:{type:"string",enum:["s","m","l","xl"],default:"m"}},required:["text"]}},{type:"function",name:"canvas_draw_flowchart",description:"绘制流程图。提供节点和连接，自动布局。",parameters:{type:"object",properties:{nodes:{type:"array",items:{type:"object",properties:{id:{type:"string"},label:{type:"string"},type:{type:"string",enum:["start","end","process","decision"]}}},description:"节点列表"},edges:{type:"array",items:{type:"object",properties:{from:{type:"string"},to:{type:"string"},label:{type:"string"}}},description:"连接列表"}},required:["nodes","edges"]}},{type:"function",name:"canvas_clear",description:"清空画布",parameters:{type:"object",properties:{},required:[]}},{type:"function",name:"render_mermaid",description:"渲染 Mermaid 图表（流程图、脑图、时序图）。切换到 Mermaid 渲染器显示图表。",parameters:{type:"object",properties:{content:{type:"string",description:"Mermaid 语法内容"}},required:["content"]}},{type:"function",name:"render_chart",description:"渲染 ECharts 图表。切换到 ECharts 渲染器显示统计图表。",parameters:{type:"object",properties:{type:{type:"string",enum:["line","bar","pie"],description:"图表类型"},data:{type:"object",description:"图表数据"},title:{type:"string",description:"图表标题"}},required:["type","data"]}},{type:"function",name:"render_network",description:"渲染 D3 力导向网络图。切换到 D3 渲染器显示网络关系图。",parameters:{type:"object",properties:{nodes:{type:"array",items:{type:"object",properties:{id:{type:"string"},label:{type:"string"},group:{type:"number"}}},description:"节点列表"},links:{type:"array",items:{type:"object",properties:{source:{type:"string"},target:{type:"string"},value:{type:"number"}}},description:"连接列表"}},required:["nodes","links"]}},{type:"function",name:"query_viz_data",description:"查询可视化数据",parameters:{type:"object",properties:{source:{type:"string",description:"数据源（如 cecelia_runs, system_metrics）"},type:{type:"string",description:"数据类型（如 timeline, stats, overview）"},range:{type:"string",description:"时间范围（如 24h, 7d, 30d）"}},required:["source","type"]}},{type:"function",name:"cecelia_create_task",description:"创建开发任务",parameters:{type:"object",properties:{title:{type:"string",description:"任务标题"},description:{type:"string",description:"任务描述"}},required:["title","description"]}},{type:"function",name:"cecelia_list_tasks",description:"列出所有任务",parameters:{type:"object",properties:{},required:[]}},{type:"function",name:"cecelia_health_check",description:"检查系统状态",parameters:{type:"object",properties:{},required:[]}}],ce=`你是 Cecelia，主人的私人管家。你运行在主人的 VPS 上，配合无限画布为主人服务。

你的能力：
1. 画布操作：canvas_draw_shape, canvas_add_text, canvas_draw_flowchart, canvas_clear
2. 可视化渲染：render_mermaid, render_chart, render_network
3. 数据查询：query_viz_data
4. 任务管理：cecelia_create_task, cecelia_list_tasks
5. 系统状态：cecelia_health_check

当主人想要可视化想法时：
- "画一个流程图" → 使用 render_mermaid 在画布上添加 Mermaid 流程图
- "显示柱状图/折线图/饼图" → 使用 render_chart 在画布上添加 ECharts 图表
- "画网络关系图" → 使用 render_network 在画布上添加 D3 力导向图
- "查询数据" → 使用 query_viz_data 获取数据
- "画一个矩形/圆形" → 使用 canvas_draw_shape (tldraw 画布)
- "写点文字" → 使用 canvas_add_text (tldraw 画布)
- "清空画布" → 使用 canvas_clear

Mermaid 示例：
- 流程图: "graph TD; A-->B; A-->C; B-->D; C-->D;"
- 脑图: "mindmap\\n  root((核心))\\n    A\\n    B\\n    C"
- 时序图: "sequenceDiagram\\n  A->>B: Hello\\n  B->>A: Hi"

ECharts 示例：
- 折线图: { xAxis: { type: 'category', data: ['Mon', 'Tue', 'Wed'] }, yAxis: { type: 'value' }, series: [{ data: [120, 200, 150], type: 'line' }] }
- 柱状图: { xAxis: { type: 'category', data: ['A', 'B', 'C'] }, yAxis: { type: 'value' }, series: [{ data: [10, 20, 30], type: 'bar' }] }
- 饼图: { series: [{ type: 'pie', data: [{ value: 335, name: 'A' }, { value: 234, name: 'B' }] }] }

D3 网络图示例：
- nodes: [{ id: '1', label: 'Node 1', group: 1 }, { id: '2', label: 'Node 2', group: 2 }]
- links: [{ source: '1', target: '2', value: 1 }]

规则：
- 必须通过工具执行操作
- 极简回复（"好的"、"完成"、"明白"），不要重复主人说的内容
- render_mermaid/render_chart/render_network 会在画布上添加可视化组件
- 多个可视化可以同时存在，可拖拽缩放`;function ke(){const[g,O]=o.useState(!1),[_,k]=o.useState(!1),[C,m]=o.useState(""),[v,j]=o.useState(""),[E,X]=o.useState(""),[Y,H]=o.useState("shimmer"),[pe,G]=o.useState(!1),[de,K]=o.useState(null),[q,T]=o.useState([]),N=o.useRef(null),l=o.useRef(null),D=o.useRef(null),A=o.useRef(null),w=o.useRef(null),R=o.useCallback(t=>{const e=w.current;if(console.log("[drawShape] editorRef.current:",e,"args:",t),!e)return console.error("[drawShape] Editor not ready!"),{success:!1,error:"Editor not ready"};const{shape:a,x:r=200,y:n=200,width:p=200,height:d=100,color:y="blue",text:c}=t,s=S();try{switch(a){case"rectangle":e.createShape({id:s,type:"geo",x:r,y:n,props:{geo:"rectangle",w:p,h:d,color:y}}),e.zoomToFit({animation:{duration:200}});break;case"ellipse":console.log("[drawShape] Creating ellipse at",r,n,"size",p,d),e.createShape({id:s,type:"geo",x:r,y:n,props:{geo:"ellipse",w:p,h:d,color:y}}),e.zoomToFit({animation:{duration:200}}),console.log("[drawShape] Ellipse created with id:",s);const h=e.getCurrentPageShapes();console.log("[drawShape] Current page shapes:",h.length,h);break;case"text":e.createShape({id:s,type:"text",x:r,y:n,props:{text:c||"Text",color:y,size:"m"}});break;case"arrow":e.createShape({id:s,type:"arrow",x:r,y:n,props:{color:y}});break}return{success:!0,shape_id:s}}catch(h){return{success:!1,error:String(h)}}},[]),M=o.useCallback(t=>{const e=w.current;if(!e)return{success:!1,error:"Editor not ready"};const{text:a,x:r=200,y:n=200,size:p="m"}=t,d=S();try{return e.createShape({id:d,type:"text",x:r,y:n,props:{text:a,size:p}}),{success:!0,shape_id:d}}catch(y){return{success:!1,error:String(y)}}},[]),I=o.useCallback(t=>{const e=w.current;if(!e)return{success:!1,error:"Editor not ready"};const{nodes:a=[],edges:r=[]}=t,n=new Map,p=100,d=100,y=150,c=60,s=200,h=120;try{return a.forEach((u,f)=>{const b=Math.floor(f/3),x=f%3,W=p+x*s,U=d+b*h,V=S();e.createShape({id:V,type:"geo",x:W,y:U,props:{geo:u.type==="decision"?"diamond":"rectangle",w:y,h:c,color:u.type==="start"?"green":u.type==="end"?"red":"blue",text:u.label}}),n.set(u.id,{x:W+y/2,y:U+c/2,shapeId:V})}),r.forEach(u=>{const f=n.get(u.from),b=n.get(u.to);if(f&&b){const x=S();e.createShape({id:x,type:"arrow",props:{color:"black",start:{x:f.x,y:f.y+c/2},end:{x:b.x,y:b.y-c/2}}})}}),e.zoomToFit({animation:{duration:200}}),{success:!0,nodes_created:a.length,edges_created:r.length}}catch(u){return{success:!1,error:String(u)}}},[]),z=o.useCallback(()=>{const t=w.current;if(!t)return{success:!1,error:"Editor not ready"};try{const e=t.getCurrentPageShapeIds();return t.deleteShapes([...e]),{success:!0}}catch(e){return{success:!1,error:String(e)}}},[]),J=o.useCallback(t=>{const{content:e}=t;if(!e||typeof e!="string")return{success:!1,error:"Invalid content parameter"};const a={id:`mermaid-${Date.now()}`,type:"mermaid",data:e,shapeId:""};return T(r=>[...r,a]),{success:!0,widget_id:a.id}},[]),L=o.useCallback(t=>{if(!w.current)return{success:!1,error:"Editor not ready"};const{type:a,data:r,title:n}=t;if(!a||!r)return{success:!1,error:"Missing required parameters: type and data"};let p;const d=r;switch(a){case"line":case"bar":{const s=d.xData||["A","B","C","D","E"],h=d.yData||[10,20,30,40,50];p={title:n?{text:n,textStyle:{color:"#f1f5f9"}}:void 0,xAxis:{type:"category",data:s},yAxis:{type:"value"},series:[{data:h,type:a}],backgroundColor:"transparent"};break}case"pie":{const s=d.pieData||[{name:"A",value:335},{name:"B",value:234}];p={title:n?{text:n,textStyle:{color:"#f1f5f9"}}:void 0,series:[{type:"pie",data:s}],backgroundColor:"transparent"};break}default:return{success:!1,error:`Unsupported chart type: ${a}`}}const y=S(),c={id:`chart-${Date.now()}`,type:"chart",data:p,shapeId:y};return T(s=>[...s,c]),{success:!0,widget_id:c.id,chart_type:a}},[]),P=o.useCallback(t=>{const{nodes:e,links:a}=t;if(!e||!a)return{success:!1,error:"Missing required parameters: nodes and links"};if(!Array.isArray(e)||!Array.isArray(a))return{success:!1,error:"nodes and links must be arrays"};const r=S(),n={id:`network-${Date.now()}`,type:"network",data:{nodes:e,links:a},shapeId:r};return T(p=>[...p,n]),{success:!0,widget_id:n.id,nodes_count:e.length,links_count:a.length}},[]),B=o.useCallback(async t=>{const{source:e,type:a,range:r}=t;try{if(e==="cecelia_runs"){const p=await(await fetch("/api/cecelia/runs")).json();return{success:!0,source:e,data:p}}else if(e==="system_metrics"){const p=await(await fetch("/api/cecelia/health")).json();return{success:!0,source:e,data:p}}else return{success:!1,error:`Unknown data source: ${e}`}}catch(n){return{success:!1,error:String(n)}}},[]),$=o.useCallback(async(t,e,a)=>{console.log("Tool call:",t,e),console.log("[handleToolCall] drawShape function:",typeof R,R);let r;switch(t){case"canvas_draw_shape":console.log("[handleToolCall] Calling drawShape..."),r=R(e),console.log("[handleToolCall] drawShape result:",r);break;case"canvas_add_text":r=M(e);break;case"canvas_draw_flowchart":r=I(e);break;case"canvas_clear":r=z();break;case"render_mermaid":r=J(e);break;case"render_chart":r=L(e);break;case"render_network":r=P(e);break;case"query_viz_data":r=await B(e);break;case"cecelia_create_task":{r=await(await fetch("/api/cecelia/tasks",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)})).json();break}case"cecelia_list_tasks":{r=await(await fetch("/api/cecelia/runs")).json();break}case"cecelia_health_check":{r=await(await fetch("/api/cecelia/health")).json();break}default:r={error:`Unknown tool: ${t}`}}return l.current&&l.current.readyState==="open"&&(l.current.send(JSON.stringify({type:"conversation.item.create",item:{type:"function_call_output",call_id:a,output:JSON.stringify(r)}})),l.current.send(JSON.stringify({type:"response.create"}))),r},[R,M,I,z,J,L,P,B]),Q=o.useCallback(async()=>{var t;if(!(g||_)){k(!0),m("正在连接..."),j("");try{const e=new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"}]});N.current=e;const a=document.createElement("audio");a.autoplay=!0,D.current=a,e.ontrack=c=>{a.srcObject=c.streams[0]};const r=await navigator.mediaDevices.getUserMedia({audio:!0});A.current=r,e.addTrack(r.getTracks()[0]);const n=e.createDataChannel("oai-events");l.current=n,n.onopen=()=>{k(!1),O(!0),m("已连接，请说话...");const c={type:"session.update",session:{instructions:ce,tools:ie,tool_choice:"auto",input_audio_transcription:{model:"whisper-1"}}};console.log("[Cecelia] session.update:",JSON.stringify(c,null,2)),n.send(JSON.stringify(c))},n.onmessage=c=>{var h;const s=JSON.parse(c.data);if(console.log("[Cecelia] 收到消息:",s.type),(s.type.includes("session")||s.type.includes("error")||s.type.includes("function")||s.type.includes("response"))&&console.log("[Cecelia] 详情:",s),s.type==="error"&&(console.error("Realtime error:",s),m("错误: "+(((h=s.error)==null?void 0:h.message)||JSON.stringify(s.error)))),s.type==="input_audio_buffer.speech_started"&&(m("正在听..."),j("")),s.type==="input_audio_buffer.speech_stopped"&&m("处理中..."),s.type==="conversation.item.input_audio_transcription.completed"&&m("你: "+s.transcript),s.type==="response.output_audio_transcript.delta"&&j(u=>u+(s.delta||"")),s.type==="response.function_call_arguments.done"){const{call_id:u,name:f,arguments:b}=s;try{const x=JSON.parse(b);m(`正在执行: ${f}...`),$(f,x,u)}catch(x){console.error("Failed to parse function args:",x)}}},await e.setLocalDescription(),await new Promise(c=>{e.iceGatheringState==="complete"?c():(e.onicegatheringstatechange=()=>{e.iceGatheringState==="complete"&&c()},setTimeout(c,3e3))});const d=await(await fetch("/api/cecelia/realtime-sdp",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({sdp:(t=e.localDescription)==null?void 0:t.sdp,model:"gpt-4o-realtime-preview-2024-12-17"})})).json();if(!d.success)throw console.error("SDP exchange error:",d.error),new Error(`SDP exchange failed: ${d.error}`);const y=d.sdp;await e.setRemoteDescription({type:"answer",sdp:y})}catch(e){console.error("Failed to start voice:",e),m("启动失败: "+(e instanceof Error?e.message:String(e))),k(!1),F()}}},[g,_,Y,$]),F=o.useCallback(()=>{var t,e,a;(t=l.current)==null||t.close(),l.current=null,(e=A.current)==null||e.getTracks().forEach(r=>r.stop()),A.current=null,(a=N.current)==null||a.close(),N.current=null,D.current&&(D.current.srcObject=null,D.current=null),O(!1),k(!1)},[]);return o.useCallback(()=>{!E.trim()||!l.current||l.current.readyState!=="open"||(l.current.send(JSON.stringify({type:"conversation.item.create",item:{type:"message",role:"user",content:[{type:"input_text",text:E}]}})),l.current.send(JSON.stringify({type:"response.create"})),m("你: "+E),j(""),X(""))},[E]),o.useCallback(t=>{H(t),g&&l.current&&l.current.readyState==="open"&&l.current.send(JSON.stringify({type:"session.update",session:{audio:{output:{voice:t}}}})),G(!1)},[g]),console.log("[CeceliaCanvas] Render - transcript:",C,"aiResponse:",v,"isListening:",g),i.jsxs("div",{style:{position:"absolute",top:0,left:0,right:0,bottom:0,display:"flex",flexDirection:"column"},children:[i.jsxs("div",{style:{flex:1,position:"relative"},children:[i.jsx(se,{onMount:t=>{console.log("[Tldraw] Editor mounted"),w.current=t,K(t)}}),q.length>0&&i.jsx("div",{style:{position:"absolute",top:40,left:40,right:40,bottom:80,pointerEvents:"none",display:"grid",gridTemplateColumns:"repeat(2, 1fr)",gap:"24px",alignContent:"start"},children:q.map(t=>i.jsxs("div",{className:"bg-slate-900/95 backdrop-blur-xl rounded-2xl shadow-2xl border border-indigo-500/30 overflow-hidden",style:{pointerEvents:"auto",height:"450px"},children:[i.jsxs("div",{className:"flex items-center justify-between px-4 py-3 bg-gradient-to-r from-indigo-950/80 to-purple-950/80 border-b border-indigo-500/20",children:[i.jsx("span",{className:"text-xs font-semibold text-indigo-300 uppercase tracking-wider",children:t.type==="mermaid"?"流程图":t.type==="chart"?"图表":"网络图"}),i.jsx("button",{onClick:()=>T(e=>e.filter(a=>a.id!==t.id)),className:"p-1 hover:bg-indigo-500/20 rounded transition-colors",children:i.jsx(Z,{className:"w-4 h-4 text-indigo-400 hover:text-indigo-200"})})]}),i.jsxs("div",{className:"w-full h-full p-4",style:{height:"calc(100% - 52px)"},children:[t.type==="mermaid"&&i.jsx(ae,{content:t.data,onError:e=>console.error("Mermaid error:",e)}),t.type==="chart"&&i.jsx(ne,{config:t.data}),t.type==="network"&&i.jsx(oe,{nodes:t.data.nodes,links:t.data.links})]})]},t.id))})]}),i.jsxs("div",{style:{height:70,padding:"10px 16px",backgroundColor:"#0f172a",borderTop:"1px solid #334155",display:"flex",alignItems:"center",justifyContent:"center",gap:12,flexShrink:0},children:[(C||v)&&i.jsxs("div",{style:{flex:1,maxWidth:400,padding:"6px 12px",backgroundColor:"rgba(30, 41, 59, 0.9)",borderRadius:8,fontSize:12},children:[C&&i.jsx("span",{style:{color:"#94a3b8"},children:C}),v&&i.jsx("span",{style:{color:"#c4b5fd",marginLeft:8},children:v})]}),i.jsx("button",{onClick:g?F:Q,disabled:_,style:{width:50,height:50,borderRadius:"50%",border:"none",cursor:_?"wait":"pointer",backgroundColor:g?"#ef4444":_?"#475569":"#7c3aed",display:"flex",alignItems:"center",justifyContent:"center"},children:_?i.jsx(ee,{className:"w-6 h-6 text-white animate-spin"}):g?i.jsx(te,{className:"w-6 h-6 text-white"}):i.jsx(re,{className:"w-6 h-6 text-white"})})]})]})}export{ke as default};

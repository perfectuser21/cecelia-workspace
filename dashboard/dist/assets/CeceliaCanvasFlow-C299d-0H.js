import{r as d,j as r,L as W,ay as H,az as Z,X as v}from"./index-B6elV0yr.js";import{u as Q,a as Y,R as K,B as ee,C as te}from"./style-DBecDMG6.js";import{M as re}from"./MermaidRenderer-CapVd5DK.js";import{EChartsRenderer as se}from"./EChartsRenderer-CoIJCxkF.js";import{D3ForceRenderer as oe}from"./D3ForceRenderer-CPnmI6oj.js";import"./transform-CHVD-xw7.js";import"./string-DhfnsSdB.js";import"./step-wNkEhWaM.js";import"./ordinal-DILIJJjt.js";import"./init-Dmth1JHB.js";import"./colors-Cc3OSVma.js";function ie({data:s}){const p={circle:r.jsx("div",{className:"w-32 h-32 rounded-full border-4 flex items-center justify-center",style:{borderColor:s.color,backgroundColor:`${s.color}20`},children:s.text&&r.jsx("span",{className:"text-sm font-medium",style:{color:s.color},children:s.text})}),rectangle:r.jsx("div",{className:"w-48 h-32 rounded-lg border-4 flex items-center justify-center",style:{borderColor:s.color,backgroundColor:`${s.color}20`},children:s.text&&r.jsx("span",{className:"text-sm font-medium",style:{color:s.color},children:s.text})}),ellipse:r.jsx("div",{className:"w-48 h-32 rounded-full border-4 flex items-center justify-center",style:{borderColor:s.color,backgroundColor:`${s.color}20`},children:s.text&&r.jsx("span",{className:"text-sm font-medium",style:{color:s.color},children:s.text})})};return r.jsxs("div",{className:"relative group",children:[p[s.shape]||p.rectangle,r.jsx("button",{onClick:s.onDelete,className:"absolute -top-2 -right-2 w-6 h-6 bg-red-500 hover:bg-red-600 rounded-full opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center",children:r.jsx(v,{className:"w-4 h-4 text-white"})})]})}function ne({data:s}){return r.jsxs("div",{className:"relative group",children:[r.jsxs("div",{className:"bg-slate-800/50 backdrop-blur-sm rounded-lg p-4 border border-slate-600",style:{minWidth:200,minHeight:200},children:[r.jsx("div",{dangerouslySetInnerHTML:{__html:s.svg}}),s.description&&r.jsx("p",{className:"text-xs text-slate-400 mt-2 text-center",children:s.description})]}),r.jsx("button",{onClick:s.onDelete,className:"absolute -top-2 -right-2 w-6 h-6 bg-red-500 hover:bg-red-600 rounded-full opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center",children:r.jsx(v,{className:"w-4 h-4 text-white"})})]})}function ae({data:s}){const p={s:"text-sm",m:"text-base",l:"text-lg",xl:"text-2xl"};return r.jsxs("div",{className:"relative group",children:[r.jsx("div",{className:`px-4 py-2 rounded-lg bg-slate-800/80 backdrop-blur-sm border border-slate-600 ${p[s.size]||"text-base"}`,style:{color:s.color||"#f1f5f9"},children:s.text}),r.jsx("button",{onClick:s.onDelete,className:"absolute -top-2 -right-2 w-6 h-6 bg-red-500 hover:bg-red-600 rounded-full opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center",children:r.jsx(v,{className:"w-4 h-4 text-white"})})]})}function ce({data:s}){return r.jsxs("div",{className:"bg-slate-900/95 backdrop-blur-xl rounded-2xl shadow-2xl border border-indigo-500/30 overflow-hidden",style:{width:600,height:450},children:[r.jsxs("div",{className:"flex items-center justify-between px-4 py-3 bg-gradient-to-r from-indigo-950/80 to-purple-950/80 border-b border-indigo-500/20",children:[r.jsx("span",{className:"text-xs font-semibold text-indigo-300 uppercase tracking-wider",children:"流程图"}),r.jsx("button",{onClick:s.onDelete,className:"p-1 hover:bg-indigo-500/20 rounded transition-colors",children:r.jsx(v,{className:"w-4 h-4 text-indigo-400 hover:text-indigo-200"})})]}),r.jsx("div",{className:"w-full p-4",style:{height:"calc(100% - 52px)"},children:r.jsx(re,{content:s.content,onError:p=>console.error("Mermaid error:",p)})})]})}function le({data:s}){return r.jsxs("div",{className:"bg-slate-900/95 backdrop-blur-xl rounded-2xl shadow-2xl border border-indigo-500/30 overflow-hidden",style:{width:600,height:450},children:[r.jsxs("div",{className:"flex items-center justify-between px-4 py-3 bg-gradient-to-r from-indigo-950/80 to-purple-950/80 border-b border-indigo-500/20",children:[r.jsx("span",{className:"text-xs font-semibold text-indigo-300 uppercase tracking-wider",children:"图表"}),r.jsx("button",{onClick:s.onDelete,className:"p-1 hover:bg-indigo-500/20 rounded transition-colors",children:r.jsx(v,{className:"w-4 h-4 text-indigo-400 hover:text-indigo-200"})})]}),r.jsx("div",{className:"w-full p-4",style:{height:"calc(100% - 52px)"},children:r.jsx(se,{config:s.config})})]})}function de({data:s}){return r.jsxs("div",{className:"bg-slate-900/95 backdrop-blur-xl rounded-2xl shadow-2xl border border-indigo-500/30 overflow-hidden",style:{width:600,height:450},children:[r.jsxs("div",{className:"flex items-center justify-between px-4 py-3 bg-gradient-to-r from-indigo-950/80 to-purple-950/80 border-b border-indigo-500/20",children:[r.jsx("span",{className:"text-xs font-semibold text-indigo-300 uppercase tracking-wider",children:"网络图"}),r.jsx("button",{onClick:s.onDelete,className:"p-1 hover:bg-indigo-500/20 rounded transition-colors",children:r.jsx(v,{className:"w-4 h-4 text-indigo-400 hover:text-indigo-200"})})]}),r.jsx("div",{className:"w-full p-4",style:{height:"calc(100% - 52px)"},children:r.jsx(oe,{nodes:s.nodes,links:s.links})})]})}const pe={shapeNode:ie,textNode:ae,drawingNode:ne,mermaidNode:ce,chartNode:le,networkNode:de},ue=[{type:"function",name:"canvas_draw_shape",description:"在画布上绘制基础图形（圆形、矩形、椭圆）。可以拖拽到任意位置。",parameters:{type:"object",properties:{shape:{type:"string",enum:["circle","rectangle","ellipse"],description:"图形类型"},color:{type:"string",description:"颜色（如 blue, red, green, #6366f1）",default:"#6366f1"},text:{type:"string",description:"图形内的文字（可选）"}},required:["shape"]}},{type:"function",name:"canvas_add_text",description:"在画布上添加文本。可以拖拽到任意位置。",parameters:{type:"object",properties:{text:{type:"string",description:"文本内容"},size:{type:"string",enum:["s","m","l","xl"],default:"m",description:"字体大小"},color:{type:"string",description:"文字颜色",default:"#f1f5f9"}},required:["text"]}},{type:"function",name:"canvas_draw_line",description:"在画布上绘制连接线。连接两个节点或创建自由线条。",parameters:{type:"object",properties:{from:{type:"string",description:"起点节点ID（可选，不提供则创建自由线条）"},to:{type:"string",description:"终点节点ID（可选）"},label:{type:"string",description:"线条上的标签文字（可选）"},color:{type:"string",description:"线条颜色",default:"#6366f1"}}}},{type:"function",name:"canvas_draw_freehand",description:"绘制手绘风格的简单图形。例如：树、花、太阳、云朵、小动物轮廓等。使用 SVG 路径。",parameters:{type:"object",properties:{shape:{type:"string",enum:["tree","flower","sun","cloud","star","heart","smiley"],description:"预设的简单图形"},description:{type:"string",description:"图形描述（可选）"},color:{type:"string",description:"颜色",default:"#10b981"}},required:["shape"]}},{type:"function",name:"render_mermaid",description:"在画布上添加 Mermaid 流程图。可以自由拖拽到任意位置。",parameters:{type:"object",properties:{content:{type:"string",description:"Mermaid 语法内容"}},required:["content"]}},{type:"function",name:"render_chart",description:"在画布上添加 ECharts 图表。可以自由拖拽到任意位置。",parameters:{type:"object",properties:{type:{type:"string",enum:["line","bar","pie"],description:"图表类型"},data:{type:"object",description:"图表数据"},title:{type:"string",description:"图表标题"}},required:["type","data"]}},{type:"function",name:"render_network",description:"在画布上添加 D3 网络图。可以自由拖拽到任意位置。",parameters:{type:"object",properties:{nodes:{type:"array",items:{type:"object",properties:{id:{type:"string"},label:{type:"string"},group:{type:"number"}}}},links:{type:"array",items:{type:"object",properties:{source:{type:"string"},target:{type:"string"},value:{type:"number"}}}}},required:["nodes","links"]}}],he=`你是 Cecelia，主人的私人管家。

核心规则：
1. 主人说什么，立即执行，不要重复，不要确认，不要解释
2. 主人要求"模拟数据"或"随便"时，直接用合理的假数据，不要问细节
3. 回复只说"好的"或"完成"，不要啰嗦

你的工具：
- canvas_draw_shape - 画圆/矩形/椭圆
- canvas_add_text - 写文字
- canvas_draw_freehand - 画树/花/太阳/云/星星/爱心/笑脸
- render_mermaid - 画流程图/脑图
- render_chart - 画折线图/柱状图/饼图
- render_network - 画网络关系图

示例：
主人："显示30天营收趋势"
你：立即调用 render_chart，自动生成30天模拟数据，回复"完成"

主人："画个饼图"
你：立即调用 render_chart，自动生成3-5个分类的模拟数据，回复"好的"

主人："画一棵树"
你：立即调用 canvas_draw_freehand，回复"完成"

禁止：
- ❌ "您想要什么类型的数据？"
- ❌ "我来帮您绘制一个XXX"
- ❌ "这是一个XXX图表"
- ✅ 直接执行 + 回复"好的"或"完成"`;function $e(){const[s,p,F]=Q([]),[U,L,V]=Y([]),[k,T]=d.useState(!1),[w,N]=d.useState(!1),[$,g]=d.useState(""),[D,S]=d.useState(""),[fe,xe]=d.useState("shimmer"),R=d.useRef(null),m=d.useRef(null),_=d.useRef(null),M=d.useRef(null),b=d.useRef(0),x=d.useCallback(c=>{p(t=>t.filter(o=>o.id!==c))},[p]),y=d.useCallback((c,t)=>{const o=s.map(i=>({x:i.position.x,y:i.position.y,width:i.width||600,height:i.height||450})),e=700;let n=0;const a=10;for(;n<a;){for(let i=0;i<360;i+=45){const l=100+n*e*Math.cos(i*Math.PI/180),u=100+n*e*Math.sin(i*Math.PI/180);if(!o.some(f=>!(l+c<f.x||l>f.x+f.width||u+t<f.y||u>f.y+f.height)))return{x:l,y:u}}n++}return{x:100+b.current*100,y:100}},[s]),A=d.useCallback(c=>{const{shape:t,color:o="#6366f1",text:e}=c;if(!t)return{success:!1,error:"Missing required parameter: shape"};const n=`shape-${Date.now()}`;b.current++;const a=y(200,150),i={id:n,type:"shapeNode",position:a,data:{shape:t,color:o,text:e,onDelete:()=>x(n)},draggable:!0};return p(l=>[...l,i]),{success:!0,node_id:n,shape:t,color:o}},[p,x,y]),O=d.useCallback(c=>{const{text:t,size:o="m",color:e="#f1f5f9"}=c;if(!t)return{success:!1,error:"Missing required parameter: text"};const n=`text-${Date.now()}`;b.current++;const a=y(300,100),i={id:n,type:"textNode",position:a,data:{text:t,size:o,color:e,onDelete:()=>x(n)},draggable:!0};return p(l=>[...l,i]),{success:!0,node_id:n,text:t}},[p,x,y]),E=d.useCallback(c=>{const{from:t,to:o,label:e,color:n="#6366f1"}=c;if(!t||!o)return{success:!1,error:"需要指定起点和终点节点ID。先创建图形，再用连线连接。"};const a=`edge-${Date.now()}`,i={id:a,source:t,target:o,label:e,type:"smoothstep",style:{stroke:n,strokeWidth:2},animated:!0};return L(l=>[...l,i]),{success:!0,edge_id:a,from:t,to:o}},[L]),q=d.useCallback(c=>{const{shape:t,description:o,color:e="#10b981"}=c;if(!t)return{success:!1,error:"Missing required parameter: shape"};const a={tree:`<svg viewBox="0 0 100 120" width="100" height="120">
        <rect x="40" y="80" width="20" height="40" fill="${e}" opacity="0.8"/>
        <circle cx="50" cy="60" r="35" fill="${e}"/>
        <circle cx="30" cy="50" r="25" fill="${e}" opacity="0.9"/>
        <circle cx="70" cy="50" r="25" fill="${e}" opacity="0.9"/>
      </svg>`,flower:`<svg viewBox="0 0 100 100" width="100" height="100">
        <circle cx="50" cy="50" r="8" fill="${e}"/>
        <circle cx="50" cy="30" r="12" fill="${e}" opacity="0.7"/>
        <circle cx="70" cy="50" r="12" fill="${e}" opacity="0.7"/>
        <circle cx="50" cy="70" r="12" fill="${e}" opacity="0.7"/>
        <circle cx="30" cy="50" r="12" fill="${e}" opacity="0.7"/>
        <circle cx="35" cy="35" r="10" fill="${e}" opacity="0.6"/>
        <circle cx="65" cy="35" r="10" fill="${e}" opacity="0.6"/>
        <circle cx="65" cy="65" r="10" fill="${e}" opacity="0.6"/>
        <circle cx="35" cy="65" r="10" fill="${e}" opacity="0.6"/>
      </svg>`,sun:`<svg viewBox="0 0 100 100" width="100" height="100">
        <circle cx="50" cy="50" r="20" fill="${e}"/>
        <line x1="50" y1="10" x2="50" y2="25" stroke="${e}" stroke-width="3"/>
        <line x1="50" y1="75" x2="50" y2="90" stroke="${e}" stroke-width="3"/>
        <line x1="10" y1="50" x2="25" y2="50" stroke="${e}" stroke-width="3"/>
        <line x1="75" y1="50" x2="90" y2="50" stroke="${e}" stroke-width="3"/>
        <line x1="20" y1="20" x2="32" y2="32" stroke="${e}" stroke-width="3"/>
        <line x1="68" y1="68" x2="80" y2="80" stroke="${e}" stroke-width="3"/>
        <line x1="80" y1="20" x2="68" y2="32" stroke="${e}" stroke-width="3"/>
        <line x1="32" y1="68" x2="20" y2="80" stroke="${e}" stroke-width="3"/>
      </svg>`,cloud:`<svg viewBox="0 0 120 60" width="120" height="60">
        <ellipse cx="30" cy="40" rx="25" ry="20" fill="${e}" opacity="0.8"/>
        <ellipse cx="60" cy="30" rx="30" ry="25" fill="${e}"/>
        <ellipse cx="90" cy="40" rx="25" ry="20" fill="${e}" opacity="0.8"/>
      </svg>`,star:`<svg viewBox="0 0 100 100" width="100" height="100">
        <path d="M50,10 L61,40 L92,40 L67,60 L78,90 L50,70 L22,90 L33,60 L8,40 L39,40 Z"
              fill="${e}" stroke="${e}" stroke-width="2"/>
      </svg>`,heart:`<svg viewBox="0 0 100 100" width="100" height="100">
        <path d="M50,85 C50,85 20,60 20,40 C20,25 30,20 40,25 C45,28 50,35 50,35 C50,35 55,28 60,25 C70,20 80,25 80,40 C80,60 50,85 50,85 Z"
              fill="${e}"/>
      </svg>`,smiley:`<svg viewBox="0 0 100 100" width="100" height="100">
        <circle cx="50" cy="50" r="40" fill="${e}" opacity="0.2" stroke="${e}" stroke-width="3"/>
        <circle cx="35" cy="40" r="5" fill="${e}"/>
        <circle cx="65" cy="40" r="5" fill="${e}"/>
        <path d="M30,60 Q50,75 70,60" stroke="${e}" stroke-width="3" fill="none" stroke-linecap="round"/>
      </svg>`}[t];if(!a)return{success:!1,error:`Unknown shape: ${t}. Available: tree, flower, sun, cloud, star, heart, smiley`};const i=`drawing-${Date.now()}`;b.current++;const l=y(150,150),u={id:i,type:"drawingNode",position:l,data:{svg:a,description:o||"",onDelete:()=>x(i)},draggable:!0};return p(h=>[...h,u]),{success:!0,node_id:i,shape:t}},[p,x,y]),B=d.useCallback(c=>{const{content:t}=c;if(!t||typeof t!="string")return{success:!1,error:"Invalid content parameter"};const o=`mermaid-${Date.now()}`;b.current++;const e=y(600,450),n={id:o,type:"mermaidNode",position:e,data:{content:t,onDelete:()=>x(o)},draggable:!0};return p(a=>[...a,n]),{success:!0,node_id:o}},[p,x,y]),J=d.useCallback(c=>{const{type:t,data:o,title:e}=c;if(!t||!o)return{success:!1,error:"Missing required parameters: type and data"};let n;const a=o;switch(t){case"line":case"bar":{const h=a.xData||["A","B","C","D","E"],f=a.yData||[10,20,30,40,50];n={title:e?{text:e,textStyle:{color:"#f1f5f9"}}:void 0,xAxis:{type:"category",data:h},yAxis:{type:"value"},series:[{data:f,type:t}],backgroundColor:"transparent"};break}case"pie":{let h;if(a.pieData&&Array.isArray(a.pieData))h=a.pieData;else if(Array.isArray(a.data))h=a.data;else if(a.labels&&a.values){const f=a.labels,C=a.values;h=f.map((I,j)=>({name:I,value:C[j]||0}))}else h=[{name:"A",value:335},{name:"B",value:234},{name:"C",value:123}];n={title:e?{text:e,textStyle:{color:"#f1f5f9"}}:void 0,series:[{type:"pie",data:h,radius:"60%",label:{color:"#f1f5f9"}}],backgroundColor:"transparent"};break}default:return{success:!1,error:`Unsupported chart type: ${t}`}}const i=`chart-${Date.now()}`;b.current++;const l=y(600,450),u={id:i,type:"chartNode",position:l,data:{config:n,onDelete:()=>x(i)},draggable:!0};return p(h=>[...h,u]),{success:!0,node_id:i,chart_type:t}},[p,x,y]),z=d.useCallback(c=>{const{nodes:t,links:o}=c;if(!t||!o)return{success:!1,error:"Missing required parameters: nodes and links"};if(!Array.isArray(t)||!Array.isArray(o))return{success:!1,error:"nodes and links must be arrays"};const e=`network-${Date.now()}`;b.current++;const n=y(600,450),a={id:e,type:"networkNode",position:n,data:{nodes:t,links:o,onDelete:()=>x(e)},draggable:!0};return p(i=>[...i,a]),{success:!0,node_id:e,nodes_count:t.length,links_count:o.length}},[p,x,y]),P=d.useCallback(async(c,t,o)=>{console.log("Tool call:",c,t);let e;switch(c){case"canvas_draw_shape":e=A(t);break;case"canvas_add_text":e=O(t);break;case"canvas_draw_line":e=E(t);break;case"canvas_draw_freehand":e=q(t);break;case"render_mermaid":e=B(t);break;case"render_chart":e=J(t);break;case"render_network":e=z(t);break;default:e={error:`Unknown tool: ${c}`}}return m.current&&m.current.readyState==="open"&&(m.current.send(JSON.stringify({type:"conversation.item.create",item:{type:"function_call_output",call_id:o,output:JSON.stringify(e)}})),m.current.send(JSON.stringify({type:"response.create"}))),e},[A,O,E,q,B,J,z]),G=d.useCallback(async()=>{var c;if(!(k||w)){N(!0),g("正在连接..."),S("");try{const t=new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"}]});R.current=t;const o=document.createElement("audio");o.autoplay=!0,_.current=o,t.ontrack=l=>{o.srcObject=l.streams[0]};const e=await navigator.mediaDevices.getUserMedia({audio:!0});M.current=e,t.addTrack(e.getTracks()[0]);const n=t.createDataChannel("oai-events");m.current=n,n.onopen=()=>{N(!1),T(!0),g("已连接，请说话...");const l={type:"session.update",session:{instructions:he,tools:ue,tool_choice:"auto",input_audio_transcription:{model:"whisper-1"}}};n.send(JSON.stringify(l))},n.onmessage=l=>{var h;const u=JSON.parse(l.data);if(u.type==="error"&&(console.error("Realtime error:",u),g("错误: "+(((h=u.error)==null?void 0:h.message)||JSON.stringify(u.error)))),u.type==="input_audio_buffer.speech_started"&&(g("正在听..."),S("")),u.type==="input_audio_buffer.speech_stopped"&&g("处理中..."),u.type==="conversation.item.input_audio_transcription.completed"&&g("你: "+u.transcript),u.type==="response.output_audio_transcript.delta"&&S(f=>f+(u.delta||"")),u.type==="response.function_call_arguments.done"){const{call_id:f,name:C,arguments:I}=u;try{const j=JSON.parse(I);g(`正在执行: ${C}...`),P(C,j,f)}catch(j){console.error("Failed to parse function args:",j)}}},await t.setLocalDescription(),await new Promise(l=>{t.iceGatheringState==="complete"?l():(t.onicegatheringstatechange=()=>{t.iceGatheringState==="complete"&&l()},setTimeout(l,3e3))});const i=await(await fetch("/api/cecelia/realtime-sdp",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({sdp:(c=t.localDescription)==null?void 0:c.sdp,model:"gpt-4o-realtime-preview-2024-12-17"})})).json();if(!i.success)throw new Error(`SDP exchange failed: ${i.error}`);await t.setRemoteDescription({type:"answer",sdp:i.sdp})}catch(t){console.error("Failed to start voice:",t),g("启动失败: "+(t instanceof Error?t.message:String(t))),N(!1),X()}}},[k,w,P]),X=d.useCallback(()=>{var c,t,o;(c=m.current)==null||c.close(),m.current=null,(t=M.current)==null||t.getTracks().forEach(e=>e.stop()),M.current=null,(o=R.current)==null||o.close(),R.current=null,_.current&&(_.current.srcObject=null,_.current=null),T(!1),N(!1)},[]);return r.jsxs("div",{style:{position:"absolute",top:0,left:0,right:0,bottom:0,display:"flex",flexDirection:"column",backgroundColor:"#0f172a"},children:[r.jsx("div",{style:{flex:1,position:"relative"},children:r.jsxs(K,{nodes:s,edges:U,onNodesChange:F,onEdgesChange:V,nodeTypes:pe,fitView:!0,style:{backgroundColor:"#0f172a"},children:[r.jsx(ee,{color:"#334155",gap:16}),r.jsx(te,{})]})}),r.jsxs("div",{style:{height:70,padding:"10px 16px",backgroundColor:"#0f172a",borderTop:"1px solid #334155",display:"flex",alignItems:"center",justifyContent:"center",gap:12,flexShrink:0},children:[($||D)&&r.jsxs("div",{style:{flex:1,maxWidth:400,padding:"6px 12px",backgroundColor:"rgba(30, 41, 59, 0.9)",borderRadius:8,fontSize:12},children:[$&&r.jsx("span",{style:{color:"#94a3b8"},children:$}),D&&r.jsx("span",{style:{color:"#c4b5fd",marginLeft:8},children:D})]}),r.jsx("button",{onClick:k?X:G,disabled:w,style:{width:50,height:50,borderRadius:"50%",border:"none",cursor:w?"wait":"pointer",backgroundColor:k?"#ef4444":w?"#475569":"#7c3aed",display:"flex",alignItems:"center",justifyContent:"center"},children:w?r.jsx(W,{className:"w-6 h-6 text-white animate-spin"}):k?r.jsx(H,{className:"w-6 h-6 text-white"}):r.jsx(Z,{className:"w-6 h-6 text-white"})})]})]})}export{$e as default};

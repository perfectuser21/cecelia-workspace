import{r as o,j as c,X as Z,L as ee,ay as te,az as re}from"./index-CFNaiXDE.js";import{c as R,T as se}from"./tldraw-dfg0mHys.js";import{M as ae}from"./MermaidRenderer-BFGJDGj_.js";import{EChartsRenderer as ne}from"./EChartsRenderer-DDiuHAp2.js";import{D3ForceRenderer as oe}from"./D3ForceRenderer-ctXGmISF.js";import"./index-DuLISUY8.js";import"./transform-CHVD-xw7.js";import"./string-DhfnsSdB.js";import"./step-wNkEhWaM.js";import"./ordinal-DILIJJjt.js";import"./init-Dmth1JHB.js";import"./colors-Cc3OSVma.js";const ie=[{type:"function",name:"canvas_draw_shape",description:"在画布上绘制形状。支持矩形、圆形、箭头、线条等。",parameters:{type:"object",properties:{shape:{type:"string",enum:["rectangle","ellipse","arrow","line","text"],description:"形状类型"},x:{type:"number",description:"X 坐标",default:200},y:{type:"number",description:"Y 坐标",default:200},width:{type:"number",description:"宽度",default:200},height:{type:"number",description:"高度",default:100},color:{type:"string",description:"颜色",default:"blue"},text:{type:"string",description:"文本内容（用于 text 类型）"}},required:["shape"]}},{type:"function",name:"canvas_add_text",description:"在画布上添加文本",parameters:{type:"object",properties:{text:{type:"string",description:"文本内容"},x:{type:"number",description:"X 坐标",default:200},y:{type:"number",description:"Y 坐标",default:200},size:{type:"string",enum:["s","m","l","xl"],default:"m"}},required:["text"]}},{type:"function",name:"canvas_draw_flowchart",description:"绘制流程图。提供节点和连接，自动布局。",parameters:{type:"object",properties:{nodes:{type:"array",items:{type:"object",properties:{id:{type:"string"},label:{type:"string"},type:{type:"string",enum:["start","end","process","decision"]}}},description:"节点列表"},edges:{type:"array",items:{type:"object",properties:{from:{type:"string"},to:{type:"string"},label:{type:"string"}}},description:"连接列表"}},required:["nodes","edges"]}},{type:"function",name:"canvas_clear",description:"清空画布",parameters:{type:"object",properties:{},required:[]}},{type:"function",name:"render_mermaid",description:"渲染 Mermaid 图表（流程图、脑图、时序图）。切换到 Mermaid 渲染器显示图表。",parameters:{type:"object",properties:{content:{type:"string",description:"Mermaid 语法内容"}},required:["content"]}},{type:"function",name:"render_chart",description:"渲染 ECharts 图表。切换到 ECharts 渲染器显示统计图表。",parameters:{type:"object",properties:{type:{type:"string",enum:["line","bar","pie"],description:"图表类型"},data:{type:"object",description:"图表数据"},title:{type:"string",description:"图表标题"}},required:["type","data"]}},{type:"function",name:"render_network",description:"渲染 D3 力导向网络图。切换到 D3 渲染器显示网络关系图。",parameters:{type:"object",properties:{nodes:{type:"array",items:{type:"object",properties:{id:{type:"string"},label:{type:"string"},group:{type:"number"}}},description:"节点列表"},links:{type:"array",items:{type:"object",properties:{source:{type:"string"},target:{type:"string"},value:{type:"number"}}},description:"连接列表"}},required:["nodes","links"]}},{type:"function",name:"query_viz_data",description:"查询可视化数据",parameters:{type:"object",properties:{source:{type:"string",description:"数据源（如 cecelia_runs, system_metrics）"},type:{type:"string",description:"数据类型（如 timeline, stats, overview）"},range:{type:"string",description:"时间范围（如 24h, 7d, 30d）"}},required:["source","type"]}},{type:"function",name:"cecelia_create_task",description:"创建开发任务",parameters:{type:"object",properties:{title:{type:"string",description:"任务标题"},description:{type:"string",description:"任务描述"}},required:["title","description"]}},{type:"function",name:"cecelia_list_tasks",description:"列出所有任务",parameters:{type:"object",properties:{},required:[]}},{type:"function",name:"cecelia_health_check",description:"检查系统状态",parameters:{type:"object",properties:{},required:[]}}],ce=`你是 Cecelia，主人的私人管家。你运行在主人的 VPS 上，配合无限画布为主人服务。

你的能力：
1. 画布操作：canvas_draw_shape, canvas_add_text, canvas_draw_flowchart, canvas_clear
2. 可视化渲染：render_mermaid, render_chart, render_network
3. 数据查询：query_viz_data
4. 任务管理：cecelia_create_task, cecelia_list_tasks
5. 系统状态：cecelia_health_check

当主人想要可视化想法时：
- "画一个流程图" → 使用 render_mermaid 在画布上添加 Mermaid 流程图
- "显示柱状图/折线图/饼图" → 使用 render_chart 在画布上添加 ECharts 图表
- "画网络关系图" → 使用 render_network 在画布上添加 D3 力导向图
- "查询数据" → 使用 query_viz_data 获取数据
- "画一个矩形/圆形" → 使用 canvas_draw_shape (tldraw 画布)
- "写点文字" → 使用 canvas_add_text (tldraw 画布)
- "清空画布" → 使用 canvas_clear

Mermaid 示例：
- 流程图: "graph TD; A-->B; A-->C; B-->D; C-->D;"
- 脑图: "mindmap\\n  root((核心))\\n    A\\n    B\\n    C"
- 时序图: "sequenceDiagram\\n  A->>B: Hello\\n  B->>A: Hi"

ECharts 示例：
- 折线图: { xAxis: { type: 'category', data: ['Mon', 'Tue', 'Wed'] }, yAxis: { type: 'value' }, series: [{ data: [120, 200, 150], type: 'line' }] }
- 柱状图: { xAxis: { type: 'category', data: ['A', 'B', 'C'] }, yAxis: { type: 'value' }, series: [{ data: [10, 20, 30], type: 'bar' }] }
- 饼图: { series: [{ type: 'pie', data: [{ value: 335, name: 'A' }, { value: 234, name: 'B' }] }] }

D3 网络图示例：
- nodes: [{ id: '1', label: 'Node 1', group: 1 }, { id: '2', label: 'Node 2', group: 2 }]
- links: [{ source: '1', target: '2', value: 1 }]

规则：
- 必须通过工具执行操作
- 极简回复（"好的"、"完成"、"明白"），不要重复主人说的内容
- render_mermaid/render_chart/render_network 会在画布上添加可视化组件
- 多个可视化可以同时存在，可拖拽缩放`;function ke(){const[g,O]=o.useState(!1),[_,S]=o.useState(!1),[k,h]=o.useState(""),[C,v]=o.useState(""),[j,X]=o.useState(""),[Y,H]=o.useState("shimmer"),[pe,G]=o.useState(!1),[de,K]=o.useState(null),[q,E]=o.useState([]),N=o.useRef(null),l=o.useRef(null),T=o.useRef(null),A=o.useRef(null),w=o.useRef(null),D=o.useCallback(t=>{const e=w.current;if(console.log("[drawShape] editorRef.current:",e,"args:",t),!e)return console.error("[drawShape] Editor not ready!"),{success:!1,error:"Editor not ready"};const{shape:s,x:r=200,y:a=200,width:d=200,height:p=100,color:u="blue",text:i}=t,n=R();try{switch(s){case"rectangle":e.createShape({id:n,type:"geo",x:r,y:a,props:{geo:"rectangle",w:d,h:p,color:u}}),e.zoomToFit({animation:{duration:200}});break;case"ellipse":console.log("[drawShape] Creating ellipse at",r,a,"size",d,p),e.createShape({id:n,type:"geo",x:r,y:a,props:{geo:"ellipse",w:d,h:p,color:u}}),e.zoomToFit({animation:{duration:200}}),console.log("[drawShape] Ellipse created with id:",n);const m=e.getCurrentPageShapes();console.log("[drawShape] Current page shapes:",m.length,m);break;case"text":e.createShape({id:n,type:"text",x:r,y:a,props:{text:i||"Text",color:u,size:"m"}});break;case"arrow":e.createShape({id:n,type:"arrow",x:r,y:a,props:{color:u}});break}return{success:!0,shape_id:n}}catch(m){return{success:!1,error:String(m)}}},[]),M=o.useCallback(t=>{const e=w.current;if(!e)return{success:!1,error:"Editor not ready"};const{text:s,x:r=200,y:a=200,size:d="m"}=t,p=R();try{return e.createShape({id:p,type:"text",x:r,y:a,props:{text:s,size:d}}),{success:!0,shape_id:p}}catch(u){return{success:!1,error:String(u)}}},[]),I=o.useCallback(t=>{const e=w.current;if(!e)return{success:!1,error:"Editor not ready"};const{nodes:s=[],edges:r=[]}=t,a=new Map,d=100,p=100,u=150,i=60,n=200,m=120;try{return s.forEach((y,f)=>{const b=Math.floor(f/3),x=f%3,W=d+x*n,U=p+b*m,V=R();e.createShape({id:V,type:"geo",x:W,y:U,props:{geo:y.type==="decision"?"diamond":"rectangle",w:u,h:i,color:y.type==="start"?"green":y.type==="end"?"red":"blue",text:y.label}}),a.set(y.id,{x:W+u/2,y:U+i/2,shapeId:V})}),r.forEach(y=>{const f=a.get(y.from),b=a.get(y.to);if(f&&b){const x=R();e.createShape({id:x,type:"arrow",props:{color:"black",start:{x:f.x,y:f.y+i/2},end:{x:b.x,y:b.y-i/2}}})}}),e.zoomToFit({animation:{duration:200}}),{success:!0,nodes_created:s.length,edges_created:r.length}}catch(y){return{success:!1,error:String(y)}}},[]),z=o.useCallback(()=>{const t=w.current;if(!t)return{success:!1,error:"Editor not ready"};try{const e=t.getCurrentPageShapeIds();return t.deleteShapes([...e]),{success:!0}}catch(e){return{success:!1,error:String(e)}}},[]),J=o.useCallback(t=>{const{content:e}=t;if(!e||typeof e!="string")return{success:!1,error:"Invalid content parameter"};const s={id:`mermaid-${Date.now()}`,type:"mermaid",data:e,shapeId:""};return E(r=>[...r,s]),{success:!0,widget_id:s.id}},[]),L=o.useCallback(t=>{if(!w.current)return{success:!1,error:"Editor not ready"};const{type:s,data:r,title:a}=t;if(!s||!r)return{success:!1,error:"Missing required parameters: type and data"};let d;const p=r;switch(s){case"line":case"bar":{const i=p.xData||["A","B","C","D","E"],n=p.yData||[10,20,30,40,50];d={title:a?{text:a,textStyle:{color:"#f1f5f9"}}:void 0,xAxis:{type:"category",data:i},yAxis:{type:"value"},series:[{data:n,type:s}],backgroundColor:"transparent"};break}case"pie":{const i=p.pieData||[{name:"A",value:335},{name:"B",value:234}];d={title:a?{text:a,textStyle:{color:"#f1f5f9"}}:void 0,series:[{type:"pie",data:i}],backgroundColor:"transparent"};break}default:return{success:!1,error:`Unsupported chart type: ${s}`}}const u={id:`chart-${Date.now()}`,type:"chart",data:d};return E(i=>[...i,u]),{success:!0,widget_id:u.id,chart_type:s}},[]),P=o.useCallback(t=>{const{nodes:e,links:s}=t;if(!e||!s)return{success:!1,error:"Missing required parameters: nodes and links"};if(!Array.isArray(e)||!Array.isArray(s))return{success:!1,error:"nodes and links must be arrays"};const r={id:`network-${Date.now()}`,type:"network",data:{nodes:e,links:s}};return E(a=>[...a,r]),{success:!0,widget_id:r.id,nodes_count:e.length,links_count:s.length}},[]),B=o.useCallback(async t=>{const{source:e,type:s,range:r}=t;try{if(e==="cecelia_runs"){const d=await(await fetch("/api/cecelia/runs")).json();return{success:!0,source:e,data:d}}else if(e==="system_metrics"){const d=await(await fetch("/api/cecelia/health")).json();return{success:!0,source:e,data:d}}else return{success:!1,error:`Unknown data source: ${e}`}}catch(a){return{success:!1,error:String(a)}}},[]),$=o.useCallback(async(t,e,s)=>{console.log("Tool call:",t,e),console.log("[handleToolCall] drawShape function:",typeof D,D);let r;switch(t){case"canvas_draw_shape":console.log("[handleToolCall] Calling drawShape..."),r=D(e),console.log("[handleToolCall] drawShape result:",r);break;case"canvas_add_text":r=M(e);break;case"canvas_draw_flowchart":r=I(e);break;case"canvas_clear":r=z();break;case"render_mermaid":r=J(e);break;case"render_chart":r=L(e);break;case"render_network":r=P(e);break;case"query_viz_data":r=await B(e);break;case"cecelia_create_task":{r=await(await fetch("/api/cecelia/tasks",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)})).json();break}case"cecelia_list_tasks":{r=await(await fetch("/api/cecelia/runs")).json();break}case"cecelia_health_check":{r=await(await fetch("/api/cecelia/health")).json();break}default:r={error:`Unknown tool: ${t}`}}return l.current&&l.current.readyState==="open"&&(l.current.send(JSON.stringify({type:"conversation.item.create",item:{type:"function_call_output",call_id:s,output:JSON.stringify(r)}})),l.current.send(JSON.stringify({type:"response.create"}))),r},[D,M,I,z,J,L,P,B]),Q=o.useCallback(async()=>{var t;if(!(g||_)){S(!0),h("正在连接..."),v("");try{const e=new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"}]});N.current=e;const s=document.createElement("audio");s.autoplay=!0,T.current=s,e.ontrack=i=>{s.srcObject=i.streams[0]};const r=await navigator.mediaDevices.getUserMedia({audio:!0});A.current=r,e.addTrack(r.getTracks()[0]);const a=e.createDataChannel("oai-events");l.current=a,a.onopen=()=>{S(!1),O(!0),h("已连接，请说话...");const i={type:"session.update",session:{instructions:ce,tools:ie,tool_choice:"auto",input_audio_transcription:{model:"whisper-1"}}};console.log("[Cecelia] session.update:",JSON.stringify(i,null,2)),a.send(JSON.stringify(i))},a.onmessage=i=>{var m;const n=JSON.parse(i.data);if(console.log("[Cecelia] 收到消息:",n.type),(n.type.includes("session")||n.type.includes("error")||n.type.includes("function")||n.type.includes("response"))&&console.log("[Cecelia] 详情:",n),n.type==="error"&&(console.error("Realtime error:",n),h("错误: "+(((m=n.error)==null?void 0:m.message)||JSON.stringify(n.error)))),n.type==="input_audio_buffer.speech_started"&&(h("正在听..."),v("")),n.type==="input_audio_buffer.speech_stopped"&&h("处理中..."),n.type==="conversation.item.input_audio_transcription.completed"&&h("你: "+n.transcript),n.type==="response.output_audio_transcript.delta"&&v(y=>y+(n.delta||"")),n.type==="response.function_call_arguments.done"){const{call_id:y,name:f,arguments:b}=n;try{const x=JSON.parse(b);h(`正在执行: ${f}...`),$(f,x,y)}catch(x){console.error("Failed to parse function args:",x)}}},await e.setLocalDescription(),await new Promise(i=>{e.iceGatheringState==="complete"?i():(e.onicegatheringstatechange=()=>{e.iceGatheringState==="complete"&&i()},setTimeout(i,3e3))});const p=await(await fetch("/api/cecelia/realtime-sdp",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({sdp:(t=e.localDescription)==null?void 0:t.sdp,model:"gpt-4o-realtime-preview-2024-12-17"})})).json();if(!p.success)throw console.error("SDP exchange error:",p.error),new Error(`SDP exchange failed: ${p.error}`);const u=p.sdp;await e.setRemoteDescription({type:"answer",sdp:u})}catch(e){console.error("Failed to start voice:",e),h("启动失败: "+(e instanceof Error?e.message:String(e))),S(!1),F()}}},[g,_,Y,$]),F=o.useCallback(()=>{var t,e,s;(t=l.current)==null||t.close(),l.current=null,(e=A.current)==null||e.getTracks().forEach(r=>r.stop()),A.current=null,(s=N.current)==null||s.close(),N.current=null,T.current&&(T.current.srcObject=null,T.current=null),O(!1),S(!1)},[]);return o.useCallback(()=>{!j.trim()||!l.current||l.current.readyState!=="open"||(l.current.send(JSON.stringify({type:"conversation.item.create",item:{type:"message",role:"user",content:[{type:"input_text",text:j}]}})),l.current.send(JSON.stringify({type:"response.create"})),h("你: "+j),v(""),X(""))},[j]),o.useCallback(t=>{H(t),g&&l.current&&l.current.readyState==="open"&&l.current.send(JSON.stringify({type:"session.update",session:{audio:{output:{voice:t}}}})),G(!1)},[g]),console.log("[CeceliaCanvas] Render - transcript:",k,"aiResponse:",C,"isListening:",g),c.jsxs("div",{style:{position:"absolute",top:0,left:0,right:0,bottom:0,display:"flex",flexDirection:"column"},children:[c.jsxs("div",{style:{flex:1,position:"relative"},children:[c.jsx(se,{onMount:t=>{console.log("[Tldraw] Editor mounted"),w.current=t,K(t)}}),q.length>0&&c.jsx("div",{style:{position:"absolute",top:40,left:40,right:40,bottom:80,pointerEvents:"none",display:"grid",gridTemplateColumns:"repeat(2, 1fr)",gap:"24px",alignContent:"start"},children:q.map(t=>c.jsxs("div",{className:"bg-slate-900/95 backdrop-blur-xl rounded-2xl shadow-2xl border border-indigo-500/30 overflow-hidden",style:{pointerEvents:"auto",height:"450px"},children:[c.jsxs("div",{className:"flex items-center justify-between px-4 py-3 bg-gradient-to-r from-indigo-950/80 to-purple-950/80 border-b border-indigo-500/20",children:[c.jsx("span",{className:"text-xs font-semibold text-indigo-300 uppercase tracking-wider",children:t.type==="mermaid"?"流程图":t.type==="chart"?"图表":"网络图"}),c.jsx("button",{onClick:()=>E(e=>e.filter(s=>s.id!==t.id)),className:"p-1 hover:bg-indigo-500/20 rounded transition-colors",children:c.jsx(Z,{className:"w-4 h-4 text-indigo-400 hover:text-indigo-200"})})]}),c.jsxs("div",{className:"w-full h-full p-4",style:{height:"calc(100% - 52px)"},children:[t.type==="mermaid"&&c.jsx(ae,{content:t.data,onError:e=>console.error("Mermaid error:",e)}),t.type==="chart"&&c.jsx(ne,{config:t.data}),t.type==="network"&&c.jsx(oe,{nodes:t.data.nodes,links:t.data.links})]})]},t.id))})]}),c.jsxs("div",{style:{height:70,padding:"10px 16px",backgroundColor:"#0f172a",borderTop:"1px solid #334155",display:"flex",alignItems:"center",justifyContent:"center",gap:12,flexShrink:0},children:[(k||C)&&c.jsxs("div",{style:{flex:1,maxWidth:400,padding:"6px 12px",backgroundColor:"rgba(30, 41, 59, 0.9)",borderRadius:8,fontSize:12},children:[k&&c.jsx("span",{style:{color:"#94a3b8"},children:k}),C&&c.jsx("span",{style:{color:"#c4b5fd",marginLeft:8},children:C})]}),c.jsx("button",{onClick:g?F:Q,disabled:_,style:{width:50,height:50,borderRadius:"50%",border:"none",cursor:_?"wait":"pointer",backgroundColor:g?"#ef4444":_?"#475569":"#7c3aed",display:"flex",alignItems:"center",justifyContent:"center"},children:_?c.jsx(ee,{className:"w-6 h-6 text-white animate-spin"}):g?c.jsx(te,{className:"w-6 h-6 text-white"}):c.jsx(re,{className:"w-6 h-6 text-white"})})]})]})}export{ke as default};

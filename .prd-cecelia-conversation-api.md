---
id: prd-cecelia-conversation-api
version: 1.0.0
created: 2026-01-31
updated: 2026-01-31
changelog:
  - 1.0.0: 初始版本
---

# PRD - Cecelia 前台对话 API

## 需求来源

Brain 自动调度任务。用户需要一个前台对话接口，接收自然语言输入，解析用户意图，然后执行相应动作或回复。

## 功能描述

创建 Cecelia 前台对话 API，实现以下流程：

1. **接收自然语言**：POST /api/cecelia/chat 接收用户消息
2. **意图识别**：使用 Claude API 解析用户意图（创建任务、查询状态、执行动作等）
3. **决策执行**：根据意图调用 Brain API 执行动作（create-task、update-task 等）
4. **生成回复**：返回友好的自然语言回复

### API 设计

```
POST /api/cecelia/chat
Content-Type: application/json

{
  "message": "帮我创建一个任务：优化首页加载速度",
  "session_id": "optional-session-id"
}

Response:
{
  "success": true,
  "reply": "好的，我已经创建了任务「优化首页加载速度」，优先级设为 P1，需要我帮你分配给谁吗？",
  "actions": [
    {
      "type": "create-task",
      "result": { "task_id": "xxx", "title": "优化首页加载速度" }
    }
  ],
  "session_id": "session-xxx"
}
```

### 意图类型

- **任务管理**：创建任务、更新任务状态、查询任务列表
- **目标管理**：创建目标、查询目标进度
- **状态查询**：获取系统状态、查看 daily focus
- **执行动作**：触发 N8N workflow、设置记忆

### 实现细节

- 使用 Claude API (Haiku) 进行意图识别（快速且成本低）
- 意图识别结果映射到 Brain API 的 allowed_actions
- 自动生成 idempotency_key 防止重复执行
- 保持对话上下文（使用 session_id）
- 错误处理：意图不明确时请求用户澄清

## 涉及文件

- `apps/core/src/cecelia/routes.ts` - 新增对话路由
- `apps/core/src/cecelia/intent.ts` - 意图识别逻辑（使用 Claude API）
- `tests/api/cecelia-chat.test.ts` - 集成测试

## 成功标准

- [ ] POST /api/cecelia/chat 接收消息并返回回复
- [ ] 能识别"创建任务"意图并创建任务记录
- [ ] 能识别"查询状态"意图并返回系统状态
- [ ] 返回的 reply 是自然语言（非 JSON 格式）
- [ ] 意图不明确时返回澄清问题
- [ ] 集成测试覆盖：创建任务、查询状态、意图不明确三种场景
- [ ] 测试验证回复格式为自然语言字符串

## 非目标

- 不实现语音输入/输出
- 不实现多轮复杂对话（第一版仅支持单轮意图识别）
- 不修改 Brain API 逻辑
- 不实现前端 UI（仅提供 API）

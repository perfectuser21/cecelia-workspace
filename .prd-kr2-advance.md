---
id: prd-kr2-advance
version: 1.2.0
created: 2026-02-01
updated: 2026-02-01
changelog:
  - 1.2.0: 修正文件路径（packages/server → apps/core）
  - 1.1.0: 添加影响范围、非目标、细化成功标准（gate:prd 第一次审核后修订）
  - 1.0.0: 初始版本
---

# PRD - [Retry] Advance "KR2: PRD/TRD 自动生成（标准化）" for Cecelia Workspace

## 背景

任务来自 Brain 自动调度系统。根据 Brain status，KR2 (PRD/TRD 自动生成标准化) 已显示 100% 进度，但有多个失败的任务需要重试。

当前状态：
- Objective: O1: Cecelia 自驱进化 - 从被动执行器到自驱数字生命体 (P0)
- KR2: PRD/TRD 自动生成（标准化）progress: 100%
- 系统健康：task_system_ok: true, 2 open tasks

## 问题分析

Brain status 显示 KR2 进度为 100%，但存在以下问题：
1. 多个 "[Retry] Advance KR2" 任务状态为 failed
2. 需要验证 KR2 的实际完成情况
3. 可能需要修复导致重试失败的根本原因

## 功能描述

本任务需要：

1. **验证 KR2 完成状态**
   - 检查 PRD/TRD 生成功能是否真正可用
   - 查看相关代码和文档
   - 确认标准化规范是否已实施

2. **分析失败原因**
   - 查看之前失败任务的日志
   - 识别重复失败的模式
   - 定位根本问题

3. **修复或完善功能**
   - 如果 KR2 未真正完成，补齐缺失部分
   - 如果已完成但有 bug，修复问题
   - 更新相关文档和测试

4. **更新 Brain 系统**
   - 如果发现 KR2 进度不准确，更新正确状态
   - 清理失败的重试任务
   - 确保后续调度正常

## 影响范围

### 涉及的文件
- `apps/core/src/brain/planner.js` - Planner 逻辑（包含 TRD 生成）
- `apps/core/src/brain/templates.js` - Template 生成逻辑
- `apps/core/src/brain/__tests__/` - Brain 单元测试
- `.github/workflows/` - CI 配置（如果测试失败需要修复）

### 涉及的 API
- `GET /api/brain/status` - 查看系统状态
- `POST /api/brain/action/*` - Brain 动作 API
- 可能涉及 Task/Goal 相关 API

### 数据库表
- `tasks` - 任务表
- `goals` - 目标表
- `decision_log` - 决策日志表

## 非目标

明确说明本次 **不做** 的事情：

- ❌ 不重构整个 Brain 调度系统架构
- ❌ 不修改 Planner V2 的核心算法
- ❌ 不处理其他 KR (KR1, KR3) 的失败任务
- ❌ 不优化 Brain API 性能（除非直接导致功能失败）
- ❌ 不添加新的 PRD/TRD 生成功能（只验证和修复现有功能）
- ❌ 不修改 N8N 调度逻辑

## 成功标准

### 1. PRD/TRD 生成功能验证
- [ ] 找到 Brain 中 PRD/TRD 生成的代码位置（至少定位到具体文件和函数）
- [ ] 手动测试生成功能：创建一个测试 Goal，验证能否生成包含 title、requirements、success_criteria 的 TRD
- [ ] 如果存在自动化测试，运行 `npm test -- packages/server/src/brain/__tests__/*.test.ts`，至少 90% 通过率

### 2. 失败原因分析
- [ ] 查看 Brain decision_log，找到最近 10 次 "Advance KR2" 相关的失败记录
- [ ] 识别共同失败模式：错误堆栈、错误消息、失败步骤
- [ ] 定位根本原因：代码 bug、配置问题、依赖缺失、或逻辑错误

### 3. 问题修复（如果需要）
- [ ] 如果发现代码 bug，修复后重新测试通过
- [ ] 如果是配置问题，更新配置并验证
- [ ] 添加或修复相关单元测试，确保覆盖失败场景

### 4. 任务状态清理
- [ ] 使用 Brain API 更新相关失败任务：`curl -X POST http://localhost:5212/api/brain/action/update-task -d '{"task_id":"xxx","status":"completed"}'`
- [ ] 验证 `GET /api/brain/status` 中 p0 任务列表不再包含 "Advance KR2" 的 failed 任务
- [ ] 确认 Brain system_health 中 stale_tasks = 0

### 5. 进度验证
- [ ] 如果 KR2 确实已完成，验证功能正常工作
- [ ] 如果 KR2 未完成，更新 Brain 中的 KR2 progress 为正确值（例如 70%）
- [ ] 记录验证结果到文档（如 `docs/KR2-VERIFICATION.md`）

## 技术方案

### 1. 验证阶段
- 检查 `packages/server/src/brain/` 相关代码
- 查看 PRD/TRD 生成的 API 端点
- 测试实际生成功能

### 2. 修复阶段
- 根据发现的问题进行修复
- 添加必要的测试用例
- 更新文档

### 3. 清理阶段
- 使用 Brain API 更新任务状态
- 确保没有遗留的 failed 任务干扰后续调度

## 依赖

- Brain API (http://localhost:5212/api/brain/*)
- Task System API
- 现有 PRD/TRD 生成逻辑

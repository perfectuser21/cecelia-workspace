---
id: fix-cecelia-overview-frontend
version: 1.0.0
created: 2026-02-01
---

# PRD - 修复 Cecelia Overview 前端实现位置

## 问题背景

PR #227 将 Cecelia Overview 运行时监控功能写到了错误的文件位置：
- ❌ **错误位置**: `apps/core/features/execution/pages/CeceliaOverview.tsx`（后端测试文件，不在前端渲染路径）
- ✅ **正确位置**: `apps/dashboard/frontend/src/pages/ExecutionStatus.tsx`（前端实际页面，对应 /system/cecelia 路由）

**影响**: 用户访问 https://dev-core.zenjoymedia.media/system/cecelia 看不到新增的 Seats、Tick Loop、熔断器等监控面板。

## 功能需求

在 `apps/dashboard/frontend/src/pages/ExecutionStatus.tsx` 中添加运行时监控面板，**同时保留原有的 n8n 执行记录功能**。

### 新增监控面板

#### 1. Seats 配置卡片
- 显示最大并发数（max_concurrent）
- 显示当前使用中的 seats（in_progress 任务数）
- 显示可用 seats（max - used）
- 使用率进度条可视化

#### 2. Tick Loop 状态卡片
- 运行状态指示器（enabled && loop_running → "运行中" / "已停止"）
- 循环间隔（loop_interval_ms / 60000 分钟）
- 今日动作数（actions_today）
- 上次运行时间（last_tick，格式化显示）
- 下次运行时间（next_tick，格式化显示）

#### 3. 熔断器状态卡片
- 列表显示所有 circuit breaker
- 状态颜色标识：
  - CLOSED → 绿色
  - OPEN → 红色
  - HALF_OPEN → 黄色
- 显示失败次数
- 显示最后失败时间（如果有）

#### 4. 任务队列统计卡片
- 5 种状态的数量统计（queued/in_progress/completed/failed/cancelled）
- 可视化进度条（各状态占比）
- 百分比计算（带零除保护：`tasks.length > 0 ? ... : 0`）

#### 5. 当前活动卡片
- 显示 in_progress 状态的任务列表
- 任务标题
- 开始时间
- 运行状态动画指示器

### 数据源

- **Brain API**: `http://localhost:5221/api/brain/tick/status`
  - 提供：Tick Loop 状态、Seats 配置、熔断器状态
  
- **Tasks API**: `/api/tasks` 或 `/api/v1/tasks`（需确认正确端点）
  - 提供：任务队列数据

### 技术要求

1. **环境感知的 API URL**:
   ```typescript
   const BRAIN_API_URL = typeof window !== 'undefined' && window.location.hostname !== 'localhost'
     ? `${window.location.protocol}//${window.location.hostname}:5221`
     : 'http://localhost:5221';
   ```

2. **useCallback 防止循环依赖**:
   ```typescript
   const loadData = useCallback(async () => {
     // 数据获取逻辑
   }, [dependencies]);
   ```

3. **自动刷新**: 30 秒间隔自动刷新

4. **错误处理**: 完整的 try-catch + 用户友好的错误 UI

5. **零除保护**: 百分比计算时检查 `tasks.length > 0`

### 页面布局

```
┌─────────────────────────────────────────┐
│ 工作记录 (原标题保留)                    │
├─────────────────────────────────────────┤
│ [新增] Cecelia 运行时监控               │
│ ┌────────┬────────┬────────┬────────┐  │
│ │ Seats  │ Tick   │ 熔断器 │ 任务队 │  │
│ │ 配置   │ Loop   │ 状态   │ 列统计 │  │
│ └────────┴────────┴────────┴────────┘  │
│ ┌──────────────────────────────────┐   │
│ │ 当前活动（in_progress 任务列表） │   │
│ └──────────────────────────────────┘   │
├─────────────────────────────────────────┤
│ [原有] n8n 执行记录                     │
│ ┌────────────────────────────────────┐ │
│ │ 今日统计（总执行/成功/失败/成功率）│ │
│ └────────────────────────────────────┘ │
│ ┌────────────────────────────────────┐ │
│ │ Feature 分组展示                   │ │
│ │ - 数据采集                         │ │
│ │ - 内容发布                         │ │
│ │ - AI 自动化                        │ │
│ └────────────────────────────────────┘ │
└─────────────────────────────────────────┘
```

## 成功标准

1. 用户访问 `/system/cecelia` 能看到 5 个新监控面板
2. Brain API 数据正确获取和显示
3. Tasks API 数据正确获取和显示
4. 原有 n8n 执行记录功能保持不变
5. 数据每 30 秒自动刷新
6. 熔断器状态用正确颜色标识
7. 百分比计算无 NaN 错误（零除保护）
8. 前端构建成功（`npm run build`）
9. 部署后在浏览器中可见新功能

## 非目标

- 不修改 Brain API 实现
- 不修改 Tasks API 实现
- 不删除原有 n8n 执行记录功能
- 不改变页面路由 `/system/cecelia`

{
  "name": "Task Dispatcher v2.0",
  "nodes": [
    {
      "id": "schedule-trigger",
      "name": "å®šæ—¶è§¦å‘",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [
        240,
        300
      ],
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "minutes",
              "minutesInterval": 5
            }
          ]
        }
      }
    },
    {
      "id": "manual-trigger",
      "name": "æ‰‹åŠ¨è§¦å‘",
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [
        240,
        500
      ]
    },
    {
      "id": "webhook-trigger",
      "name": "Webhook è§¦å‘",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        240,
        700
      ],
      "webhookId": "task-dispatcher-trigger",
      "parameters": {
        "path": "task-dispatcher",
        "httpMethod": "POST",
        "responseMode": "onReceived",
        "responseData": "allEntries",
        "options": {}
      }
    },
    {
      "id": "check-vps-load",
      "name": "æ£€æŸ¥ VPS è´Ÿè½½",
      "type": "n8n-nodes-base.ssh",
      "typeVersion": 1,
      "position": [
        520,
        400
      ],
      "parameters": {
        "authentication": "privateKey",
        "host": "146.190.52.84",
        "port": 22,
        "user": "xx",
        "command": "/home/xx/bin/ai-factory-v2/monitor.sh"
      },
      "credentials": {
        "sshPrivateKey": {
          "id": "vvJsQOZ95sqzemla",
          "name": "VPS SSH Key"
        }
      }
    },
    {
      "id": "parse-load",
      "name": "è§£æè´Ÿè½½",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        780,
        400
      ],
      "parameters": {
        "jsCode": "const stdout = $input.first().json.stdout || '{}';\nlet load = { cpu: 0, memory: 0, running_tasks: 0 };\n\ntry {\n  load = JSON.parse(stdout);\n} catch (e) {\n  console.log('Failed to parse load:', e.message);\n}\n\n// é˜ˆå€¼æ£€æŸ¥\nconst MAX_CPU = 75;\nconst MAX_MEMORY = 75;\nconst MAX_RUNNING = 5;\n\nconst canExecute = load.cpu < MAX_CPU && \n                   load.memory < MAX_MEMORY && \n                   load.running_tasks < MAX_RUNNING;\n\nreturn {\n  ...load,\n  can_execute: canExecute,\n  reason: canExecute ? 'OK' : \n    load.cpu >= MAX_CPU ? `CPU ${load.cpu}% >= ${MAX_CPU}%` :\n    load.memory >= MAX_MEMORY ? `Memory ${load.memory}% >= ${MAX_MEMORY}%` :\n    `Running tasks ${load.running_tasks} >= ${MAX_RUNNING}`\n};"
      }
    },
    {
      "id": "check-can-execute",
      "name": "èµ„æºè¶³å¤Ÿ?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        1040,
        400
      ],
      "parameters": {
        "conditions": {
          "options": {
            "leftValue": "",
            "caseSensitive": true,
            "typeValidation": "strict"
          },
          "combinator": "and",
          "conditions": [
            {
              "id": "check-can",
              "operator": {
                "type": "boolean",
                "operation": "true"
              },
              "leftValue": "={{ $json.can_execute }}"
            }
          ]
        },
        "options": {}
      }
    },
    {
      "id": "resource-exhausted",
      "name": "èµ„æºä¸è¶³",
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        1300,
        560
      ]
    },
    {
      "id": "query-tasks",
      "name": "æŸ¥è¯¢ä»»åŠ¡",
      "type": "n8n-nodes-base.notion",
      "typeVersion": 2.2,
      "position": [
        1300,
        400
      ],
      "parameters": {
        "resource": "databasePage",
        "operation": "getAll",
        "databaseId": {
          "__rl": true,
          "mode": "id",
          "value": "54fe0d4cf4344e918bb0e33967661c42"
        },
        "returnAll": true,
        "options": {}
      },
      "credentials": {
        "notionApi": {
          "id": "KOSUxBByCoMPR3Au",
          "name": "Notion API"
        }
      }
    },
    {
      "id": "filter-tasks",
      "name": "è¿‡æ»¤å¯æ‰§è¡Œä»»åŠ¡",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1560,
        400
      ],
      "parameters": {
        "jsCode": "// v2.0 è¿‡æ»¤æ¡ä»¶:\n// - Status = 'Next Action' æˆ– 'Waiting'\n// - AI Task = true\n// - Coding Type æœ‰å€¼\n// - Area åŒ…å« AI Systems & Automation\n// - ä¾èµ–ä»»åŠ¡éƒ½å·²å®Œæˆ (AI Done æˆ– Completed)\n\nconst AI_AREA_ID = '21e53f413ec5805f8be2ce01f4247df2';\nconst VALID_STATUSES = ['Next Action', 'Waiting'];\nconst COMPLETED_STATUSES = ['AI Done', 'Completed'];\n\n// åˆ›å»ºä»»åŠ¡ ID -> çŠ¶æ€æ˜ å°„ï¼Œç”¨äºä¾èµ–æ£€æŸ¥\nconst allTasks = $input.all();\nconst taskStatusMap = new Map();\nallTasks.forEach(item => {\n  const id = item.json.id?.replace(/-/g, '');\n  const status = item.json.property_status;\n  if (id) taskStatusMap.set(id, status);\n});\n\nconst tasks = allTasks.filter(item => {\n  const json = item.json;\n  \n  // Status = Next Action æˆ– Waiting\n  if (!VALID_STATUSES.includes(json.property_status)) return false;\n  \n  // AI Task = true\n  if (!json.property_ai_task) return false;\n  \n  // Coding Type æœ‰å€¼\n  if (!json.property_coding_type) return false;\n  \n  // Area åŒ…å« AI Systems\n  const areas = json.property_area || [];\n  const hasAIArea = areas.some(a => {\n    const id = typeof a === 'string' ? a : a.id;\n    return id === AI_AREA_ID || id?.replace(/-/g, '') === AI_AREA_ID.replace(/-/g, '');\n  });\n  if (!hasAIArea) return false;\n  \n  // ä¾èµ–æ£€æŸ¥: blocked_by ä¸­çš„ä»»åŠ¡éƒ½å¿…é¡»æ˜¯ AI Done æˆ– Completed\n  const blockedBy = json.property_blocked_by || [];\n  const depsOK = blockedBy.every(dep => {\n    const depId = (typeof dep === 'string' ? dep : dep.id)?.replace(/-/g, '');\n    const depStatus = taskStatusMap.get(depId);\n    return COMPLETED_STATUSES.includes(depStatus);\n  });\n  if (!depsOK) return false;\n  \n  return true;\n});\n\n// æŒ‰ä¼˜å…ˆçº§æ’åº: Next Action ä¼˜å…ˆäº Waiting\ntasks.sort((a, b) => {\n  const statusOrder = { 'Next Action': 0, 'Waiting': 1 };\n  return (statusOrder[a.json.property_status] || 99) - (statusOrder[b.json.property_status] || 99);\n});\n\n// åªè¿”å›ç¬¬ä¸€ä¸ªä»»åŠ¡ï¼ˆå¼‚æ­¥æ‰§è¡Œä¸€ä¸ªå°±è¿”å›ï¼‰\nreturn tasks.slice(0, 1);"
      }
    },
    {
      "id": "check-tasks",
      "name": "æœ‰ä»»åŠ¡?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        1820,
        400
      ],
      "parameters": {
        "conditions": {
          "options": {
            "leftValue": "",
            "caseSensitive": true,
            "typeValidation": "strict"
          },
          "combinator": "and",
          "conditions": [
            {
              "id": "check-length",
              "operator": {
                "type": "number",
                "operation": "gt"
              },
              "leftValue": "={{ $input.all().length }}",
              "rightValue": 0
            }
          ]
        },
        "options": {}
      }
    },
    {
      "id": "no-tasks",
      "name": "æ— ä»»åŠ¡",
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        2080,
        560
      ]
    },
    {
      "id": "get-page-content",
      "name": "è·å–ä»»åŠ¡è¯¦æƒ…",
      "type": "n8n-nodes-base.notion",
      "typeVersion": 2.2,
      "position": [
        2080,
        400
      ],
      "parameters": {
        "resource": "block",
        "operation": "getAll",
        "blockId": {
          "__rl": true,
          "mode": "id",
          "value": "={{ $json.id }}"
        },
        "returnAll": true,
        "options": {}
      },
      "credentials": {
        "notionApi": {
          "id": "KOSUxBByCoMPR3Au",
          "name": "Notion API"
        }
      }
    },
    {
      "id": "update-status-running",
      "name": "æ›´æ–°çŠ¶æ€: In Progress",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        2340,
        400
      ],
      "parameters": {
        "method": "PATCH",
        "url": "=https://api.notion.com/v1/pages/{{ $('è¿‡æ»¤å¯æ‰§è¡Œä»»åŠ¡').first().json.id }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer {{ $env.NOTION_API_KEY }}"
            },
            {
              "name": "Notion-Version",
              "value": "2022-06-28"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"properties\": {\n    \"Status\": {\n      \"status\": {\n        \"name\": \"In Progress\"\n      }\n    },\n    \"Run ID\": {\n      \"rich_text\": [\n        {\n          \"type\": \"text\",\n          \"text\": {\n            \"content\": \"{{ $runId }}\"\n          }\n        }\n      ]\n    }\n  }\n}",
        "options": {}
      }
    },
    {
      "id": "prepare-command",
      "name": "å‡†å¤‡å¼‚æ­¥å‘½ä»¤",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2600,
        400
      ],
      "parameters": {
        "jsCode": "const task = $('è¿‡æ»¤å¯æ‰§è¡Œä»»åŠ¡').first().json;\n\n// æå–ä»»åŠ¡ä¿¡æ¯ (n8n Notion èŠ‚ç‚¹è¿”å› property_xxx æ ¼å¼)\nconst taskName = task.name || task.property_name || 'Unknown Task';\n\n// coding_type æ˜ å°„:\n// - Workflow / n8n Workflow -> n8n\n// - Backend -> backend\n// - Frontend -> frontend\n// - Check -> check (æ–°å¢)\nlet codingType = (task.property_coding_type || 'n8n').toLowerCase();\nconst typeMap = {\n  // 'workflow': 'n8n',  // å·²æ”¹ä¸ºç›´æ¥ç”¨ n8n\n  'n8n workflow': 'n8n',\n  'n8n': 'n8n',\n  'backend': 'backend',\n  'frontend': 'frontend',\n  'check': 'check'\n};\ncodingType = typeMap[codingType] || 'backend';\n\nconst taskId = task.id;\nconst runId = $runId;\n\n// v2.0 å¼‚æ­¥æ‰§è¡Œ: nohup ... &\n// æ—¥å¿—è¾“å‡ºåˆ° /home/xx/data/runs/${taskId}.log\nconst asyncCommand = `nohup /home/xx/dev/zenithjoy-autopilot/workflows/scripts/v2/main.sh \"${taskId}\" \"${codingType}\" > /home/xx/data/runs/${taskId}.log 2>&1 &`;\n\nreturn {\n  task_id: taskId,\n  task_name: taskName,\n  coding_type: codingType,\n  run_id: runId,\n  execute_command: asyncCommand,\n  is_async: true\n};"
      }
    },
    {
      "id": "execute-async",
      "name": "å¼‚æ­¥æ‰§è¡Œ",
      "type": "n8n-nodes-base.ssh",
      "typeVersion": 1,
      "position": [
        2860,
        400
      ],
      "parameters": {
        "authentication": "privateKey",
        "host": "146.190.52.84",
        "port": 22,
        "user": "xx",
        "command": "={{ $json.execute_command }}"
      },
      "credentials": {
        "sshPrivateKey": {
          "id": "vvJsQOZ95sqzemla",
          "name": "VPS SSH Key"
        }
      }
    },
    {
      "id": "log-dispatch",
      "name": "è®°å½•è°ƒåº¦",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3120,
        400
      ],
      "parameters": {
        "jsCode": "const task = $('å‡†å¤‡å¼‚æ­¥å‘½ä»¤').first().json;\n\n// å¼‚æ­¥æ¨¡å¼ä¸‹ï¼Œä»»åŠ¡å·²åœ¨åå°å¯åŠ¨\n// å®é™…ç»“æœç”± cleanup.sh é€šè¿‡ Execution Callback webhook å›æŠ¥\n\nreturn {\n  success: true,\n  message: `ä»»åŠ¡å·²å¼‚æ­¥å¯åŠ¨: ${task.task_name}`,\n  task_id: task.task_id,\n  task_name: task.task_name,\n  coding_type: task.coding_type,\n  run_id: task.run_id,\n  async: true,\n  note: 'ä»»åŠ¡ç»“æœå°†é€šè¿‡ Execution Callback å›è°ƒ'\n};"
      }
    },
    {
      "id": "notify-dispatched",
      "name": "é€šçŸ¥: å·²è°ƒåº¦",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        3380,
        400
      ],
      "parameters": {
        "method": "POST",
        "url": "https://open.feishu.cn/open-apis/bot/v2/hook/5bde68e0-9879-4a45-88ed-461a88229136",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"msg_type\": \"interactive\",\n  \"card\": {\n    \"header\": {\n      \"title\": {\n        \"tag\": \"plain_text\",\n        \"content\": \"ğŸš€ Task Dispatched\"\n      },\n      \"template\": \"blue\"\n    },\n    \"elements\": [\n      {\n        \"tag\": \"div\",\n        \"text\": {\n          \"tag\": \"lark_md\",\n          \"content\": \"**ä»»åŠ¡**: {{ $json.task_name }}\\n**ç±»å‹**: {{ $json.coding_type }}\\n**Run ID**: {{ $json.run_id }}\"\n        }\n      }\n    ]\n  }\n}",
        "options": {}
      }
    }
  ],
  "connections": {
    "å®šæ—¶è§¦å‘": {
      "main": [
        [
          {
            "node": "æ£€æŸ¥ VPS è´Ÿè½½",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "æ‰‹åŠ¨è§¦å‘": {
      "main": [
        [
          {
            "node": "æ£€æŸ¥ VPS è´Ÿè½½",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook è§¦å‘": {
      "main": [
        [
          {
            "node": "æ£€æŸ¥ VPS è´Ÿè½½",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "æ£€æŸ¥ VPS è´Ÿè½½": {
      "main": [
        [
          {
            "node": "è§£æè´Ÿè½½",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "è§£æè´Ÿè½½": {
      "main": [
        [
          {
            "node": "èµ„æºè¶³å¤Ÿ?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "èµ„æºè¶³å¤Ÿ?": {
      "main": [
        [
          {
            "node": "æŸ¥è¯¢ä»»åŠ¡",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "èµ„æºä¸è¶³",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "æŸ¥è¯¢ä»»åŠ¡": {
      "main": [
        [
          {
            "node": "è¿‡æ»¤å¯æ‰§è¡Œä»»åŠ¡",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "è¿‡æ»¤å¯æ‰§è¡Œä»»åŠ¡": {
      "main": [
        [
          {
            "node": "æœ‰ä»»åŠ¡?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "æœ‰ä»»åŠ¡?": {
      "main": [
        [
          {
            "node": "è·å–ä»»åŠ¡è¯¦æƒ…",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "æ— ä»»åŠ¡",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "è·å–ä»»åŠ¡è¯¦æƒ…": {
      "main": [
        [
          {
            "node": "æ›´æ–°çŠ¶æ€: In Progress",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "æ›´æ–°çŠ¶æ€: In Progress": {
      "main": [
        [
          {
            "node": "å‡†å¤‡å¼‚æ­¥å‘½ä»¤",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "å‡†å¤‡å¼‚æ­¥å‘½ä»¤": {
      "main": [
        [
          {
            "node": "å¼‚æ­¥æ‰§è¡Œ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "å¼‚æ­¥æ‰§è¡Œ": {
      "main": [
        [
          {
            "node": "è®°å½•è°ƒåº¦",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "è®°å½•è°ƒåº¦": {
      "main": [
        [
          {
            "node": "é€šçŸ¥: å·²è°ƒåº¦",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1",
    "saveManualExecutions": true,
    "callerPolicy": "workflowsFromSameOwner",
    "availableInMCP": true
  }
}
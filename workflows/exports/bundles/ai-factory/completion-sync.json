{
  "name": "Completion Sync v1.0",
  "nodes": [
    {
      "id": "schedule-trigger",
      "name": "å®šæ—¶è§¦å‘",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [240, 400],
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "minutes",
              "minutesInterval": 5
            }
          ]
        }
      }
    },
    {
      "id": "manual-trigger",
      "name": "æ‰‹åŠ¨è§¦å‘",
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [240, 600]
    },
    {
      "id": "query-completed-features",
      "name": "æŸ¥è¯¢å·²å®Œæˆçš„ Feature Check",
      "type": "n8n-nodes-base.notion",
      "typeVersion": 2.2,
      "position": [520, 500],
      "parameters": {
        "resource": "databasePage",
        "operation": "getAll",
        "databaseId": {
          "__rl": true,
          "mode": "id",
          "value": "54fe0d4cf4344e918bb0e33967661c42"
        },
        "returnAll": true,
        "options": {}
      },
      "credentials": {
        "notionApi": {
          "id": "KOSUxBByCoMPR3Au",
          "name": "Notion API"
        }
      }
    },
    {
      "id": "filter-features",
      "name": "è¿‡æ»¤ Feature Check",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [780, 500],
      "parameters": {
        "jsCode": "// è¿‡æ»¤æ¡ä»¶:\n// - Daily Highlight = true (Feature Check)\n// - AI Task = true\n// - Status = Completed\n\nconst allTasks = $input.all();\n\n// åˆ›å»ºä»»åŠ¡ ID -> ä»»åŠ¡å¯¹è±¡æ˜ å°„\nconst taskMap = new Map();\nallTasks.forEach(item => {\n  const id = item.json.id?.replace(/-/g, '');\n  if (id) taskMap.set(id, item.json);\n});\n\n// æ‰¾åˆ°å·²å®Œæˆçš„ Feature Check\nconst completedFeatures = allTasks.filter(item => {\n  const json = item.json;\n  \n  // Daily Highlight = true\n  if (!json.property_daily_highlight) return false;\n  \n  // AI Task = true\n  if (!json.property_ai_task) return false;\n  \n  // Status = Completed\n  if (json.property_status !== 'Completed') return false;\n  \n  return true;\n});\n\n// å¯¹äºæ¯ä¸ªå·²å®Œæˆçš„ Featureï¼Œæ£€æŸ¥å…¶ä¾èµ–ä»»åŠ¡\nconst tasksToSync = [];\n\nfor (const feature of completedFeatures) {\n  const blockedBy = feature.json.property_blocked_by || [];\n  \n  for (const dep of blockedBy) {\n    const depId = (typeof dep === 'string' ? dep : dep.id)?.replace(/-/g, '');\n    const depTask = taskMap.get(depId);\n    \n    if (depTask && depTask.property_status !== 'Completed') {\n      // ä¾èµ–ä»»åŠ¡è¿˜æœªåŒæ­¥ä¸º Completed\n      tasksToSync.push({\n        task_id: depTask.id,\n        task_name: depTask.name || depTask.property_name,\n        current_status: depTask.property_status,\n        feature_name: feature.json.name || feature.json.property_name,\n        feature_id: feature.json.id\n      });\n    }\n  }\n}\n\nif (tasksToSync.length === 0) {\n  return [{ json: { no_tasks: true, message: 'æ²¡æœ‰éœ€è¦åŒæ­¥çš„ä»»åŠ¡' } }];\n}\n\nreturn tasksToSync.map(t => ({ json: t }));"
      }
    },
    {
      "id": "check-tasks",
      "name": "æœ‰ä»»åŠ¡éœ€è¦åŒæ­¥?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [1040, 500],
      "parameters": {
        "conditions": {
          "options": {
            "leftValue": "",
            "caseSensitive": true,
            "typeValidation": "strict"
          },
          "combinator": "and",
          "conditions": [
            {
              "id": "check-no-tasks",
              "operator": {
                "type": "boolean",
                "operation": "notEqual"
              },
              "leftValue": "={{ $json.no_tasks }}",
              "rightValue": true
            }
          ]
        },
        "options": {}
      }
    },
    {
      "id": "no-sync",
      "name": "æ— éœ€åŒæ­¥",
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [1300, 660]
    },
    {
      "id": "loop-tasks",
      "name": "é€ä¸ªåŒæ­¥",
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [1300, 500],
      "parameters": {
        "batchSize": 1,
        "options": {}
      }
    },
    {
      "id": "update-status",
      "name": "æ›´æ–°çŠ¶æ€: Completed",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1560, 500],
      "parameters": {
        "method": "PATCH",
        "url": "=https://api.notion.com/v1/pages/{{ $json.task_id }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer {{ $env.NOTION_API_KEY }}"
            },
            {
              "name": "Notion-Version",
              "value": "2022-06-28"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"properties\": {\n    \"Status\": {\n      \"status\": {\n        \"name\": \"Completed\"\n      }\n    }\n  }\n}",
        "options": {}
      }
    },
    {
      "id": "log-sync",
      "name": "è®°å½•åŒæ­¥",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1820, 500],
      "parameters": {
        "jsCode": "const task = $('é€ä¸ªåŒæ­¥').item.json;\n\nreturn {\n  synced: true,\n  task_id: task.task_id,\n  task_name: task.task_name,\n  from_status: task.current_status,\n  to_status: 'Completed',\n  feature_name: task.feature_name\n};"
      }
    },
    {
      "id": "collect-results",
      "name": "æ”¶é›†ç»“æœ",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2080, 500],
      "parameters": {
        "jsCode": "// è¿™ä¸ªèŠ‚ç‚¹åœ¨å¾ªç¯å®Œæˆåæ‰§è¡Œ\nconst allItems = $input.all();\nconst syncedTasks = allItems.filter(item => item.json.synced);\n\nif (syncedTasks.length === 0) {\n  return { json: { synced_count: 0, message: 'æ²¡æœ‰åŒæ­¥ä»»ä½•ä»»åŠ¡' } };\n}\n\n// æŒ‰ feature åˆ†ç»„\nconst byFeature = {};\nfor (const item of syncedTasks) {\n  const featureName = item.json.feature_name || 'Unknown';\n  if (!byFeature[featureName]) {\n    byFeature[featureName] = [];\n  }\n  byFeature[featureName].push(item.json.task_name);\n}\n\nconst summaryParts = [];\nfor (const [feature, tasks] of Object.entries(byFeature)) {\n  summaryParts.push(`**${feature}**: ${tasks.join(', ')}`);\n}\n\nreturn {\n  synced_count: syncedTasks.length,\n  summary: summaryParts.join('\\n'),\n  details: syncedTasks.map(t => t.json)\n};"
      }
    },
    {
      "id": "check-synced",
      "name": "æœ‰åŒæ­¥?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [2340, 500],
      "parameters": {
        "conditions": {
          "options": {
            "leftValue": "",
            "caseSensitive": true,
            "typeValidation": "strict"
          },
          "combinator": "and",
          "conditions": [
            {
              "id": "check-count",
              "operator": {
                "type": "number",
                "operation": "gt"
              },
              "leftValue": "={{ $json.synced_count }}",
              "rightValue": 0
            }
          ]
        },
        "options": {}
      }
    },
    {
      "id": "notify-sync",
      "name": "é€šçŸ¥: çŠ¶æ€åŒæ­¥",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [2600, 400],
      "parameters": {
        "method": "POST",
        "url": "https://open.feishu.cn/open-apis/bot/v2/hook/5bde68e0-9879-4a45-88ed-461a88229136",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"msg_type\": \"interactive\",\n  \"card\": {\n    \"header\": {\n      \"title\": {\n        \"tag\": \"plain_text\",\n        \"content\": \"ğŸ”„ Task çŠ¶æ€åŒæ­¥\"\n      },\n      \"template\": \"turquoise\"\n    },\n    \"elements\": [\n      {\n        \"tag\": \"div\",\n        \"text\": {\n          \"tag\": \"lark_md\",\n          \"content\": \"å·²åŒæ­¥ {{ $json.synced_count }} ä¸ªä»»åŠ¡ä¸º Completed:\\n\\n{{ $json.summary }}\"\n        }\n      }\n    ]\n  }\n}",
        "options": {}
      }
    },
    {
      "id": "done",
      "name": "å®Œæˆ",
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [2600, 600]
    }
  ],
  "connections": {
    "å®šæ—¶è§¦å‘": {
      "main": [[{"node": "æŸ¥è¯¢å·²å®Œæˆçš„ Feature Check", "type": "main", "index": 0}]]
    },
    "æ‰‹åŠ¨è§¦å‘": {
      "main": [[{"node": "æŸ¥è¯¢å·²å®Œæˆçš„ Feature Check", "type": "main", "index": 0}]]
    },
    "æŸ¥è¯¢å·²å®Œæˆçš„ Feature Check": {
      "main": [[{"node": "è¿‡æ»¤ Feature Check", "type": "main", "index": 0}]]
    },
    "è¿‡æ»¤ Feature Check": {
      "main": [[{"node": "æœ‰ä»»åŠ¡éœ€è¦åŒæ­¥?", "type": "main", "index": 0}]]
    },
    "æœ‰ä»»åŠ¡éœ€è¦åŒæ­¥?": {
      "main": [
        [{"node": "é€ä¸ªåŒæ­¥", "type": "main", "index": 0}],
        [{"node": "æ— éœ€åŒæ­¥", "type": "main", "index": 0}]
      ]
    },
    "é€ä¸ªåŒæ­¥": {
      "main": [
        [{"node": "æ›´æ–°çŠ¶æ€: Completed", "type": "main", "index": 0}],
        [{"node": "æ”¶é›†ç»“æœ", "type": "main", "index": 0}]
      ]
    },
    "æ›´æ–°çŠ¶æ€: Completed": {
      "main": [[{"node": "è®°å½•åŒæ­¥", "type": "main", "index": 0}]]
    },
    "è®°å½•åŒæ­¥": {
      "main": [[{"node": "é€ä¸ªåŒæ­¥", "type": "main", "index": 0}]]
    },
    "æ”¶é›†ç»“æœ": {
      "main": [[{"node": "æœ‰åŒæ­¥?", "type": "main", "index": 0}]]
    },
    "æœ‰åŒæ­¥?": {
      "main": [
        [{"node": "é€šçŸ¥: çŠ¶æ€åŒæ­¥", "type": "main", "index": 0}],
        [{"node": "å®Œæˆ", "type": "main", "index": 0}]
      ]
    },
    "é€šçŸ¥: çŠ¶æ€åŒæ­¥": {
      "main": [[{"node": "å®Œæˆ", "type": "main", "index": 0}]]
    }
  },
  "settings": {
    "executionOrder": "v1",
    "saveManualExecutions": true,
    "callerPolicy": "workflowsFromSameOwner",
    "availableInMCP": true
  }
}

#!/bin/bash
#
# Example Regression Test: Performance and Complexity Check
#
# This test validates that workflows don't exceed reasonable complexity limits.
# Rename this file to remove .template extension to activate it.
#

set -e

WORKFLOW_IDS="$1"

# Load secrets for API access
source /home/xx/dev/n8n-workflows/.secrets 2>/dev/null || {
  echo "Error: Cannot load .secrets file"
  exit 1
}

if [[ -z "$N8N_REST_API_KEY" ]]; then
  echo "Error: N8N_REST_API_KEY not set"
  exit 1
fi

# Configuration
MAX_NODES=50
MAX_DEPTH=10  # Maximum nesting depth of connections

# Test: Validate workflow complexity
for wid in $WORKFLOW_IDS; do
  if [[ -z "$wid" ]]; then
    continue
  fi

  # Fetch workflow details
  wf_content=$(curl -s -H "X-N8N-API-KEY: $N8N_REST_API_KEY" \
    "http://localhost:5679/api/v1/workflows/$wid" 2>/dev/null)

  # Check node count
  node_count=$(echo "$wf_content" | jq '.nodes | length')

  if [[ $node_count -gt $MAX_NODES ]]; then
    echo "Error: Workflow $wid has $node_count nodes (exceeds limit of $MAX_NODES)"
    exit 1
  fi

  echo "Workflow $wid complexity: $node_count nodes (within limits)"

  # Check for circular dependencies (basic check)
  connections=$(echo "$wf_content" | jq -r '.connections | keys[]' 2>/dev/null || echo "")

  if [[ -n "$connections" ]]; then
    # Count unique source and target nodes
    source_count=$(echo "$connections" | wc -l)

    # If there are more connections than nodes, might indicate complexity issues
    if [[ $source_count -gt $((node_count * 3)) ]]; then
      echo "Warning: Workflow $wid has high connection density (${source_count} connections for ${node_count} nodes)"
      # Don't fail, just warn
    fi
  fi

  # Check for duplicate node names (can cause confusion)
  duplicate_names=$(echo "$wf_content" | jq -r '.nodes[].name' | sort | uniq -d)

  if [[ -n "$duplicate_names" ]]; then
    echo "Warning: Workflow $wid has duplicate node names: $duplicate_names"
    # Don't fail, just warn
  fi
done

echo "Performance and complexity check passed"
exit 0

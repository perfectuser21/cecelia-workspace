{
  "name": "Feature Completion Sync",
  "description": null,
  "active": false,
  "nodes": [
    {
      "id": "schedule-trigger",
      "name": "æ¯5åˆ†é’Ÿè§¦å‘",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [
        240,
        300
      ],
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "minutes",
              "minutesInterval": 5
            }
          ]
        }
      }
    },
    {
      "id": "manual-trigger",
      "name": "æ‰‹åŠ¨è§¦å‘",
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [
        240,
        500
      ]
    },
    {
      "id": "query-ai-done",
      "name": "æŸ¥è¯¢ AI Done çš„ Feature Check",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        520,
        400
      ],
      "parameters": {
        "method": "POST",
        "url": "https://api.notion.com/v1/databases/54fe0d4c-f434-4e91-8bb0-e33967661c42/query",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer {{ $env.NOTION_API_KEY }}"
            },
            {
              "name": "Notion-Version",
              "value": "2022-06-28"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "{\n  \"filter\": {\n    \"and\": [\n      { \"property\": \"Daily Highlight\", \"checkbox\": { \"equals\": true } },\n      { \"property\": \"AI Task\", \"checkbox\": { \"equals\": true } },\n      { \"property\": \"Coding Type\", \"select\": { \"equals\": \"Check\" } },\n      { \"property\": \"Status\", \"status\": { \"equals\": \"AI Done\" } }\n    ]\n  },\n  \"page_size\": 10\n}",
        "options": {}
      }
    },
    {
      "id": "query-completed",
      "name": "æŸ¥è¯¢ Completed çš„ Feature Check",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        520,
        600
      ],
      "parameters": {
        "method": "POST",
        "url": "https://api.notion.com/v1/databases/54fe0d4c-f434-4e91-8bb0-e33967661c42/query",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer {{ $env.NOTION_API_KEY }}"
            },
            {
              "name": "Notion-Version",
              "value": "2022-06-28"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "{\n  \"filter\": {\n    \"and\": [\n      { \"property\": \"Daily Highlight\", \"checkbox\": { \"equals\": true } },\n      { \"property\": \"AI Task\", \"checkbox\": { \"equals\": true } },\n      { \"property\": \"Coding Type\", \"select\": { \"equals\": \"Check\" } },\n      { \"property\": \"Status\", \"status\": { \"equals\": \"Completed\" } }\n    ]\n  },\n  \"page_size\": 10\n}",
        "options": {}
      }
    },
    {
      "id": "merge-results",
      "name": "åˆå¹¶ç»“æœ",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3,
      "position": [
        780,
        500
      ],
      "parameters": {
        "mode": "append",
        "options": {}
      }
    },
    {
      "id": "process-features",
      "name": "å¤„ç† Feature",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1040,
        500
      ],
      "parameters": {
        "jsCode": "const items = $input.all();\n\n// åˆ†ç±»å¤„ç† AI Done å’Œ Completed\nconst results = [];\n\nfor (const item of items) {\n  const pageResults = item.json.results || [];\n  \n  for (const page of pageResults) {\n    const status = page.properties?.Status?.status?.name;\n    const taskId = page.id;\n    const taskName = page.properties?.Name?.title?.map(t => t.plain_text).join('') || 'Unknown';\n    const projectId = page.properties?.Project?.relation?.[0]?.id;\n    \n    results.push({\n      task_id: taskId,\n      task_name: taskName,\n      status: status,\n      project_id: projectId,\n      action: status === 'AI Done' ? 'notify_review' : 'sync_completed'\n    });\n  }\n}\n\nif (results.length === 0) {\n  return { no_tasks: true };\n}\n\nreturn results;"
      }
    },
    {
      "id": "check-has-tasks",
      "name": "æœ‰ä»»åŠ¡?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        1300,
        500
      ],
      "parameters": {
        "conditions": {
          "options": {
            "leftValue": "",
            "caseSensitive": true,
            "typeValidation": "strict"
          },
          "combinator": "and",
          "conditions": [
            {
              "id": "check-no-tasks",
              "operator": {
                "type": "boolean",
                "operation": "false"
              },
              "leftValue": "={{ $json.no_tasks || false }}"
            }
          ]
        },
        "options": {}
      }
    },
    {
      "id": "no-tasks",
      "name": "æ— ä»»åŠ¡",
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        1560,
        660
      ]
    },
    {
      "id": "split-features",
      "name": "æ‹†åˆ† Feature",
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        1560,
        500
      ],
      "parameters": {
        "batchSize": 1,
        "options": {}
      }
    },
    {
      "id": "check-action",
      "name": "æ£€æŸ¥æ“ä½œç±»å‹",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        1820,
        500
      ],
      "parameters": {
        "conditions": {
          "options": {
            "leftValue": "",
            "caseSensitive": true,
            "typeValidation": "strict"
          },
          "combinator": "and",
          "conditions": [
            {
              "id": "check-action",
              "operator": {
                "type": "string",
                "operation": "equals"
              },
              "leftValue": "={{ $json.action }}",
              "rightValue": "notify_review"
            }
          ]
        },
        "options": {}
      }
    },
    {
      "id": "read-check-report",
      "name": "è¯»å–æ£€æŸ¥æŠ¥å‘Š",
      "type": "n8n-nodes-base.ssh",
      "typeVersion": 1,
      "position": [
        2080,
        400
      ],
      "parameters": {
        "authentication": "privateKey",
        "host": "146.190.52.84",
        "port": 22,
        "user": "xx",
        "command": "=# è¯»å– Feature Check çš„æ‰§è¡Œç»“æœ\nRUN_DIR=$(ls -td /home/xx/data/runs/*{{ $json.task_id.slice(0,8) }}* 2>/dev/null | head -1)\nif [[ -f \"$RUN_DIR/result.json\" ]]; then\n  cat \"$RUN_DIR/result.json\"\nelse\n  echo '{\"success\": true, \"score\": 100, \"message\": \"No report found\"}'\nfi"
      },
      "credentials": {
        "sshPrivateKey": {
          "id": "vvJsQOZ95sqzemla",
          "name": "VPS SSH Key"
        }
      }
    },
    {
      "id": "parse-report",
      "name": "è§£ææŠ¥å‘Š",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2340,
        400
      ],
      "parameters": {
        "jsCode": "const stdout = $input.first().json.stdout || '{}';\nconst taskInfo = $('æ‹†åˆ† Feature').first().json;\n\nlet report = { success: true, score: 100 };\ntry {\n  report = JSON.parse(stdout);\n} catch (e) {\n  // è§£æå¤±è´¥ä½¿ç”¨é»˜è®¤å€¼\n}\n\n// æå–åˆ†æ•°\nconst score = report.score || report.scores?.total || 100;\nconst passed = score >= 80;\n\nreturn {\n  ...taskInfo,\n  score: score,\n  passed: passed,\n  report: report\n};"
      }
    },
    {
      "id": "notify-review",
      "name": "é€šçŸ¥éªŒæ”¶",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        2600,
        400
      ],
      "parameters": {
        "method": "POST",
        "url": "={{ $env.FEISHU_BOT_WEBHOOK }}",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"msg_type\": \"interactive\",\n  \"card\": {\n    \"header\": {\n      \"title\": { \"tag\": \"plain_text\", \"content\": \"{{ $json.passed ? 'âœ…' : 'âš ï¸' }} Feature æ‰§è¡Œå®Œæˆï¼Œè¯·éªŒæ”¶\" },\n      \"template\": \"{{ $json.passed ? 'green' : 'orange' }}\"\n    },\n    \"elements\": [\n      {\n        \"tag\": \"div\",\n        \"text\": {\n          \"tag\": \"lark_md\",\n          \"content\": \"**Feature**: {{ $json.task_name }}\\n**è¯„åˆ†**: {{ $json.score }}/100\\n\\n{{ $json.passed ? 'æ‰€æœ‰ä»»åŠ¡æ‰§è¡ŒæˆåŠŸï¼' : 'è¯„åˆ†ä¸è¶³ 80 åˆ†ï¼Œè¯·æ£€æŸ¥ã€‚' }}\\n\\n**æ“ä½œ**:\\nâ€¢ é€šè¿‡ â†’ æ”¹æˆ Completed\\nâ€¢ ä¸é€šè¿‡ â†’ å†™åé¦ˆåæ”¹æˆ Next Action\"\n        }\n      },\n      {\n        \"tag\": \"action\",\n        \"actions\": [\n          {\n            \"tag\": \"button\",\n            \"text\": { \"tag\": \"plain_text\", \"content\": \"æŸ¥çœ‹ Feature\" },\n            \"url\": \"https://www.notion.so/{{ $json.task_id.replace(/-/g, '') }}\",\n            \"type\": \"primary\"\n          }\n        ]\n      }\n    ]\n  }\n}",
        "options": {}
      }
    },
    {
      "id": "sync-completed",
      "name": "åŒæ­¥å®ŒæˆçŠ¶æ€",
      "type": "n8n-nodes-base.ssh",
      "typeVersion": 1,
      "position": [
        2080,
        600
      ],
      "parameters": {
        "authentication": "privateKey",
        "host": "146.190.52.84",
        "port": 22,
        "user": "xx",
        "command": "=# å°† Feature ä¸‹æ‰€æœ‰ä»»åŠ¡æ”¹æˆ Completed\n# è¿™é‡Œç®€åŒ–å¤„ç†ï¼Œå®é™…éœ€è¦æŸ¥è¯¢ Project ä¸‹æ‰€æœ‰ä»»åŠ¡\necho 'åŒæ­¥å®ŒæˆçŠ¶æ€: {{ $json.task_id }}'"
      },
      "credentials": {
        "sshPrivateKey": {
          "id": "vvJsQOZ95sqzemla",
          "name": "VPS SSH Key"
        }
      }
    },
    {
      "id": "query-project-tasks",
      "name": "æŸ¥è¯¢ Project ä»»åŠ¡",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        2340,
        600
      ],
      "parameters": {
        "method": "POST",
        "url": "https://api.notion.com/v1/databases/54fe0d4c-f434-4e91-8bb0-e33967661c42/query",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer {{ $env.NOTION_API_KEY }}"
            },
            {
              "name": "Notion-Version",
              "value": "2022-06-28"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"filter\": {\n    \"and\": [\n      { \"property\": \"Project\", \"relation\": { \"contains\": \"{{ $json.project_id }}\" } },\n      { \"property\": \"AI Task\", \"checkbox\": { \"equals\": true } },\n      { \"property\": \"Status\", \"status\": { \"does_not_equal\": \"Completed\" } }\n    ]\n  },\n  \"page_size\": 50\n}",
        "options": {}
      }
    },
    {
      "id": "batch-update-completed",
      "name": "æ‰¹é‡æ›´æ–°ä¸º Completed",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2600,
        600
      ],
      "parameters": {
        "jsCode": "const taskInfo = $('æ‹†åˆ† Feature').first().json;\nconst queryResult = $input.first().json;\nconst tasksToUpdate = queryResult.results || [];\n\n// å‡†å¤‡æ‰¹é‡æ›´æ–°\nconst updates = tasksToUpdate.map(task => ({\n  task_id: task.id,\n  task_name: task.properties?.Name?.title?.map(t => t.plain_text).join('') || 'Unknown'\n}));\n\nreturn {\n  feature_name: taskInfo.task_name,\n  tasks_to_sync: updates.length,\n  tasks: updates\n};"
      }
    },
    {
      "id": "update-each-task",
      "name": "é€ä¸ªæ›´æ–°ä»»åŠ¡",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        2860,
        600
      ],
      "parameters": {
        "method": "PATCH",
        "url": "=https://api.notion.com/v1/pages/{{ $json.tasks[0]?.task_id || '' }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer {{ $env.NOTION_API_KEY }}"
            },
            {
              "name": "Notion-Version",
              "value": "2022-06-28"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "{\n  \"properties\": {\n    \"Status\": { \"status\": { \"name\": \"Completed\" } }\n  }\n}",
        "options": {}
      }
    },
    {
      "id": "notify-synced",
      "name": "é€šçŸ¥å·²åŒæ­¥",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        3120,
        600
      ],
      "parameters": {
        "method": "POST",
        "url": "={{ $env.FEISHU_BOT_WEBHOOK }}",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"msg_type\": \"interactive\",\n  \"card\": {\n    \"header\": {\n      \"title\": { \"tag\": \"plain_text\", \"content\": \"ğŸ‰ Feature éªŒæ”¶é€šè¿‡\" },\n      \"template\": \"green\"\n    },\n    \"elements\": [\n      {\n        \"tag\": \"div\",\n        \"text\": {\n          \"tag\": \"lark_md\",\n          \"content\": \"**Feature**: {{ $('æ‹†åˆ† Feature').first().json.task_name }}\\n\\nå·²åŒæ­¥ {{ $json.tasks_to_sync }} ä¸ªä»»åŠ¡ä¸º Completedã€‚\"\n        }\n      }\n    ]\n  }\n}",
        "options": {}
      }
    },
    {
      "id": "loop-back",
      "name": "ç»§ç»­ä¸‹ä¸€ä¸ª",
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        3120,
        500
      ]
    }
  ],
  "connections": {
    "æ¯5åˆ†é’Ÿè§¦å‘": {
      "main": [
        [
          {
            "node": "æŸ¥è¯¢ AI Done çš„ Feature Check",
            "type": "main",
            "index": 0
          },
          {
            "node": "æŸ¥è¯¢ Completed çš„ Feature Check",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "æ‰‹åŠ¨è§¦å‘": {
      "main": [
        [
          {
            "node": "æŸ¥è¯¢ AI Done çš„ Feature Check",
            "type": "main",
            "index": 0
          },
          {
            "node": "æŸ¥è¯¢ Completed çš„ Feature Check",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "æŸ¥è¯¢ AI Done çš„ Feature Check": {
      "main": [
        [
          {
            "node": "åˆå¹¶ç»“æœ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "æŸ¥è¯¢ Completed çš„ Feature Check": {
      "main": [
        [
          {
            "node": "åˆå¹¶ç»“æœ",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "åˆå¹¶ç»“æœ": {
      "main": [
        [
          {
            "node": "å¤„ç† Feature",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "å¤„ç† Feature": {
      "main": [
        [
          {
            "node": "æœ‰ä»»åŠ¡?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "æœ‰ä»»åŠ¡?": {
      "main": [
        [
          {
            "node": "æ‹†åˆ† Feature",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "æ— ä»»åŠ¡",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "æ‹†åˆ† Feature": {
      "main": [
        [
          {
            "node": "æ£€æŸ¥æ“ä½œç±»å‹",
            "type": "main",
            "index": 0
          }
        ],
        []
      ]
    },
    "æ£€æŸ¥æ“ä½œç±»å‹": {
      "main": [
        [
          {
            "node": "è¯»å–æ£€æŸ¥æŠ¥å‘Š",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "åŒæ­¥å®ŒæˆçŠ¶æ€",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "è¯»å–æ£€æŸ¥æŠ¥å‘Š": {
      "main": [
        [
          {
            "node": "è§£ææŠ¥å‘Š",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "è§£ææŠ¥å‘Š": {
      "main": [
        [
          {
            "node": "é€šçŸ¥éªŒæ”¶",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "é€šçŸ¥éªŒæ”¶": {
      "main": [
        [
          {
            "node": "ç»§ç»­ä¸‹ä¸€ä¸ª",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "åŒæ­¥å®ŒæˆçŠ¶æ€": {
      "main": [
        [
          {
            "node": "æŸ¥è¯¢ Project ä»»åŠ¡",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "æŸ¥è¯¢ Project ä»»åŠ¡": {
      "main": [
        [
          {
            "node": "æ‰¹é‡æ›´æ–°ä¸º Completed",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "æ‰¹é‡æ›´æ–°ä¸º Completed": {
      "main": [
        [
          {
            "node": "æ›´æ–°æ¯ä¸ªä»»åŠ¡",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "æ›´æ–°æ¯ä¸ªä»»åŠ¡": {
      "main": [
        [
          {
            "node": "é€šçŸ¥å·²åŒæ­¥",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "é€šçŸ¥å·²åŒæ­¥": {
      "main": [
        [
          {
            "node": "ç»§ç»­ä¸‹ä¸€ä¸ª",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ç»§ç»­ä¸‹ä¸€ä¸ª": {
      "main": [
        [
          {
            "node": "æ‹†åˆ† Feature",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1",
    "saveManualExecutions": true,
    "callerPolicy": "workflowsFromSameOwner",
    "availableInMCP": false
  },
  "staticData": {
    "node:æ¯5åˆ†é’Ÿè§¦å‘": {
      "recurrenceRules": []
    }
  },
  "meta": null,
  "pinData": null,
  "versionCounter": 7,
  "shared": [
    {
      "updatedAt": "2025-12-29T12:53:34.544Z",
      "createdAt": "2025-12-29T12:53:34.544Z",
      "role": "workflow:owner",
      "workflowId": "wAp3FlamQUENKBgu",
      "projectId": "XvpIUT75BWOBRhfk",
      "project": {
        "updatedAt": "2025-12-19T12:48:01.773Z",
        "createdAt": "2025-12-19T12:44:28.241Z",
        "id": "XvpIUT75BWOBRhfk",
        "name": "Alex Xu  <zenithjoycloud@gmail.com>",
        "type": "personal",
        "icon": null,
        "description": null,
        "projectRelations": [
          {
            "updatedAt": "2025-12-19T12:44:28.241Z",
            "createdAt": "2025-12-19T12:44:28.241Z",
            "userId": "57fa6390-a40c-4605-97ed-6ca13f0b80a7",
            "projectId": "XvpIUT75BWOBRhfk",
            "user": {
              "updatedAt": "2025-12-30T16:01:06.000Z",
              "createdAt": "2025-12-19T12:44:26.915Z",
              "id": "57fa6390-a40c-4605-97ed-6ca13f0b80a7",
              "email": "zenithjoycloud@gmail.com",
              "firstName": "Alex",
              "lastName": "Xu ",
              "personalizationAnswers": null,
              "settings": {
                "userActivated": true,
                "userClaimedAiCredits": true,
                "easyAIWorkflowOnboarded": true,
                "firstSuccessfulWorkflowId": "Ar2BwcAElSsexIKC",
                "userActivatedAt": 1766314472886
              },
              "disabled": false,
              "mfaEnabled": false,
              "lastActiveAt": "2025-12-30",
              "isPending": false
            }
          }
        ]
      }
    }
  ]
}

#!/bin/bash
#
# Backend æ‰§è¡Œå™¨
# è´Ÿè´£ï¼šåˆ†æ PRDã€ç”Ÿæˆåç«¯ä»£ç ã€å†™å…¥æ–‡ä»¶ã€è¿è¡Œæµ‹è¯•
#
# ç”¨æ³•: execute.sh <run_id> <task_info_path>
#

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
SHARED_DIR="$(dirname "$SCRIPT_DIR")/shared"

# åŠ è½½å…¬å…±åŸºç¡€
source "$SHARED_DIR/execute-base.sh"

# è§£æå‚æ•°
parse_execute_args "$@"

# æ‰“å°å¼€å§‹æ—¥å¿—
log_execute_start "Backend"

# ============================================================
# æ£€æŸ¥æ˜¯å¦è·³è¿‡æ‰§è¡Œï¼ˆç¨³å®šæ€§éªŒè¯ï¼‰
# ============================================================
if check_skip_execution "code"; then
  output_skip_result
  exit 0
fi

# ============================================================
# [1/5] åˆ†æé¡¹ç›®ç»“æ„
# ============================================================
log_info "[1/5] åˆ†æé¡¹ç›®ç»“æ„..."

# ä»ä»»åŠ¡ä¿¡æ¯è·å–ç›®æ ‡é¡¹ç›®è·¯å¾„
TARGET_PROJECT=$(json_get "$TASK_INFO_PATH" '.project_path' "$PROJECT_DIR/apps/dashboard")

if [[ ! -d "$TARGET_PROJECT" ]]; then
  log_error "ç›®æ ‡é¡¹ç›®ä¸å­˜åœ¨: $TARGET_PROJECT"
  exit 1
fi

log_info "ç›®æ ‡é¡¹ç›®: $TARGET_PROJECT"

# æ£€æµ‹é¡¹ç›®ç±»å‹
PROJECT_TYPE="unknown"
if [[ -f "$TARGET_PROJECT/package.json" ]]; then
  if grep -q '"typescript"' "$TARGET_PROJECT/package.json" 2>/dev/null; then
    PROJECT_TYPE="typescript"
  else
    PROJECT_TYPE="javascript"
  fi
elif [[ -f "$TARGET_PROJECT/requirements.txt" ]] || [[ -f "$TARGET_PROJECT/pyproject.toml" ]]; then
  PROJECT_TYPE="python"
fi

log_info "é¡¹ç›®ç±»å‹: $PROJECT_TYPE"

# ============================================================
# [2/5] è°ƒç”¨ Claude ç”Ÿæˆä»£ç 
# ============================================================
log_info "[2/5] è°ƒç”¨ Claude ç”Ÿæˆä»£ç ..."

FILES_CHANGED=()
CODE_OUTPUT=""

if [[ "${TEST_MODE:-}" == "1" ]]; then
  log_info "[TEST_MODE] ä½¿ç”¨ mock ä»£ç ç”Ÿæˆ"

  # åˆ›å»º mock æ–‡ä»¶ (ä½¿ç”¨ core ç›®å½•æˆ– src ç›®å½•)
  if [[ -d "$TARGET_PROJECT/core" ]]; then
    MOCK_FILE="$TARGET_PROJECT/core/mock-feature-${RUN_ID}.ts"
  else
    MOCK_FILE="$TARGET_PROJECT/src/mock-feature-${RUN_ID}.ts"
  fi
  mkdir -p "$(dirname "$MOCK_FILE")"

  cat > "$MOCK_FILE" <<'EOF'
/**
 * Mock feature generated by AI Factory
 * This is a test file for backend executor
 */

export interface MockFeature {
  id: string;
  name: string;
  createdAt: Date;
}

export function createMockFeature(name: string): MockFeature {
  return {
    id: `mock-${Date.now()}`,
    name,
    createdAt: new Date(),
  };
}

export function getMockFeatures(): MockFeature[] {
  return [
    createMockFeature('Feature 1'),
    createMockFeature('Feature 2'),
  ];
}
EOF

  FILES_CHANGED+=("$MOCK_FILE")
  CODE_OUTPUT="Created mock feature file"
  log_info "Mock æ–‡ä»¶å·²åˆ›å»º: $MOCK_FILE"
else
  PROMPT="æ ¹æ®ä»¥ä¸‹ä»»åŠ¡æè¿°ï¼Œç”Ÿæˆåç«¯ä»£ç ã€‚

ä»»åŠ¡å: $TASK_NAME
ä»»åŠ¡æè¿°:
$TASK_CONTENT

é¡¹ç›®è·¯å¾„: $TARGET_PROJECT
é¡¹ç›®ç±»å‹: $PROJECT_TYPE

è¦æ±‚ï¼š
1. åˆ†æä»»åŠ¡éœ€æ±‚ï¼Œç¡®å®šéœ€è¦åˆ›å»ºæˆ–ä¿®æ”¹çš„æ–‡ä»¶
2. ç”Ÿæˆç¬¦åˆé¡¹ç›®é£æ ¼çš„ä»£ç 
3. åŒ…å«å¿…è¦çš„ç±»å‹å®šä¹‰ï¼ˆTypeScriptï¼‰æˆ–ç±»å‹æ³¨è§£ï¼ˆPythonï¼‰
4. æ·»åŠ é€‚å½“çš„é”™è¯¯å¤„ç†
5. å¦‚æœéœ€è¦æ–°å¢ API ç«¯ç‚¹ï¼Œéµå¾ª RESTful è§„èŒƒ

è¯·è¾“å‡º JSON æ ¼å¼ï¼š
{
  \"files\": [
    {
      \"path\": \"ç›¸å¯¹è·¯å¾„\",
      \"action\": \"create|modify\",
      \"content\": \"æ–‡ä»¶å†…å®¹\"
    }
  ],
  \"summary\": \"å˜æ›´æ‘˜è¦\"
}"

  if ! call_claude "$PROMPT" 600; then
    exit 1
  fi

  CODE_OUTPUT=$(extract_json_from_claude "$CLAUDE_OUTPUT") || {
    log_error "æ— æ³•è§£æ Claude è¾“å‡º"
    exit 1
  }

  # è§£æå¹¶å†™å…¥æ–‡ä»¶
  FILE_COUNT=$(echo "$CODE_OUTPUT" | jq '.files | length')

  for ((i=0; i<FILE_COUNT; i++)); do
    FILE_PATH=$(echo "$CODE_OUTPUT" | jq -r ".files[$i].path")
    FILE_ACTION=$(echo "$CODE_OUTPUT" | jq -r ".files[$i].action")
    FILE_CONTENT=$(echo "$CODE_OUTPUT" | jq -r ".files[$i].content")

    FULL_PATH="$TARGET_PROJECT/$FILE_PATH"
    mkdir -p "$(dirname "$FULL_PATH")"

    echo "$FILE_CONTENT" > "$FULL_PATH"
    FILES_CHANGED+=("$FULL_PATH")
    log_info "[$FILE_ACTION] $FILE_PATH"
  done
fi

# æ£€æŸ¥ç£ç›˜ç©ºé—´
check_disk_space "$WORK_DIR" 100 || exit 1

# ä¿å­˜å˜æ›´æ–‡ä»¶åˆ—è¡¨
printf '%s\n' "${FILES_CHANGED[@]}" > "$WORK_DIR/files_changed.txt"
log_info "å…±å˜æ›´ ${#FILES_CHANGED[@]} ä¸ªæ–‡ä»¶"

# ============================================================
# [3/5] è¿è¡Œæµ‹è¯•ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
# ============================================================
log_info "[3/5] è¿è¡Œæµ‹è¯•..."

TEST_RESULT="skipped"
TEST_OUTPUT=""

if [[ "${TEST_MODE:-}" == "1" ]]; then
  log_info "[TEST_MODE] æ¨¡æ‹Ÿæµ‹è¯•é€šè¿‡"
  TEST_RESULT="passed"
  TEST_OUTPUT="All tests passed (mock)"
else
  cd "$TARGET_PROJECT"

  if [[ "$PROJECT_TYPE" == "typescript" || "$PROJECT_TYPE" == "javascript" ]]; then
    if [[ -f "package.json" ]] && grep -q '"test"' package.json; then
      log_info "è¿è¡Œ npm test..."
      TEST_OUTPUT=$(npm test 2>&1) && TEST_RESULT="passed" || TEST_RESULT="failed"
    else
      log_info "æœªé…ç½®æµ‹è¯•è„šæœ¬ï¼Œè·³è¿‡"
    fi
  elif [[ "$PROJECT_TYPE" == "python" ]]; then
    if command -v pytest &>/dev/null; then
      log_info "è¿è¡Œ pytest..."
      TEST_OUTPUT=$(pytest --tb=short 2>&1) && TEST_RESULT="passed" || TEST_RESULT="failed"
    else
      log_info "pytest æœªå®‰è£…ï¼Œè·³è¿‡æµ‹è¯•"
    fi
  fi

  cd - > /dev/null
fi

log_info "æµ‹è¯•ç»“æœ: $TEST_RESULT"

# ============================================================
# [4/5] è¿è¡Œ Lint æ£€æŸ¥
# ============================================================
log_info "[4/5] è¿è¡Œ Lint æ£€æŸ¥..."

LINT_RESULT="skipped"
LINT_OUTPUT=""

if [[ "${TEST_MODE:-}" == "1" ]]; then
  log_info "[TEST_MODE] æ¨¡æ‹Ÿ lint é€šè¿‡"
  LINT_RESULT="passed"
  LINT_OUTPUT="No lint errors (mock)"
else
  cd "$TARGET_PROJECT"

  if [[ "$PROJECT_TYPE" == "typescript" || "$PROJECT_TYPE" == "javascript" ]]; then
    if [[ -f "package.json" ]] && grep -q '"lint"' package.json; then
      log_info "è¿è¡Œ npm run lint..."
      LINT_OUTPUT=$(npm run lint 2>&1) && LINT_RESULT="passed" || LINT_RESULT="warning"
    elif command -v eslint &>/dev/null; then
      log_info "è¿è¡Œ eslint..."
      LINT_OUTPUT=$(eslint --ext .ts,.js src/ 2>&1) && LINT_RESULT="passed" || LINT_RESULT="warning"
    fi
  elif [[ "$PROJECT_TYPE" == "python" ]]; then
    if command -v ruff &>/dev/null; then
      log_info "è¿è¡Œ ruff..."
      LINT_OUTPUT=$(ruff check . 2>&1) && LINT_RESULT="passed" || LINT_RESULT="warning"
    elif command -v flake8 &>/dev/null; then
      log_info "è¿è¡Œ flake8..."
      LINT_OUTPUT=$(flake8 . 2>&1) && LINT_RESULT="passed" || LINT_RESULT="warning"
    fi
  fi

  cd - > /dev/null
fi

log_info "Lint ç»“æœ: $LINT_RESULT"

# ============================================================
# ä¿å­˜ç»“æœ
# ============================================================
RESULT_SUCCESS=true
if [[ "$TEST_RESULT" == "failed" ]]; then
  RESULT_SUCCESS=false
fi

RESULT_ARTIFACTS=$(jq -n \
  --arg type "code" \
  --arg id "backend-${RUN_ID}" \
  --arg project "$TARGET_PROJECT" \
  --arg project_type "$PROJECT_TYPE" \
  --argjson file_count "${#FILES_CHANGED[@]}" \
  --arg test_result "$TEST_RESULT" \
  --arg lint_result "$LINT_RESULT" \
  '[{
    type: $type,
    id: $id,
    name: "Backend Code Generation",
    project: $project,
    project_type: $project_type,
    files_changed: $file_count,
    test_result: $test_result,
    lint_result: $lint_result
  }]')

save_result

# ============================================================
# [5/5] ç”Ÿæˆæˆªå›¾æŠ¥å‘Š
# ============================================================
log_info "[5/5] ç”Ÿæˆæ‰§è¡Œç»“æœæˆªå›¾..."

SAFE_PROJECT=$(html_escape "$TARGET_PROJECT")

# ç”Ÿæˆæ–‡ä»¶å˜æ›´åˆ—è¡¨ HTML
FILES_HTML=""
for f in "${FILES_CHANGED[@]}"; do
  SAFE_F=$(html_escape "$(basename "$f")")
  FILES_HTML+="<div class=\"info-row\"><span class=\"info-value\">ğŸ“„ ${SAFE_F}</span></div>"
done

MAIN_CONTENT="
<div class=\"grid\">
  <div class=\"card\">
    <div class=\"card-title\">å˜æ›´æ–‡ä»¶æ•°</div>
    <div class=\"card-value\">${#FILES_CHANGED[@]} ä¸ª</div>
  </div>
  <div class=\"card\">
    <div class=\"card-title\">é¡¹ç›®ç±»å‹</div>
    <div class=\"card-value\">${PROJECT_TYPE}</div>
  </div>
</div>
<div class=\"card\">
  <div class=\"card-title\">ç›®æ ‡é¡¹ç›®</div>
  <div class=\"card-value\" style=\"font-size: 16px;\">${SAFE_PROJECT}</div>
</div>
<div class=\"card\">
  <div class=\"card-title\">æµ‹è¯•ç»“æœ</div>
  <div class=\"card-value $([ "$TEST_RESULT" == "passed" ] && echo "success")\">
    $([ "$TEST_RESULT" == "passed" ] && echo "âœ…" || echo "âš ï¸") ${TEST_RESULT}
  </div>
</div>
<div class=\"card\">
  <div class=\"card-title\">Lint ç»“æœ</div>
  <div class=\"card-value $([ "$LINT_RESULT" == "passed" ] && echo "success")\">
    $([ "$LINT_RESULT" == "passed" ] && echo "âœ…" || echo "âš ï¸") ${LINT_RESULT}
  </div>
</div>
<div class=\"card\">
  <div class=\"card-title\">å˜æ›´æ–‡ä»¶</div>
  ${FILES_HTML}
</div>
"

REPORT_HTML=$(generate_result_report_html "Backend ä»£ç ç”Ÿæˆå®Œæˆ" "âœ…" "$MAIN_CONTENT")
screenshot_html_report "$RUN_ID" "backend-execute-result" "$REPORT_HTML" || log_warn "ç»“æœæˆªå›¾å¤±è´¥"

# ============================================================
# å®Œæˆ
# ============================================================
log_execute_end "Backend"

jq -n \
  --argjson success "$RESULT_SUCCESS" \
  --arg project "$TARGET_PROJECT" \
  --arg project_type "$PROJECT_TYPE" \
  --argjson file_count "${#FILES_CHANGED[@]}" \
  --arg test_result "$TEST_RESULT" \
  --arg lint_result "$LINT_RESULT" \
  '{
    success: $success,
    project: $project,
    project_type: $project_type,
    files_changed: $file_count,
    test_result: $test_result,
    lint_result: $lint_result
  }'

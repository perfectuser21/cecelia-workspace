#!/bin/bash
#
# Backend æ‰§è¡Œå™¨
# è´Ÿè´£ï¼šåˆ†æ PRDã€ç”Ÿæˆåç«¯ä»£ç ã€å†™å…¥æ–‡ä»¶ã€è¿è¡Œæµ‹è¯•
#
# ç”¨æ³•: execute.sh <run_id> <task_info_path>
#

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
# v1.1: ä½¿ç”¨å›ºå®šä½ç½®çš„ shared è„šæœ¬
SHARED_DIR="/home/xx/bin/ai-factory-v2"

# åŠ è½½å…¬å…±åŸºç¡€
source "$SHARED_DIR/execute-base.sh"

# è§£æå‚æ•°
parse_execute_args "$@"

# æ‰“å°å¼€å§‹æ—¥å¿—
log_execute_start "Backend"

# ============================================================
# æ£€æŸ¥æ˜¯å¦è·³è¿‡æ‰§è¡Œï¼ˆç¨³å®šæ€§éªŒè¯ï¼‰
# ============================================================
if check_skip_execution "code"; then
  output_skip_result
  exit 0
fi

# ============================================================
# [1/5] åˆ†æé¡¹ç›®ç»“æ„
# ============================================================
log_info "[1/5] åˆ†æé¡¹ç›®ç»“æ„..."

# ä»ä»»åŠ¡ä¿¡æ¯è·å–ç›®æ ‡é¡¹ç›®è·¯å¾„
TARGET_PROJECT=$(json_get "$TASK_INFO_PATH" '.project_path' "$PROJECT_DIR/apps/dashboard")

# å®‰å…¨æ£€æŸ¥ï¼šç¦æ­¢è·¯å¾„éå†
if [[ "$TARGET_PROJECT" == *".."* ]]; then
  log_error "å®‰å…¨é”™è¯¯: è·¯å¾„åŒ…å«éæ³•å­—ç¬¦ (..): $TARGET_PROJECT"
  exit 1
fi

# ä½¿ç”¨ realpath è·å–è§„èŒƒåŒ–è·¯å¾„
TARGET_PROJECT=$(realpath -m "$TARGET_PROJECT" 2>/dev/null) || {
  log_error "æ— æ³•è§£æè·¯å¾„: $TARGET_PROJECT"
  exit 1
}

# éªŒè¯è·¯å¾„åœ¨å…è®¸çš„ç›®å½•å†…
ALLOWED_DIRS=("/home/xx/dev" "/home/xx/data")
PATH_ALLOWED=false
for allowed in "${ALLOWED_DIRS[@]}"; do
  if [[ "$TARGET_PROJECT" == "$allowed"* ]]; then
    PATH_ALLOWED=true
    break
  fi
done

if [[ "$PATH_ALLOWED" != "true" ]]; then
  log_error "å®‰å…¨é”™è¯¯: è·¯å¾„ä¸åœ¨å…è®¸ç›®å½•å†…: $TARGET_PROJECT"
  exit 1
fi

if [[ ! -d "$TARGET_PROJECT" ]]; then
  log_error "ç›®æ ‡é¡¹ç›®ä¸å­˜åœ¨: $TARGET_PROJECT"
  exit 1
fi

log_info "ç›®æ ‡é¡¹ç›®: $TARGET_PROJECT"

# æ£€æµ‹é¡¹ç›®ç±»å‹
PROJECT_TYPE="unknown"
if [[ -f "$TARGET_PROJECT/package.json" ]]; then
  if grep -q '"typescript"' "$TARGET_PROJECT/package.json" 2>/dev/null; then
    PROJECT_TYPE="typescript"
  else
    PROJECT_TYPE="javascript"
  fi
elif [[ -f "$TARGET_PROJECT/requirements.txt" ]] || [[ -f "$TARGET_PROJECT/pyproject.toml" ]]; then
  PROJECT_TYPE="python"
fi

log_info "é¡¹ç›®ç±»å‹: $PROJECT_TYPE"

# ============================================================
# [2/5] è°ƒç”¨ Claude ç”Ÿæˆä»£ç 
# ============================================================
log_info "[2/5] è°ƒç”¨ Claude ç”Ÿæˆä»£ç ..."

FILES_CHANGED=()
CODE_OUTPUT=""

if [[ "${TEST_MODE:-}" == "1" ]]; then
  # æ£€æŸ¥æ˜¯å¦æ¨¡æ‹Ÿè¶…æ—¶
  local test_timeout="${TEST_TIMEOUT:-300}"
  if [[ "$test_timeout" -lt 5 ]]; then
    log_warn "[TEST_MODE] æ¨¡æ‹Ÿè¶…æ—¶ (TEST_TIMEOUT=$test_timeout < 5)"
    echo '{"success": false, "error": "timeout"}' > "$WORK_DIR/result.json"
    exit 124
  fi

  log_info "[TEST_MODE] ä½¿ç”¨ mock ä»£ç ç”Ÿæˆ"

  # åˆ›å»º mock æ–‡ä»¶ (ä½¿ç”¨ core ç›®å½•æˆ– src ç›®å½•)
  if [[ -d "$TARGET_PROJECT/core" ]]; then
    MOCK_FILE="$TARGET_PROJECT/core/mock-feature-${RUN_ID}.ts"
  else
    MOCK_FILE="$TARGET_PROJECT/src/mock-feature-${RUN_ID}.ts"
  fi
  mkdir -p "$(dirname "$MOCK_FILE")" || {
    log_error "æ— æ³•åˆ›å»ºç›®å½•: $(dirname "$MOCK_FILE")"
    exit 1
  }

  cat > "$MOCK_FILE" <<'EOF'
/**
 * Mock feature generated by AI Factory
 * This is a test file for backend executor
 */

export interface MockFeature {
  id: string;
  name: string;
  createdAt: Date;
}

export function createMockFeature(name: string): MockFeature {
  return {
    id: `mock-${Date.now()}`,
    name,
    createdAt: new Date(),
  };
}

export function getMockFeatures(): MockFeature[] {
  return [
    createMockFeature('Feature 1'),
    createMockFeature('Feature 2'),
  ];
}
EOF

  FILES_CHANGED+=("$MOCK_FILE")
  CODE_OUTPUT="Created mock feature file"
  log_info "Mock æ–‡ä»¶å·²åˆ›å»º: $MOCK_FILE"
else
  PROMPT="æ ¹æ®ä»¥ä¸‹ä»»åŠ¡æè¿°ï¼Œç”Ÿæˆåç«¯ä»£ç ã€‚

ä»»åŠ¡å: $TASK_NAME
ä»»åŠ¡æè¿°:
$TASK_CONTENT

é¡¹ç›®è·¯å¾„: $TARGET_PROJECT
é¡¹ç›®ç±»å‹: $PROJECT_TYPE

## æ ¸å¿ƒåŸåˆ™ï¼ˆå¿…é¡»éµå®ˆï¼‰

**å¢é‡ä¿®æ”¹åŸåˆ™**ï¼š
- åªæ·»åŠ /ä¿®æ”¹ä»»åŠ¡éœ€è¦çš„ä»£ç ï¼Œä¸è¦åˆ é™¤æˆ–é‡å†™ç°æœ‰åŠŸèƒ½
- ä¿®æ”¹æ–‡ä»¶æ—¶ï¼Œä¿ç•™æ‰€æœ‰ç°æœ‰çš„å‡½æ•°ã€ç±»ã€å¯¼å‡º
- å¦‚æœä»»åŠ¡è¯´"æ·»åŠ åŠŸèƒ½"ï¼Œå°±åœ¨ç°æœ‰ä»£ç åŸºç¡€ä¸Šæ·»åŠ ï¼Œè€Œä¸æ˜¯é‡å†™æ•´ä¸ªæ–‡ä»¶
- å¦‚æœä»»åŠ¡è¯´"ä¿®å¤/ä¼˜åŒ–"ï¼Œåªæ”¹å¿…è¦çš„éƒ¨åˆ†ï¼Œä¿æŒå…¶ä»–ä»£ç ä¸å˜

**ç¦æ­¢è¡Œä¸º**ï¼š
- ç¦æ­¢åˆ é™¤ç°æœ‰çš„å‡½æ•°æˆ–ç±»ï¼ˆé™¤éä»»åŠ¡æ˜ç¡®è¦æ±‚åˆ é™¤ï¼‰
- ç¦æ­¢ç§»é™¤ç°æœ‰çš„å¯¼å‡ºï¼ˆexportï¼‰
- ç¦æ­¢é‡æ„æˆ–"ä¼˜åŒ–"ä»»åŠ¡èŒƒå›´ä¹‹å¤–çš„ä»£ç 
- ç¦æ­¢æ”¹å˜ç°æœ‰ API çš„æ¥å£ç­¾åï¼ˆé™¤éä»»åŠ¡è¦æ±‚ï¼‰

## ä»£ç è¦æ±‚

1. åˆ†æä»»åŠ¡éœ€æ±‚ï¼Œç¡®å®šéœ€è¦åˆ›å»ºæˆ–ä¿®æ”¹çš„æ–‡ä»¶
2. ç”Ÿæˆç¬¦åˆé¡¹ç›®é£æ ¼çš„ä»£ç 
3. åŒ…å«å¿…è¦çš„ç±»å‹å®šä¹‰ï¼ˆTypeScriptï¼‰æˆ–ç±»å‹æ³¨è§£ï¼ˆPythonï¼‰
4. æ·»åŠ é€‚å½“çš„é”™è¯¯å¤„ç†
5. å¦‚æœéœ€è¦æ–°å¢ API ç«¯ç‚¹ï¼Œéµå¾ª RESTful è§„èŒƒ

## è¾“å‡ºæ ¼å¼

å¿…é¡»è¾“å‡º JSON æ ¼å¼ï¼ˆä¸è¦è¾“å‡ºå…¶ä»–å†…å®¹ï¼‰ï¼š
\`\`\`json
{
  \"files\": [
    {
      \"path\": \"ç›¸å¯¹è·¯å¾„\",
      \"action\": \"create|modify\",
      \"content\": \"å®Œæ•´çš„æ–‡ä»¶å†…å®¹ï¼ˆä¿®æ”¹æ—¶åŒ…å«åŸæœ‰ä»£ç +æ–°å¢ä»£ç ï¼‰\"
    }
  ],
  \"summary\": \"å˜æ›´æ‘˜è¦\"
}
\`\`\`"

  if ! call_claude "$PROMPT" 600; then
    exit 1
  fi

  CODE_OUTPUT=$(extract_json_from_claude "$CLAUDE_OUTPUT") || {
    log_error "æ— æ³•è§£æ Claude è¾“å‡º"
    exit 1
  }

  # è§£æå¹¶å†™å…¥æ–‡ä»¶
  # é¦–å…ˆéªŒè¯ .files æ˜¯æ•°ç»„ç±»å‹
  FILES_TYPE=$(echo "$CODE_OUTPUT" | jq -r 'if .files == null then "null" elif (.files | type) == "array" then "array" else "invalid" end')
  if [[ "$FILES_TYPE" == "null" ]]; then
    log_error "Claude è¾“å‡ºç¼ºå°‘ .files å­—æ®µ"
    exit 1
  fi
  if [[ "$FILES_TYPE" != "array" ]]; then
    log_error "Claude è¾“å‡ºçš„ .files ä¸æ˜¯æ•°ç»„ç±»å‹: $FILES_TYPE"
    exit 1
  fi

  FILE_COUNT=$(echo "$CODE_OUTPUT" | jq '.files | length')

  # éªŒè¯ FILE_COUNT æ˜¯æœ‰æ•ˆæ•°å­—ä¸”åœ¨åˆç†èŒƒå›´
  if ! [[ "$FILE_COUNT" =~ ^[0-9]+$ ]]; then
    log_error "FILE_COUNT ä¸æ˜¯æœ‰æ•ˆæ•°å­—: $FILE_COUNT"
    exit 1
  fi
  if [[ "$FILE_COUNT" -eq 0 ]]; then
    log_warn "Claude æœªç”Ÿæˆä»»ä½•æ–‡ä»¶ï¼Œå¯èƒ½éœ€è¦æ£€æŸ¥ PRD å†…å®¹"
    # ä¸é€€å‡ºï¼Œç»§ç»­æ‰§è¡Œåç»­æ­¥éª¤ï¼ˆæµ‹è¯•/lintï¼‰
  fi
  if [[ "$FILE_COUNT" -gt 100 ]]; then
    log_error "FILE_COUNT è¶…å‡ºé™åˆ¶ (æœ€å¤§ 100): $FILE_COUNT"
    exit 1
  fi

  for ((i=0; i<FILE_COUNT; i++)); do
    FILE_PATH=$(echo "$CODE_OUTPUT" | jq -r ".files[$i].path // empty")
    FILE_ACTION=$(echo "$CODE_OUTPUT" | jq -r ".files[$i].action // empty")
    FILE_CONTENT=$(echo "$CODE_OUTPUT" | jq -r ".files[$i].content // empty")

    # éªŒè¯å¿…è¦å­—æ®µéç©º
    if [[ -z "$FILE_PATH" ]]; then
      log_error "æ–‡ä»¶è·¯å¾„ä¸ºç©º (ç´¢å¼• $i)ï¼Œè·³è¿‡"
      continue
    fi
    if [[ -z "$FILE_CONTENT" ]]; then
      log_warn "æ–‡ä»¶å†…å®¹ä¸ºç©º (ç´¢å¼• $i): $FILE_PATHï¼Œè·³è¿‡"
      continue
    fi

    # éªŒè¯ FILE_ACTION æ˜¯æœ‰æ•ˆå€¼ï¼ˆcreate æˆ– modifyï¼‰
    # åŒæ—¶æ£€æŸ¥ "null" å­—ç¬¦ä¸²ï¼ˆjq å¯èƒ½è¿”å›å­—ç¬¦ä¸² "null"ï¼‰
    if [[ -z "$FILE_ACTION" || "$FILE_ACTION" == "null" ]]; then
      log_warn "æ–‡ä»¶æ“ä½œç±»å‹ä¸ºç©º (ç´¢å¼• $i): $FILE_PATHï¼Œé»˜è®¤ä½¿ç”¨ create"
      FILE_ACTION="create"
    elif [[ "$FILE_ACTION" != "create" && "$FILE_ACTION" != "modify" ]]; then
      log_warn "æ— æ•ˆçš„æ–‡ä»¶æ“ä½œç±»å‹ '$FILE_ACTION' (ç´¢å¼• $i): $FILE_PATHï¼Œé»˜è®¤ä½¿ç”¨ create"
      FILE_ACTION="create"
    fi

    # å®‰å…¨æ£€æŸ¥ï¼šç¦æ­¢è·¯å¾„éå†
    if [[ "$FILE_PATH" == *".."* ]]; then
      log_error "å®‰å…¨é”™è¯¯: æ–‡ä»¶è·¯å¾„åŒ…å«éæ³•å­—ç¬¦ (..): $FILE_PATH"
      exit 1
    fi

    FULL_PATH="$TARGET_PROJECT/$FILE_PATH"

    # ä½¿ç”¨ realpath éªŒè¯æœ€ç»ˆè·¯å¾„åœ¨ TARGET_PROJECT å†…
    RESOLVED_PATH=$(realpath -m "$FULL_PATH" 2>/dev/null) || {
      log_error "æ— æ³•è§£ææ–‡ä»¶è·¯å¾„: $FULL_PATH"
      exit 1
    }
    # è·¯å¾„å®‰å…¨éªŒè¯ï¼šå¿…é¡»åœ¨ TARGET_PROJECT ç›®å½•å†…
    # ç¡®ä¿ TARGET_PROJECT ä¸ä»¥ç‰¹æ®Šå­—ç¬¦ç»“å°¾ï¼ˆé˜²æ­¢å‰ç¼€åŒ¹é…ç»•è¿‡ï¼‰
    # ä¾‹å¦‚ï¼šTARGET_PROJECT="/home/xx/dev" å¯èƒ½åŒ¹é… "/home/xx/dev-malicious"
    TARGET_PROJECT_NORMALIZED="${TARGET_PROJECT%/}"  # ç§»é™¤æœ«å°¾æ–œæ ï¼ˆå¦‚æœæœ‰ï¼‰

    # ä½¿ç”¨ [[ ]] è¿›è¡Œæ›´ä¸¥æ ¼çš„è·¯å¾„åŒ¹é…
    if [[ "$RESOLVED_PATH" == "$TARGET_PROJECT_NORMALIZED" ]]; then
      log_error "å®‰å…¨é”™è¯¯: ä¸èƒ½å†™å…¥é¡¹ç›®æ ¹ç›®å½•æœ¬èº«"
      exit 1
    elif [[ "$RESOLVED_PATH" != "$TARGET_PROJECT_NORMALIZED/"* ]]; then
      log_error "å®‰å…¨é”™è¯¯: æ–‡ä»¶è·¯å¾„é€ƒé€¸å‡ºé¡¹ç›®ç›®å½•: $FILE_PATH -> $RESOLVED_PATH"
      exit 1
    fi
    # else: åœ¨å…è®¸èŒƒå›´å†…ï¼Œç»§ç»­æ‰§è¡Œ

    mkdir -p "$(dirname "$RESOLVED_PATH")" || {
      log_error "æ— æ³•åˆ›å»ºç›®å½•: $(dirname "$RESOLVED_PATH")"
      exit 1
    }

    # ä½¿ç”¨ printf é¿å… echo çš„ -e/-n é—®é¢˜å’Œæ¢è¡Œç¬¦å¤„ç†
    printf '%s\n' "$FILE_CONTENT" > "$RESOLVED_PATH" || {
      log_error "æ— æ³•å†™å…¥æ–‡ä»¶: $RESOLVED_PATH"
      exit 1
    }
    FILES_CHANGED+=("$RESOLVED_PATH")
    log_info "[$FILE_ACTION] $FILE_PATH"
  done
fi

# æ£€æŸ¥ç£ç›˜ç©ºé—´
check_disk_space "$WORK_DIR" 100 || exit 1

# ä¿å­˜å˜æ›´æ–‡ä»¶åˆ—è¡¨
if [[ ${#FILES_CHANGED[@]} -gt 0 ]]; then
  printf '%s\n' "${FILES_CHANGED[@]}" > "$WORK_DIR/files_changed.txt"
else
  : > "$WORK_DIR/files_changed.txt"
fi
log_info "å…±å˜æ›´ ${#FILES_CHANGED[@]} ä¸ªæ–‡ä»¶"

# ============================================================
# [3/5] è¿è¡Œæµ‹è¯•ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
# ============================================================
log_info "[3/5] è¿è¡Œæµ‹è¯•..."

TEST_RESULT="skipped"
TEST_OUTPUT=""

TEST_TIMEOUT=${TEST_TIMEOUT:-300}  # é»˜è®¤ 5 åˆ†é’Ÿè¶…æ—¶

# éªŒè¯ TEST_TIMEOUT æ˜¯æœ‰æ•ˆæ•°å­—
if ! [[ "$TEST_TIMEOUT" =~ ^[0-9]+$ ]] || [[ "$TEST_TIMEOUT" -le 0 ]]; then
  log_warn "TEST_TIMEOUT ä¸æ˜¯æœ‰æ•ˆæ­£æ•´æ•°: $TEST_TIMEOUTï¼Œä½¿ç”¨é»˜è®¤å€¼ 300"
  TEST_TIMEOUT=300
fi

# æ¸…ç†å¯èƒ½å¡ä½çš„æµ‹è¯•è¿›ç¨‹çš„å‡½æ•°
cleanup_test_processes() {
  # æ¸…ç†å¯èƒ½æ®‹ç•™çš„ npm/pytest è¿›ç¨‹
  pkill -u "$(whoami)" -f "npm test" 2>/dev/null || true
  pkill -u "$(whoami)" -f "pytest" 2>/dev/null || true
}

if [[ "${TEST_MODE:-}" == "1" ]]; then
  log_info "[TEST_MODE] æ¨¡æ‹Ÿæµ‹è¯•é€šè¿‡"
  TEST_RESULT="passed"
  TEST_OUTPUT="All tests passed (mock)"
else
  # ä½¿ç”¨å­ shell éš”ç¦»ç›®å½•å˜æ›´ï¼Œé¿å…å½±å“åç»­ä»£ç 
  if [[ "$PROJECT_TYPE" == "typescript" || "$PROJECT_TYPE" == "javascript" ]]; then
    # æ£€æŸ¥æ˜¯å¦æœ‰æµ‹è¯•æ–‡ä»¶
    TEST_FILES=$(find "$TARGET_PROJECT" -name "*.test.ts" -o -name "*.spec.ts" -o -name "*.test.js" -o -name "*.spec.js" 2>/dev/null | head -1)
    if [[ -f "$TARGET_PROJECT/package.json" ]] && grep -q '"test"' "$TARGET_PROJECT/package.json" && [[ -n "$TEST_FILES" ]]; then
      log_info "è¿è¡Œ npm test (timeout: ${TEST_TIMEOUT}s)..."
      # ä½¿ç”¨å­ shell éš”ç¦» cdï¼Œ-k 10 è¡¨ç¤ºè¶…æ—¶å 10 ç§’å¼ºåˆ¶ SIGKILL
      TEST_OUTPUT=$(
        cd "$TARGET_PROJECT" 2>/dev/null || { echo "Failed to cd to project directory"; exit 1; }
        timeout -k 10 "$TEST_TIMEOUT" npm test 2>&1
      )
      TEST_EXIT_CODE=$?
      if [[ $TEST_EXIT_CODE -eq 0 ]]; then
        TEST_RESULT="passed"
      elif [[ $TEST_EXIT_CODE -eq 124 || $TEST_EXIT_CODE -eq 137 ]]; then
        # 124 = timeout, 137 = killed by SIGKILL (128+9)
        TEST_RESULT="timeout"
        log_warn "npm test è¶…æ—¶ (${TEST_TIMEOUT}s)"
        cleanup_test_processes
      elif [[ "$TEST_OUTPUT" == "Failed to cd to project directory" ]]; then
        log_error "æ— æ³•åˆ‡æ¢åˆ°é¡¹ç›®ç›®å½•: $TARGET_PROJECT"
        TEST_RESULT="failed"
      else
        TEST_RESULT="failed"
      fi
    else
      log_info "æœªæ‰¾åˆ°æµ‹è¯•æ–‡ä»¶ï¼Œè·³è¿‡æµ‹è¯•"
    fi
  elif [[ "$PROJECT_TYPE" == "python" ]]; then
    if command -v pytest &>/dev/null; then
      log_info "è¿è¡Œ pytest (timeout: ${TEST_TIMEOUT}s)..."
      # ä½¿ç”¨å­ shell éš”ç¦» cdï¼Œ-k 10 è¡¨ç¤ºè¶…æ—¶å 10 ç§’å¼ºåˆ¶ SIGKILL
      TEST_OUTPUT=$(
        cd "$TARGET_PROJECT" 2>/dev/null || { echo "Failed to cd to project directory"; exit 1; }
        timeout -k 10 "$TEST_TIMEOUT" pytest --tb=short 2>&1
      )
      TEST_EXIT_CODE=$?
      if [[ $TEST_EXIT_CODE -eq 0 ]]; then
        TEST_RESULT="passed"
      elif [[ $TEST_EXIT_CODE -eq 124 || $TEST_EXIT_CODE -eq 137 ]]; then
        TEST_RESULT="timeout"
        log_warn "pytest è¶…æ—¶ (${TEST_TIMEOUT}s)"
        cleanup_test_processes
      elif [[ "$TEST_OUTPUT" == "Failed to cd to project directory" ]]; then
        log_error "æ— æ³•åˆ‡æ¢åˆ°é¡¹ç›®ç›®å½•: $TARGET_PROJECT"
        TEST_RESULT="failed"
      else
        TEST_RESULT="failed"
      fi
    else
      log_info "pytest æœªå®‰è£…ï¼Œè·³è¿‡æµ‹è¯•"
    fi
  fi
fi

log_info "æµ‹è¯•ç»“æœ: $TEST_RESULT"

# ============================================================
# [4/5] è¿è¡Œ Lint æ£€æŸ¥
# ============================================================
log_info "[4/5] è¿è¡Œ Lint æ£€æŸ¥..."

LINT_RESULT="skipped"
LINT_OUTPUT=""

LINT_TIMEOUT=${LINT_TIMEOUT:-120}  # é»˜è®¤ 2 åˆ†é’Ÿè¶…æ—¶

# éªŒè¯ LINT_TIMEOUT æ˜¯æœ‰æ•ˆæ•°å­—
if ! [[ "$LINT_TIMEOUT" =~ ^[0-9]+$ ]] || [[ "$LINT_TIMEOUT" -le 0 ]]; then
  log_warn "LINT_TIMEOUT ä¸æ˜¯æœ‰æ•ˆæ­£æ•´æ•°: $LINT_TIMEOUTï¼Œä½¿ç”¨é»˜è®¤å€¼ 120"
  LINT_TIMEOUT=120
fi

# æ¸…ç†å¯èƒ½å¡ä½çš„ lint è¿›ç¨‹çš„å‡½æ•°
cleanup_lint_processes() {
  pkill -u "$(whoami)" -f "npm run lint" 2>/dev/null || true
  pkill -u "$(whoami)" -f "eslint" 2>/dev/null || true
  pkill -u "$(whoami)" -f "ruff check" 2>/dev/null || true
  pkill -u "$(whoami)" -f "flake8" 2>/dev/null || true
}

if [[ "${TEST_MODE:-}" == "1" ]]; then
  log_info "[TEST_MODE] æ¨¡æ‹Ÿ lint é€šè¿‡"
  LINT_RESULT="passed"
  LINT_OUTPUT="No lint errors (mock)"
else
  # ä½¿ç”¨å­ shell éš”ç¦»ç›®å½•å˜æ›´
  if [[ "$PROJECT_TYPE" == "typescript" || "$PROJECT_TYPE" == "javascript" ]]; then
    if [[ -f "$TARGET_PROJECT/package.json" ]] && grep -q '"lint"' "$TARGET_PROJECT/package.json"; then
      log_info "è¿è¡Œ npm run lint (timeout: ${LINT_TIMEOUT}s)..."
      LINT_OUTPUT=$(
        cd "$TARGET_PROJECT" 2>/dev/null || { echo "Failed to cd to project directory"; exit 1; }
        timeout -k 10 "$LINT_TIMEOUT" npm run lint 2>&1
      )
      LINT_EXIT_CODE=$?
      if [[ $LINT_EXIT_CODE -eq 0 ]]; then
        LINT_RESULT="passed"
      elif [[ $LINT_EXIT_CODE -eq 124 || $LINT_EXIT_CODE -eq 137 ]]; then
        LINT_RESULT="timeout"
        log_warn "npm run lint è¶…æ—¶ (${LINT_TIMEOUT}s)"
        cleanup_lint_processes
      elif [[ "$LINT_OUTPUT" == "Failed to cd to project directory" ]]; then
        log_error "æ— æ³•åˆ‡æ¢åˆ°é¡¹ç›®ç›®å½•: $TARGET_PROJECT"
        LINT_RESULT="failed"
      else
        LINT_RESULT="warning"
      fi
    elif command -v eslint &>/dev/null; then
      log_info "è¿è¡Œ eslint (timeout: ${LINT_TIMEOUT}s)..."
      LINT_OUTPUT=$(
        cd "$TARGET_PROJECT" 2>/dev/null || { echo "Failed to cd to project directory"; exit 1; }
        timeout -k 10 "$LINT_TIMEOUT" eslint --ext .ts,.js src/ 2>&1
      )
      LINT_EXIT_CODE=$?
      if [[ $LINT_EXIT_CODE -eq 0 ]]; then
        LINT_RESULT="passed"
      elif [[ $LINT_EXIT_CODE -eq 124 || $LINT_EXIT_CODE -eq 137 ]]; then
        LINT_RESULT="timeout"
        log_warn "eslint è¶…æ—¶ (${LINT_TIMEOUT}s)"
        cleanup_lint_processes
      elif [[ "$LINT_OUTPUT" == "Failed to cd to project directory" ]]; then
        log_error "æ— æ³•åˆ‡æ¢åˆ°é¡¹ç›®ç›®å½•: $TARGET_PROJECT"
        LINT_RESULT="failed"
      else
        LINT_RESULT="warning"
      fi
    fi
  elif [[ "$PROJECT_TYPE" == "python" ]]; then
    if command -v ruff &>/dev/null; then
      log_info "è¿è¡Œ ruff (timeout: ${LINT_TIMEOUT}s)..."
      LINT_OUTPUT=$(
        cd "$TARGET_PROJECT" 2>/dev/null || { echo "Failed to cd to project directory"; exit 1; }
        timeout -k 10 "$LINT_TIMEOUT" ruff check . 2>&1
      )
      LINT_EXIT_CODE=$?
      if [[ $LINT_EXIT_CODE -eq 0 ]]; then
        LINT_RESULT="passed"
      elif [[ $LINT_EXIT_CODE -eq 124 || $LINT_EXIT_CODE -eq 137 ]]; then
        LINT_RESULT="timeout"
        log_warn "ruff è¶…æ—¶ (${LINT_TIMEOUT}s)"
        cleanup_lint_processes
      elif [[ "$LINT_OUTPUT" == "Failed to cd to project directory" ]]; then
        log_error "æ— æ³•åˆ‡æ¢åˆ°é¡¹ç›®ç›®å½•: $TARGET_PROJECT"
        LINT_RESULT="failed"
      else
        LINT_RESULT="warning"
      fi
    elif command -v flake8 &>/dev/null; then
      log_info "è¿è¡Œ flake8 (timeout: ${LINT_TIMEOUT}s)..."
      LINT_OUTPUT=$(
        cd "$TARGET_PROJECT" 2>/dev/null || { echo "Failed to cd to project directory"; exit 1; }
        timeout -k 10 "$LINT_TIMEOUT" flake8 . 2>&1
      )
      LINT_EXIT_CODE=$?
      if [[ $LINT_EXIT_CODE -eq 0 ]]; then
        LINT_RESULT="passed"
      elif [[ $LINT_EXIT_CODE -eq 124 || $LINT_EXIT_CODE -eq 137 ]]; then
        LINT_RESULT="timeout"
        log_warn "flake8 è¶…æ—¶ (${LINT_TIMEOUT}s)"
        cleanup_lint_processes
      elif [[ "$LINT_OUTPUT" == "Failed to cd to project directory" ]]; then
        log_error "æ— æ³•åˆ‡æ¢åˆ°é¡¹ç›®ç›®å½•: $TARGET_PROJECT"
        LINT_RESULT="failed"
      else
        LINT_RESULT="warning"
      fi
    fi
  fi
fi

log_info "Lint ç»“æœ: $LINT_RESULT"

# ============================================================
# ä¿å­˜ç»“æœ
# ============================================================
RESULT_SUCCESS=true

# æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶å˜æ›´ï¼ˆé TEST_MODE ä¸‹ï¼Œ0 ä¸ªæ–‡ä»¶å˜æ›´è§†ä¸ºå¤±è´¥ï¼‰
if [[ "${TEST_MODE:-}" != "1" && ${#FILES_CHANGED[@]} -eq 0 ]]; then
  log_warn "æ²¡æœ‰æ–‡ä»¶å˜æ›´ï¼Œæ ‡è®°ä¸ºå¤±è´¥"
  RESULT_SUCCESS=false
fi

# æ£€æŸ¥æµ‹è¯•ç»“æœï¼ˆfailed æˆ– timeout å‡è§†ä¸ºå¤±è´¥ï¼‰
if [[ "$TEST_RESULT" == "failed" || "$TEST_RESULT" == "timeout" ]]; then
  RESULT_SUCCESS=false
fi
# æ£€æŸ¥ lint ç»“æœï¼ˆåªæœ‰ failed è§†ä¸ºå¤±è´¥ï¼Œwarning ä¸å½±å“æˆåŠŸçŠ¶æ€ï¼‰
if [[ "$LINT_RESULT" == "failed" || "$LINT_RESULT" == "timeout" ]]; then
  RESULT_SUCCESS=false
fi

RESULT_ARTIFACTS=$(jq -n \
  --arg type "code" \
  --arg id "backend-${RUN_ID}" \
  --arg project "$TARGET_PROJECT" \
  --arg project_type "$PROJECT_TYPE" \
  --argjson file_count "${#FILES_CHANGED[@]}" \
  --arg test_result "$TEST_RESULT" \
  --arg lint_result "$LINT_RESULT" \
  '[{
    type: $type,
    id: $id,
    name: "Backend Code Generation",
    project: $project,
    project_type: $project_type,
    files_changed: $file_count,
    test_result: $test_result,
    lint_result: $lint_result
  }]')

save_result

# ============================================================
# [5/5] ç”Ÿæˆæˆªå›¾æŠ¥å‘Š
# ============================================================
log_info "[5/5] ç”Ÿæˆæ‰§è¡Œç»“æœæˆªå›¾..."

SAFE_PROJECT=$(html_escape "$TARGET_PROJECT")

# ç”Ÿæˆæ–‡ä»¶å˜æ›´åˆ—è¡¨ HTML
FILES_HTML=""
for f in "${FILES_CHANGED[@]}"; do
  SAFE_F=$(html_escape "$(basename "$f")")
  FILES_HTML+="<div class=\"info-row\"><span class=\"info-value\">ğŸ“„ ${SAFE_F}</span></div>"
done

MAIN_CONTENT="
<div class=\"grid\">
  <div class=\"card\">
    <div class=\"card-title\">å˜æ›´æ–‡ä»¶æ•°</div>
    <div class=\"card-value\">${#FILES_CHANGED[@]} ä¸ª</div>
  </div>
  <div class=\"card\">
    <div class=\"card-title\">é¡¹ç›®ç±»å‹</div>
    <div class=\"card-value\">${PROJECT_TYPE}</div>
  </div>
</div>
<div class=\"card\">
  <div class=\"card-title\">ç›®æ ‡é¡¹ç›®</div>
  <div class=\"card-value\" style=\"font-size: 16px;\">${SAFE_PROJECT}</div>
</div>
<div class=\"card\">
  <div class=\"card-title\">æµ‹è¯•ç»“æœ</div>
  <div class=\"card-value $([ "$TEST_RESULT" == "passed" ] && echo "success")\">
    $([ "$TEST_RESULT" == "passed" ] && echo "âœ…" || echo "âš ï¸") ${TEST_RESULT}
  </div>
</div>
<div class=\"card\">
  <div class=\"card-title\">Lint ç»“æœ</div>
  <div class=\"card-value $([ "$LINT_RESULT" == "passed" ] && echo "success")\">
    $([ "$LINT_RESULT" == "passed" ] && echo "âœ…" || echo "âš ï¸") ${LINT_RESULT}
  </div>
</div>
<div class=\"card\">
  <div class=\"card-title\">å˜æ›´æ–‡ä»¶</div>
  ${FILES_HTML}
</div>
"

REPORT_HTML=$(generate_result_report_html "Backend ä»£ç ç”Ÿæˆå®Œæˆ" "âœ…" "$MAIN_CONTENT")
screenshot_html_report "$RUN_ID" "backend-execute-result" "$REPORT_HTML" || log_warn "ç»“æœæˆªå›¾å¤±è´¥"

# ============================================================
# å®Œæˆ
# ============================================================
log_execute_end "Backend"

jq -n \
  --argjson success "$RESULT_SUCCESS" \
  --arg project "$TARGET_PROJECT" \
  --arg project_type "$PROJECT_TYPE" \
  --argjson file_count "${#FILES_CHANGED[@]}" \
  --arg test_result "$TEST_RESULT" \
  --arg lint_result "$LINT_RESULT" \
  '{
    success: $success,
    project: $project,
    project_type: $project_type,
    files_changed: $file_count,
    test_result: $test_result,
    lint_result: $lint_result
  }'

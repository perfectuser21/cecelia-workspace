#!/bin/bash
#
# Frontend æ‰§è¡Œå™¨
# è´Ÿè´£ï¼šåˆ†æ PRDã€ç”Ÿæˆå‰ç«¯ç»„ä»¶ä»£ç ã€å†™å…¥æ–‡ä»¶ã€è¿è¡Œæ„å»º
#
# ç”¨æ³•: execute.sh <run_id> <task_info_path>
#

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
SHARED_DIR="$(dirname "$SCRIPT_DIR")/shared"

# åŠ è½½å…¬å…±åŸºç¡€
source "$SHARED_DIR/execute-base.sh"

# è§£æå‚æ•°
parse_execute_args "$@"

# æ‰“å°å¼€å§‹æ—¥å¿—
log_execute_start "Frontend"

# ============================================================
# æ£€æŸ¥æ˜¯å¦è·³è¿‡æ‰§è¡Œï¼ˆç¨³å®šæ€§éªŒè¯ï¼‰
# ============================================================
if check_skip_execution "component"; then
  output_skip_result
  exit 0
fi

# ============================================================
# [1/5] åˆ†æé¡¹ç›®ç»“æ„
# ============================================================
log_info "[1/5] åˆ†æé¡¹ç›®ç»“æ„..."

# ä»ä»»åŠ¡ä¿¡æ¯è·å–ç›®æ ‡é¡¹ç›®è·¯å¾„
TARGET_PROJECT=$(json_get "$TASK_INFO_PATH" '.project_path' "$PROJECT_DIR/apps/dashboard/frontend")

# éªŒè¯ TARGET_PROJECT è·¯å¾„å®‰å…¨æ€§
if [[ "$TARGET_PROJECT" == *".."* ]]; then
  log_error "è·¯å¾„åŒ…å«éæ³•å­—ç¬¦ '..': $TARGET_PROJECT"
  exit 1
fi

# ä½¿ç”¨ realpath è§„èŒƒåŒ–è·¯å¾„å¹¶éªŒè¯åœ¨å…è®¸ç›®å½•å†…
ALLOWED_DIRS=("$PROJECT_DIR" "/home/xx/dev")
TARGET_PROJECT_REAL=$(realpath -m "$TARGET_PROJECT" 2>/dev/null) || {
  log_error "æ— æ³•è§£æè·¯å¾„: $TARGET_PROJECT"
  exit 1
}

IN_ALLOWED_DIR=false
for allowed_dir in "${ALLOWED_DIRS[@]}"; do
  if [[ "$TARGET_PROJECT_REAL" == "$allowed_dir"* ]]; then
    IN_ALLOWED_DIR=true
    break
  fi
done

if [[ "$IN_ALLOWED_DIR" != "true" ]]; then
  log_error "ç›®æ ‡é¡¹ç›®è·¯å¾„ä¸åœ¨å…è®¸ç›®å½•å†…: $TARGET_PROJECT_REAL"
  exit 1
fi

TARGET_PROJECT="$TARGET_PROJECT_REAL"

if [[ ! -d "$TARGET_PROJECT" ]]; then
  log_error "ç›®æ ‡é¡¹ç›®ä¸å­˜åœ¨: $TARGET_PROJECT"
  exit 1
fi

log_info "ç›®æ ‡é¡¹ç›®: $TARGET_PROJECT"

# æ£€æµ‹å‰ç«¯æ¡†æ¶
FRAMEWORK="unknown"
if [[ -f "$TARGET_PROJECT/package.json" ]]; then
  if grep -q '"react"' "$TARGET_PROJECT/package.json" 2>/dev/null; then
    FRAMEWORK="react"
  elif grep -q '"vue"' "$TARGET_PROJECT/package.json" 2>/dev/null; then
    FRAMEWORK="vue"
  elif grep -q '"svelte"' "$TARGET_PROJECT/package.json" 2>/dev/null; then
    FRAMEWORK="svelte"
  fi
fi

# æ£€æµ‹æ ·å¼æ–¹æ¡ˆ
STYLING="css"
if grep -q '"tailwindcss"' "$TARGET_PROJECT/package.json" 2>/dev/null; then
  STYLING="tailwind"
elif grep -q '"styled-components"' "$TARGET_PROJECT/package.json" 2>/dev/null; then
  STYLING="styled-components"
elif grep -q '"@emotion"' "$TARGET_PROJECT/package.json" 2>/dev/null; then
  STYLING="emotion"
fi

log_info "æ¡†æ¶: $FRAMEWORK, æ ·å¼: $STYLING"

# ============================================================
# [2/5] è°ƒç”¨ Claude ç”Ÿæˆç»„ä»¶
# ============================================================
log_info "[2/5] è°ƒç”¨ Claude ç”Ÿæˆç»„ä»¶..."

FILES_CHANGED=()
COMPONENT_COUNT=0

if [[ "${TEST_MODE:-}" == "1" ]]; then
  log_info "[TEST_MODE] ä½¿ç”¨ mock ç»„ä»¶ç”Ÿæˆ"

  # åˆ›å»º mock ç»„ä»¶æ–‡ä»¶
  MOCK_COMPONENT="$TARGET_PROJECT/src/components/MockFeature-${RUN_ID}.tsx"
  mkdir -p "$(dirname "$MOCK_COMPONENT")"

  cat > "$MOCK_COMPONENT" <<'EOF'
/**
 * Mock Feature Component
 * Generated by AI Factory Frontend Executor
 */

import React from 'react';

interface MockFeatureProps {
  title: string;
  description?: string;
  onAction?: () => void;
}

export const MockFeature: React.FC<MockFeatureProps> = ({
  title,
  description,
  onAction,
}) => {
  return (
    <div className="p-4 bg-white rounded-lg shadow-md">
      <h3 className="text-lg font-semibold text-gray-900">{title}</h3>
      {description && (
        <p className="mt-2 text-sm text-gray-600">{description}</p>
      )}
      {onAction && (
        <button
          onClick={onAction}
          className="mt-4 px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700"
        >
          Action
        </button>
      )}
    </div>
  );
};

export default MockFeature;
EOF

  FILES_CHANGED+=("$MOCK_COMPONENT")
  COMPONENT_COUNT=1
  log_info "Mock ç»„ä»¶å·²åˆ›å»º: $MOCK_COMPONENT"
else
  PROMPT="æ ¹æ®ä»¥ä¸‹ä»»åŠ¡æè¿°ï¼Œç”Ÿæˆå‰ç«¯ç»„ä»¶ä»£ç ã€‚

ä»»åŠ¡å: $TASK_NAME
ä»»åŠ¡æè¿°:
$TASK_CONTENT

é¡¹ç›®è·¯å¾„: $TARGET_PROJECT
æ¡†æ¶: $FRAMEWORK
æ ·å¼æ–¹æ¡ˆ: $STYLING

è¦æ±‚ï¼š
1. åˆ†æä»»åŠ¡éœ€æ±‚ï¼Œç¡®å®šéœ€è¦åˆ›å»ºçš„ç»„ä»¶
2. ç”Ÿæˆç¬¦åˆé¡¹ç›®é£æ ¼çš„ç»„ä»¶ä»£ç 
3. ä½¿ç”¨ TypeScript ç±»å‹å®šä¹‰
4. ç»„ä»¶åº”è¯¥æ˜¯å“åº”å¼çš„
5. ä½¿ç”¨ ${STYLING} è¿›è¡Œæ ·å¼å¤„ç†
6. åŒ…å«å¿…è¦çš„ props ç±»å‹å®šä¹‰

è¯·è¾“å‡º JSON æ ¼å¼ï¼š
{
  \"components\": [
    {
      \"path\": \"ç›¸å¯¹è·¯å¾„\",
      \"name\": \"ç»„ä»¶å\",
      \"content\": \"æ–‡ä»¶å†…å®¹\"
    }
  ],
  \"summary\": \"å˜æ›´æ‘˜è¦\"
}"

  if ! call_claude "$PROMPT" 600; then
    exit 1
  fi

  CODE_OUTPUT=$(extract_json_from_claude "$CLAUDE_OUTPUT") || {
    log_error "æ— æ³•è§£æ Claude è¾“å‡º"
    exit 1
  }

  # è§£æå¹¶å†™å…¥æ–‡ä»¶
  COMPONENT_COUNT=$(echo "$CODE_OUTPUT" | jq '.components | length')

  # éªŒè¯ COMPONENT_COUNT æ˜¯æœ‰æ•ˆæ•°å­—ä¸”åœ¨åˆç†èŒƒå›´å†…
  if ! [[ "$COMPONENT_COUNT" =~ ^[0-9]+$ ]]; then
    log_error "COMPONENT_COUNT ä¸æ˜¯æœ‰æ•ˆæ•°å­—: $COMPONENT_COUNT"
    exit 1
  fi

  if [[ "$COMPONENT_COUNT" -lt 0 ]] || [[ "$COMPONENT_COUNT" -gt 100 ]]; then
    log_error "COMPONENT_COUNT è¶…å‡ºåˆç†èŒƒå›´ (0-100): $COMPONENT_COUNT"
    exit 1
  fi

  for ((i=0; i<COMPONENT_COUNT; i++)); do
    COMP_PATH=$(echo "$CODE_OUTPUT" | jq -r ".components[$i].path")
    COMP_NAME=$(echo "$CODE_OUTPUT" | jq -r ".components[$i].name")
    COMP_CONTENT=$(echo "$CODE_OUTPUT" | jq -r ".components[$i].content")

    # éªŒè¯ COMP_PATH ä¸åŒ…å«è·¯å¾„éå†å­—ç¬¦
    if [[ "$COMP_PATH" == *".."* ]] || [[ "$COMP_PATH" == /* ]]; then
      log_error "ç»„ä»¶è·¯å¾„åŒ…å«éæ³•å­—ç¬¦: $COMP_PATH"
      continue
    fi

    FULL_PATH="$TARGET_PROJECT/$COMP_PATH"

    # ä½¿ç”¨ realpath éªŒè¯æœ€ç»ˆè·¯å¾„åœ¨ç›®æ ‡é¡¹ç›®å†…
    FULL_PATH_REAL=$(realpath -m "$FULL_PATH" 2>/dev/null) || {
      log_error "æ— æ³•è§£æç»„ä»¶è·¯å¾„: $FULL_PATH"
      continue
    }

    if [[ "$FULL_PATH_REAL" != "$TARGET_PROJECT"* ]]; then
      log_error "ç»„ä»¶è·¯å¾„è¶…å‡ºç›®æ ‡é¡¹ç›®èŒƒå›´: $FULL_PATH_REAL"
      continue
    fi

    mkdir -p "$(dirname "$FULL_PATH_REAL")"

    echo "$COMP_CONTENT" > "$FULL_PATH_REAL"
    FILES_CHANGED+=("$FULL_PATH_REAL")
    log_info "[åˆ›å»º] $COMP_NAME -> $COMP_PATH"
  done
fi

# æ£€æŸ¥ç£ç›˜ç©ºé—´
check_disk_space "$WORK_DIR" 100 || exit 1

# ä¿å­˜å˜æ›´æ–‡ä»¶åˆ—è¡¨
if [[ ${#FILES_CHANGED[@]} -gt 0 ]]; then
  printf '%s\n' "${FILES_CHANGED[@]}" > "$WORK_DIR/files_changed.txt"
else
  : > "$WORK_DIR/files_changed.txt"
fi
log_info "å…±åˆ›å»º ${#FILES_CHANGED[@]} ä¸ªç»„ä»¶æ–‡ä»¶"

# ============================================================
# [3/5] TypeScript ç±»å‹æ£€æŸ¥
# ============================================================
log_info "[3/5] TypeScript ç±»å‹æ£€æŸ¥..."

TSC_RESULT="skipped"
TSC_OUTPUT=""

if [[ "${TEST_MODE:-}" == "1" ]]; then
  log_info "[TEST_MODE] æ¨¡æ‹Ÿç±»å‹æ£€æŸ¥é€šè¿‡"
  TSC_RESULT="passed"
else
  if [[ -f "$TARGET_PROJECT/tsconfig.json" ]]; then
    if command -v npx &>/dev/null; then
      log_info "è¿è¡Œ tsc --noEmit (timeout 120s)..."
      TSC_OUTPUT=$(
        cd "$TARGET_PROJECT" && timeout 120 npx tsc --noEmit 2>&1
      )
      TSC_EXIT_CODE=$?
      if [[ $TSC_EXIT_CODE -eq 0 ]]; then
        TSC_RESULT="passed"
      elif [[ $TSC_EXIT_CODE -eq 124 ]]; then
        TSC_RESULT="timeout"
        log_warn "TypeScript ç±»å‹æ£€æŸ¥è¶…æ—¶ (120s)"
      else
        TSC_RESULT="warning"
      fi
    fi
  else
    log_info "æœªæ‰¾åˆ° tsconfig.jsonï¼Œè·³è¿‡ç±»å‹æ£€æŸ¥"
  fi
fi

log_info "ç±»å‹æ£€æŸ¥ç»“æœ: $TSC_RESULT"

# ============================================================
# [4/5] è¿è¡Œæ„å»º
# ============================================================
log_info "[4/5] è¿è¡Œæ„å»º..."

BUILD_RESULT="skipped"
BUILD_OUTPUT=""

if [[ "${TEST_MODE:-}" == "1" ]]; then
  log_info "[TEST_MODE] æ¨¡æ‹Ÿæ„å»ºé€šè¿‡"
  BUILD_RESULT="passed"
else
  if [[ -f "$TARGET_PROJECT/package.json" ]] && grep -q '"build"' "$TARGET_PROJECT/package.json"; then
    log_info "è¿è¡Œ npm run build (timeout 300s)..."
    BUILD_OUTPUT=$(
      cd "$TARGET_PROJECT" && timeout 300 npm run build 2>&1
    )
    BUILD_EXIT_CODE=$?
    if [[ $BUILD_EXIT_CODE -eq 0 ]]; then
      BUILD_RESULT="passed"
    elif [[ $BUILD_EXIT_CODE -eq 124 ]]; then
      BUILD_RESULT="timeout"
      log_warn "æ„å»ºè¶…æ—¶ (300s)"
    else
      BUILD_RESULT="failed"
    fi
  else
    log_info "æœªé…ç½®æ„å»ºè„šæœ¬ï¼Œè·³è¿‡"
  fi
fi

log_info "æ„å»ºç»“æœ: $BUILD_RESULT"

# ============================================================
# ä¿å­˜ç»“æœ
# ============================================================
RESULT_SUCCESS=true
if [[ "$TSC_RESULT" == "failed" ]] || [[ "$TSC_RESULT" == "timeout" ]]; then
  RESULT_SUCCESS=false
fi
if [[ "$BUILD_RESULT" == "failed" ]] || [[ "$BUILD_RESULT" == "timeout" ]]; then
  RESULT_SUCCESS=false
fi

RESULT_ARTIFACTS=$(jq -n \
  --arg type "component" \
  --arg id "frontend-${RUN_ID}" \
  --arg project "$TARGET_PROJECT" \
  --arg framework "$FRAMEWORK" \
  --arg styling "$STYLING" \
  --argjson component_count "$COMPONENT_COUNT" \
  --arg tsc_result "$TSC_RESULT" \
  --arg build_result "$BUILD_RESULT" \
  '[{
    type: $type,
    id: $id,
    name: "Frontend Component Generation",
    project: $project,
    framework: $framework,
    styling: $styling,
    components_created: $component_count,
    tsc_result: $tsc_result,
    build_result: $build_result
  }]')

save_result

# ============================================================
# [5/5] ç”Ÿæˆæˆªå›¾æŠ¥å‘Š
# ============================================================
log_info "[5/5] ç”Ÿæˆæ‰§è¡Œç»“æœæˆªå›¾..."

SAFE_PROJECT=$(html_escape "$TARGET_PROJECT")

# ç”Ÿæˆç»„ä»¶åˆ—è¡¨ HTML
COMPONENTS_HTML=""
for f in "${FILES_CHANGED[@]}"; do
  SAFE_F=$(html_escape "$(basename "$f")")
  COMPONENTS_HTML+="<div class=\"info-row\"><span class=\"info-value\">ğŸ§© ${SAFE_F}</span></div>"
done

MAIN_CONTENT="
<div class=\"grid\">
  <div class=\"card\">
    <div class=\"card-title\">ç»„ä»¶æ•°é‡</div>
    <div class=\"card-value\">${#FILES_CHANGED[@]} ä¸ª</div>
  </div>
  <div class=\"card\">
    <div class=\"card-title\">æ¡†æ¶</div>
    <div class=\"card-value\">${FRAMEWORK}</div>
  </div>
</div>
<div class=\"card\">
  <div class=\"card-title\">ç›®æ ‡é¡¹ç›®</div>
  <div class=\"card-value\" style=\"font-size: 16px;\">${SAFE_PROJECT}</div>
</div>
<div class=\"card\">
  <div class=\"info-row\">
    <span class=\"info-label\">æ ·å¼æ–¹æ¡ˆ</span>
    <span class=\"info-value\">${STYLING}</span>
  </div>
</div>
<div class=\"card\">
  <div class=\"card-title\">ç±»å‹æ£€æŸ¥</div>
  <div class=\"card-value $([ "$TSC_RESULT" == "passed" ] && echo "success")\">
    $([ "$TSC_RESULT" == "passed" ] && echo "âœ…" || echo "âš ï¸") ${TSC_RESULT}
  </div>
</div>
<div class=\"card\">
  <div class=\"card-title\">æ„å»ºç»“æœ</div>
  <div class=\"card-value $([ "$BUILD_RESULT" == "passed" ] && echo "success")\">
    $([ "$BUILD_RESULT" == "passed" ] && echo "âœ…" || echo "âš ï¸") ${BUILD_RESULT}
  </div>
</div>
<div class=\"card\">
  <div class=\"card-title\">åˆ›å»ºçš„ç»„ä»¶</div>
  ${COMPONENTS_HTML}
</div>
"

REPORT_HTML=$(generate_result_report_html "Frontend ç»„ä»¶ç”Ÿæˆå®Œæˆ" "âœ…" "$MAIN_CONTENT")
screenshot_html_report "$RUN_ID" "frontend-execute-result" "$REPORT_HTML" || log_warn "ç»“æœæˆªå›¾å¤±è´¥"

# ============================================================
# å®Œæˆ
# ============================================================
log_execute_end "Frontend"

jq -n \
  --argjson success "$RESULT_SUCCESS" \
  --arg project "$TARGET_PROJECT" \
  --arg framework "$FRAMEWORK" \
  --arg styling "$STYLING" \
  --argjson component_count "$COMPONENT_COUNT" \
  --arg tsc_result "$TSC_RESULT" \
  --arg build_result "$BUILD_RESULT" \
  '{
    success: $success,
    project: $project,
    framework: $framework,
    styling: $styling,
    components_created: $component_count,
    tsc_result: $tsc_result,
    build_result: $build_result
  }'

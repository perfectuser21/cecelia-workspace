{
  "name": "AIå·¥å‚-Workflowç”Ÿäº§çº¿",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "workflow-factory",
        "responseMode": "lastNode",
        "options": {}
      },
      "id": "webhook-receive-prd",
      "name": "æ¥æ”¶PRD",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        240,
        300
      ],
      "webhookId": "workflow-factory-prd"
    },
    {
      "parameters": {
        "jsCode": "// åˆå§‹åŒ– Runï¼Œç”Ÿæˆ run_id æˆ–ä½¿ç”¨ç»­è·‘çš„ run_id\nconst now = new Date();\nconst inputData = $input.first().json;\n\nconst resumeRunId = inputData.resume_run_id || inputData.body?.resume_run_id || null;\nconst runId = resumeRunId || (now.toISOString().replace(/[-:T]/g, '').slice(0, 14) + '-' + Math.random().toString(36).slice(2, 8));\n\nconst prd = inputData.prd || inputData.body?.prd || 'æœªæä¾›PRD';\nconst targetWorkflow = inputData.target_workflow || inputData.body?.target_workflow || null;\n\nreturn [{\n  json: {\n    run_id: runId,\n    prd: prd,\n    target_workflow: targetWorkflow,\n    started_at: now.toISOString(),\n    factory_type: 'workflow',\n    state_dir: `/home/xx/data/runs/${runId}`,\n    rework_count: 0,\n    is_resume: resumeRunId ? true : false,\n    resume_run_id: resumeRunId\n  }\n}];"
      },
      "id": "code-init-run",
      "name": "åˆå§‹åŒ–Run",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        400,
        300
      ]
    },
    {
      "parameters": {
        "authentication": "privateKey",
        "command": "=mkdir -p {{ $json.state_dir }}/{tasks,qc,docs,rework,reports} && echo '{{ $json.prd }}' > {{ $json.state_dir }}/prd.md && echo '{\"status\": \"decomposing\", \"started_at\": \"{{ $json.started_at }}\", \"rework_count\": 0}' > {{ $json.state_dir }}/state.json"
      },
      "id": "ssh-init-state",
      "name": "SSH åˆå§‹åŒ–çŠ¶æ€ç›®å½•",
      "type": "n8n-nodes-base.ssh",
      "typeVersion": 1,
      "position": [
        560,
        300
      ],
      "credentials": {
        "sshPrivateKey": {
          "id": "vvJsQOZ95sqzemla",
          "name": "VPS SSH Key"
        }
      }
    },
    {
      "parameters": {
        "authentication": "privateKey",
        "command": "=cd /home/xx/dev/n8n-workflows && claude -p 'ä½ æ˜¯ n8n æ¶æ„å¸ˆã€‚åˆ†æä»¥ä¸‹ PRD å¹¶åˆ†è§£ä¸ºå…·ä½“çš„ workflow ä»»åŠ¡åˆ—è¡¨ã€‚\n\nè¾“å‡º JSON æ ¼å¼ï¼š\n{\"tasks\": [{\"id\": \"task_1\", \"name\": \"ä»»åŠ¡å\", \"description\": \"è¯¦ç»†æè¿°\", \"depends_on\": [], \"files_expected\": [\"é¢„æœŸåˆ›å»ºçš„workflowæ–‡ä»¶æˆ–èŠ‚ç‚¹\"], \"complexity\": 3, \"estimated_minutes\": 15, \"model\": \"sonnet\"}]}\n\nå­—æ®µè¯´æ˜ï¼š\n- id: ä»»åŠ¡IDï¼ˆtask_1, task_2...ï¼‰\n- name: ä»»åŠ¡åç§°\n- description: è¯¦ç»†æè¿°ä»»åŠ¡å†…å®¹\n- depends_on: ä¾èµ–çš„ä»»åŠ¡IDåˆ—è¡¨\n- files_expected: é¢„æœŸäº§å‡ºçš„ workflow æˆ–èŠ‚ç‚¹åˆ—è¡¨\n- complexity: å¤æ‚åº¦è¯„åˆ† 1-5ï¼ˆ1=éå¸¸ç®€å•ï¼Œ5=éå¸¸å¤æ‚ï¼‰\n- estimated_minutes: é¢„ä¼°æ‰§è¡Œæ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰\n- model: æ¨èä½¿ç”¨çš„æ¨¡å‹ï¼ˆcomplexity>=4ç”¨opusï¼Œ<=2ç”¨haikuï¼Œå…¶ä»–ç”¨sonnetï¼‰\n\nPRDï¼š\n{{ $json.prd }}\n\n{{ $json.target_workflow ? \"ç›®æ ‡ Workflow: \" + $json.target_workflow : \"åˆ›å»ºæ–° workflow\" }}' --allowedTools \"Read,Write,Edit,Grep,Glob,Bash,mcp__n8n__search_workflows,mcp__n8n__get_workflow_details\" --model sonnet 2>&1 | tail -n 100"
      },
      "id": "ssh-claude-decompose",
      "name": "SSH Claude A - åˆ†è§£PRD",
      "type": "n8n-nodes-base.ssh",
      "typeVersion": 1,
      "position": [
        720,
        300
      ],
      "credentials": {
        "sshPrivateKey": {
          "id": "vvJsQOZ95sqzemla",
          "name": "VPS SSH Key"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// æ‹“æ‰‘æ’åºï¼šå°†ä»»åŠ¡æŒ‰ä¾èµ–å…³ç³»åˆ†æˆæ³¢æ¬¡ï¼Œå¹¶æ™ºèƒ½åˆ†é…æ¨¡å‹\nconst items = $input.all();\nconst rawOutput = items[0].json.stdout || '';\nconst initData = $('åˆå§‹åŒ–Run').first().json;\n\nlet tasks;\n\n// è§£æ Claude è¾“å‡ºçš„ JSON\ntry {\n  const match = rawOutput.match(/\\{[\\s\\S]*\"tasks\"[\\s\\S]*\\]/i);\n  if (match) {\n    tasks = JSON.parse(match[0]).tasks;\n  } else {\n    throw new Error('æ— æ³•è§£æä»»åŠ¡åˆ—è¡¨');\n  }\n} catch (e) {\n  return [{ json: { error: 'è§£æå¤±è´¥', details: e.message, raw: rawOutput, ...initData } }];\n}\n\nif (!tasks || tasks.length === 0) {\n  return [{ json: { error: 'ä»»åŠ¡åˆ—è¡¨ä¸ºç©º', ...initData } }];\n}\n\n// æ™ºèƒ½åˆ†é…æ¨¡å‹ï¼šæ ¹æ®å¤æ‚åº¦å­—æ®µæˆ–ä»»åŠ¡æè¿°é€‰æ‹©æ¨¡å‹\nfunction assignModel(task) {\n  // ä¼˜å…ˆä½¿ç”¨ä»»åŠ¡ä¸­æŒ‡å®šçš„æ¨¡å‹\n  if (task.model && ['opus', 'sonnet', 'haiku'].includes(task.model)) {\n    return task.model;\n  }\n  \n  // æ ¹æ®å¤æ‚åº¦åˆ†é…\n  const complexity = task.complexity || 3;\n  if (complexity >= 4) {\n    return 'opus';\n  } else if (complexity <= 2) {\n    return 'haiku';\n  }\n  \n  // é»˜è®¤: sonnet (ä¸­ç­‰å¤æ‚åº¦)\n  return 'sonnet';\n}\n\n// æ‹“æ‰‘æ’åº\nconst waves = [];\nconst completed = new Set();\nconst taskMap = new Map(tasks.map(t => [t.id, t]));\n\nwhile (completed.size < tasks.length) {\n  const wave = [];\n  \n  for (const task of tasks) {\n    if (completed.has(task.id)) continue;\n    \n    const deps = task.depends_on || [];\n    const allDepsCompleted = deps.every(dep => completed.has(dep));\n    \n    if (allDepsCompleted) {\n      wave.push(task);\n    }\n  }\n  \n  if (wave.length === 0) {\n    return [{ json: { error: 'å¾ªç¯ä¾èµ–æ£€æµ‹', completed: Array.from(completed), ...initData } }];\n  }\n  \n  wave.forEach(t => completed.add(t.id));\n  waves.push(wave);\n}\n\n// è¿”å›æ‰å¹³åŒ–çš„ä»»åŠ¡åˆ—è¡¨ï¼ˆå¸¦å®Œæ•´å­—æ®µï¼‰\nconst sortedTasks = [];\nwaves.forEach((wave, waveIndex) => {\n  wave.forEach(task => {\n    const assignedModel = assignModel(task);\n    sortedTasks.push({\n      ...task,\n      waveIndex,\n      totalWaves: waves.length,\n      model: assignedModel,\n      // ç¡®ä¿æ–°å­—æ®µå­˜åœ¨\n      complexity: task.complexity || 3,\n      estimated_minutes: task.estimated_minutes || 10,\n      files_expected: task.files_expected || [],\n      ...initData\n    });\n  });\n});\n\n// ä¿å­˜ waves ä¿¡æ¯åˆ°çŠ¶æ€ç›®å½•ï¼ˆç”¨äºæ–­ç‚¹ç»­è·‘ï¼‰\nconst waveData = {\n  waves: waves.map((wave, idx) => ({\n    waveIndex: idx,\n    tasks: wave.map(t => ({\n      id: t.id,\n      name: t.name,\n      depends_on: t.depends_on || [],\n      complexity: t.complexity || 3,\n      estimated_minutes: t.estimated_minutes || 10,\n      model: assignModel(t)\n    }))\n  })),\n  totalWaves: waves.length,\n  tasksCount: sortedTasks.length\n};\n\n// å‡†å¤‡å®Œæ•´çš„æ‰§è¡Œè®¡åˆ’ï¼ˆç”¨äºä¿å­˜åˆ° plan.jsonï¼‰\nconst executionPlan = {\n  run_id: initData.run_id,\n  created_at: new Date().toISOString(),\n  prd: initData.prd,\n  target_workflow: initData.target_workflow,\n  tasks: tasks.map(t => ({\n    id: t.id,\n    name: t.name,\n    description: t.description,\n    depends_on: t.depends_on || [],\n    files_expected: t.files_expected || [],\n    complexity: t.complexity || 3,\n    estimated_minutes: t.estimated_minutes || 10,\n    model: assignModel(t)\n  })),\n  waves: waveData.waves,\n  summary: {\n    total_tasks: tasks.length,\n    total_waves: waves.length,\n    estimated_total_minutes: tasks.reduce((sum, t) => sum + (t.estimated_minutes || 10), 0),\n    model_distribution: {\n      opus: tasks.filter(t => assignModel(t) === 'opus').length,\n      sonnet: tasks.filter(t => assignModel(t) === 'sonnet').length,\n      haiku: tasks.filter(t => assignModel(t) === 'haiku').length\n    }\n  }\n};\n\n// æ³¨æ„ï¼šéœ€è¦åœ¨ SSH èŠ‚ç‚¹ä¸­ä¿å­˜è¿™ä¸ªä¿¡æ¯\n// è¿™é‡Œåªæ˜¯å‡†å¤‡æ•°æ®ï¼Œå®é™…ä¿å­˜åœ¨ä¸‹ä¸€ä¸ªèŠ‚ç‚¹\n\nreturn sortedTasks.map(task => ({\n  json: {\n    ...task,\n    _waveData: waveData,  // ä¼ é€’ wave æ•°æ®ç”¨äºä¿å­˜\n    _executionPlan: executionPlan  // ä¼ é€’æ‰§è¡Œè®¡åˆ’ç”¨äºä¿å­˜åˆ° plan.json\n  }\n}));"
      },
      "id": "code-topological-sort",
      "name": "Code - æ‹“æ‰‘æ’åº",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        900,
        300
      ]
    },
    {
      "parameters": {
        "batchSize": 3,
        "options": {}
      },
      "id": "split-in-batches",
      "name": "SplitInBatches - ä»»åŠ¡åˆ†æ‰¹",
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        1080,
        300
      ]
    },
    {
      "parameters": {
        "authentication": "privateKey",
        "command": "=cd /home/xx/dev/n8n-workflows && # æ›´æ–° wave ä¿¡æ¯\nif [ ! -z \"{{ $json.waveIndex }}\" ]; then\n  jq '.current_wave = {{ $json.waveIndex }} | .total_waves = {{ $json.totalWaves }}' {{ $json.state_dir }}/state.json > {{ $json.state_dir }}/state.json.tmp 2>/dev/null && mv {{ $json.state_dir }}/state.json.tmp {{ $json.state_dir }}/state.json || true\nfi\necho '{\"task_id\": \"{{ $json.id }}\", \"status\": \"executing\", \"model\": \"{{ $json.model || 'sonnet' }}\", \"complexity\": {{ $json.complexity || 3 }}, \"estimated_minutes\": {{ $json.estimated_minutes || 10 }}}' > {{ $json.state_dir }}/tasks/{{ $json.id }}.json && claude -p 'æ‰§è¡Œä»¥ä¸‹ n8n workflow ä»»åŠ¡ï¼š\n\nä»»åŠ¡ID: {{ $json.id }}\nä»»åŠ¡å: {{ $json.name }}\næè¿°: {{ $json.description }}\né¢„æœŸäº§å‡º: {{ JSON.stringify($json.files_expected) }}\nå¤æ‚åº¦: {{ $json.complexity || 3 }}/5\né¢„ä¼°æ—¶é—´: {{ $json.estimated_minutes || 10 }} åˆ†é’Ÿ\n\nè¦æ±‚ï¼š\n1. ä½¿ç”¨ mcp__n8n å·¥å…·åˆ›å»º/ä¿®æ”¹ workflow\n2. ç¡®ä¿æ‰€æœ‰èŠ‚ç‚¹è¿æ¥æ­£ç¡®\n3. å®Œæˆåè¿”å› JSONï¼š{\"task_id\": \"{{ $json.id }}\", \"status\": \"success\", \"workflow_id\": \"xxx\", \"nodes_created\": N, \"files_created\": [\"xxx\"]}' --allowedTools \"mcp__n8n__search_workflows,mcp__n8n__get_workflow_details,mcp__n8n__execute_workflow,Read,Write,Edit,Bash\" --model {{ $json.model || 'sonnet' }} 2>&1 | tail -n 100"
      },
      "id": "ssh-claude-execute",
      "name": "SSH Claude B - æ‰§è¡Œä»»åŠ¡",
      "type": "n8n-nodes-base.ssh",
      "typeVersion": 1,
      "position": [
        1260,
        300
      ],
      "credentials": {
        "sshPrivateKey": {
          "id": "vvJsQOZ95sqzemla",
          "name": "VPS SSH Key"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// åˆå¹¶æ‰€æœ‰ä»»åŠ¡æ‰§è¡Œç»“æœ\nconst items = $input.all();\nconst results = [];\nlet successCount = 0;\nlet failedCount = 0;\nlet initData = {};\n\nfor (const item of items) {\n  // ä¿å­˜ initData\n  if (item.json.run_id) {\n    initData = {\n      run_id: item.json.run_id,\n      state_dir: item.json.state_dir,\n      target_workflow: item.json.target_workflow,\n      started_at: item.json.started_at,\n      rework_count: item.json.rework_count || 0  // ä¿ç•™è¿”å·¥è®¡æ•°\n    };\n  }\n  \n  try {\n    const output = item.json.stdout || '';\n    const match = output.match(/\\{[\\s\\S]*\"task_id\"[\\s\\S]*\"status\"[\\s\\S]*\\}/i);\n    \n    let result;\n    if (match) {\n      result = JSON.parse(match[0]);\n    } else {\n      result = {\n        task_id: item.json.id || 'unknown',\n        status: 'completed',\n        output: output.slice(-500)\n      };\n    }\n    \n    results.push(result);\n    \n    if (result.status === 'success') {\n      successCount++;\n    } else if (result.status === 'failed') {\n      failedCount++;\n    }\n  } catch (e) {\n    results.push({\n      task_id: item.json.id || 'parse_error',\n      status: 'failed',\n      error: e.message\n    });\n    failedCount++;\n  }\n}\n\nreturn [{\n  json: {\n    ...initData,\n    results,\n    summary: {\n      total: results.length,\n      success: successCount,\n      failed: failedCount,\n      success_rate: results.length > 0 ? (successCount / results.length * 100).toFixed(2) + '%' : '0%'\n    },\n    timestamp: new Date().toISOString()\n  }\n}];"
      },
      "id": "code-merge-results",
      "name": "Code - åˆå¹¶ç»“æœ",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1440,
        300
      ]
    },
    {
      "parameters": {
        "authentication": "privateKey",
        "command": "=# ç¡¬æ£€æŸ¥ï¼šéªŒè¯ workflow å­˜åœ¨æ€§å’ŒèŠ‚ç‚¹å®Œæ•´æ€§\nsource /home/xx/dev/n8n-workflows/.secrets\nBASE_URL=\"http://localhost:5679/api/v1\"\n\necho '{\"check\": \"workflow_existence\", \"results\": [], \"all_exist\": true}' > /tmp/hard_check_{{ $json.run_id }}.json\n\nfor workflow_id in $(echo '{{ JSON.stringify($json.results) }}' | jq -r '.[].workflow_id // empty' 2>/dev/null); do\n  if [ -n \"$workflow_id\" ]; then\n    response=$(curl -s -H \"X-N8N-API-KEY: $N8N_REST_API_KEY\" \"$BASE_URL/workflows/$workflow_id\" 2>/dev/null)\n    \n    if echo \"$response\" | jq -e '.id' > /dev/null 2>&1; then\n      node_count=$(echo \"$response\" | jq '.nodes | length')\n      jq --arg wid \"$workflow_id\" --argjson nc \"$node_count\" \\\n        '.results += [{\"workflow_id\": $wid, \"exists\": true, \"node_count\": $nc}]' \\\n        /tmp/hard_check_{{ $json.run_id }}.json > /tmp/hard_check_{{ $json.run_id }}_tmp.json && \\\n        mv /tmp/hard_check_{{ $json.run_id }}_tmp.json /tmp/hard_check_{{ $json.run_id }}.json\n    else\n      jq --arg wid \"$workflow_id\" \\\n        '.results += [{\"workflow_id\": $wid, \"exists\": false}] | .all_exist = false' \\\n        /tmp/hard_check_{{ $json.run_id }}.json > /tmp/hard_check_{{ $json.run_id }}_tmp.json && \\\n        mv /tmp/hard_check_{{ $json.run_id }}_tmp.json /tmp/hard_check_{{ $json.run_id }}.json\n    fi\n  fi\ndone\n\ncat /tmp/hard_check_{{ $json.run_id }}.json\ncp /tmp/hard_check_{{ $json.run_id }}.json {{ $json.state_dir }}/qc/hard_check.json\nrm -f /tmp/hard_check_{{ $json.run_id }}.json /tmp/hard_check_{{ $json.run_id }}_tmp.json"
      },
      "id": "ssh-bash-hard-check",
      "name": "SSH Bash - ç¡¬æ£€æŸ¥",
      "type": "n8n-nodes-base.ssh",
      "typeVersion": 1,
      "position": [
        1660,
        120
      ],
      "credentials": {
        "sshPrivateKey": {
          "id": "vvJsQOZ95sqzemla",
          "name": "VPS SSH Key"
        }
      }
    },
    {
      "parameters": {
        "authentication": "privateKey",
        "command": "=cd /home/xx/dev/n8n-workflows && output=$(claude -p 'å¯¹ä»¥ä¸‹ workflows è¿›è¡Œå¿«é€Ÿè´¨é‡æ£€æŸ¥ï¼š\n\n{{ JSON.stringify($json.results.filter(r => r.workflow_id), null, 2) }}\n\næ£€æŸ¥ç‚¹ï¼š\n1. èŠ‚ç‚¹å‘½åæ˜¯å¦æ¸…æ™°ï¼ˆä¸­æ–‡æè¿°ï¼‰\n2. æ˜¯å¦æœ‰é”™è¯¯å¤„ç†\n3. è¿æ¥æ˜¯å¦å®Œæ•´\n\nè¿”å› JSONï¼š{\"check\": \"quality\", \"pass\": true/false, \"issues\": [{\"workflow_id\": \"xxx\", \"issue\": \"é—®é¢˜æè¿°\"}]}' --allowedTools \"mcp__n8n__get_workflow_details\" --model sonnet 2>&1 | tail -n 50) && echo \"$output\" && echo \"$output\" | grep -o '{\"check\":.*}' > {{ $json.state_dir }}/qc/soft_check.json || echo '{\"check\": \"quality\", \"pass\": false, \"error\": \"è§£æå¤±è´¥\"}' > {{ $json.state_dir }}/qc/soft_check.json"
      },
      "id": "ssh-claude-quality-check",
      "name": "SSH Claude C - è½¯æ£€æŸ¥",
      "type": "n8n-nodes-base.ssh",
      "typeVersion": 1,
      "position": [
        1660,
        240
      ],
      "credentials": {
        "sshPrivateKey": {
          "id": "vvJsQOZ95sqzemla",
          "name": "VPS SSH Key"
        }
      }
    },
    {
      "parameters": {
        "authentication": "privateKey",
        "command": "=# å®‰å…¨æ‰«æï¼šæ£€æŸ¥ workflow ä¸­çš„å®‰å…¨é—®é¢˜\nsource /home/xx/dev/n8n-workflows/.secrets\nBASE_URL=\"http://localhost:5679/api/v1\"\n\n# åˆå§‹åŒ–æ‰«æç»“æœ\necho '{\n  \"check\": \"security_scan\",\n  \"issues\": [],\n  \"pass\": true,\n  \"details\": {\n    \"credentials\": {\"checked\": true, \"found\": 0},\n    \"sql_injection\": {\"checked\": true, \"found\": 0},\n    \"xss\": {\"checked\": true, \"found\": 0},\n    \"command_injection\": {\"checked\": true, \"found\": 0}\n  }\n}' > /tmp/security_{{ $json.run_id }}.json\n\nfor workflow_id in $(echo '{{ JSON.stringify($json.results) }}' | jq -r '.[].workflow_id // empty' 2>/dev/null); do\n  if [ -n \"$workflow_id\" ]; then\n    response=$(curl -s -H \"X-N8N-API-KEY: $N8N_REST_API_KEY\" \"$BASE_URL/workflows/$workflow_id\" 2>/dev/null)\n    \n    # 1. æ£€æŸ¥ç¡¬ç¼–ç å‡­æ®ï¼ˆæ’é™¤ credential referenceï¼‰\n    if echo \"$response\" | grep -E '(password|secret|api[_-]?key)\\s*[\":=]\\s*[\"'\"'\"'][A-Za-z0-9+/=]{20,}' | grep -v 'credentials' > /dev/null 2>&1; then\n      jq --arg wid \"$workflow_id\" \\\n        '.issues += [{\"workflow_id\": $wid, \"type\": \"credentials\", \"issue\": \"å¯èƒ½åŒ…å«ç¡¬ç¼–ç å‡­æ®\"}] | .pass = false | .details.credentials.found += 1' \\\n        /tmp/security_{{ $json.run_id }}.json > /tmp/security_{{ $json.run_id }}_tmp.json && \\\n        mv /tmp/security_{{ $json.run_id }}_tmp.json /tmp/security_{{ $json.run_id }}.json\n    fi\n    \n    # 2. æ£€æŸ¥ SQL æ³¨å…¥é£é™©ï¼ˆæ‹¼æ¥ SQL å­—ç¬¦ä¸²ï¼‰\n    if echo \"$response\" | grep -E '(SELECT|INSERT|UPDATE|DELETE|DROP).*[+].*\\$(json|input|execution)' > /dev/null 2>&1 || \\\n       echo \"$response\" | grep -E 'query.*[+].*variable|sql.*[+].*\\$' > /dev/null 2>&1; then\n      jq --arg wid \"$workflow_id\" \\\n        '.issues += [{\"workflow_id\": $wid, \"type\": \"sql_injection\", \"issue\": \"å¯èƒ½å­˜åœ¨ SQL æ³¨å…¥é£é™©ï¼ˆå­—ç¬¦ä¸²æ‹¼æ¥ï¼‰\"}] | .pass = false | .details.sql_injection.found += 1' \\\n        /tmp/security_{{ $json.run_id }}.json > /tmp/security_{{ $json.run_id }}_tmp.json && \\\n        mv /tmp/security_{{ $json.run_id }}_tmp.json /tmp/security_{{ $json.run_id }}.json\n    fi\n    \n    # 3. æ£€æŸ¥ XSS é£é™©ï¼ˆç›´æ¥è¾“å‡ºç”¨æˆ·è¾“å…¥åˆ° HTMLï¼‰\n    if echo \"$response\" | grep -E 'innerHTML.*=.*(\\$json|\\$input)|document\\.write\\(' > /dev/null 2>&1; then\n      jq --arg wid \"$workflow_id\" \\\n        '.issues += [{\"workflow_id\": $wid, \"type\": \"xss\", \"issue\": \"å¯èƒ½å­˜åœ¨ XSS é£é™©ï¼ˆç›´æ¥è¾“å‡ºåˆ° HTMLï¼‰\"}] | .pass = false | .details.xss.found += 1' \\\n        /tmp/security_{{ $json.run_id }}.json > /tmp/security_{{ $json.run_id }}_tmp.json && \\\n        mv /tmp/security_{{ $json.run_id }}_tmp.json /tmp/security_{{ $json.run_id }}.json\n    fi\n    \n    # 4. æ£€æŸ¥å‘½ä»¤æ³¨å…¥é£é™©ï¼ˆä¸å®‰å…¨çš„å‘½ä»¤æ‹¼æ¥ï¼‰\n    if echo \"$response\" | grep -E 'exec\\(.*\\$(json|input)|spawn\\(.*\\$(json|input)|child_process.*\\$' > /dev/null 2>&1 || \\\n       echo \"$response\" | grep -E 'eval\\(.*\\$(json|input)' > /dev/null 2>&1; then\n      jq --arg wid \"$workflow_id\" \\\n        '.issues += [{\"workflow_id\": $wid, \"type\": \"command_injection\", \"issue\": \"å¯èƒ½å­˜åœ¨å‘½ä»¤æ³¨å…¥é£é™©ï¼ˆä¸å®‰å…¨çš„å‘½ä»¤æ‹¼æ¥ï¼‰\"}] | .pass = false | .details.command_injection.found += 1' \\\n        /tmp/security_{{ $json.run_id }}.json > /tmp/security_{{ $json.run_id }}_tmp.json && \\\n        mv /tmp/security_{{ $json.run_id }}_tmp.json /tmp/security_{{ $json.run_id }}.json\n    fi\n  fi\ndone\n\ncat /tmp/security_{{ $json.run_id }}.json\ncp /tmp/security_{{ $json.run_id }}.json {{ $json.state_dir }}/qc/security.json\nrm -f /tmp/security_{{ $json.run_id }}.json /tmp/security_{{ $json.run_id }}_tmp.json"
      },
      "id": "ssh-bash-security-scan",
      "name": "SSH Bash - å®‰å…¨æ‰«æ",
      "type": "n8n-nodes-base.ssh",
      "typeVersion": 1,
      "position": [
        1660,
        360
      ],
      "credentials": {
        "sshPrivateKey": {
          "id": "vvJsQOZ95sqzemla",
          "name": "VPS SSH Key"
        }
      }
    },
    {
      "parameters": {
        "authentication": "privateKey",
        "command": "=# é›†æˆæ£€æŸ¥ï¼šéªŒè¯ workflow è¿æ¥å’Œä¾èµ–å®Œæ•´æ€§\nsource /home/xx/dev/n8n-workflows/.secrets\nBASE_URL=\"http://localhost:5679/api/v1\"\n\nimports_ok=1\napi_ok=1\n\nfor workflow_id in $(echo '{{ JSON.stringify($json.results) }}' | jq -r '.[].workflow_id // empty' 2>/dev/null); do\n  if [ -n \"$workflow_id\" ]; then\n    response=$(curl -s -H \"X-N8N-API-KEY: $N8N_REST_API_KEY\" \"$BASE_URL/workflows/$workflow_id\" 2>/dev/null)\n    \n    # æ£€æŸ¥æ‰€æœ‰èŠ‚ç‚¹æ˜¯å¦æœ‰ connections\n    node_count=$(echo \"$response\" | jq '.nodes | length')\n    connection_count=$(echo \"$response\" | jq '.connections | length')\n    \n    # è‡³å°‘åº”è¯¥æœ‰ n-1 ä¸ªè¿æ¥ï¼ˆå¯¹äº n ä¸ªèŠ‚ç‚¹çš„çº¿æ€§æµï¼‰\n    if [ \"$connection_count\" -lt 1 ] && [ \"$node_count\" -gt 1 ]; then\n      imports_ok=0\n    fi\n    \n    # æ£€æŸ¥æ˜¯å¦æœ‰æœªè¿æ¥çš„èŠ‚ç‚¹ï¼ˆå­¤ç«‹èŠ‚ç‚¹ï¼‰\n    orphan_count=$(echo \"$response\" | jq '[.nodes[] | select(.type != \"n8n-nodes-base.webhook\" and .type != \"n8n-nodes-base.manualTrigger\")] | length - (.connections | length)' 2>/dev/null || echo 0)\n    if [ \"$orphan_count\" -gt 1 ]; then\n      api_ok=0\n    fi\n  fi\ndone\n\necho '{\"imports_ok\": '$imports_ok', \"api_ok\": '$api_ok'}' > {{ $json.state_dir }}/qc/integration.json\necho \"INTEGRATION_CHECK_RESULT|imports_ok=$imports_ok|api_ok=$api_ok\""
      },
      "id": "ssh-bash-integration-check",
      "name": "SSH Bash - é›†æˆæ£€æŸ¥",
      "type": "n8n-nodes-base.ssh",
      "typeVersion": 1,
      "position": [
        1660,
        480
      ],
      "credentials": {
        "sshPrivateKey": {
          "id": "vvJsQOZ95sqzemla",
          "name": "VPS SSH Key"
        }
      }
    },
    {
      "parameters": {
        "authentication": "privateKey",
        "command": "=# æ€§èƒ½æ£€æŸ¥ï¼šéªŒè¯ workflow å¤æ‚åº¦å’Œæ•ˆç‡\nsource /home/xx/dev/n8n-workflows/.secrets\nBASE_URL=\"http://localhost:5679/api/v1\"\n\nsize_ok=1\ncomplexity_ok=1\n\nfor workflow_id in $(echo '{{ JSON.stringify($json.results) }}' | jq -r '.[].workflow_id // empty' 2>/dev/null); do\n  if [ -n \"$workflow_id\" ]; then\n    response=$(curl -s -H \"X-N8N-API-KEY: $N8N_REST_API_KEY\" \"$BASE_URL/workflows/$workflow_id\" 2>/dev/null)\n    \n    # æ£€æŸ¥èŠ‚ç‚¹æ•°é‡ï¼ˆå•ä¸ª workflow ä¸åº”è¶…è¿‡ 50 ä¸ªèŠ‚ç‚¹ï¼‰\n    node_count=$(echo \"$response\" | jq '.nodes | length')\n    if [ \"$node_count\" -gt 50 ]; then\n      size_ok=0\n    fi\n    \n    # æ£€æŸ¥ä»£ç èŠ‚ç‚¹ä¸­çš„ä»£ç é•¿åº¦ï¼ˆå•ä¸ª Code èŠ‚ç‚¹ä¸åº”è¶…è¿‡ 500 è¡Œï¼‰\n    max_code_lines=$(echo \"$response\" | jq -r '[.nodes[] | select(.type == \"n8n-nodes-base.code\") | .parameters.jsCode // \"\" | split(\"\\n\") | length] | max // 0')\n    if [ \"$max_code_lines\" -gt 500 ]; then\n      complexity_ok=0\n    fi\n    \n    # æ£€æŸ¥åµŒå¥—æ·±åº¦ï¼ˆSplitInBatches åµŒå¥—ä¸åº”è¶…è¿‡ 3 å±‚ï¼‰\n    split_count=$(echo \"$response\" | jq '[.nodes[] | select(.type == \"n8n-nodes-base.splitInBatches\")] | length')\n    if [ \"$split_count\" -gt 3 ]; then\n      complexity_ok=0\n    fi\n  fi\ndone\n\necho '{\"size_ok\": '$size_ok', \"complexity_ok\": '$complexity_ok'}' > {{ $json.state_dir }}/qc/performance.json\necho \"PERFORMANCE_CHECK_RESULT|size_ok=$size_ok|complexity_ok=$complexity_ok\""
      },
      "id": "ssh-bash-performance-check",
      "name": "SSH Bash - æ€§èƒ½æ£€æŸ¥",
      "type": "n8n-nodes-base.ssh",
      "typeVersion": 1,
      "position": [
        1660,
        600
      ],
      "credentials": {
        "sshPrivateKey": {
          "id": "vvJsQOZ95sqzemla",
          "name": "VPS SSH Key"
        }
      }
    },
    {
      "parameters": {
        "authentication": "privateKey",
        "command": "=# Gitæ£€æŸ¥ï¼šéªŒè¯åˆ†æ”¯ã€æœªæäº¤å˜æ›´ã€ç‰ˆæœ¬ä¸€è‡´æ€§\ncd /home/xx/dev/n8n-workflows\n\nbranch_ok=1\nuncommitted=0\nversion_ok=1\n\n# æ£€æŸ¥å½“å‰åˆ†æ”¯æ˜¯å¦åœ¨å—ä¿æŠ¤åˆ†æ”¯ï¼ˆmain/masterï¼‰\ncurrent_branch=$(git branch --show-current 2>/dev/null || echo \"unknown\")\nif [ \"$current_branch\" = \"main\" ] || [ \"$current_branch\" = \"master\" ]; then\n  branch_ok=0\nfi\n\n# æ£€æŸ¥æ˜¯å¦æœ‰æœªæäº¤çš„å˜æ›´\nuncommitted=$(git status --porcelain 2>/dev/null | wc -l)\n\n# æ£€æŸ¥ç‰ˆæœ¬ä¸€è‡´æ€§ï¼ˆå¦‚æœæœ‰ package.jsonï¼‰\nif [ -f \"package.json\" ]; then\n  pkg_version=$(jq -r '.version // \"0.0.0\"' package.json 2>/dev/null)\n  # æ£€æŸ¥æ˜¯å¦æœ‰ç‰ˆæœ¬ç›¸å…³çš„ tag\n  latest_tag=$(git describe --tags --abbrev=0 2>/dev/null || echo \"v0.0.0\")\n  tag_version=${latest_tag#v}\n  \n  # ç®€å•æ¯”è¾ƒç‰ˆæœ¬å·ï¼ˆå»æ‰ v å‰ç¼€ï¼‰\n  if [ \"$pkg_version\" != \"$tag_version\" ] && [ \"$latest_tag\" != \"v0.0.0\" ]; then\n    version_ok=0\n  fi\nfi\n\necho '{\"branch_ok\": '$branch_ok', \"uncommitted\": '$uncommitted', \"version_ok\": '$version_ok'}' > {{ $json.state_dir }}/qc/git.json\necho \"GIT_CHECK_RESULT|branch_ok=$branch_ok|uncommitted=$uncommitted|version_ok=$version_ok\""
      },
      "id": "ssh-bash-git-check",
      "name": "SSH Bash - Gitæ£€æŸ¥",
      "type": "n8n-nodes-base.ssh",
      "typeVersion": 1,
      "position": [
        1660,
        720
      ],
      "credentials": {
        "sshPrivateKey": {
          "id": "vvJsQOZ95sqzemla",
          "name": "VPS SSH Key"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// å†³ç­–ï¼šæ ¹æ®è´¨æ£€ç»“æœå†³å®š PASS / REWORK / FAIL\nconst items = $input.all();\nconst mergeResult = $('Code - åˆå¹¶ç»“æœ').first().json;\n\n// è§£æå„é¡¹æ£€æŸ¥ç»“æœ\nlet hardCheck = { all_exist: true, results: [] };\nlet softCheck = { pass: true, issues: [] };\nlet securityCheck = { pass: true, issues: [], details: { credentials: { checked: true, found: 0 }, sql_injection: { checked: true, found: 0 }, xss: { checked: true, found: 0 }, command_injection: { checked: true, found: 0 } } };\nlet integrationCheck = { imports_ok: 1, api_ok: 1 };\nlet performanceCheck = { size_ok: 1, complexity_ok: 1 };\nlet gitCheck = { branch_ok: 1, uncommitted: 0, version_ok: 1 };\n\nfor (const item of items) {\n  const stdout = item.json.stdout || '';\n  \n  // ç¡¬æ£€æŸ¥\n  const hardMatch = stdout.match(/\\{[\\s\\S]*\"check\"\\s*:\\s*\"workflow_existence\"[\\s\\S]*\\}/);\n  if (hardMatch) {\n    try {\n      hardCheck = JSON.parse(hardMatch[0]);\n    } catch (e) {}\n  }\n  \n  // è½¯æ£€æŸ¥\n  const softMatch = stdout.match(/\\{[\\s\\S]*\"check\"\\s*:\\s*\"quality\"[\\s\\S]*\\}/);\n  if (softMatch) {\n    try {\n      softCheck = JSON.parse(softMatch[0]);\n    } catch (e) {}\n  }\n  \n  // å®‰å…¨æ£€æŸ¥ï¼ˆæ”¯æŒæ–°çš„ details æ ¼å¼ï¼‰\n  const securityMatch = stdout.match(/\\{[\\s\\S]*\"check\"\\s*:\\s*\"security_scan\"[\\s\\S]*\\}/);\n  if (securityMatch) {\n    try {\n      securityCheck = JSON.parse(securityMatch[0]);\n    } catch (e) {}\n  }\n  \n  // é›†æˆæ£€æŸ¥\n  const integrationMatch = stdout.match(/INTEGRATION_CHECK_RESULT\\|imports_ok=(\\d+)\\|api_ok=(\\d+)/);\n  if (integrationMatch) {\n    integrationCheck = {\n      imports_ok: parseInt(integrationMatch[1]),\n      api_ok: parseInt(integrationMatch[2])\n    };\n  }\n  \n  // æ€§èƒ½æ£€æŸ¥\n  const performanceMatch = stdout.match(/PERFORMANCE_CHECK_RESULT\\|size_ok=(\\d+)\\|complexity_ok=(\\d+)/);\n  if (performanceMatch) {\n    performanceCheck = {\n      size_ok: parseInt(performanceMatch[1]),\n      complexity_ok: parseInt(performanceMatch[2])\n    };\n  }\n  \n  // Gitæ£€æŸ¥\n  const gitMatch = stdout.match(/GIT_CHECK_RESULT\\|branch_ok=(\\d+)\\|uncommitted=(\\d+)\\|version_ok=(\\d+)/);\n  if (gitMatch) {\n    gitCheck = {\n      branch_ok: parseInt(gitMatch[1]),\n      uncommitted: parseInt(gitMatch[2]),\n      version_ok: parseInt(gitMatch[3])\n    };\n  }\n}\n\n// å†³ç­–é€»è¾‘\nconst issues = [];\nlet decision = 'PASS';\nlet action = 'è´¨æ£€é€šè¿‡ï¼Œè¿›å…¥æ–‡æ¡£ç”Ÿæˆ';\n\n// ä¸¥é‡é—®é¢˜ -> FAIL\nif (!hardCheck.all_exist) {\n  issues.push({ severity: 'critical', type: 'hardCheck', message: 'Workflow åˆ›å»ºå¤±è´¥æˆ–ä¸å­˜åœ¨', details: hardCheck.results });\n}\nif (!securityCheck.pass) {\n  issues.push({ severity: 'critical', type: 'security', message: `å®‰å…¨é—®é¢˜: ${securityCheck.issues.length} ä¸ª`, details: securityCheck.issues });\n}\n\n// ä¸­ç­‰é—®é¢˜ -> REWORK\nif (!softCheck.pass) {\n  issues.push({ severity: 'high', type: 'softCheck', message: `è´¨é‡é—®é¢˜: ${softCheck.issues.length} ä¸ª`, details: softCheck.issues });\n}\nif (mergeResult.summary.failed > 0) {\n  issues.push({ severity: 'high', type: 'execution', message: `æ‰§è¡Œå¤±è´¥: ${mergeResult.summary.failed} ä¸ªä»»åŠ¡`, details: mergeResult.results.filter(r => r.status === 'failed') });\n}\nif (integrationCheck.imports_ok === 0) {\n  issues.push({ severity: 'high', type: 'integration', message: 'Workflow è¿æ¥ä¸å®Œæ•´' });\n}\nif (integrationCheck.api_ok === 0) {\n  issues.push({ severity: 'high', type: 'integration', message: 'Workflow å­˜åœ¨å­¤ç«‹èŠ‚ç‚¹' });\n}\n\n// ä½ä¼˜å…ˆçº§é—®é¢˜ -> WARNINGï¼ˆä»ç„¶ PASSï¼‰\nif (performanceCheck.size_ok === 0) {\n  issues.push({ severity: 'low', type: 'performance', message: 'Workflow èŠ‚ç‚¹æ•°é‡è¿‡å¤šï¼ˆ>50ï¼‰' });\n}\nif (performanceCheck.complexity_ok === 0) {\n  issues.push({ severity: 'low', type: 'performance', message: 'Workflow å¤æ‚åº¦è¿‡é«˜ï¼ˆä»£ç >500è¡Œæˆ–åµŒå¥—>3å±‚ï¼‰' });\n}\nif (gitCheck.branch_ok === 0) {\n  issues.push({ severity: 'low', type: 'git', message: 'å·¥ä½œåœ¨å—ä¿æŠ¤åˆ†æ”¯ï¼ˆmain/masterï¼‰' });\n}\nif (gitCheck.uncommitted > 0) {\n  issues.push({ severity: 'low', type: 'git', message: `å­˜åœ¨ ${gitCheck.uncommitted} ä¸ªæœªæäº¤çš„å˜æ›´` });\n}\nif (gitCheck.version_ok === 0) {\n  issues.push({ severity: 'low', type: 'git', message: 'ç‰ˆæœ¬å·ä¸ä¸€è‡´ï¼ˆpackage.jsonï¼‰' });\n}\n\n// å†³ç­–\nconst criticalCount = issues.filter(i => i.severity === 'critical').length;\nconst highCount = issues.filter(i => i.severity === 'high').length;\nconst lowCount = issues.filter(i => i.severity === 'low').length;\n\nif (criticalCount > 0) {\n  decision = 'FAIL';\n  action = 'å‘ç°ä¸¥é‡é—®é¢˜ï¼Œéœ€è¦äººå·¥ä»‹å…¥';\n} else if (highCount > 0) {\n  decision = 'REWORK';\n  action = 'éœ€è¦ä¿®å¤é—®é¢˜åé‡è¯•';\n} else if (lowCount > 0) {\n  decision = 'PASS';\n  action = `è´¨æ£€é€šè¿‡ï¼ˆæœ‰ ${lowCount} ä¸ªæ€§èƒ½è­¦å‘Šï¼‰`;\n}\n\nreturn [{\n  json: {\n    ...mergeResult,\n    decision,\n    action,\n    issues,\n    checks: {\n      hardCheck: { all_exist: hardCheck.all_exist, count: hardCheck.results?.length || 0 },\n      softCheck: { pass: softCheck.pass, issues: softCheck.issues?.length || 0 },\n      securityCheck: { \n        pass: securityCheck.pass, \n        issues: securityCheck.issues?.length || 0,\n        details: securityCheck.details || {}\n      },\n      integrationCheck: { imports_ok: integrationCheck.imports_ok === 1, api_ok: integrationCheck.api_ok === 1 },\n      performanceCheck: { size_ok: performanceCheck.size_ok === 1, complexity_ok: performanceCheck.complexity_ok === 1 },\n      gitCheck: { branch_ok: gitCheck.branch_ok === 1, uncommitted: gitCheck.uncommitted, version_ok: gitCheck.version_ok === 1 }\n    }\n  }\n}];"
      },
      "id": "code-decision",
      "name": "Code - å†³ç­–",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1880,
        300
      ]
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.decision }}",
                    "rightValue": "PASS",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "PASS"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.decision }}",
                    "rightValue": "REWORK",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "REWORK"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.decision }}",
                    "rightValue": "FAIL",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "FAIL"
            }
          ]
        },
        "options": {}
      },
      "id": "switch-decision",
      "name": "Switch - å†³ç­–åˆ†æ”¯",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3,
      "position": [
        2060,
        300
      ]
    },
    {
      "parameters": {
        "authentication": "privateKey",
        "command": "=cd /home/xx/dev/n8n-workflows && claude -p 'ä¸ºä»¥ä¸‹ workflows ç”Ÿæˆç®€çŸ­ä½¿ç”¨æ–‡æ¡£ï¼š\n\n{{ JSON.stringify($json.results.filter(r => r.workflow_id), null, 2) }}\n\nè¦æ±‚ï¼š\n1. æ¯ä¸ª workflow çš„åŠŸèƒ½è¯´æ˜\n2. è§¦å‘æ–¹å¼ï¼ˆwebhook pathï¼‰\n3. è¾“å…¥è¾“å‡ºæ ¼å¼\n\nä¿å­˜åˆ° /home/xx/dev/n8n-workflows/docs/{{ $json.run_id }}.md' --allowedTools \"mcp__n8n__get_workflow_details,Write,Edit\" --model haiku 2>&1 | tail -n 30"
      },
      "id": "ssh-claude-doc-gen",
      "name": "SSH Claude D - ç”Ÿæˆæ–‡æ¡£",
      "type": "n8n-nodes-base.ssh",
      "typeVersion": 1,
      "position": [
        2240,
        160
      ],
      "credentials": {
        "sshPrivateKey": {
          "id": "vvJsQOZ95sqzemla",
          "name": "VPS SSH Key"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// æ£€æŸ¥è¿”å·¥æ¬¡æ•°ï¼Œè¶…è¿‡ 2 æ¬¡åˆ™è½¬ä¸º FAIL\nconst data = $input.first().json;\nconst currentCount = data.rework_count || 0;\n\nif (currentCount >= 2) {\n  return [{\n    json: {\n      ...data,\n      decision: 'FAIL',\n      action: 'è¿”å·¥æ¬¡æ•°è¶…è¿‡é™åˆ¶ï¼ˆ2æ¬¡ï¼‰ï¼Œéœ€è¦äººå·¥ä»‹å…¥',\n      rework_exceeded: true\n    }\n  }];\n}\n\nreturn [{\n  json: {\n    ...data,\n    can_rework: true\n  }\n}];"
      },
      "id": "code-check-rework-count",
      "name": "Code - æ£€æŸ¥è¿”å·¥æ¬¡æ•°",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2240,
        320
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "can-rework",
              "leftValue": "={{ $json.can_rework }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "true"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "if-can-rework",
      "name": "IF - æ˜¯å¦å¯è¿”å·¥",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        2420,
        320
      ]
    },
    {
      "parameters": {
        "jsCode": "// æ„å»ºè¿”å·¥è®¡åˆ’ï¼šåˆ†æå¤±è´¥ä»»åŠ¡åŠå…¶ä¾èµ–é“¾\nconst data = $input.first().json;\nconst failedTasks = data.results.filter(r => r.status === 'failed');\nconst allTasks = data.results;\n\n// æ‰¾å‡ºéœ€è¦è¿”å·¥çš„ä»»åŠ¡ï¼ˆå¤±è´¥ä»»åŠ¡ + ä¾èµ–å¤±è´¥ä»»åŠ¡çš„ä»»åŠ¡ï¼‰\nconst needRework = new Set();\nconst taskMap = new Map(allTasks.map(t => [t.task_id, t]));\n\n// æ ‡è®°å¤±è´¥ä»»åŠ¡\nfailedTasks.forEach(t => needRework.add(t.task_id));\n\n// æ‰¾å‡ºä¾èµ–å¤±è´¥ä»»åŠ¡çš„ä»»åŠ¡ï¼ˆéœ€è¦é€’å½’ï¼‰\nfunction findDependents(taskId) {\n  for (const task of allTasks) {\n    if (task.depends_on && task.depends_on.includes(taskId)) {\n      if (!needRework.has(task.task_id)) {\n        needRework.add(task.task_id);\n        findDependents(task.task_id);\n      }\n    }\n  }\n}\n\nfailedTasks.forEach(t => findDependents(t.task_id));\n\n// æ„å»ºè¿”å·¥ä»»åŠ¡åˆ—è¡¨\nconst reworkTasks = Array.from(needRework).map(taskId => {\n  const task = taskMap.get(taskId);\n  return {\n    task_id: taskId,\n    reason: failedTasks.some(ft => ft.task_id === taskId) ? 'failed' : 'depends_on_failed',\n    original_result: task\n  };\n});\n\nconst newReworkCount = (data.rework_count || 0) + 1;\n\n// ä¿å­˜è¿”å·¥è®¡åˆ’åˆ°æ–‡ä»¶\nconst reworkPlan = {\n  rework_id: newReworkCount,\n  timestamp: new Date().toISOString(),\n  failed_count: failedTasks.length,\n  rework_count: reworkTasks.length,\n  tasks: reworkTasks,\n  issues: data.issues\n};\n\nreturn [{\n  json: {\n    ...data,\n    rework_plan: reworkPlan,\n    rework_count: newReworkCount,\n    rework_task_ids: Array.from(needRework)\n  }\n}];"
      },
      "id": "code-build-rework-plan",
      "name": "Code - æ„å»ºè¿”å·¥è®¡åˆ’",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2600,
        260
      ]
    },
    {
      "parameters": {
        "authentication": "privateKey",
        "command": "=# ä¿å­˜è¿”å·¥è®¡åˆ’å¹¶æ‰§è¡Œè¿”å·¥\necho '{{ JSON.stringify($json.rework_plan) }}' > {{ $json.state_dir }}/rework/rework_{{ $json.rework_count }}.json\n\n# æ›´æ–°çŠ¶æ€\njq '.rework_count = {{ $json.rework_count }} | .status = \"reworking\"' {{ $json.state_dir }}/state.json > {{ $json.state_dir }}/state.json.tmp && mv {{ $json.state_dir }}/state.json.tmp {{ $json.state_dir }}/state.json\n\ncd /home/xx/dev/n8n-workflows\n\n# å¯¹æ¯ä¸ªéœ€è¦è¿”å·¥çš„ä»»åŠ¡æ‰§è¡Œ Claude ä¿®å¤\nfor task_id in {{ $json.rework_task_ids.join(' ') }}; do\n  echo \"è¿”å·¥ä»»åŠ¡: $task_id\"\n  \n  # è¯»å–ä»»åŠ¡è¯¦æƒ…\n  task_info=$(cat {{ $json.state_dir }}/tasks/${task_id}.json 2>/dev/null || echo '{}')\n  \n  # è¯»å–å¤±è´¥åŸå› \n  failure_reason=$(echo '{{ JSON.stringify($json.issues) }}' | jq -r \".[] | select(.type == \\\"execution\\\") | .details[] | select(.task_id == \\\"$task_id\\\") | .error // \\\"æœªçŸ¥é”™è¯¯\\\"\")\n  \n  # æ‰§è¡Œè¿”å·¥\n  claude -p \"ä¿®å¤ä»¥ä¸‹ä»»åŠ¡çš„é—®é¢˜ï¼š\n\nä»»åŠ¡ID: $task_id\nä»»åŠ¡ä¿¡æ¯: $task_info\nå¤±è´¥åŸå› : $failure_reason\n\nè¦æ±‚ï¼š\n1. åˆ†æå¤±è´¥åŸå› \n2. ä¿®å¤é—®é¢˜å¹¶é‡æ–°æ‰§è¡Œ\n3. è¿”å› JSONï¼š{\\\"task_id\\\": \\\"$task_id\\\", \\\"status\\\": \\\"success/failed\\\", \\\"reworked\\\": true}\" \\\n    --allowedTools \"mcp__n8n__search_workflows,mcp__n8n__get_workflow_details,mcp__n8n__execute_workflow,Read,Write,Edit,Bash\" \\\n    --model sonnet 2>&1 | tail -n 100 > {{ $json.state_dir }}/tasks/${task_id}_rework_{{ $json.rework_count }}.log\ndone\n\necho \"è¿”å·¥å®Œæˆï¼Œä»»åŠ¡æ•°: {{ $json.rework_task_ids.length }}\""
      },
      "id": "ssh-execute-rework",
      "name": "SSH - æ‰§è¡Œè¿”å·¥",
      "type": "n8n-nodes-base.ssh",
      "typeVersion": 1,
      "position": [
        2780,
        260
      ],
      "credentials": {
        "sshPrivateKey": {
          "id": "vvJsQOZ95sqzemla",
          "name": "VPS SSH Key"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// è§£æè¿”å·¥ç»“æœï¼Œå‡†å¤‡é‡æ–°è¿›å…¥åˆå¹¶ç»“æœæµç¨‹\nconst data = $input.first().json;\nconst stdout = data.stdout || '';\n\n// è¯»å–æ‰€æœ‰è¿”å·¥ä»»åŠ¡çš„ç»“æœ\nconst reworkResults = [];\n\nfor (const taskId of data.rework_task_ids) {\n  // ä»æ—¥å¿—ä¸­æå–ç»“æœ\n  const logMatch = stdout.match(new RegExp(`task_id[\"'\\\\s]*:[\"'\\\\s]*${taskId}[\\\\s\\\\S]*?status[\"'\\\\s]*:[\"'\\\\s]*(success|failed)`, 'i'));\n  \n  if (logMatch) {\n    reworkResults.push({\n      task_id: taskId,\n      status: logMatch[1],\n      reworked: true,\n      rework_iteration: data.rework_count\n    });\n  } else {\n    // é»˜è®¤æ ‡è®°ä¸ºå¤±è´¥\n    reworkResults.push({\n      task_id: taskId,\n      status: 'failed',\n      reworked: true,\n      rework_iteration: data.rework_count,\n      error: 'æ— æ³•è§£æè¿”å·¥ç»“æœ'\n    });\n  }\n}\n\n// åˆå¹¶åŸå§‹ç»“æœå’Œè¿”å·¥ç»“æœ\nconst mergedResults = data.results.map(original => {\n  const reworked = reworkResults.find(r => r.task_id === original.task_id);\n  return reworked || original;\n});\n\n// è¾“å‡ºåˆå¹¶ç»“æœï¼Œæ¨¡æ‹Ÿ SplitInBatches çš„è¾“å‡ºæ ¼å¼\nreturn mergedResults.map(result => ({\n  json: {\n    id: result.task_id,\n    run_id: data.run_id,\n    state_dir: data.state_dir,\n    target_workflow: data.target_workflow,\n    rework_count: data.rework_count,\n    started_at: data.started_at,\n    stdout: JSON.stringify(result)\n  }\n}));"
      },
      "id": "code-parse-rework-results",
      "name": "Code - è§£æè¿”å·¥ç»“æœ",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2960,
        260
      ]
    },
    {
      "parameters": {
        "authentication": "privateKey",
        "command": "=echo 'æ›´æ–°çŠ¶æ€æ–‡ä»¶(FAIL)...' && mkdir -p {{ $json.state_dir }} && echo '{\"status\": \"{{ $json.decision }}\", \"completed_at\": \"{{ $json.timestamp }}\", \"issues\": {{ JSON.stringify($json.issues) }}, \"rework_count\": {{ $json.rework_count || 0 }}}' > {{ $json.state_dir }}/state.json"
      },
      "id": "ssh-update-state-fail",
      "name": "SSH æ›´æ–°çŠ¶æ€(FAIL)",
      "type": "n8n-nodes-base.ssh",
      "typeVersion": 1,
      "position": [
        2240,
        480
      ],
      "credentials": {
        "sshPrivateKey": {
          "id": "vvJsQOZ95sqzemla",
          "name": "VPS SSH Key"
        }
      }
    },
    {
      "parameters": {
        "authentication": "privateKey",
        "command": "=echo 'æ›´æ–°çŠ¶æ€æ–‡ä»¶(è¶…é™)...' && mkdir -p {{ $json.state_dir }} && echo '{\"status\": \"{{ $json.decision }}\", \"completed_at\": \"{{ $json.timestamp }}\", \"issues\": {{ JSON.stringify($json.issues) }}, \"rework_count\": {{ $json.rework_count || 0 }}, \"rework_exceeded\": true}' > {{ $json.state_dir }}/state.json"
      },
      "id": "ssh-update-state-exceeded",
      "name": "SSH æ›´æ–°çŠ¶æ€(è¶…é™)",
      "type": "n8n-nodes-base.ssh",
      "typeVersion": 1,
      "position": [
        2600,
        420
      ],
      "credentials": {
        "sshPrivateKey": {
          "id": "vvJsQOZ95sqzemla",
          "name": "VPS SSH Key"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// ç”Ÿæˆç®¡ç†æŠ¥å‘Šå¹¶ä¿å­˜\nconst data = $('Code - å†³ç­–').first().json;\n\n// è®¡ç®—æ—¶é•¿\nconst startedAt = new Date(data.started_at);\nconst completedAt = new Date();\nconst durationMinutes = Math.round((completedAt - startedAt) / 1000 / 60 * 100) / 100;\n\n// ç»Ÿè®¡æ¨¡å‹è°ƒç”¨æ¬¡æ•°ï¼ˆæ ¹æ®ä»»åŠ¡æ¨¡å‹åˆ†é… + å›ºå®šè§’è‰²ï¼‰\nconst totalTasks = data.summary.total || 0;\nconst reworkCount = data.rework_count || 0;\n\n// ä» results ä¸­æå–ä»»åŠ¡æ¨¡å‹åˆ†é…ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰\nconst tasksByModel = { opus: 0, sonnet: 0, haiku: 0 };\ntry {\n  // å°è¯•ä»æ‹“æ‰‘æ’åºèŠ‚ç‚¹çš„è¾“å‡ºä¸­æå–æ¨¡å‹ä¿¡æ¯ï¼ˆéœ€è¦ä» state_dir è¯»å–ï¼‰\n  // ç”±äºæ— æ³•ç›´æ¥è®¿é—®ä¹‹å‰èŠ‚ç‚¹çš„è¯¦ç»†æ•°æ®ï¼Œæˆ‘ä»¬åšä¿å®ˆä¼°ç®—\n  // å‡è®¾å¤§éƒ¨åˆ†ä»»åŠ¡ç”¨ sonnetï¼Œå°‘é‡ç®€å•ä»»åŠ¡ç”¨ haiku\n  tasksByModel.sonnet = Math.ceil(totalTasks * 0.7);\n  tasksByModel.haiku = Math.floor(totalTasks * 0.2);\n  tasksByModel.opus = totalTasks - tasksByModel.sonnet - tasksByModel.haiku;\n} catch (e) {\n  // é»˜è®¤å…¨éƒ¨ç”¨ sonnet\n  tasksByModel.sonnet = totalTasks;\n}\n\n// è®¡ç®—å„è§’è‰²çš„æ¨¡å‹è°ƒç”¨\nconst opusCalls = tasksByModel.opus + (reworkCount * Math.ceil((data.rework_task_ids?.length || 0) * 0.1)); // è¿”å·¥ä»»åŠ¡ä¸­10%å¯èƒ½æ˜¯opusçº§åˆ«\nconst sonnetCalls = 1 + tasksByModel.sonnet + 1 + (reworkCount * Math.ceil((data.rework_task_ids?.length || 0) * 0.7)); // Aåˆ†è§£(1) + Bæ‰§è¡Œä»»åŠ¡(sonnetéƒ¨åˆ†) + Cè½¯æ£€æŸ¥(1) + è¿”å·¥(70%)\nconst haikuCalls = tasksByModel.haiku + 1 + (reworkCount * Math.floor((data.rework_task_ids?.length || 0) * 0.2)); // Bæ‰§è¡Œä»»åŠ¡(haikuéƒ¨åˆ†) + Dæ–‡æ¡£ç”Ÿæˆ(1) + è¿”å·¥(20%)\n\n// æ±‡æ€»æŠ¥å‘Š\nconst summary = {\n  run_id: data.run_id,\n  factory_type: data.factory_type || 'workflow',\n  \n  execution: {\n    total_tasks: totalTasks,\n    completed: data.summary.success || 0,\n    failed: data.summary.failed || 0,\n    success_rate: data.summary.success_rate || '0%',\n    rework_count: reworkCount\n  },\n  \n  timeline: {\n    started_at: data.started_at,\n    completed_at: completedAt.toISOString(),\n    duration_minutes: durationMinutes\n  },\n  \n  quality: {\n    checks_passed: [\n      data.checks.hardCheck.all_exist ? 'hardCheck' : null,\n      data.checks.softCheck.pass ? 'softCheck' : null,\n      data.checks.securityCheck.pass ? 'security' : null,\n      data.checks.integrationCheck.imports_ok ? 'integration.imports' : null,\n      data.checks.integrationCheck.api_ok ? 'integration.api' : null,\n      data.checks.performanceCheck.size_ok ? 'performance.size' : null,\n      data.checks.performanceCheck.complexity_ok ? 'performance.complexity' : null\n    ].filter(Boolean),\n    checks_failed: [\n      !data.checks.hardCheck.all_exist ? 'hardCheck' : null,\n      !data.checks.softCheck.pass ? 'softCheck' : null,\n      !data.checks.securityCheck.pass ? 'security' : null,\n      !data.checks.integrationCheck.imports_ok ? 'integration.imports' : null,\n      !data.checks.integrationCheck.api_ok ? 'integration.api' : null,\n      !data.checks.performanceCheck.size_ok ? 'performance.size' : null,\n      !data.checks.performanceCheck.complexity_ok ? 'performance.complexity' : null\n    ].filter(Boolean),\n    issues_count: data.issues?.length || 0,\n    decision: data.decision\n  },\n  \n  model_usage: {\n    opus_calls: opusCalls,\n    sonnet_calls: sonnetCalls,\n    haiku_calls: haikuCalls,\n    total_calls: opusCalls + sonnetCalls + haikuCalls,\n    breakdown: {\n      tasks: tasksByModel,\n      roles: {\n        claude_a_decompose: 'sonnet',\n        claude_b_execute: 'dynamic (opus/sonnet/haiku)',\n        claude_c_quality: 'sonnet',\n        claude_d_docs: 'haiku'\n      }\n    }\n  },\n  \n  workflows_created: data.results.filter(r => r.workflow_id).map(r => r.workflow_id),\n  state_dir: data.state_dir\n};\n\nreturn [{\n  json: {\n    ...data,\n    summary_report: summary\n  }\n}];"
      },
      "id": "code-manage-report",
      "name": "Code - ç®¡ç†æŠ¥å‘Š",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2420,
        160
      ]
    },
    {
      "parameters": {
        "authentication": "privateKey",
        "command": "=# ä¿å­˜ summary.json\nSUMMARY_JSON='{{ JSON.stringify($json.summary_report, null, 2) }}'\necho \"$SUMMARY_JSON\" > {{ $json.state_dir }}/reports/summary.json\necho \"æŠ¥å‘Šå·²ä¿å­˜: {{ $json.state_dir }}/reports/summary.json\"\ncat {{ $json.state_dir }}/reports/summary.json"
      },
      "id": "ssh-save-summary",
      "name": "SSH ä¿å­˜æ‘˜è¦æŠ¥å‘Š",
      "type": "n8n-nodes-base.ssh",
      "typeVersion": 1,
      "position": [
        2600,
        160
      ],
      "credentials": {
        "sshPrivateKey": {
          "id": "vvJsQOZ95sqzemla",
          "name": "VPS SSH Key"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://open.feishu.cn/open-apis/bot/v2/hook/5bde68e0-9879-4a45-88ed-461a88229136",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"msg_type\": \"interactive\",\n  \"card\": {\n    \"header\": {\n      \"title\": {\n        \"tag\": \"plain_text\",\n        \"content\": \"{{ $json.decision === 'PASS' ? 'Workflow ç”Ÿäº§å®Œæˆ' : ($json.decision === 'REWORK' ? 'Workflow ç”Ÿäº§éœ€è¿”å·¥' : 'Workflow ç”Ÿäº§å¤±è´¥') }}\"\n      },\n      \"template\": \"{{ $json.decision === 'PASS' ? 'green' : ($json.decision === 'REWORK' ? 'orange' : 'red') }}\"\n    },\n    \"elements\": [\n      {\n        \"tag\": \"div\",\n        \"text\": {\n          \"tag\": \"lark_md\",\n          \"content\": \"**Run ID**: {{ $json.run_id }}\\n\\n**æ‰§è¡Œæ‘˜è¦**\\n- æ€»ä»»åŠ¡: {{ $json.summary.total }}\\n- æˆåŠŸ: {{ $json.summary.success }}\\n- å¤±è´¥: {{ $json.summary.failed }}\\n- æˆåŠŸç‡: {{ $json.summary.success_rate }}\\n- è¿”å·¥æ¬¡æ•°: {{ $json.rework_count || 0 }}\\n\\n**è´¨æ£€ç»“æœ**\\n- Workflowå­˜åœ¨: {{ $json.checks.hardCheck.all_exist ? 'âœ…' : 'âŒ' }}\\n- ä»£ç è´¨é‡: {{ $json.checks.softCheck.pass ? 'âœ…' : 'âŒ' }}\\n- å®‰å…¨æ‰«æ: {{ $json.checks.securityCheck.pass ? 'âœ…' : 'âŒ' }}\\n- é›†æˆæ£€æŸ¥: {{ ($json.checks.integrationCheck.imports_ok && $json.checks.integrationCheck.api_ok) ? 'âœ…' : 'âš ï¸' }}\\n- æ€§èƒ½æ£€æŸ¥: {{ ($json.checks.performanceCheck.size_ok && $json.checks.performanceCheck.complexity_ok) ? 'âœ…' : 'âš ï¸' }}\\n\\n**å†³ç­–**: {{ $json.decision }}\\n**æ“ä½œ**: {{ $json.action }}{{ $json.rework_exceeded ? '\\nâš ï¸ è¿”å·¥æ¬¡æ•°è¶…é™' : '' }}\"\n        }\n      }\n    ]\n  }\n}",
        "options": {}
      },
      "id": "http-feishu-notify",
      "name": "HTTP - é£ä¹¦é€šçŸ¥",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        2780,
        300
      ]
    },
    {
      "parameters": {
        "jsCode": "// ç”Ÿæˆå®Œæ•´æµæ°´çº¿çŠ¶æ€æŠ¥å‘Š\nconst data = $('Code - ç®¡ç†æŠ¥å‘Š').first().json;\nconst completedAt = new Date().toISOString();\n\n// è®¡ç®—è€—æ—¶\nconst startTime = new Date(data.started_at);\nconst endTime = new Date(completedAt);\nconst durationSec = Math.round((endTime - startTime) / 1000);\nconst durationStr = durationSec >= 60 ? `${Math.floor(durationSec/60)}m ${durationSec%60}s` : `${durationSec}s`;\n\n// çŠ¶æ€ç¬¦å·\nconst S = { ok: 'âœ…', fail: 'âŒ', warn: 'âš ï¸', skip: 'â­ï¸', run: 'ğŸ”„' };\n\n// æµæ°´çº¿å„é˜¶æ®µçŠ¶æ€\nconst pipeline = {\n  '1_æ¥æ”¶PRD': { status: S.ok, detail: `PRDé•¿åº¦: ${data.prd?.length || 0} å­—ç¬¦` },\n  '2_åˆå§‹åŒ–': { status: S.ok, detail: `run_id: ${data.run_id}` },\n  '3_PRDåˆ†è§£': { status: data.summary?.total > 0 ? S.ok : S.fail, detail: `åˆ†è§£å‡º ${data.summary?.total || 0} ä¸ªä»»åŠ¡` },\n  '4_ä»»åŠ¡æ‰§è¡Œ': {\n    status: data.summary?.failed === 0 ? S.ok : (data.summary?.success > 0 ? S.warn : S.fail),\n    detail: `æˆåŠŸ ${data.summary?.success || 0}/${data.summary?.total || 0}ï¼ŒæˆåŠŸç‡ ${data.summary?.success_rate || '0%'}`\n  },\n  '5_è´¨é‡æ£€æŸ¥': {\n    status: data.checks ? (Object.values(data.checks).every(c => c.pass !== false && c.all_exist !== false) ? S.ok : S.warn) : S.skip,\n    detail: [\n      `ç¡¬æ£€æŸ¥: ${data.checks?.hardCheck?.all_exist ? S.ok : S.fail}`,\n      `è½¯æ£€æŸ¥: ${data.checks?.softCheck?.pass ? S.ok : S.fail}`,\n      `å®‰å…¨: ${data.checks?.securityCheck?.pass ? S.ok : S.fail}`,\n      `é›†æˆ: ${(data.checks?.integrationCheck?.imports_ok && data.checks?.integrationCheck?.api_ok) ? S.ok : S.warn}`,\n      `æ€§èƒ½: ${(data.checks?.performanceCheck?.size_ok && data.checks?.performanceCheck?.complexity_ok) ? S.ok : S.warn}`\n    ].join(' | ')\n  },\n  '6_å†³ç­–': {\n    status: data.decision === 'PASS' ? S.ok : (data.decision === 'REWORK' ? S.warn : S.fail),\n    detail: `${data.decision} - ${data.action}`\n  },\n  '7_è¿”å·¥': {\n    status: (data.rework_count || 0) === 0 ? S.skip : ((data.rework_count || 0) <= 2 ? S.warn : S.fail),\n    detail: `è¿”å·¥ ${data.rework_count || 0}/2 æ¬¡${data.rework_exceeded ? ' (è¶…é™)' : ''}`\n  },\n  '8_æ–‡æ¡£ç”Ÿæˆ': {\n    status: data.decision === 'PASS' ? S.ok : S.skip,\n    detail: data.decision === 'PASS' ? `docs/${data.run_id}.md` : 'è·³è¿‡'\n  },\n  '9_æŠ¥å‘Šä¿å­˜': {\n    status: S.ok,\n    detail: `${data.state_dir}/reports/summary.json`\n  }\n};\n\n// ç®€æ´çš„æ–‡æœ¬æŠ¥å‘Š\nconst textReport = `## AIå·¥å‚-Workflowç”Ÿäº§çº¿ è¿è¡ŒæŠ¥å‘Š\n\n**Run ID**: \\`${data.run_id}\\`\n**å†³ç­–**: ${data.decision === 'PASS' ? 'âœ… é€šè¿‡' : (data.decision === 'REWORK' ? 'âš ï¸ è¿”å·¥' : 'âŒ å¤±è´¥')}\n**è€—æ—¶**: ${durationStr}\n\n### æµæ°´çº¿çŠ¶æ€\n\n| é˜¶æ®µ | çŠ¶æ€ | è¯¦æƒ… |\n|------|------|------|\n${Object.entries(pipeline).map(([k, v]) => `| ${k.replace('_', '. ')} | ${v.status} | ${v.detail} |`).join('\\n')}\n\n### æ‰§è¡Œæ‘˜è¦\n- æ€»ä»»åŠ¡: ${data.summary?.total || 0}\n- æˆåŠŸ: ${data.summary?.success || 0}\n- å¤±è´¥: ${data.summary?.failed || 0}\n- è¿”å·¥: ${data.rework_count || 0} æ¬¡\n\n### äº§å‡º\n- Workflows: ${data.results?.filter(r => r.workflow_id).map(r => r.workflow_id).join(', ') || 'æ— '}\n- æ–‡æ¡£: ${data.state_dir}/docs/\n- æŠ¥å‘Š: ${data.state_dir}/reports/summary.json\n`;\n\nreturn [{\n  json: {\n    run_id: data.run_id,\n    decision: data.decision,\n    status: data.decision === 'PASS' ? 'success' : (data.decision === 'REWORK' ? 'needs_rework' : 'failed'),\n    duration: durationStr,\n    pipeline,\n    summary: data.summary,\n    workflows_created: data.results?.filter(r => r.workflow_id).map(r => r.workflow_id) || [],\n    issues_count: data.issues?.length || 0,\n    rework_count: data.rework_count || 0,\n    state_dir: data.state_dir,\n    text_report: textReport,\n    completed_at: completedAt\n  }\n}];"
      },
      "id": "code-response",
      "name": "Code - ç”Ÿæˆæµæ°´çº¿æŠ¥å‘Š",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2960,
        300
      ]
    },
    {
      "parameters": {
        "resource": "databasePage",
        "operation": "create",
        "databaseId": {
          "__rl": true,
          "mode": "id",
          "value": "1ff5bb0c-1c78-8082-8cf0-f2cce8f44fc7"
        },
        "propertiesUi": {
          "propertyValues": [
            {
              "key": "title|title",
              "title": "={{ 'Workflowç”Ÿäº§-' + $json.run_id }}"
            },
            {
              "key": "Decision|select",
              "selectValue": "={{ $json.decision }}"
            },
            {
              "key": "Status|select",
              "selectValue": "={{ $json.status }}"
            },
            {
              "key": "Duration|rich_text",
              "textContent": "={{ $json.duration }}"
            },
            {
              "key": "Tasks|rich_text",
              "textContent": "={{ $json.summary.total + 'ä¸ªä»»åŠ¡, æˆåŠŸ' + $json.summary.success + ', å¤±è´¥' + $json.summary.failed }}"
            },
            {
              "key": "Workflows|rich_text",
              "textContent": "={{ $json.workflows_created.join(', ') || 'æ— ' }}"
            }
          ]
        },
        "blockUi": {
          "blockValues": [
            {
              "type": "paragraph",
              "richText": false,
              "textContent": "={{ $json.text_report }}"
            }
          ]
        },
        "options": {}
      },
      "id": "notion-save-report",
      "name": "Notion - ä¿å­˜æŠ¥å‘Š",
      "type": "n8n-nodes-base.notion",
      "typeVersion": 2.2,
      "position": [
        3140,
        300
      ],
      "credentials": {
        "notionApi": {
          "id": "JDYClose2lGSrmxz",
          "name": "Notion account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// è¿”å›æœ€ç»ˆç»“æœï¼ˆwebhookå“åº”ï¼‰\nconst data = $('Code - ç”Ÿæˆæµæ°´çº¿æŠ¥å‘Š').first().json;\nconst notionResult = $input.first().json;\n\nreturn [{\n  json: {\n    ...data,\n    notion_page_id: notionResult.id || null,\n    notion_url: notionResult.url || null\n  }\n}];"
      },
      "id": "code-final-response",
      "name": "è¿”å›ç»“æœ",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3320,
        300
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "is-resume",
              "leftValue": "={{ $json.is_resume }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "true"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "if-is-resume",
      "name": "IF - æ˜¯å¦ç»­è·‘",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        560,
        200
      ]
    },
    {
      "parameters": {
        "authentication": "privateKey",
        "command": "=# åŠ è½½æ–­ç‚¹çŠ¶æ€\nSTATE_FILE={{ $json.state_dir }}/state.json\nWAVES_FILE={{ $json.state_dir }}/waves.json\n\nif [ ! -f \"$STATE_FILE\" ]; then\n  echo '{\"error\": \"state.json ä¸å­˜åœ¨\", \"path\": \"'$STATE_FILE'\"}'\n  exit 1\nfi\n\n# è¯»å–çŠ¶æ€æ–‡ä»¶\nstate=$(cat $STATE_FILE)\nlast_wave=$(echo \"$state\" | jq -r '.last_completed_wave // -1')\nrework_count=$(echo \"$state\" | jq -r '.rework_count // 0')\n\n# è¯»å–æ‰€æœ‰ä»»åŠ¡\nif [ -f \"$WAVES_FILE\" ]; then\n  waves=$(cat $WAVES_FILE)\nelse\n  # ä» tasks ç›®å½•é‡å»º\n  tasks=$(ls {{ $json.state_dir }}/tasks/*.json 2>/dev/null | xargs -I{} cat {} | jq -s '.')\n  waves='{\"waves\": [], \"tasks\": '\"$tasks\"'}'\nfi\n\n# æ‰¾å‡ºéœ€è¦ç»§ç»­æ‰§è¡Œçš„ä»»åŠ¡ï¼ˆpending æˆ– failedï¼‰\npending_tasks=$(find {{ $json.state_dir }}/tasks -name '*.json' -exec sh -c '\n  status=$(jq -r \".status\" \"$1\")\n  if [ \"$status\" = \"pending\" ] || [ \"$status\" = \"executing\" ] || [ \"$status\" = \"failed\" ]; then\n    cat \"$1\"\n  fi\n' _ {} \\; | jq -s '.')\n\necho '{\"last_completed_wave\": '\"$last_wave\"', \"rework_count\": '\"$rework_count\"', \"pending_tasks\": '\"$pending_tasks\"', \"waves\": '\"$waves\"'}'"
      },
      "id": "ssh-load-checkpoint",
      "name": "SSH - åŠ è½½æ–­ç‚¹çŠ¶æ€",
      "type": "n8n-nodes-base.ssh",
      "typeVersion": 1,
      "position": [
        720,
        120
      ],
      "credentials": {
        "sshPrivateKey": {
          "id": "vvJsQOZ95sqzemla",
          "name": "VPS SSH Key"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// è§£ææ–­ç‚¹çŠ¶æ€ï¼Œå‡†å¤‡ä»»åŠ¡åˆ—è¡¨\nconst initData = $('åˆå§‹åŒ–Run').first().json;\nconst sshOutput = $input.first().json;\nconst stdout = sshOutput.stdout || '{}';\n\nlet checkpointData;\ntry {\n  checkpointData = JSON.parse(stdout);\n} catch (e) {\n  return [{ json: { error: 'è§£ææ–­ç‚¹çŠ¶æ€å¤±è´¥', details: e.message, raw: stdout, ...initData } }];\n}\n\nif (checkpointData.error) {\n  return [{ json: { error: checkpointData.error, path: checkpointData.path, ...initData } }];\n}\n\nconst pendingTasks = checkpointData.pending_tasks || [];\nconst lastWave = checkpointData.last_completed_wave || -1;\nconst reworkCount = checkpointData.rework_count || 0;\n\nif (pendingTasks.length === 0) {\n  return [{ json: { error: 'æ²¡æœ‰å¾…æ‰§è¡Œçš„ä»»åŠ¡', last_wave: lastWave, ...initData } }];\n}\n\n// è½¬æ¢ä¸ºæ‰§è¡Œæ ¼å¼\nconst tasksToExecute = pendingTasks.map((task, index) => ({\n  json: {\n    id: task.task_id || `task_${index}`,\n    name: task.name || task.task_name || `ä»»åŠ¡ ${index}`,\n    description: task.description || '',\n    depends_on: task.depends_on || [],\n    nodes_expected: task.nodes_expected || [],\n    waveIndex: task.waveIndex || lastWave + 1,\n    totalWaves: task.totalWaves || lastWave + 2,\n    ...initData,\n    rework_count: reworkCount,\n    is_checkpoint_resume: true,\n    last_completed_wave: lastWave\n  }\n}));\n\nreturn tasksToExecute;"
      },
      "id": "code-parse-checkpoint",
      "name": "Code - è§£ææ–­ç‚¹çŠ¶æ€",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        900,
        120
      ]
    },
    {
      "parameters": {
        "authentication": "privateKey",
        "command": "=# ä¿å­˜ waves ä¿¡æ¯å’Œæ‰§è¡Œè®¡åˆ’ï¼ˆç”¨äºæ–­ç‚¹ç»­è·‘å’Œä»»åŠ¡è¿½è¸ªï¼‰\nWAVES_FILE={{ $json.state_dir }}/waves.json\nPLAN_FILE={{ $json.state_dir }}/plan.json\n\n# ä¿å­˜ waves æ•°æ®\nWAVE_DATA='{{ JSON.stringify($json._waveData) }}'\n\nif [ ! -z \"$WAVE_DATA\" ] && [ \"$WAVE_DATA\" != \"null\" ]; then\n  echo \"$WAVE_DATA\" > $WAVES_FILE\n  echo \"Waves ä¿¡æ¯å·²ä¿å­˜: $WAVES_FILE\"\nelse\n  echo \"è­¦å‘Š: æ²¡æœ‰ wave æ•°æ®\"\nfi\n\n# ä¿å­˜æ‰§è¡Œè®¡åˆ’\nPLAN_DATA='{{ JSON.stringify($json._executionPlan) }}'\n\nif [ ! -z \"$PLAN_DATA\" ] && [ \"$PLAN_DATA\" != \"null\" ]; then\n  echo \"$PLAN_DATA\" > $PLAN_FILE\n  echo \"æ‰§è¡Œè®¡åˆ’å·²ä¿å­˜: $PLAN_FILE\"\n  \n  # è¾“å‡ºè®¡åˆ’æ‘˜è¦\n  echo \"---\"\n  echo \"æ€»ä»»åŠ¡æ•°: $(echo \"$PLAN_DATA\" | jq -r '.summary.total_tasks // 0')\"\n  echo \"æ€»æ³¢æ¬¡æ•°: $(echo \"$PLAN_DATA\" | jq -r '.summary.total_waves // 0')\"\n  echo \"é¢„è®¡æ—¶é•¿: $(echo \"$PLAN_DATA\" | jq -r '.summary.estimated_total_minutes // 0') åˆ†é’Ÿ\"\n  echo \"æ¨¡å‹åˆ†é… - Opus: $(echo \"$PLAN_DATA\" | jq -r '.summary.model_distribution.opus // 0'), Sonnet: $(echo \"$PLAN_DATA\" | jq -r '.summary.model_distribution.sonnet // 0'), Haiku: $(echo \"$PLAN_DATA\" | jq -r '.summary.model_distribution.haiku // 0')\"\nelse\n  echo \"è­¦å‘Š: æ²¡æœ‰æ‰§è¡Œè®¡åˆ’æ•°æ®\"\nfi"
      },
      "id": "ssh-save-waves",
      "name": "SSH ä¿å­˜ Waves",
      "type": "n8n-nodes-base.ssh",
      "typeVersion": 1,
      "position": [
        1020,
        300
      ],
      "credentials": {
        "sshPrivateKey": {
          "id": "vvJsQOZ95sqzemla",
          "name": "VPS SSH Key"
        }
      }
    }
  ],
  "connections": {
    "æ¥æ”¶PRD": {
      "main": [
        [
          {
            "node": "åˆå§‹åŒ–Run",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "åˆå§‹åŒ–Run": {
      "main": [
        [
          {
            "node": "IF - æ˜¯å¦ç»­è·‘",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "SSH åˆå§‹åŒ–çŠ¶æ€ç›®å½•": {
      "main": [
        [
          {
            "node": "SSH Claude A - åˆ†è§£PRD",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "SSH Claude A - åˆ†è§£PRD": {
      "main": [
        [
          {
            "node": "Code - æ‹“æ‰‘æ’åº",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code - æ‹“æ‰‘æ’åº": {
      "main": [
        [
          {
            "node": "SSH ä¿å­˜ Waves",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "SplitInBatches - ä»»åŠ¡åˆ†æ‰¹": {
      "main": [
        [
          {
            "node": "SSH Claude B - æ‰§è¡Œä»»åŠ¡",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Code - åˆå¹¶ç»“æœ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "SSH Claude B - æ‰§è¡Œä»»åŠ¡": {
      "main": [
        [
          {
            "node": "SplitInBatches - ä»»åŠ¡åˆ†æ‰¹",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code - åˆå¹¶ç»“æœ": {
      "main": [
        [
          {
            "node": "SSH Bash - ç¡¬æ£€æŸ¥",
            "type": "main",
            "index": 0
          },
          {
            "node": "SSH Claude C - è½¯æ£€æŸ¥",
            "type": "main",
            "index": 0
          },
          {
            "node": "SSH Bash - å®‰å…¨æ‰«æ",
            "type": "main",
            "index": 0
          },
          {
            "node": "SSH Bash - é›†æˆæ£€æŸ¥",
            "type": "main",
            "index": 0
          },
          {
            "node": "SSH Bash - æ€§èƒ½æ£€æŸ¥",
            "type": "main",
            "index": 0
          },
          {
            "node": "SSH Bash - Gitæ£€æŸ¥",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "SSH Bash - ç¡¬æ£€æŸ¥": {
      "main": [
        [
          {
            "node": "Code - å†³ç­–",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "SSH Claude C - è½¯æ£€æŸ¥": {
      "main": [
        [
          {
            "node": "Code - å†³ç­–",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "SSH Bash - å®‰å…¨æ‰«æ": {
      "main": [
        [
          {
            "node": "Code - å†³ç­–",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "SSH Bash - é›†æˆæ£€æŸ¥": {
      "main": [
        [
          {
            "node": "Code - å†³ç­–",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "SSH Bash - æ€§èƒ½æ£€æŸ¥": {
      "main": [
        [
          {
            "node": "Code - å†³ç­–",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "SSH Bash - Gitæ£€æŸ¥": {
      "main": [
        [
          {
            "node": "Code - å†³ç­–",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code - å†³ç­–": {
      "main": [
        [
          {
            "node": "Switch - å†³ç­–åˆ†æ”¯",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch - å†³ç­–åˆ†æ”¯": {
      "main": [
        [
          {
            "node": "SSH Claude D - ç”Ÿæˆæ–‡æ¡£",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Code - æ£€æŸ¥è¿”å·¥æ¬¡æ•°",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "SSH æ›´æ–°çŠ¶æ€(FAIL)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "SSH Claude D - ç”Ÿæˆæ–‡æ¡£": {
      "main": [
        [
          {
            "node": "Code - ç®¡ç†æŠ¥å‘Š",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code - æ£€æŸ¥è¿”å·¥æ¬¡æ•°": {
      "main": [
        [
          {
            "node": "IF - æ˜¯å¦å¯è¿”å·¥",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF - æ˜¯å¦å¯è¿”å·¥": {
      "main": [
        [
          {
            "node": "Code - æ„å»ºè¿”å·¥è®¡åˆ’",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "SSH æ›´æ–°çŠ¶æ€(è¶…é™)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code - æ„å»ºè¿”å·¥è®¡åˆ’": {
      "main": [
        [
          {
            "node": "SSH - æ‰§è¡Œè¿”å·¥",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "SSH - æ‰§è¡Œè¿”å·¥": {
      "main": [
        [
          {
            "node": "Code - è§£æè¿”å·¥ç»“æœ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code - è§£æè¿”å·¥ç»“æœ": {
      "main": [
        [
          {
            "node": "Code - åˆå¹¶ç»“æœ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "SSH æ›´æ–°çŠ¶æ€(FAIL)": {
      "main": [
        [
          {
            "node": "HTTP - é£ä¹¦é€šçŸ¥",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "SSH æ›´æ–°çŠ¶æ€(è¶…é™)": {
      "main": [
        [
          {
            "node": "HTTP - é£ä¹¦é€šçŸ¥",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code - ç®¡ç†æŠ¥å‘Š": {
      "main": [
        [
          {
            "node": "SSH ä¿å­˜æ‘˜è¦æŠ¥å‘Š",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "SSH ä¿å­˜æ‘˜è¦æŠ¥å‘Š": {
      "main": [
        [
          {
            "node": "HTTP - é£ä¹¦é€šçŸ¥",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP - é£ä¹¦é€šçŸ¥": {
      "main": [
        [
          {
            "node": "Code - ç”Ÿæˆæµæ°´çº¿æŠ¥å‘Š",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code - ç”Ÿæˆæµæ°´çº¿æŠ¥å‘Š": {
      "main": [
        [
          {
            "node": "Notion - ä¿å­˜æŠ¥å‘Š",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Notion - ä¿å­˜æŠ¥å‘Š": {
      "main": [
        [
          {
            "node": "è¿”å›ç»“æœ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF - æ˜¯å¦ç»­è·‘": {
      "main": [
        [
          {
            "node": "SSH - åŠ è½½æ–­ç‚¹çŠ¶æ€",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "SSH åˆå§‹åŒ–çŠ¶æ€ç›®å½•",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "SSH - åŠ è½½æ–­ç‚¹çŠ¶æ€": {
      "main": [
        [
          {
            "node": "Code - è§£ææ–­ç‚¹çŠ¶æ€",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code - è§£ææ–­ç‚¹çŠ¶æ€": {
      "main": [
        [
          {
            "node": "SplitInBatches - ä»»åŠ¡åˆ†æ‰¹",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "SSH ä¿å­˜ Waves": {
      "main": [
        [
          {
            "node": "SplitInBatches - ä»»åŠ¡åˆ†æ‰¹",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1",
    "saveManualExecutions": true,
    "callerPolicy": "workflowsFromSameOwner"
  }
}
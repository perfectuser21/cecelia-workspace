{
  "name": "AIå·¥å‚-åŸºåº§ç”Ÿäº§çº¿",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "codebase-factory",
        "responseMode": "lastNode",
        "options": {}
      },
      "id": "webhook-trigger",
      "name": "æ¥æ”¶PRD",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [240, 300]
    },
    {
      "parameters": {
        "authentication": "privateKey",
        "command": "cd {{ $json.projectPath || '/home/xx/dev/n8n-social-media-scraper' }} && claude -p 'ä½ æ˜¯æ¶æ„å¸ˆã€‚åˆ†æä»¥ä¸‹PRDï¼Œå°†å…¶åˆ†è§£ä¸ºå¯æ‰§è¡Œçš„ä»»åŠ¡åˆ—è¡¨ã€‚è¿”å›JSONæ ¼å¼ï¼š{\"tasks\": [{\"id\": \"task-1\", \"name\": \"ä»»åŠ¡å\", \"description\": \"è¯¦ç»†æè¿°\", \"depends_on\": [], \"files_expected\": [\"file1.ts\"], \"complexity\": \"low|medium|high\"}]}ã€‚\n\nPRDå†…å®¹ï¼š\n{{ $json.prd }}' --model sonnet --allowedTools \"Read,Write,Edit,Glob,Grep,Bash\" 2>&1"
      },
      "id": "claude-a-decompose",
      "name": "SSH Claude A - åˆ†è§£PRD",
      "type": "n8n-nodes-base.ssh",
      "typeVersion": 1,
      "position": [460, 300],
      "credentials": {
        "sshPrivateKey": {
          "id": "vvJsQOZ95sqzemla",
          "name": "VPS SSH"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// æ‹“æ‰‘æ’åºï¼šæŠŠä»»åŠ¡æŒ‰ä¾èµ–å…³ç³»æ’æˆæ³¢æ¬¡\nconst items = $input.all();\nconst rawOutput = items[0].json.stdout || items[0].json;\n\n// æå– JSONï¼ˆClaude å¯èƒ½è¿”å›å¸¦ markdown çš„ï¼‰\nlet tasksData;\ntry {\n  const jsonMatch = rawOutput.match(/\\{[\\s\\S]*\"tasks\"[\\s\\S]*\\}/m);\n  if (jsonMatch) {\n    tasksData = JSON.parse(jsonMatch[0]);\n  } else {\n    tasksData = JSON.parse(rawOutput);\n  }\n} catch (e) {\n  return [{ json: { error: 'æ— æ³•è§£æä»»åŠ¡åˆ—è¡¨', raw: rawOutput } }];\n}\n\nconst tasks = tasksData.tasks || [];\nif (tasks.length === 0) {\n  return [{ json: { error: 'ä»»åŠ¡åˆ—è¡¨ä¸ºç©º' } }];\n}\n\n// æ‹“æ‰‘æ’åº\nconst taskMap = new Map(tasks.map(t => [t.id, t]));\nconst waves = [];\nconst completed = new Set();\n\nwhile (completed.size < tasks.length) {\n  const wave = [];\n  \n  for (const task of tasks) {\n    if (completed.has(task.id)) continue;\n    \n    const deps = task.depends_on || [];\n    const depsReady = deps.every(depId => completed.has(depId));\n    \n    if (depsReady) {\n      wave.push(task);\n    }\n  }\n  \n  if (wave.length === 0) {\n    return [{ json: { error: 'æ£€æµ‹åˆ°å¾ªç¯ä¾èµ–', completed: Array.from(completed) } }];\n  }\n  \n  waves.push(wave);\n  wave.forEach(t => completed.add(t.id));\n}\n\n// è¿”å›æ‰å¹³åŒ–çš„ä»»åŠ¡åˆ—è¡¨ï¼Œæ¯ä¸ªä»»åŠ¡å¸¦ waveIndex\nconst sortedTasks = [];\nwaves.forEach((wave, waveIndex) => {\n  wave.forEach(task => {\n    sortedTasks.push({\n      ...task,\n      waveIndex,\n      totalWaves: waves.length,\n      projectPath: items[0].json.projectPath || '/home/xx/dev/n8n-social-media-scraper'\n    });\n  });\n});\n\nreturn sortedTasks.map(task => ({ json: task }));"
      },
      "id": "code-topology-sort",
      "name": "Code - æ‹“æ‰‘æ’åº",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [680, 300]
    },
    {
      "parameters": {
        "batchSize": 1,
        "options": {}
      },
      "id": "split-batches",
      "name": "SplitInBatches",
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [900, 300]
    },
    {
      "parameters": {
        "authentication": "privateKey",
        "command": "cd {{ $json.projectPath }} && claude -p 'ä½ æ˜¯å¼€å‘å·¥ç¨‹å¸ˆã€‚æ‰§è¡Œä»¥ä¸‹ä»»åŠ¡ï¼š\n\nä»»åŠ¡ID: {{ $json.id }}\nä»»åŠ¡å: {{ $json.name }}\næè¿°: {{ $json.description }}\né¢„æœŸæ–‡ä»¶: {{ $json.files_expected.join(\", \") }}\n\nè¦æ±‚ï¼š\n1. åˆ›å»º/ä¿®æ”¹å¿…è¦çš„ä»£ç æ–‡ä»¶\n2. ç¡®ä¿ä»£ç ç¬¦åˆTypeScriptæœ€ä½³å®è·µ\n3. æ·»åŠ å¿…è¦çš„ç±»å‹å®šä¹‰å’Œé”™è¯¯å¤„ç†\n4. å®Œæˆåè¾“å‡ºï¼šTASK_COMPLETE|{{ $json.id }}|æ–‡ä»¶åˆ—è¡¨' --model sonnet --allowedTools \"Read,Write,Edit,Glob,Grep,Bash\" 2>&1"
      },
      "id": "claude-b-execute",
      "name": "SSH Claude B - æ‰§è¡Œä»»åŠ¡",
      "type": "n8n-nodes-base.ssh",
      "typeVersion": 1,
      "position": [1120, 300],
      "credentials": {
        "sshPrivateKey": {
          "id": "vvJsQOZ95sqzemla",
          "name": "VPS SSH"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// åˆå¹¶æ‰€æœ‰ä»»åŠ¡çš„æ‰§è¡Œç»“æœ\nconst items = $input.all();\nconst results = [];\nconst errors = [];\n\nfor (const item of items) {\n  const stdout = item.json.stdout || '';\n  const stderr = item.json.stderr || '';\n  \n  // æ£€æŸ¥ä»»åŠ¡å®Œæˆæ ‡è®°\n  if (stdout.includes('TASK_COMPLETE')) {\n    const match = stdout.match(/TASK_COMPLETE\\|(\\S+)\\|(.+)/);\n    if (match) {\n      results.push({\n        taskId: match[1],\n        status: 'success',\n        files: match[2].split(',').map(f => f.trim()),\n        output: stdout\n      });\n    }\n  } else if (stderr || stdout.includes('error') || stdout.includes('Error')) {\n    errors.push({\n      taskId: item.json.id,\n      status: 'failed',\n      error: stderr || stdout,\n      task: item.json\n    });\n  } else {\n    results.push({\n      taskId: item.json.id,\n      status: 'completed',\n      output: stdout\n    });\n  }\n}\n\nconst projectPath = items[0]?.json?.projectPath || '/home/xx/dev/n8n-social-media-scraper';\n\nreturn [{\n  json: {\n    totalTasks: items.length,\n    successCount: results.length,\n    errorCount: errors.length,\n    results,\n    errors,\n    projectPath,\n    timestamp: new Date().toISOString()\n  }\n}];"
      },
      "id": "code-merge-results",
      "name": "Code - åˆå¹¶ç»“æœ",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1340, 300]
    },
    {
      "parameters": {
        "authentication": "privateKey",
        "command": "cd {{ $json.projectPath }} && (\n  echo '=== æ–‡ä»¶æ£€æŸ¥ ==='\n  for file in $(echo '{{ $json.results.map(r => r.files).flat().join(\" \") }}'); do\n    if [ -f \"$file\" ]; then\n      echo \"âœ“ $file\"\n    else\n      echo \"âœ— Missing: $file\"\n    fi\n  done\n  \n  echo ''\n  echo '=== TypeScript è¯­æ³•æ£€æŸ¥ ==='\n  if command -v npx &> /dev/null; then\n    npx tsc --noEmit --skipLibCheck 2>&1 | head -20\n  else\n    echo 'TypeScript æœªå®‰è£…ï¼Œè·³è¿‡'\n  fi\n)"
      },
      "id": "bash-hard-check",
      "name": "SSH Bash - ç¡¬æ£€æŸ¥",
      "type": "n8n-nodes-base.ssh",
      "typeVersion": 1,
      "position": [1560, 180],
      "credentials": {
        "sshPrivateKey": {
          "id": "vvJsQOZ95sqzemla",
          "name": "VPS SSH"
        }
      }
    },
    {
      "parameters": {
        "authentication": "privateKey",
        "command": "cd {{ $json.projectPath }} && claude -p 'ä½ æ˜¯ä»£ç å®¡æŸ¥å‘˜ã€‚æ£€æŸ¥ä»¥ä¸‹æ–‡ä»¶çš„ä»£ç è´¨é‡ï¼š\n\næ–‡ä»¶åˆ—è¡¨ï¼š\n{{ $json.results.map(r => r.files).flat().join(\"\\n\") }}\n\næ£€æŸ¥ç‚¹ï¼š\n1. ä»£ç å¯è¯»æ€§å’Œå¯ç»´æŠ¤æ€§\n2. é”™è¯¯å¤„ç†æ˜¯å¦å®Œå–„\n3. æ˜¯å¦éµå¾ªæœ€ä½³å®è·µ\n4. æ½œåœ¨çš„æ€§èƒ½é—®é¢˜\n\nè¿”å›æ ¼å¼ï¼š\nQUALITY_CHECK|PASS|å¤‡æ³¨\næˆ–\nQUALITY_CHECK|FAIL|é—®é¢˜åˆ—è¡¨' --model sonnet --allowedTools \"Read,Grep\" 2>&1"
      },
      "id": "claude-c-soft-check",
      "name": "SSH Claude C - è½¯æ£€æŸ¥",
      "type": "n8n-nodes-base.ssh",
      "typeVersion": 1,
      "position": [1560, 300],
      "credentials": {
        "sshPrivateKey": {
          "id": "vvJsQOZ95sqzemla",
          "name": "VPS SSH"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// ç‰ˆæœ¬ä¸€è‡´æ€§æ£€æŸ¥\nconst items = $input.all();\nconst projectPath = items[0].json.projectPath;\n\n// è¿™é‡Œç®€åŒ–ä¸ºæ£€æŸ¥æ˜¯å¦æœ‰ package.json\nconst fs = require('fs');\nconst path = require('path');\n\ntry {\n  // æ³¨æ„ï¼šn8n Code èŠ‚ç‚¹æ— æ³•ç›´æ¥è®¿é—®æ–‡ä»¶ç³»ç»Ÿ\n  // å®é™…åº”è¯¥é€šè¿‡ SSH æ‰§è¡Œ\n  return [{\n    json: {\n      check: 'version-consistency',\n      status: 'skipped',\n      message: 'ç‰ˆæœ¬æ£€æŸ¥éœ€è¦SSHæ‰§è¡Œï¼Œæœ¬èŠ‚ç‚¹ç®€åŒ–å¤„ç†',\n      projectPath\n    }\n  }];\n} catch (e) {\n  return [{\n    json: {\n      check: 'version-consistency',\n      status: 'error',\n      error: e.message\n    }\n  }];\n}"
      },
      "id": "code-version-check",
      "name": "Code - ç‰ˆæœ¬ä¸€è‡´æ€§",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1560, 420]
    },
    {
      "parameters": {
        "authentication": "privateKey",
        "command": "cd {{ $json.projectPath }} && (\n  echo '=== å®‰å…¨æ‰«æ ==='\n  \n  echo 'æ£€æŸ¥ç¡¬ç¼–ç å¯†é’¥...'\n  grep -r -i -E '(password|secret|api[_-]?key|token)\\s*=\\s*[\"'\"'][^\"'\"']+[\"'\"']' --include='*.ts' --include='*.js' . 2>/dev/null | head -10 || echo 'æœªå‘ç°ç¡¬ç¼–ç å¯†é’¥'\n  \n  echo ''\n  echo 'æ£€æŸ¥SQLæ³¨å…¥é£é™©...'\n  grep -r -E 'query\\s*\\([^?]*\\$\\{' --include='*.ts' --include='*.js' . 2>/dev/null | head -10 || echo 'æœªå‘ç°SQLæ³¨å…¥é£é™©'\n  \n  echo ''\n  echo 'æ£€æŸ¥evalä½¿ç”¨...'\n  grep -r 'eval\\s*\\(' --include='*.ts' --include='*.js' . 2>/dev/null | head -10 || echo 'æœªå‘ç°eval'\n)"
      },
      "id": "bash-security-scan",
      "name": "SSH Bash - å®‰å…¨æ‰«æ",
      "type": "n8n-nodes-base.ssh",
      "typeVersion": 1,
      "position": [1560, 540],
      "credentials": {
        "sshPrivateKey": {
          "id": "vvJsQOZ95sqzemla",
          "name": "VPS SSH"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// å†³ç­–ï¼šæ ¹æ®è´¨æ£€ç»“æœå†³å®šé€šè¿‡/è¿”å·¥/å¤±è´¥\nconst items = $input.all();\n\nconst checks = {\n  hardCheck: items.find(i => i.json.stdout && i.json.stdout.includes('æ–‡ä»¶æ£€æŸ¥')),\n  softCheck: items.find(i => i.json.stdout && i.json.stdout.includes('QUALITY_CHECK')),\n  versionCheck: items.find(i => i.json.check === 'version-consistency'),\n  securityScan: items.find(i => i.json.stdout && i.json.stdout.includes('å®‰å…¨æ‰«æ'))\n};\n\nconst issues = [];\n\n// ç¡¬æ£€æŸ¥\nif (checks.hardCheck) {\n  const stdout = checks.hardCheck.json.stdout;\n  if (stdout.includes('âœ— Missing')) {\n    issues.push({ severity: 'critical', type: 'hardCheck', message: 'ç¼ºå¤±å¿…éœ€æ–‡ä»¶' });\n  }\n  if (stdout.includes('error TS')) {\n    issues.push({ severity: 'high', type: 'hardCheck', message: 'TypeScript ç¼–è¯‘é”™è¯¯' });\n  }\n}\n\n// è½¯æ£€æŸ¥\nif (checks.softCheck) {\n  const stdout = checks.softCheck.json.stdout;\n  if (stdout.includes('QUALITY_CHECK|FAIL')) {\n    issues.push({ severity: 'medium', type: 'softCheck', message: 'ä»£ç è´¨é‡é—®é¢˜' });\n  }\n}\n\n// å®‰å…¨æ‰«æ\nif (checks.securityScan) {\n  const stdout = checks.securityScan.json.stdout;\n  if (!stdout.includes('æœªå‘ç°ç¡¬ç¼–ç å¯†é’¥') && stdout.match(/password|secret|api[_-]?key/i)) {\n    issues.push({ severity: 'critical', type: 'security', message: 'å‘ç°ç¡¬ç¼–ç å¯†é’¥' });\n  }\n  if (!stdout.includes('æœªå‘ç°SQLæ³¨å…¥é£é™©') && stdout.includes('query')) {\n    issues.push({ severity: 'high', type: 'security', message: 'SQLæ³¨å…¥é£é™©' });\n  }\n}\n\n// å†³ç­–é€»è¾‘\nconst criticalIssues = issues.filter(i => i.severity === 'critical');\nconst highIssues = issues.filter(i => i.severity === 'high');\n\nlet decision, action;\n\nif (criticalIssues.length > 0) {\n  decision = 'FAIL';\n  action = 'æµç¨‹ç»ˆæ­¢ï¼Œéœ€è¦äººå·¥ä»‹å…¥';\n} else if (highIssues.length > 2) {\n  decision = 'REWORK';\n  action = 'è¿”å·¥ä¿®å¤ä¸¥é‡é—®é¢˜';\n} else if (issues.length > 5) {\n  decision = 'REWORK';\n  action = 'é—®é¢˜è¿‡å¤šï¼Œéœ€è¦è¿”å·¥';\n} else {\n  decision = 'PASS';\n  action = 'è´¨æ£€é€šè¿‡ï¼Œè¿›å…¥æ–‡æ¡£ç”Ÿæˆ';\n}\n\n// è·å–åŸå§‹åˆå¹¶ç»“æœ\nconst mergeResult = $('Code - åˆå¹¶ç»“æœ').first().json;\n\nreturn [{\n  json: {\n    decision,\n    action,\n    issues,\n    summary: {\n      critical: criticalIssues.length,\n      high: highIssues.length,\n      medium: issues.filter(i => i.severity === 'medium').length,\n      total: issues.length\n    },\n    checks: {\n      hardCheck: checks.hardCheck ? 'completed' : 'missing',\n      softCheck: checks.softCheck ? 'completed' : 'missing',\n      versionCheck: checks.versionCheck ? 'completed' : 'missing',\n      securityScan: checks.securityScan ? 'completed' : 'missing'\n    },\n    originalResult: mergeResult,\n    timestamp: new Date().toISOString()\n  }\n}];"
      },
      "id": "code-decision",
      "name": "Code - å†³ç­–",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1780, 300]
    },
    {
      "parameters": {
        "authentication": "privateKey",
        "command": "cd {{ $json.originalResult.projectPath }} && claude -p 'ä½ æ˜¯æŠ€æœ¯æ–‡æ¡£å·¥ç¨‹å¸ˆã€‚ä¸ºæœ¬æ¬¡ä»£ç ç”Ÿæˆåˆ›å»ºæ–‡æ¡£ï¼š\n\nä»»åŠ¡å®Œæˆæƒ…å†µï¼š\n{{ JSON.stringify($json.originalResult.results, null, 2) }}\n\nè´¨æ£€ç»“æœï¼š\nå†³ç­–ï¼š{{ $json.decision }}\né—®é¢˜æ±‡æ€»ï¼š{{ JSON.stringify($json.summary, null, 2) }}\n\nç”Ÿæˆä»¥ä¸‹æ–‡æ¡£ï¼š\n1. æ›´æ–° README.mdï¼ˆå¦‚æœä¸å­˜åœ¨åˆ™åˆ›å»ºï¼‰\n2. æ·»åŠ  CHANGELOG.md æ¡ç›®\n3. å¦‚æœæœ‰æ–°å¢ APIï¼Œç”Ÿæˆ API.md\n\nå®Œæˆåè¾“å‡ºï¼šDOCS_COMPLETE' --model sonnet --allowedTools \"Read,Write,Edit,Glob\" 2>&1"
      },
      "id": "claude-d-docs",
      "name": "SSH Claude D - æ–‡æ¡£ç”Ÿæˆ",
      "type": "n8n-nodes-base.ssh",
      "typeVersion": 1,
      "position": [2000, 300],
      "credentials": {
        "sshPrivateKey": {
          "id": "vvJsQOZ95sqzemla",
          "name": "VPS SSH"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://open.feishu.cn/open-apis/bot/v2/hook/5bde68e0-9879-4a-88ed-461a88229136",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "msg_type",
              "value": "text"
            },
            {
              "name": "content",
              "value": "={\"text\": \"ğŸ­ AIå·¥å‚ç”Ÿäº§çº¿æŠ¥å‘Š\\n\\nå†³ç­–ï¼š\" + $json.decision + \"\\næ“ä½œï¼š\" + $json.action + \"\\n\\né—®é¢˜æ±‡æ€»ï¼š\\nä¸¥é‡ï¼š\" + $json.summary.critical + \" ä¸ª\\né«˜å±ï¼š\" + $json.summary.high + \" ä¸ª\\nä¸­ç­‰ï¼š\" + $json.summary.medium + \" ä¸ª\\n\\nä»»åŠ¡æ€»æ•°ï¼š\" + $json.originalResult.totalTasks + \"\\næˆåŠŸï¼š\" + $json.originalResult.successCount + \"\\nå¤±è´¥ï¼š\" + $json.originalResult.errorCount + \"\\n\\næ—¶é—´ï¼š\" + $json.timestamp + \"\"}"
            }
          ]
        },
        "options": {}
      },
      "id": "http-feishu-notify",
      "name": "HTTP - é£ä¹¦é€šçŸ¥",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [2220, 300]
    }
  ],
  "connections": {
    "æ¥æ”¶PRD": {
      "main": [
        [
          {
            "node": "SSH Claude A - åˆ†è§£PRD",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "SSH Claude A - åˆ†è§£PRD": {
      "main": [
        [
          {
            "node": "Code - æ‹“æ‰‘æ’åº",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code - æ‹“æ‰‘æ’åº": {
      "main": [
        [
          {
            "node": "SplitInBatches",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "SplitInBatches": {
      "main": [
        [
          {
            "node": "SSH Claude B - æ‰§è¡Œä»»åŠ¡",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "SSH Claude B - æ‰§è¡Œä»»åŠ¡": {
      "main": [
        [
          {
            "node": "Code - åˆå¹¶ç»“æœ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code - åˆå¹¶ç»“æœ": {
      "main": [
        [
          {
            "node": "SSH Bash - ç¡¬æ£€æŸ¥",
            "type": "main",
            "index": 0
          },
          {
            "node": "SSH Claude C - è½¯æ£€æŸ¥",
            "type": "main",
            "index": 0
          },
          {
            "node": "Code - ç‰ˆæœ¬ä¸€è‡´æ€§",
            "type": "main",
            "index": 0
          },
          {
            "node": "SSH Bash - å®‰å…¨æ‰«æ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "SSH Bash - ç¡¬æ£€æŸ¥": {
      "main": [
        [
          {
            "node": "Code - å†³ç­–",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "SSH Claude C - è½¯æ£€æŸ¥": {
      "main": [
        [
          {
            "node": "Code - å†³ç­–",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code - ç‰ˆæœ¬ä¸€è‡´æ€§": {
      "main": [
        [
          {
            "node": "Code - å†³ç­–",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "SSH Bash - å®‰å…¨æ‰«æ": {
      "main": [
        [
          {
            "node": "Code - å†³ç­–",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code - å†³ç­–": {
      "main": [
        [
          {
            "node": "SSH Claude D - æ–‡æ¡£ç”Ÿæˆ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "SSH Claude D - æ–‡æ¡£ç”Ÿæˆ": {
      "main": [
        [
          {
            "node": "HTTP - é£ä¹¦é€šçŸ¥",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  }
}

# Git Auto-Branch Management

## 概述

AI工厂 Workflow生产线现已集成自动 Git 分支管理功能，解决了痛点 #13（Git混乱）。

## 功能特性

### 1. 自动分支创建
- 每次执行自动创建工作分支: `factory/{RUN_ID}`
- 从当前分支分叉，保护主分支不受直接修改
- 支持续跑场景（如果分支已存在则切换）

### 2. 规范化提交
- 自动生成结构化提交信息
- 包含 Run ID、PRD 摘要、质检结果
- 提交前自动 `git add .`

### 3. 状态追踪
- 所有 Git 操作记录到 `$STATE_DIR/git_operations.json`
- 包含分支信息、提交哈希、时间戳等
- 集成到摘要报告中

## 使用方法

### 启用 Git 管理（默认）

```bash
bash /home/xx/bin/workflow-factory.sh \
  --run-id "run_$(date +%s)" \
  --prd "你的 PRD 内容"
```

### 禁用 Git 管理

使用 `--no-git` 参数跳过所有 Git 操作：

```bash
bash /home/xx/bin/workflow-factory.sh \
  --run-id "run_$(date +%s)" \
  --prd "你的 PRD 内容" \
  --no-git
```

## Git 工作流程

### 1. 初始化阶段（`init_run()` → `init_git_branch()`）

```
检查是否为 git 仓库
    ↓
获取当前分支（original_branch）
    ↓
创建工作分支: factory/{RUN_ID}
    ↓
记录 Git 状态到 git_operations.json
```

#### git_operations.json 结构（初始化后）

```json
{
  "git_enabled": true,
  "branch_name": "factory/run_1703123456",
  "original_branch": "main",
  "created_at": "2025-12-25T10:30:00+08:00",
  "commit_before": "abc123def456",
  "branch_created": true
}
```

### 2. 提交阶段（`commit_changes()`）

在所有任务完成、质检通过后自动调用：

```
检查是否有变更（git status --porcelain）
    ↓
生成提交信息（包含 PRD、Run ID、质检结果）
    ↓
git add .
    ↓
git commit -m "..."
    ↓
更新 git_operations.json（commit_hash、committed_at）
```

#### 提交信息格式

```
[AI Factory] {PRD 前 60 字}

Run ID: run_1703123456
Generated by: AI工厂-Workflow生产线
Date: 2025-12-25T10:35:00+08:00

Changes:
- 3 files modified

Quality Checks:
- Hard Check: true
- Soft Check: true
- Security: true
```

#### git_operations.json 结构（提交后）

```json
{
  "git_enabled": true,
  "branch_name": "factory/run_1703123456",
  "original_branch": "main",
  "created_at": "2025-12-25T10:30:00+08:00",
  "commit_before": "abc123def456",
  "branch_created": true,
  "committed": true,
  "commit_hash": "def789ghi012",
  "commit_message": "创建新的数据清洗 workflow",
  "committed_at": "2025-12-25T10:35:00+08:00"
}
```

### 3. 清理阶段（`cleanup_git_branch()`，可选）

目前未自动调用，保留分支供手动合并：

```bash
# 手动合并工作分支
cd /home/xx/dev/zenithjoy-autopilot/workflows
git checkout main
git merge factory/run_1703123456

# 合并后删除工作分支
git branch -d factory/run_1703123456
```

## 集成到摘要报告

`git_operations.json` 内容自动包含在 `summary.json` 中：

```json
{
  "run_id": "run_1703123456",
  "prd": "...",
  "tasks": { ... },
  "cost": { ... },
  "qc": { ... },
  "git": {
    "git_enabled": true,
    "branch_name": "factory/run_1703123456",
    "original_branch": "main",
    "committed": true,
    "commit_hash": "def789ghi012",
    "commit_message": "创建新的数据清洗 workflow",
    "committed_at": "2025-12-25T10:35:00+08:00"
  }
}
```

## 错误处理

### 场景 1：不在 Git 仓库中

```json
{
  "git_enabled": false,
  "reason": "not_a_git_repo"
}
```

脚本继续执行，不影响主流程。

### 场景 2：无法创建分支

```json
{
  "git_enabled": true,
  "branch_created": false,
  "error": "create_failed"
}
```

脚本继续执行，但不会进行后续提交操作。

### 场景 3：没有变更需要提交

```json
{
  "git_enabled": true,
  "branch_name": "factory/run_1703123456",
  "committed": false,
  "reason": "no_changes"
}
```

这是正常情况（例如所有操作都通过 n8n API 完成，本地文件无变更）。

### 场景 4：提交失败

```json
{
  "git_enabled": true,
  "branch_name": "factory/run_1703123456",
  "committed": false,
  "error": "commit_failed"
}
```

检查 Git 配置、权限或冲突。

## 质检集成

Git 状态检查集成到第 6 路质检（`qc/git.json`）：

```json
{
  "check": "git",
  "branch_ok": true,          // false if on main/master
  "uncommitted": 0,            // 未提交文件数量
  "version_ok": true
}
```

如果当前在受保护分支（main/master）上工作，`branch_ok` 会标记为 `false`，但不会阻止执行。

## 安全保护

### 1. 受保护分支检测
- 检测是否在 `main` 或 `master` 分支
- 记录警告但不阻止执行
- 在质检中标记 `branch_ok: false`

### 2. 非 Git 仓库保护
- 自动检测是否为 Git 仓库
- 非 Git 仓库时优雅降级，不报错

### 3. 提交前检查
- 检查是否有实际变更
- 避免空提交

## 最佳实践

### 1. 手动合并策略

```bash
# 检查工作分支
cd /home/xx/dev/zenithjoy-autopilot/workflows
git branch | grep factory/

# 查看分支变更
git log factory/run_1703123456 --oneline

# 合并到主分支
git checkout main
git merge factory/run_1703123456

# 清理已合并分支
git branch -d factory/run_1703123456
```

### 2. 批量清理旧分支

```bash
# 列出所有 factory/ 分支
git branch | grep factory/

# 删除已合并的分支
git branch --merged | grep factory/ | xargs git branch -d

# 强制删除未合并的分支（谨慎使用）
git branch | grep factory/ | xargs git branch -D
```

### 3. 查看 Git 操作历史

```bash
# 查看特定 run 的 Git 操作
jq '.' /home/xx/data/runs/run_1703123456/git_operations.json

# 查看所有 run 的 Git 状态
for dir in /home/xx/data/runs/*/; do
  if [[ -f "$dir/git_operations.json" ]]; then
    echo "=== $(basename $dir) ==="
    jq '{committed, commit_hash, branch_name}' "$dir/git_operations.json"
  fi
done
```

## 配置参数

| 参数 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| `--no-git` | flag | false | 禁用 Git 操作 |

## 文件路径

| 文件 | 路径 | 说明 |
|------|------|------|
| 主脚本 | `/home/xx/bin/workflow-factory.sh` | 包含 Git 管理函数 |
| 状态文件 | `$STATE_DIR/git_operations.json` | 记录 Git 操作状态 |
| 工作目录 | `/home/xx/dev/zenithjoy-autopilot/workflows` | Git 仓库根目录 |

## 函数说明

### `init_git_branch()`

**调用时机**: `init_run()` 结束时

**功能**:
1. 检查是否为 Git 仓库
2. 获取当前分支
3. 创建工作分支 `factory/{RUN_ID}`
4. 记录初始状态到 `git_operations.json`

**返回值**:
- `0`: 成功或优雅降级
- `1`: 严重错误（分支创建失败）

### `commit_changes()`

**调用时机**: 主流程完成后，`generate_summary()` 之前

**功能**:
1. 检查是否有变更
2. 生成规范化提交信息
3. 执行 `git add .` 和 `git commit`
4. 更新 `git_operations.json`

**返回值**:
- `0`: 成功或无变更
- `1`: 提交失败

### `cleanup_git_branch()`

**调用时机**: 手动调用（目前未集成到主流程）

**功能**:
1. 切换回原始分支
2. 记录合并命令到 `git_operations.json`
3. 保留工作分支供手动合并

## 故障排查

### 问题 1: 提交失败

**症状**: `git_operations.json` 显示 `"error": "commit_failed"`

**排查步骤**:
1. 检查 Git 配置:
   ```bash
   git config user.name
   git config user.email
   ```
2. 检查工作区状态:
   ```bash
   cd /home/xx/dev/zenithjoy-autopilot/workflows
   git status
   ```
3. 检查是否有冲突:
   ```bash
   git diff
   ```

### 问题 2: 分支创建失败

**症状**: `git_operations.json` 显示 `"error": "create_failed"`

**排查步骤**:
1. 检查是否已存在同名分支:
   ```bash
   git branch | grep factory/{RUN_ID}
   ```
2. 检查 Git 权限:
   ```bash
   ls -la /home/xx/dev/zenithjoy-autopilot/workflows/.git
   ```

### 问题 3: Git 操作被跳过

**症状**: `git_operations.json` 显示 `"git_enabled": false`

**原因**:
- 使用了 `--no-git` 参数
- 不在 Git 仓库中（`"reason": "not_a_git_repo"`）

**解决**:
- 移除 `--no-git` 参数
- 确保在 Git 仓库目录中执行

## 更新日志

- **2025-12-25**: 初始版本
  - 实现自动分支创建
  - 实现规范化提交
  - 集成到质检和摘要报告
  - 添加 `--no-git` 参数

## 下一步计划

1. **自动合并**: 质检通过后自动合并到主分支
2. **冲突处理**: 检测并处理 Git 冲突
3. **推送到远程**: 支持自动推送到 remote
4. **分支清理**: 自动清理已合并的旧分支
5. **Git Hooks**: 集成 pre-commit 和 post-commit hooks

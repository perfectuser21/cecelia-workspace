# Git 分支规范

## 分支策略

```
main (稳定版本)
  │
  └── develop (开发分支)
        │
        ├── feature/{task_id} (任务分支 - Claude Code 使用)
        ├── feature/{task_id}
        └── feature/{task_id}
```

---

## 分支说明

| 分支 | 用途 | 谁创建 | 谁合并 |
|------|------|--------|--------|
| main | 稳定版本，随时可部署 | - | 人工 |
| develop | 开发分支，集成测试 | - | 人工 |
| feature/{task_id} | 单个任务的工作分支 | Claude Code | 人工 |

---

## Claude Code 的 Git 操作

### 任务开始时（prepare.sh）

```bash
# 1. 确保 Git 状态干净
git status --porcelain
# 如果有未提交的更改，报错退出

# 2. 切换到 develop 并拉取最新
git checkout develop
git pull origin develop

# 3. 创建任务分支
git checkout -b feature/{task_id}
```

### 任务完成时（cleanup.sh）

```bash
# 1. 添加所有更改
git add .

# 2. 提交（带任务信息）
git commit -m "feat({task_id}): {task_name}

Task: {notion_url}
Run ID: {run_id}
Quality Score: {score}/100

Generated by AI Factory v2"

# 3. 推送到远程
git push origin feature/{task_id}
```

### 返工时

```bash
# 在同一分支上继续工作
# commit 消息带 [retry-N] 标记

git add .
git commit -m "fix({task_id}): [retry-1] 修复质检问题

- 修复了 xxx
- 调整了 yyy"
```

---

## 分支命名规范

### feature 分支

```
feature/{task_id}

# 示例
feature/abc123def456          # Notion page ID
feature/1fb0ec1cc75b482b      # 取 ID 前 16 位也可以
```

### 其他分支（人工创建）

```
hotfix/{issue}                # 紧急修复
release/{version}             # 发布分支
```

---

## Commit 消息规范

### 格式

```
<type>(<scope>): <subject>

<body>

<footer>
```

### Type

| Type | 用途 |
|------|------|
| feat | 新功能 |
| fix | Bug 修复 |
| refactor | 重构 |
| docs | 文档 |
| test | 测试 |
| chore | 杂项 |

### 示例

```
feat(n8n): 创建抖音数据抓取 Workflow

- 添加 Schedule Trigger 每小时触发
- 添加 SSH 节点执行抓取脚本
- 添加飞书通知节点

Task: https://notion.so/xxx
Run ID: 20251227-abc123
Quality Score: 85/100

Generated by AI Factory v2
```

---

## 合并冲突处理

### Claude Code 的处理方式

Claude Code **不自动解决合并冲突**。

在质检阶段检查冲突：

```bash
# 尝试合并 develop（只检查，不真正合并）
git merge --no-commit --no-ff develop

if [ $? -ne 0 ]; then
  # 有冲突，中止合并
  git merge --abort

  # 报告冲突，标记为需人工处理
  echo "合并冲突，需要人工处理"
  exit 2  # 返回码 2 = 需人工处理
fi

# 没有冲突，清理
git merge --abort
```

### 人工合并流程

当 Claude Code 完成任务后：

1. 任务状态变为 `Waiting`
2. 人工 Review 代码
3. 人工在本地执行合并：

```bash
git checkout develop
git pull origin develop
git merge feature/{task_id}
git push origin develop

# 可选：删除 feature 分支
git branch -d feature/{task_id}
git push origin --delete feature/{task_id}
```

---

## 并发控制

### 问题

Git 工作目录只有一个，如果多个任务同时执行：
- 任务 A 在 `feature/task-1` 工作
- 任务 B 想创建 `feature/task-2`
- checkout 会互相影响

### 解决方案

使用**锁机制**确保同一时间只有一个任务操作 Git：

```bash
# prepare.sh 获取锁
acquire_lock "/home/xx/.locks/claude-factory.lock"

# ... 执行任务 ...

# cleanup.sh 释放锁
release_lock "/home/xx/.locks/claude-factory.lock"
```

### 未来优化

如果需要并行执行，可以使用 `git worktree`：

```bash
# 为每个任务创建独立的工作目录
git worktree add /home/xx/data/worktrees/{task_id} -b feature/{task_id}

# 任务完成后清理
git worktree remove /home/xx/data/worktrees/{task_id}
```

但目前阶段使用锁机制即可。

---

## 保护规则

### main 分支

- 禁止直接 push
- 只能通过 PR 合并
- 需要人工 Review

### develop 分支

- 禁止 Claude Code 直接 push
- Claude Code 只能 push 到 feature 分支
- 人工合并 feature 到 develop

### feature 分支

- Claude Code 可以 push
- 命名必须符合 `feature/{task_id}` 格式

---

## 常见场景

### 场景 1：正常执行

```
1. prepare.sh: checkout develop → 创建 feature/xxx
2. execute.sh: 开发代码
3. quality-check.sh: 检查质量
4. cleanup.sh: commit → push feature/xxx
5. 人工: merge feature/xxx → develop
```

### 场景 2：需要返工

```
1. prepare.sh: checkout develop → 创建 feature/xxx
2. execute.sh: 开发代码
3. quality-check.sh: 失败 → 返工
4. execute.sh: 修复代码
5. quality-check.sh: 通过
6. cleanup.sh: commit [retry-1] → push
```

### 场景 3：需要人工处理

```
1. prepare.sh: checkout develop → 创建 feature/xxx
2. execute.sh: 开发代码
3. quality-check.sh: 失败 → 返工 2 次仍失败
4. cleanup.sh: 标记为需人工处理 → 飞书通知
5. 人工: 查看问题 → 手动修复或取消任务
```

### 场景 4：Git 状态不干净

```
1. prepare.sh: 检查 Git 状态 → 发现未提交更改
2. 报错退出，不自动 stash
3. 飞书通知：需要人工清理 Git 状态
```

---

## 更新记录

| 日期 | 变更 |
|------|------|
| 2025-12-27 | 初始创建：定义分支策略、命名规范、冲突处理 |

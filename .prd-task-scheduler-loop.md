---
id: prd-task-scheduler-loop
version: 1.0.0
created: 2026-01-28
updated: 2026-01-28
changelog:
  - 1.0.0: Initial PRD for Task Scheduler Loop
---

# PRD: Task Scheduler Loop（任务调度循环）

## OKR 目标

**让 Cecelia 自动处理任务，系统不再沉默**

### 关键结果

1. N8N 每 5 分钟自动检查待处理任务
2. 按优先级 P0 > P1 > P2 排序
3. 自动调用 Cecelia 执行最高优先级任务
4. 任务完成后自动更新状态

## 系统架构

```
┌─────────────────────────────────────────────────────────┐
│  N8N Scheduler Workflow (每 5 分钟)                      │
│                                                          │
│  1. 查询待处理任务                                        │
│     GET /api/tasks/tasks?status=queued                   │
│                    ↓                                     │
│  2. 按优先级排序                                          │
│     P0 → P1 → P2                                         │
│                    ↓                                     │
│  3. 调用 Cecelia 执行                                     │
│     POST /api/panorama/execute                           │
│                    ↓                                     │
│  4. 等待完成，更新状态                                    │
│     PATCH /api/tasks/tasks/:id                           │
│                    ↓                                     │
│  5. 循环继续                                              │
└─────────────────────────────────────────────────────────┘
```

## 需求

### 1. N8N Workflow: Task Scheduler

**触发**: Schedule Trigger (每 5 分钟)

**步骤**:

1. **HTTP Request**: 获取 queued 任务
   ```
   GET http://localhost:5212/api/tasks/tasks?status=queued
   ```

2. **Code Node**: 排序 + 选择最高优先级
   ```javascript
   const tasks = $input.all();
   const sorted = tasks.sort((a, b) => {
     const priority = { P0: 0, P1: 1, P2: 2 };
     return priority[a.priority] - priority[b.priority];
   });
   return sorted.length > 0 ? [sorted[0]] : [];
   ```

3. **IF Node**: 有任务？
   - Yes → 继续执行
   - No → 结束

4. **HTTP Request**: 更新状态为 in_progress
   ```
   PATCH http://localhost:5212/api/tasks/tasks/:id
   { "status": "in_progress" }
   ```

5. **HTTP Request**: 调用 Cecelia 执行
   ```
   POST http://localhost:5230/execute
   { "task_id": "...", "prd_content": "..." }
   ```

6. **Wait Node**: 等待执行完成（或设置超时）

7. **HTTP Request**: 更新状态为 completed/failed
   ```
   PATCH http://localhost:5212/api/tasks/tasks/:id
   { "status": "completed" }
   ```

### 2. API 更新

- [ ] GET /api/tasks/tasks 支持 ?status=queued 过滤
- [ ] PATCH /api/tasks/tasks/:id 支持更新 status

### 3. Cecelia Executor 更新

- [ ] 支持从 task 数据启动执行
- [ ] 执行完成后回调更新状态

## 验收标准

- [ ] N8N Workflow 创建成功
- [ ] 每 5 分钟自动检查任务
- [ ] P0 任务优先被执行
- [ ] 任务状态自动更新
- [ ] 日志可追踪

## 测试方法

1. 创建一个 P0 任务
2. 等待 5 分钟
3. 确认任务被自动执行
4. 确认状态变为 completed

---
id: prd-organ-unification
version: 2.0.0
created: 2026-01-30
updated: 2026-01-30
changelog:
  - 2.0.0: 重写 - 基于代码实际分析，修正迁移对象
  - 1.0.0: 初始版本
---

# PRD: Cecelia 器官统一重构（v2.0）

## 背景

经过全量资产盘点 + 代码深度分析，发现原诊断需要修正：

### 原诊断（部分错误）

| 诊断 | 实际情况 |
|------|---------|
| cecelia-quality 的 orchestrator/ 是"非法掌权的脑" | ❌ 错误 - 这是 **QA 编排器**（qa-run.sh），专门执行测试，不是通用调度 |
| cecelia-quality 的 control-plane/ 是决策层 | ❌ 错误 - 这是 **QA 配置中心**（repo-registry.yaml），不是系统控制 |
| autumnrice 应该迁移到 workflows | ❌ 错误 - autumnrice 是**管家/调度器**（决策层），不是执行层 |

### 修正后诊断

**真正的"多脑"问题**：

```
cecelia-workspace (proxy 入口)
    │
    └──▶ cecelia-semantic-brain (真正的大脑)
         ├── orchestrator_routes.py  ← 核心决策：Chat/Voice/Realtime
         ├── state_routes.py         ← 核心状态：Focus/Tick/Actions
         └── src/autumnrice/         ← 核心引擎：TRD→Task→Run
```

问题不是"有多个脑"，而是：
1. **控制权在外面**：workspace 只是 proxy，真正逻辑在 semantic-brain
2. **执行能力散落**：skills 分散在多个 repo

---

## 器官定义（修正版）

| 器官 | 职责 | 唯一归属 | 当前状态 |
|------|------|----------|---------|
| 器官1 | 入口与面板 | cecelia-workspace/apps/dashboard | ✅ 正确 |
| 器官2 | 路由与聚合 | cecelia-workspace/apps/core | ⚠️ 需强化（目前只是 proxy） |
| 器官3 | 决策与任务 | cecelia-semantic-brain | ✅ 正确（但 workspace 应该聚合） |
| 器官4 | 记忆与知识 | cecelia-semantic-brain | ✅ 正确 |
| 器官5 | 执行与员工 | cecelia-workflows | ⚠️ 需归一（skills 散落） |
| 器官6 | 质量与免疫 | cecelia-quality | ✅ 正确（不应该动） |

---

## 成功标准

### Phase 1：强化 Workspace 为唯一入口（聚合层）

**目标**：让 workspace 成为系统唯一入口，加入聚合/缓存能力

- [ ] `/api/brain/status` 聚合 semantic-brain + quality + workflows 状态
- [ ] `/api/panorama` 返回完整系统全景（不再只是 VPS 监控）
- [ ] 所有外部调用必须走 workspace，不直接访问 semantic-brain
- [ ] 加入请求日志/审计
- [ ] 验证：从 workspace 可以获取系统所有状态

### Phase 2：执行能力归一（只迁移 Skills）

**目标**：纯执行类代码迁移到 workflows

- [ ] semantic-brain/skills/（如有纯执行 skills）→ workflows/skills/
- [ ] zenithjoy-creator/skills/ → workflows/skills/creator/
- [ ] zenithjoy-engine/n8n/ → workflows/n8n/engine/
- [ ] 验证：所有执行通过 workflows 触发

**不迁移**：
- ❌ src/autumnrice/（调度器，不是执行器）
- ❌ orchestrator_routes.py（决策层）
- ❌ state_routes.py（状态层）

### Phase 3：Quality 保持独立

**目标**：确认 quality 职责清晰，不需要迁移

- [ ] 确认 quality 只做 QA（测试、审计、门禁）
- [ ] 确认 quality 不涉及通用调度
- [ ] 文档化 quality API 使用方式
- [ ] 验证：quality 是独立的质量保障系统

---

## 详细计划

### Phase 1：强化聚合层（本周）

#### 1.1 创建 `/api/system/status` 聚合端点

```typescript
// apps/core/src/system/routes.ts (新建)

GET /api/system/status
Response:
{
  "brain": {
    "health": "ok",
    "focus": { /* from semantic-brain */ },
    "tick": { /* from semantic-brain */ },
    "tasks": { "p0": 2, "p1": 5, "p2": 8 }
  },
  "quality": {
    "health": "ok",
    "queueLength": 3,
    "lastRun": { /* from quality */ }
  },
  "workflows": {
    "health": "ok",
    "activeWorkers": 2,
    "pendingTasks": 5
  },
  "timestamp": "2026-01-30T10:00:00Z"
}
```

#### 1.2 升级 `/api/panorama` 为系统全景

```typescript
// apps/core/src/panorama/routes.ts (修改)

GET /api/panorama/full
Response:
{
  "vps": { /* 原有 VPS 监控 */ },
  "brain": { /* 聚合 semantic-brain */ },
  "quality": { /* 聚合 quality */ },
  "github": { /* 聚合 GitHub */ },
  "services": [
    { "name": "semantic-brain", "port": 5220, "status": "up" },
    { "name": "quality", "port": 5681, "status": "up" },
    { "name": "n8n", "port": 5678, "status": "up" }
  ]
}
```

#### 1.3 添加请求日志中间件

```typescript
// apps/core/src/middleware/audit.ts (新建)

// 记录所有 /api/* 请求到 decision_log 表
// 包括：timestamp, path, method, user, response_status
```

#### 1.4 文档化 API 入口

```
所有外部调用必须走：
  https://dev-core.zenjoymedia.media/api/*

禁止直接访问：
  ❌ localhost:5220 (semantic-brain)
  ❌ localhost:5681 (quality)
  ❌ localhost:5678 (n8n)
```

---

### Phase 2：执行归一（下周）

#### 2.1 迁移纯执行 Skills

```
zenithjoy-creator/skills/          cecelia-workflows
├── luxury-card-generator/  ──────→ skills/creator/luxury-card/
├── batch-analyzer/         ──────→ skills/creator/batch-analyzer/
└── platform-scraper/       ──────→ skills/creator/scraper/

zenithjoy-engine/n8n/              cecelia-workflows
└── workflows/              ──────→ n8n/engine/
```

#### 2.2 更新调用路径

```bash
# 旧路径（兼容 2 周）
~/.claude/skills/luxury-card-generator/

# 新路径
cecelia-workflows/skills/creator/luxury-card/

# 使用 symlink 兼容
ln -s cecelia-workflows/skills/creator/luxury-card ~/.claude/skills/luxury-card-generator
```

#### 2.3 不迁移的代码（明确标注）

```
semantic-brain/src/autumnrice/     ← 保留（调度器）
semantic-brain/orchestrator_routes.py ← 保留（决策层）
semantic-brain/state_routes.py     ← 保留（状态层）
```

---

### Phase 3：Quality 独立确认（后续）

#### 3.1 Quality 职责边界

```
cecelia-quality 只做：
├── QA 配置（control-plane/）
│   ├── repo-registry.yaml  - 哪些 repo 需要质检
│   └── qa-policy.yaml      - 质检策略
│
├── QA 编排（orchestrator/）
│   ├── qa-run.sh          - 执行 L1/L2A/RCI
│   └── qa-run-all.sh      - 全量质检
│
├── QA 队列（gateway/ + queue/）
│   └── 任务入队和执行
│
└── QA 状态（state/）
    └── 质检结果和统计

Quality 不做：
❌ 通用任务调度
❌ 系统状态管理
❌ 决策/编排
```

#### 3.2 API 使用文档

```bash
# Quality API (port 5681)
GET  /api/state      - QA 系统状态
GET  /api/queue      - QA 队列
GET  /api/runs       - QA 运行记录
POST /api/enqueue    - 提交 QA 任务

# 通过 workspace 访问
curl https://dev-core.zenjoymedia.media/api/quality/state
```

---

## 风险与缓解

| 风险 | 缓解措施 |
|------|----------|
| 聚合层增加延迟 | 加入缓存（Redis/内存），30秒 TTL |
| 外部服务不可用 | 聚合端点返回降级数据，标注 unavailable |
| Skills 迁移破坏现有调用 | symlink 兼容 2 周 |

---

## 验收测试

### Phase 1 验收

```bash
# 1. 聚合端点工作
curl http://localhost:5212/api/system/status | jq
# 应该返回 brain + quality + workflows 状态

# 2. Panorama 返回完整全景
curl http://localhost:5212/api/panorama/full | jq
# 应该包含所有子系统状态

# 3. 请求被记录
psql -c "SELECT * FROM decision_log ORDER BY created_at DESC LIMIT 5"
# 应该看到最近的 API 调用记录
```

### Phase 2 验收

```bash
# 1. Skills 在 workflows
ls cecelia-workflows/skills/
# 应该包含: creator/, ...

# 2. 旧路径仍可用（symlink）
ls -la ~/.claude/skills/luxury-card-generator
# 应该指向 workflows

# 3. Skills 执行正常
/luxury-card-generator test
```

### Phase 3 验收

```bash
# 1. Quality 独立运行
curl http://localhost:5681/api/health
# 应该返回 healthy

# 2. QA 任务可提交
curl -X POST http://localhost:5680/add -d '{"intent":"runQA"}'

# 3. 通过 workspace 可访问
curl http://localhost:5212/api/quality/state
```

---

## 目标架构图（修正版）

```
┌─────────────────────────────────────────────────────────────────┐
│              cecelia-workspace (唯一入口)                        │
│                                                                 │
│  ┌─────────────────┐  ┌─────────────────────────────────────┐   │
│  │ 器官1: Dashboard │  │ 器官2: Core (聚合层)                │   │
│  │                 │  │                                     │   │
│  │ - Console       │  │ /api/system/status  → 聚合所有状态  │   │
│  │ - Ops Panel     │  │ /api/panorama/full  → 系统全景      │   │
│  │                 │  │ /api/brain/*        → proxy brain   │   │
│  │                 │  │ /api/quality/*      → proxy quality │   │
│  │                 │  │ /api/tasks/*        → 原生任务系统  │   │
│  └─────────────────┘  └─────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
                                │
          ┌─────────────────────┼─────────────────────┐
          ▼                     ▼                     ▼
┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐
│ 器官3+4: Brain   │  │ 器官5: Workflows │  │ 器官6: Quality   │
│ semantic-brain   │  │                  │  │                  │
│                  │  │ - n8n/           │  │ - QA 配置        │
│ - orchestrator   │  │ - staff/         │  │ - QA 编排        │
│ - state          │  │ - skills/        │  │ - QA 队列        │
│ - autumnrice     │  │   ├── creator/   │  │ - QA 状态        │
│ - memory         │  │   └── ...        │  │                  │
│                  │  │ - evidence/      │  │ (独立运行)       │
│ (决策+记忆)      │  │ (执行+证据)      │  │ (质量保障)       │
└──────────────────┘  └──────────────────┘  └──────────────────┘
```

---

## 与原 PRD 的差异

| 项目 | 原 PRD | 修正版 |
|------|--------|--------|
| quality 的 control-plane/ | 迁移到 workspace | ❌ 不迁移（QA 配置） |
| quality 的 orchestrator/ | 迁移到 workspace | ❌ 不迁移（QA 编排器） |
| quality 的 gateway/ | 迁移到 workspace | ❌ 不迁移（QA 入队） |
| quality 的 queue/ | 迁移到 workspace | ❌ 不迁移（QA 队列） |
| quality 的 state/ | 迁移到 workspace | ❌ 不迁移（QA 状态） |
| brain 的 orchestrator_routes | 迁移到 workspace | ❌ 保留（通过 proxy 访问） |
| brain 的 state_routes | 迁移到 workspace | ❌ 保留（通过 proxy 访问） |
| autumnrice | 迁移到 workflows | ❌ 保留在 brain（调度器不是执行器） |
| workspace 定位 | 迁入所有代码 | ✅ 做聚合层，不物理迁移 |

---

## 执行命令

开始 Phase 1：

```bash
cd /home/xx/dev/cecelia-workspace
git checkout -b cp-organ-unification-v2
```

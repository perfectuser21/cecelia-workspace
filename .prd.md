# PRD: PR Plans Frontend Phase 2 - Enhanced Features

## 背景

Phase 1 已完成基础 UI（PR #295）：
- ✅ Initiative Detail 页面
- ✅ PR Plans 列表显示
- ✅ 依赖关系文本显示
- ✅ 状态图标和进度条

Phase 2 增强用户体验和交互性。

## 功能清单

### 🎨 Feature 1: 依赖关系图可视化

**优先级**: P1 - 高价值，直观展示依赖链

**描述**: 使用图形化方式展示 PR Plans 之间的依赖关系。

**技术方案**:
- 使用 **React Flow** (更轻量) 或 D3.js
- 或使用简单的 SVG 自绘（控制力强）

**UI 设计**:
```
┌─────────────────────────────────────┐
│ Dependency Graph              [∨]   │  ← 可折叠
├─────────────────────────────────────┤
│                                      │
│   [PR Plan 1]                        │
│        ↓                             │
│   [PR Plan 2] ───→ [PR Plan 4]      │
│        ↓                             │
│   [PR Plan 3]                        │
│                                      │
└─────────────────────────────────────┘
```

**Node 样式**:
- Completed: 绿色边框
- In Progress: 蓝色边框 + 动画
- Planning: 灰色边框
- Blocked: 黄色边框 + 虚线

**交互**:
- 点击节点 → 高亮该节点和依赖链
- 悬停 → 显示 DoD tooltip

**预估工作量**: 2-3 小时

---

### 🔄 Feature 2: 实时状态更新

**优先级**: P2 - 有用但非必需

**描述**: 通过 WebSocket 实时同步 PR Plans 状态变化。

**技术方案**:
- 订阅 Brain WebSocket: `ws://localhost:5221/ws`
- 监听 `pr_plan_update` 事件
- 自动更新 UI（无需刷新）

**实现**:
```typescript
// In InitiativeDetail.tsx
useEffect(() => {
  const ws = new WebSocket('ws://localhost:5221/ws');

  ws.onmessage = (event) => {
    const data = JSON.parse(event.data);
    if (data.type === 'pr_plan_update') {
      // Update local state
      updatePRPlan(data.pr_plan);
    }
  };

  return () => ws.close();
}, []);
```

**用户体验**:
- 其他用户/Brain 更新状态时，自动同步
- 进度条实时更新
- 状态变化有动画过渡

**预估工作量**: 1-2 小时

---

### ✏️ Feature 3: 编辑 PR Plan 状态

**优先级**: P1 - 用户需要手动控制

**描述**: 允许用户手动更新 PR Plan 状态（planning → in_progress → completed）。

**UI 设计**:

在 PR Plan Card 上添加下拉菜单：
```
┌─────────────────────────────────────┐
│ #2 OAuth Integration        [⋮]     │ ← 菜单按钮
│ 🚧 large | In Progress               │
│                                      │
│ 菜单展开：                            │
│  ✓ Mark as Completed                │
│  ⏸️ Change to Planning               │
│  ❌ Cancel                           │
└─────────────────────────────────────┘
```

**API 调用**:
```typescript
// PUT /api/brain/pr-plans/:id
await updatePRPlanStatus(prPlanId, 'completed');
```

**验证逻辑**:
- 不能跳过状态（planning → completed）
- 如果有依赖未完成，不能标记为 in_progress
- 确认对话框

**预估工作量**: 2 小时

---

### 🔗 Feature 4: 链接到 Tasks 视图

**优先级**: P2 - 便利功能

**描述**: 从 PR Plan 卡片直接跳转到关联的 Tasks 列表。

**UI 设计**:
```
┌─────────────────────────────────────┐
│ #2 OAuth Integration                │
│ 🚧 large | In Progress               │
│ Tasks: 1/3  [View Tasks →]          │ ← 点击查看
└─────────────────────────────────────┘
```

**跳转逻辑**:
```typescript
// 跳转到 Tasks 页面并过滤
navigate(`/planning/tasks?pr_plan_id=${prPlan.id}`);
```

**Tasks 页面修改**:
- 添加 `pr_plan_id` 过滤参数
- 高亮来自 PR Plan 的 Tasks
- 显示面包屑：Initiative → PR Plan → Tasks

**预估工作量**: 1-2 小时

---

### 📁 Feature 5: 文件列表显示

**优先级**: P3 - 锦上添花

**描述**: 显示 PR Plan 关联的文件列表。

**UI 设计**:
```
┌─────────────────────────────────────┐
│ #2 OAuth Integration                │
│ 🚧 large | In Progress               │
│                                      │
│ 📁 Files (3):                        │
│  - src/auth/oauth.ts                │
│  - src/auth/providers/google.ts     │
│  - src/auth/providers/github.ts     │
└─────────────────────────────────────┘
```

**数据来源**:
- PR Plans 表的 `files` 字段（已存在）

**交互**:
- 点击文件名 → 在 VS Code 中打开（使用 `vscode://file/...`）
- 或在 GitHub 中查看

**预估工作量**: 1 小时

---

### 🎯 Feature 6: 快速操作按钮

**优先级**: P2 - 提升效率

**描述**: 在 Initiative Detail 页面添加快速操作。

**UI 设计**:
```
┌─────────────────────────────────────┐
│ User Authentication System          │
│                                      │
│ [+ Create PR Plan]  [🔄 Refresh]    │
│ [📊 View Graph]     [📋 Export]     │
└─────────────────────────────────────┘
```

**操作**:
- **Create PR Plan**: 打开创建表单
- **Refresh**: 刷新数据
- **View Graph**: 切换到依赖图视图
- **Export**: 导出 PR Plans 为 Markdown/JSON

**预估工作量**: 2-3 小时

---

## 推荐实施顺序

### 🥇 最小可行产品 (MVP)
**预估总时间**: 3-4 小时

1. **Feature 3: 编辑状态** (2h) - 最实用
2. **Feature 4: 链接到 Tasks** (1.5h) - 工作流连贯性
3. **Feature 5: 文件列表** (1h) - 简单且有用

### 🥈 完整体验
**预估总时间**: 6-8 小时

4. **Feature 1: 依赖图** (2.5h) - 可视化增强
5. **Feature 2: 实时更新** (1.5h) - 锦上添花

### 🥉 高级功能
**预估总时间**: 10+ 小时

6. **Feature 6: 快速操作** (3h) - 完整工具集
7. **其他增强**:
   - 批量操作
   - 历史记录
   - 评论系统

---

## 技术依赖

### 新增 npm 包（可选）

```json
{
  "dependencies": {
    "reactflow": "^11.10.0",  // Feature 1: 依赖图
    "d3": "^7.8.5"              // 或使用 D3（更灵活）
  }
}
```

如果使用简单 SVG 自绘，则无需新增依赖。

### Brain API 更新（如需要）

Feature 3 需要 Brain 支持更新 PR Plan 状态：

```javascript
// Brain: routes.js
app.put('/api/brain/pr-plans/:id', async (req, res) => {
  const { id } = req.params;
  const { status } = req.body;

  // 验证状态转换
  // 更新数据库
  // 广播 WebSocket 事件（Feature 2）
});
```

---

## 选择建议

**如果时间有限（1-2 小时）**:
→ 只做 Feature 3 (编辑状态) + Feature 5 (文件列表)

**如果想要完整体验（4-6 小时）**:
→ Feature 3 + 4 + 5 + 1 (编辑 + 链接 + 文件 + 依赖图)

**如果追求完美（8+ 小时）**:
→ 全部实现

---

## 下一步

请选择你想实现的功能：

1. **快速 MVP** (Feature 3 + 5，约 3 小时)
2. **完整体验** (Feature 1 + 3 + 4，约 6 小时)
3. **自定义** (告诉我你想要哪些功能)

我会根据你的选择开始实现。

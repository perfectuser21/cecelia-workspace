---
id: prd-kr2-prd-trd-validation
version: 1.1.0
created: 2026-01-31
updated: 2026-01-31
changelog:
  - 1.0.0: 初始版本
  - 1.1.0: 补充验证规则细节、API 返回格式、错误处理行为、测试用例清单
---

## PRD - PRD/TRD 验证与标准化增强

**需求来源**: Brain 自动调度 - KR2: PRD/TRD 自动生成（标准化），progress 0%。当前模板引擎可以生成 PRD/TRD，但没有验证层确保生成结果符合标准。

**功能描述**:

为 `apps/core/src/brain/templates.js` 添加两个验证函数和对应 API 端点：

### 1. validatePrd(content: string)

通过文本匹配检查 PRD 内容是否包含必需字段：
- 必需字段（匹配 `**需求来源**` 或 `## 需求来源` 等标记）：`需求来源`、`功能描述`、`成功标准`
- 推荐字段（缺少时产生 warning）：`非目标`、`涉及文件`
- 返回格式：`{ valid: boolean, errors: string[], warnings: string[] }`
- 验证失败不阻止生成，仅返回结果

### 2. validateTrd(content: string)

检查 TRD 是否包含 TRD_TEMPLATE 中 `required: true` 的 section：
- 必需 section（匹配 `## 技术背景` 等标题）：技术背景、架构设计、API 设计、数据模型、测试策略
- 推荐 section：实施计划
- 返回格式：`{ valid: boolean, errors: string[], warnings: string[] }`

### 3. API 端点

- `POST /api/brain/validate/prd` — body: `{ content: string }` → 200: `{ valid, errors, warnings }`
- `POST /api/brain/validate/trd` — body: `{ content: string }` → 200: `{ valid, errors, warnings }`
- 缺少 content 参数时返回 400

### 4. Planner 集成

在 `planner.js` 的 `generateTaskPRD()` 函数中，PRD 生成后调用 `validatePrd()`，将结果写入 `console.log`（`[PRD-VALIDATE] valid=true/false errors=[...]`）。验证失败不阻止流程，仅记录。

**涉及文件**:
- `apps/core/src/brain/templates.js` — 添加 validatePrd, validateTrd 并 export
- `apps/core/src/brain/routes.js` — 添加两个 validate 端点
- `apps/core/src/brain/planner.js` — generateTaskPRD() 末尾添加验证调用
- `apps/core/src/brain/__tests__/templates.test.js` — 新增测试

**成功标准**:
- [ ] `validatePrd("## 功能描述\nxxx")` 返回 `{ valid: false, errors: ['缺少必需字段: 需求来源', '缺少必需字段: 成功标准'], warnings: ['缺少推荐字段: 非目标', '缺少推荐字段: 涉及文件'] }`
- [ ] `validatePrd(renderPrd(...))` 对 renderPrd 生成的完整 PRD 返回 `{ valid: true, errors: [], warnings: [] }`
- [ ] `validateTrd("## 技术背景\n...")` 对仅有部分 section 的 TRD 返回对应缺少 section 的 errors
- [ ] `validateTrd(renderTrd(...))` 对完整 TRD 返回 `{ valid: true, errors: [], warnings: [] }`
- [ ] `POST /api/brain/validate/prd` 带 `{ content: "..." }` 返回 HTTP 200 + `{ valid, errors, warnings }`
- [ ] `POST /api/brain/validate/trd` 带 `{ content: "..." }` 返回 HTTP 200 + `{ valid, errors, warnings }`
- [ ] `POST /api/brain/validate/prd` 不带 content 返回 HTTP 400
- [ ] planner generateTaskPRD() 生成 PRD 后日志输出 `[PRD-VALIDATE]`
- [ ] 测试用例覆盖：validatePrd 空内容、部分字段、完整内容；validateTrd 空内容、缺少各 section、完整内容；API 成功/400 响应

**非目标**:
- 不修改现有 PRD/TRD 生成逻辑
- 不添加前端 UI
- 不实现 TRD decomposition
- 不修改数据库 schema
- 不在验证失败时阻止 PRD 生成

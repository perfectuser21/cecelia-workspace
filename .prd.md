---
id: prd-kr2-prd-trd-enhance
version: 1.1.0
created: 2026-01-31
updated: 2026-01-31
changelog:
  - 1.0.0: 初始版本
  - 1.1.0: 补充验证规则、JSON schema、API 规范
---

# PRD - PRD/TRD 自动生成增强：验证强化 + TRD 验证 + JSON 导出

## 背景

**需求来源**: Brain 自动调度，推进 KR2: PRD/TRD 自动生成（标准化），当前进度 0%。

系统已有 PRD/TRD 模板引擎（`templates.js`）、生成端点、基础 PRD 验证（`validatePrd` 只检查 section 存在）。缺口：验证仅检查结构不检查内容质量、TRD 无验证端点、无结构化 JSON 导出。

## 功能描述

### 1. PRD 验证增强

在现有 `validatePrd()` 基础上新增内容质量检查：

**验收标准动词检查**：扫描 acceptance_criteria section 的每个 bullet，检测是否包含操作动词（如"显示"、"返回"、"创建"、"检查"、"支持"、"调用"等）。不含动词的标记为不可测试。

**功能需求充实度**：functional_requirements section 内容长度 ≥ 50 字符。

**目标 section 检查**：objectives section 至少包含 1 个 bullet point（`- ` 开头的行）。

### 2. TRD 验证

新增 `validateTrd(trdContent)` 函数：
- 必需 section：技术背景(technical_background)、架构设计(architecture_design)、测试策略(test_strategy)
- 每个必需 section 内容非空（去除空白后 > 0 字符）
- 返回格式：`{ valid: boolean, errors: string[] }`

**端点**：`POST /api/brain/validate/trd`
- Request: `{ trd_content: string }`
- Response: `{ valid: boolean, errors: string[] }`

### 3. JSON 结构化导出

**`prdToJson(prdContent)`** 返回：
```json
{
  "title": "string",
  "sections": {
    "background": "string",
    "objectives": "string",
    "functional_requirements": "string",
    "non_functional_requirements": "string",
    "acceptance_criteria": "string",
    "milestones": "string"
  }
}
```

**`trdToJson(trdContent)`** 返回：
```json
{
  "title": "string",
  "sections": {
    "technical_background": "string",
    "architecture_design": "string",
    "api_design": "string",
    "data_model": "string",
    "test_strategy": "string"
  }
}
```

**生成端点增强**：
- `POST /api/brain/generate/prd` 支持 body 中 `format: "json"` 参数，返回 JSON 结构
- `POST /api/brain/generate/trd` 同上

## 涉及文件

- `apps/core/src/brain/templates.js` - 增强 validatePrd、新增 validateTrd/prdToJson/trdToJson
- `apps/core/src/brain/routes.js` - 新增 validate/trd 端点、format 参数
- `apps/core/src/brain/__tests__/templates.test.js` - 新增测试

## 成功标准

- [ ] PRD 验证能识别不含动词的验收标准并报错（单元测试验证）
- [ ] PRD 验证能检测功能需求内容 < 50 字符并报错
- [ ] TRD 验证检查 3 个必需 section 存在且非空
- [ ] `POST /api/brain/validate/trd` 返回 `{valid, errors}`
- [ ] `prdToJson()` 将 PRD markdown 解析为含 title 和 sections 的 JSON
- [ ] `trdToJson()` 将 TRD markdown 解析为含 title 和 sections 的 JSON
- [ ] 生成端点传入 `format:"json"` 时返回 JSON 结构而非 markdown
- [ ] 新增至少 10 个单元测试覆盖验证和导出的正常/异常场景

## 非目标

- 不做 PDF/HTML 渲染
- 不做跨 PRD 依赖检测
- 不改现有模板结构
- 不做批量操作
- 不修改 api_design / data_model 为必需 section（保持灵活性）

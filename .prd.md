---
id: prd-kr2-prd-trd-auto-generation
version: 1.0.0
created: 2026-02-01
updated: 2026-02-01
changelog:
  - 1.0.0: 初始版本 - 完善 PRD/TRD 自动生成功能
---

# PRD - KR2: PRD/TRD 自动生成（标准化）

## 需求来源

**Goal**: O1: Cecelia 自驱进化 - 从被动执行器到自驱数字生命体
**KR**: KR2: PRD/TRD 自动生成（标准化） (progress: 0%, priority: P0)
**触发**: Brain 自动调度，任务多次失败需要重试

## 背景

当前 Cecelia 系统已经实现了 PRD/TRD 模板和生成函数（`generatePrdFromGoalKR`, `generateTrdFromGoalKR`），但这个功能可能存在以下问题导致多次任务失败：

1. 生成的文档质量不符合标准
2. 缺少必要的集成测试
3. 文档验证逻辑不够严格
4. 生成流程中可能存在错误处理不当

## 目标

确保 PRD/TRD 自动生成功能完全可用且符合标准：
- 所有模板函数正常工作
- 生成的文档通过验证
- 测试覆盖率达标
- 与 Brain 系统正确集成

## 功能描述

### 当前实现分析

已有的核心功能（在 `apps/core/src/brain/templates.js`）：
- `generatePrdFromGoalKR()` - 从 Goal/KR 上下文生成 PRD
- `generateTrdFromGoalKR()` - 从 Goal/KR 上下文生成 TRD
- `validatePrd()` - PRD 文档验证
- `validateTrd()` - TRD 文档验证

已有的集成点（在 `apps/core/src/brain/planner.js`）：
- `generateTaskPRD()` - 生成任务 PRD 文件

### 需要完成的工作

1. **代码审查与修复**
   - 检查现有生成函数的逻辑是否正确
   - 确保所有必需字段都正确生成
   - 修复可能的边界情况错误

2. **验证逻辑强化**
   - 确保 `validatePrd()` 能捕获所有不符合标准的文档
   - 确保 `validateTrd()` 能捕获所有不符合标准的文档
   - 添加更详细的验证错误信息

3. **测试完善**
   - 运行现有测试确保通过
   - 添加缺失的测试用例
   - 测试边界情况和错误处理

4. **文档生成流程**
   - 确保 PRD 生成后自动验证
   - 确保 TRD 生成后自动验证
   - 验证失败时提供清晰的错误信息

## 涉及文件

**核心实现**：
- `apps/core/src/brain/templates.js` - 模板和生成函数
- `apps/core/src/brain/planner.js` - 集成和调用逻辑

**测试文件**：
- `apps/core/src/brain/__tests__/templates.test.js` - 单元测试
- `apps/core/src/brain/__tests__/planner.test.js` - 集成测试

**API 路由**：
- `apps/core/src/brain/routes.js` - Brain API 端点

## 成功标准

- [ ] 所有现有测试通过（`npm test apps/core/src/brain/__tests__/templates.test.js`）
- [ ] `generatePrdFromGoalKR()` 生成的 PRD 通过 `validatePrd()` 验证
- [ ] `generateTrdFromGoalKR()` 生成的 TRD 通过 `validateTrd()` 验证
- [ ] 测试覆盖率达到 80% 以上
- [ ] 代码审计通过，无 L1/L2 级别问题
- [ ] 所有文档生成函数有完整的 JSDoc 注释
- [ ] CI 测试通过

## 非目标

- 不修改文档模板结构（PRD_TEMPLATE, TRD_TEMPLATE）
- 不添加新的文档类型（只处理 PRD 和 TRD）
- 不改变现有 API 接口
- 不修改无关的 Brain 模块

## 验收方式

1. 运行完整测试套件：
   ```bash
   npm test apps/core/src/brain/__tests__/templates.test.js
   npm test apps/core/src/brain/__tests__/planner.test.js
   ```

2. 手动测试生成功能：
   ```bash
   # 测试 PRD 生成
   curl -X POST http://localhost:5212/api/brain/generate-prd \
     -H "Content-Type: application/json" \
     -d '{"title": "测试功能", "description": "测试描述"}'

   # 测试 TRD 生成
   curl -X POST http://localhost:5212/api/brain/generate-trd \
     -H "Content-Type: application/json" \
     -d '{"title": "测试技术方案", "description": "测试描述"}'
   ```

3. 验证生成的文档符合标准格式

## 优先级

P0 - 阻塞 Cecelia 自驱进化能力，必须立即完成

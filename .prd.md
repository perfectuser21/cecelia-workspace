---
id: fix-inbox-ws-path
version: 1.0.0
created: 2026-02-23
updated: 2026-02-23
changelog:
  - 1.0.0: 初始版本
---

# PRD: 修复 Inbox WebSocket 连接路径问题

## 背景

`InboxPage` 使用 `useProposals` hook，其中包含 WebSocket 连接逻辑。
当 WebSocket 连接失败时（`wsConnected = false`），界面显示 `WifiOff`（叉号）+ "轮询" 文字。

## 根因分析

`workspace/apps/core/src/dashboard/server.ts` 中：

1. `brainProxy` 挂载到 `app.use('/api/brain', brainProxy)`，带有 `pathRewrite: (path) => '/api/brain' + path`
   - Express 会剥离 `/api/brain` 前缀，pathRewrite 再补回去 → HTTP 正常 ✓

2. WebSocket upgrade handler 手动处理：
   ```js
   req.url = '/ws';          // 手动改写为 /ws
   brainProxy.upgrade(req, socket, head);
   ```
   pathRewrite 收到 `/ws` → 变成 `/api/brain/ws` → 发往 Brain `ws://localhost:5221/api/brain/ws`

   **Brain 的 WebSocket 实际在 `/ws`，不在 `/api/brain/ws`** → 连接失败！

## 解决方案

在 `server.ts` 新增一个不带 `pathRewrite` 的 `brainWsProxy`，专门用于 WebSocket upgrade：

```js
const brainWsProxy = createProxyMiddleware({
  target: BRAIN_NODE_API,
  changeOrigin: true,
  ws: true,
});
```

WebSocket upgrade handler 改用 `brainWsProxy`，不再需要手动改写 `req.url`（直接传 `/ws`）。

## 影响范围

- `apps/core/src/dashboard/server.ts` — 新增 brainWsProxy，修改 upgrade handler
- 不影响 HTTP API 路由（brainProxy 不变）
- 不影响 Brain 服务代码

## 验收标准

1. `wsConnected` 变为 `true`，InboxPage 右上角显示绿色 Wifi 图标 + "实时"
2. 现有 HTTP API 路由（`/api/brain/*`）正常工作
3. npm test 通过

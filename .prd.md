# PRD: 可观测性 Dashboard (Observability Dashboard)

## 背景

Cecelia Core v1.23.0 已实现可观测性系统后端（run_events 表 + trace SDK + 7 个 API 端点），但缺少前端可视化界面。用户无法直观查看：
- 当前有哪些任务在执行
- 执行卡在哪一层（L0/L1/L2/L3/L4）
- 哪些任务失败了、原因是什么
- 是否有任务 stuck（卡住超过 5 分钟）

## 目标

在 cecelia/workspace/apps/dashboard 实现可观测性 Dashboard，调用 Core API 展示实时执行状态。

## 功能需求

### 1. API 层（src/api/observability.api.ts）

创建 TypeScript API 客户端，调用以下 Core 端点：

```typescript
- GET /brain/trace/runs/active        // 活跃运行列表
- GET /brain/trace/runs/:run_id       // 单个运行详情
- GET /brain/trace/runs/:run_id/last-alive  // 最后活跃时间
- GET /brain/trace/failures/top       // 失败统计（Top 10）
- GET /brain/trace/stuck              // 卡住检测
- GET /brain/trace/artifacts/:id      // 查看 artifact
- GET /brain/trace/artifacts/:id/download  // 下载 artifact
```

定义 TypeScript 接口：
- RunEvent
- ActiveRun
- FailureStats
- StuckRun
- Artifact

### 2. 主 Dashboard 页面（src/pages/ObservabilityDashboard.tsx）

布局分为 4 个区域：

```
┌─────────────────────────────────────────┐
│  顶部：实时指标卡片                      │
│  - 活跃运行数 | 今日成功 | 今日失败      │
└─────────────────────────────────────────┘
┌────────────────┬────────────────────────┐
│  左侧：        │  右侧：                 │
│  活跃运行列表   │  选中运行的详情         │
│  (实时刷新)     │  - 执行追踪（层级树）   │
│                │  - 输入/输出            │
│                │  - Artifacts           │
├────────────────┴────────────────────────┤
│  底部：失败分析 + Stuck 检测             │
│  - Top 10 失败原因图表                   │
│  - Stuck 任务告警列表                    │
└─────────────────────────────────────────┘
```

### 3. 组件

#### ActiveRunsPanel (src/components/observability/ActiveRunsPanel.tsx)

- 显示活跃运行列表
- 每行显示：run_id, task_id, layer, step_name, 执行时长
- 支持点击查看详情
- 实时刷新（5 秒轮询）

#### ExecutionTraceViewer (src/components/observability/ExecutionTraceViewer.tsx)

- 展示单个 run 的执行追踪（层级树）
- L0 → L1 → L2 → L3 → L4 层级可视化
- 每个 span 显示：
  - 层级图标（L0~L4）
  - step_name
  - status badge（running/success/failed）
  - 执行时长
  - heartbeat 状态

#### FailureAnalysisChart (src/components/observability/FailureAnalysisChart.tsx)

- 使用 recharts 展示 Top 10 失败原因
- 柱状图：reason_code 为 X 轴，count 为 Y 轴
- 按 reason_kind 分组着色：
  - TRANSIENT: 黄色
  - PERSISTENT: 红色
  - RESOURCE: 橙色
  - CONFIG: 紫色

#### StuckDetectionPanel (src/components/observability/StuckDetectionPanel.tsx)

- 展示卡住超过 5 分钟的任务
- 告警样式（红色背景）
- 显示：run_id, layer, step_name, 卡住时长
- 提供"查看详情"按钮

### 4. 路由集成

在 `src/config/navigation.config.ts` 添加导航项：

```typescript
{
  path: '/observability',
  label: 'Observability',
  icon: 'Activity',
  component: () => import('../pages/ObservabilityDashboard')
}
```

## 技术约束

- **技术栈**：React + TypeScript + Vite + Tailwind CSS
- **图表库**：recharts（已安装）
- **API 调用**：axios（已安装）
- **实时更新**：setInterval 轮询（5 秒）
- **状态管理**：React useState/useEffect
- **响应式**：Tailwind CSS grid/flex

## 数据示例

### Active Run
```json
{
  "run_id": "abc-123",
  "task_id": "task-456",
  "last_span_id": "span-789",
  "layer": "L2_executor",
  "step_name": "execute_task",
  "status": "running",
  "executor_host": "us-vps",
  "ts_start": "2026-02-12T10:00:00Z",
  "heartbeat_ts": "2026-02-12T10:05:00Z",
  "seconds_since_activity": 10
}
```

### Failure Stats
```json
{
  "reason_code": "TIMEOUT",
  "reason_kind": "TRANSIENT",
  "count": 15,
  "last_occurred": "2026-02-12T09:30:00Z",
  "example_run_id": "run-xyz"
}
```

## UI 设计要求

- **颜色方案**：
  - 成功：绿色
  - 失败：红色
  - 运行中：蓝色
  - Stuck：橙色告警
- **实时反馈**：显示"最后更新时间"
- **加载状态**：显示 Loading spinner
- **错误处理**：API 失败时显示错误消息

## 验收标准

1. ✅ 能看到所有活跃运行
2. ✅ 点击运行能查看详细的执行追踪
3. ✅ 能看到 Top 10 失败原因图表
4. ✅ 能看到卡住的任务（超过 5 分钟）
5. ✅ 数据每 5 秒自动刷新
6. ✅ 响应式布局（桌面 + 移动端）
7. ✅ TypeScript 类型安全
8. ✅ 与现有 Dashboard 风格一致

## 非功能需求

- **性能**：初次加载 < 2 秒
- **可维护性**：组件化、类型安全
- **可扩展性**：易于添加新的可观测性指标

## 参考

- Core API 文档：`cecelia/core/brain/src/trace-routes.js`
- 现有 Dashboard：`src/pages/Dashboard.tsx`
- 现有 API 调用：`src/api/brain.api.ts`

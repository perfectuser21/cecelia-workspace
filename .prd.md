---
id: prd-trd-template-engine-kr
version: 1.0.0
created: 2026-01-31
updated: 2026-01-31
changelog:
  - 1.0.0: 初始版本
---

# PRD - TRD 模板引擎（KR 上下文增强）

## 需求来源

KR2: PRD/TRD 自动生成（标准化）。`generatePrdFromGoalKR()` 已实现 PRD 的 KR 上下文增强生成，但 TRD 侧缺少对应的 `generateTrdFromGoalKR()` 函数。现有的 `generateTrdFromGoal()` 只接受基础的 title/description/milestones，不携带 KR 进度、优先级等上下文。

## 功能描述

在 `apps/core/src/brain/templates.js` 中新增 `generateTrdFromGoalKR()` 函数，接受 KR 和 Project 上下文，生成带有 KR 信息的 TRD markdown。同时更新 API route 和 planner 集成。

具体变更：

1. **`generateTrdFromGoalKR(params)`** - 新函数，接受 `{ title, description, kr, project, milestones }` 参数：
   - 生成 frontmatter（id 基于 title slug）
   - 技术背景 section 包含 KR title/progress/priority 和 project name/repo_path
   - 架构设计 section 包含项目技术栈信息
   - 里程碑分解 section 根据 milestones 参数或自动生成默认里程碑
   - 其余 sections（API 设计、数据模型、测试策略）保持标准模板
   - 无 KR 参数时退化为基础模板（类似 generateTrdFromGoal 行为）

2. **Route 更新** - `POST /api/brain/generate/trd` 支持 `kr` 和 `project` 可选参数，有 KR 时调用 generateTrdFromGoalKR

3. **Planner 集成** - 在 planner.js 新增 `generateTaskTRD(title, description, kr, project)` 函数，对标现有 `generateTaskPRD()`，写入 PRD_DIR 并返回 `{ path, validation }`

## 涉及文件

- `apps/core/src/brain/templates.js` - 新增 generateTrdFromGoalKR，导出
- `apps/core/src/brain/routes.js` - 更新 POST /api/brain/generate/trd route，import 新函数
- `apps/core/src/brain/planner.js` - 新增 generateTaskTRD，import 新函数
- `apps/core/src/brain/__tests__/templates.test.js` - 新增测试用例

## 成功标准

- [ ] `generateTrdFromGoalKR({ title: 'X', kr: { title: 'KR2', progress: 50, priority: 'P0' } })` 返回的 markdown 包含 "KR2" 和 "50%"
- [ ] 生成的 TRD 通过 `validateTrd()` 返回 `valid: true`
- [ ] `POST /api/brain/generate/trd` 传入 `{ title, kr, project }` 返回 200 且 trd 字段包含 KR 信息
- [ ] `generateTaskTRD()` 写入文件到 PRD_DIR 并返回 `{ path, validation }` 结构
- [ ] 所有现有测试继续通过（`npm test` 在 apps/core 下执行）
- [ ] 新增至少 5 个测试覆盖：基础调用、有 KR 上下文、有 milestones、无 KR 退化、JSON 格式输出

## 非目标

- 不修改现有 generateTrdFromGoal 函数行为
- 不修改 TRD decomposer 逻辑
- 不修改前端代码
- 不修改 generatePrdFromGoalKR 函数

---
id: cp-planner-v3
version: 1.0.0
created: 2026-01-31
updated: 2026-01-31
changelog:
  - 1.0.0: 初始版本
---

# PRD - Planner V3：按 KR 优先级自动分解具体可执行任务（含 PRD 路径）

## 需求来源
Brain 自动调度任务。当前 Planner V2 的 `autoGenerateTask()` 只能生成模糊标题（如 `Advance "KR title" for project`），没有具体可执行内容，也不生成 PRD 文件，导致 Cecelia 无法自动执行。

## 功能描述

升级 `apps/core/dist/brain/planner.js` 中的任务生成逻辑：

1. **KR 分解策略**：根据 KR 的 metadata（metric、target、description）和已完成任务，推断下一步具体任务标题和描述
2. **PRD 自动生成**：为每个生成的任务创建标准 PRD 文件，路径存入 task 的 `payload.prd_path`
3. **优先级继承**：任务优先级从 KR 优先级继承，gap 大的 KR 产出更高优先级任务
4. **去重增强**：基于已完成任务的 title + description 去重，避免生成语义重复的任务

### 具体改动

**`autoGenerateTask()`** 函数改造：
- 替换 `generateTaskTitle()` 的简单字符串拼接，改为基于 KR 上下文的具体任务推断
- 新增 `generateTaskPRD()` 函数，生成标准 PRD markdown 到 `/tmp/cecelia-prds/` 目录
- PRD 内容包含：需求来源（KR title）、功能描述（具体步骤）、涉及文件（从 project.repo_path 推断）、成功标准
- 将 `prd_path` 写入 task 的 `payload` 字段

**KR 分解规则**（基于 KR title 关键词匹配）：
- "意图识别" → 任务如 "扩展 intent.js phrase patterns" / "添加 entity types"
- "PRD/TRD 自动生成" → 任务如 "实现 TRD 模板引擎" / "添加 PRD 验证逻辑"
- "Planning Engine" → 任务如 "升级 planner V3 分解逻辑"
- 通用 fallback → 基于 progress gap 生成"调研 + 实现 + 测试"三阶段任务

## 涉及文件
- **修改**: `apps/core/dist/brain/planner.js` - 升级 autoGenerateTask、新增 generateTaskPRD
- **修改**: `apps/core/dist/brain/__tests__/planner.test.js` - 补充 V3 测试用例（如存在）

## 成功标准
1. `autoGenerateTask()` 生成的任务 title 包含具体动作（不再是 "Advance X"）
2. 每个自动生成的任务都有 `payload.prd_path` 指向有效的 PRD 文件
3. PRD 文件包含标准字段：需求来源、功能描述、成功标准
4. 针对不同 KR 类型生成不同的任务（至少 3 种 KR 分解策略）
5. 已完成任务不会被重复生成（语义去重）
6. 现有 planner 测试仍然通过

## 非目标
- 不使用 LLM 生成任务（纯规则引擎，V4 再引入 LLM）
- 不修改 `planNextTask()` 的选择逻辑（selectTargetKR/selectTargetProject 不变）
- 不修改 `handlePlanInput()` 的 CRUD 逻辑
- 不修改 API 路由
- 不修改 planning.ts（Nightly Planner 独立模块）

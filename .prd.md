---
id: prd-planner-strategy-refresh
version: 1.2.0
created: 2026-01-31
updated: 2026-01-31
changelog:
  - 1.2.0: 根据 gate:prd 第二轮反馈，澄清 completedCount、测试细节、async 边界
  - 1.1.0: 根据 gate:prd 反馈修复完整性和可验收性
  - 1.0.0: 初始版本
---

## PRD - Planner KR Strategy 刷新 + 进度感知

**需求来源**: Planner V3 的 KR_STRATEGIES 中 `prd_trd_generation` 策略列出的 4 个任务已在代码中实现，但 KR2 进度仍为 0%。Planner 耗尽候选后无法生成有效任务，反复失败。这是一个技术改进。

**功能描述**:

### Phase 1: 更新 prd_trd_generation 策略任务列表

替换 KR_STRATEGIES 中 `prd_trd_generation` 的 tasks 数组为以下 4 个新任务：
1. `PRD 生成端到端冒烟测试` - 调用 POST /api/brain/generate/prd 验证返回的 markdown 通过 validatePrd 校验
2. `PRD 验证 API 集成测试` - 调用 POST /api/brain/validate/prd 验证 valid=true/false 的不同输入
3. `TRD 分解结果持久化验证` - 调用 POST /api/brain/trd/decompose 验证返回的 milestones 和 tasks 数量 > 0
4. `Planner 自动 PRD 质量达标` - 验证 generateTaskPRD 生成的 PRD 能通过 validatePrd（score >= 60）

### Phase 2: 在 generateNextTask 中添加策略耗尽检测 + KR 进度更新

修改位置：`generateNextTask` 函数（async），在调用 `generateTaskFromKR` 返回 null 之后、return null 之前。

`completedCount` 定义：`completedTitles`（从数据库 `SELECT title FROM tasks WHERE goal_id=$1 AND status='completed'` 查询得到）中，与当前匹配策略的 tasks 标题匹配的数量。

`totalTasks` 定义：匹配策略的 `tasks.length`。

进度公式：`Math.round((completedCount / totalTasks) * 100)`

具体代码变更：
```javascript
// 在 generateNextTask 中，当 taskCandidate === null 时：
if (!taskCandidate) {
  // 检查是否匹配了策略（非 fallback）
  const strategy = KR_STRATEGIES.find(s => s.match(kr.title));
  if (strategy) {
    const completedCount = strategy.tasks.filter(t =>
      completedTitles.some(ct => ct === t.title || ct.includes(t.title) || t.title.includes(ct))
    ).length;
    const progress = Math.round((completedCount / strategy.tasks.length) * 100);
    await pool.query('UPDATE goals SET progress = $1 WHERE id = $2', [progress, kr.id]);
  }
  return null;
}
```

注意：`generateTaskFromKR` 保持同步不变，进度更新逻辑放在 async 的 `generateNextTask` 中。

### Phase 3: 添加 progressWeight 字段

为 KR_STRATEGIES 每个策略对象添加 `progressWeight` 属性，值等于 `tasks.length`。当前架构下每个 KR 只匹配一个策略（KR_STRATEGIES.find 取第一个匹配），不处理多策略匹配。

**涉及文件**:
- `apps/core/src/brain/planner.js` - KR_STRATEGIES 更新、generateNextTask 添加进度逻辑
- `apps/core/src/brain/__tests__/planner.test.js` - 新增 3 个测试

**成功标准**:
1. `prd_trd_generation.tasks` 包含上述 4 个新任务标题，不再包含旧任务
2. 每个 KR_STRATEGIES 策略有 `progressWeight` 字段，值 === `tasks.length`
3. generateNextTask 在 taskCandidate===null 且匹配到策略时，执行 `UPDATE goals SET progress` SQL
4. 测试 1 - `策略任务全部耗尽`: 传入 completedTitles=['PRD 生成端到端冒烟测试','PRD 验证 API 集成测试','TRD 分解结果持久化验证','Planner 自动 PRD 质量达标']，验证 generateTaskFromKR 返回 null
5. 测试 2 - `进度更新触发`: 使用 vitest.mock('../task-system/db.js') mock pool.query，调用 generateNextTask 使其走到策略耗尽分支，验证 pool.query 被调用且参数包含 UPDATE goals
6. 测试 3 - `progressWeight 一致性`: 遍历 KR_STRATEGIES，assert 每个 strategy.progressWeight === strategy.tasks.length

**非目标**:
- 不修改 templates.js（PRD/TRD 模板引擎）
- 不修改 routes.js（Brain API 路由）
- 不修改前端
- 不修改 selectTargetKR / selectTargetProject 逻辑
- 不修改 generateNextTask 的函数签名
- 不修改 N8N workflow 调度

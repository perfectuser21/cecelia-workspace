---
id: prd-tick-auto-loop
version: 1.0.0
created: 2026-01-31
updated: 2026-01-31
changelog:
  - 1.0.0: 初始版本
---

# PRD - Brain Tick 自动循环机制

## 需求来源

实际运行中发现 `next_tick` 过期 8 小时无人触发，系统停摆。`tick_enabled` 只是状态标记，没有定时器运行。

## 功能描述

在 Node.js 进程内实现 tick 自动循环（L0 主心跳），与已有的 execution-callback 事件驱动（L1）配合，形成"定时驱动 + 事件加速"的双保险架构。

### 核心改动

1. **tick.js** - 新增 `startTickLoop()` / `stopTickLoop()` / `runTickSafe()`
   - setInterval 每 2 分钟执行一次 tick
   - 防重入锁（内存锁 + 超时自动释放 60s）
   - enable/disable 时联动启停

2. **server.ts** - 启动时检查 tick 状态，已启用则自动拉起循环

3. **routes.js** - enable/disable API 联动调用 startTickLoop/stopTickLoop

### 不改动

- executeTick() 核心逻辑不变
- execution-callback 触发 tick 的逻辑保留
- 不引入外部依赖

## 涉及文件

- `apps/core/src/brain/tick.js`（修改：加循环控制）
- `apps/core/src/brain/routes.js`（修改：enable/disable 联动）
- `apps/core/src/dashboard/server.ts`（修改：启动时拉起循环）
- `apps/core/src/brain/__tests__/tick-loop.test.js`（新建：循环测试）

## 成功标准

- [ ] 服务启动后，若 tick_enabled=true，自动开始每 2 分钟执行 tick
- [ ] enable API 调用后立即启动循环
- [ ] disable API 调用后立即停止循环
- [ ] 多个触发源不会并发执行 tick（防重入锁）
- [ ] tick 执行超过 60 秒自动释放锁
- [ ] GET /api/brain/tick/status 返回 loop_running 字段
- [ ] 测试覆盖：防重入、超时、启停联动

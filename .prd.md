---
id: cp-failed-task-retry
version: 1.0.0
created: 2026-01-31
updated: 2026-01-31
changelog:
  - 1.0.0: 初始版本
---

## PRD - 失败任务智能重试：分析失败原因 + 调整参数 + 重新入队

**需求来源**: Brain 自动调度任务。当前重试机制仅简单重新入队（planner.js 创建 `[Retry]` 任务），无失败原因分析、无参数调整，导致相同失败重复出现浪费资源。

**功能描述**: 在 Brain 的重试环节增加智能重试模块：
1. **分析失败原因**：从 task error 信息 + cecelia_events 中提取失败类别（timeout / code_error / infra_error / prd_unclear）
2. **调整重试参数**：根据失败类别自动调整策略（timeout 类增大超时阈值、infra_error 类延迟重试、prd_unclear 类不重试直接 abandon）
3. **重新入队**：带调整后参数创建 retry 任务，记录分析结果到 payload.failure_analysis

**涉及文件**:
- `apps/core/src/brain/retry-analyzer.js` — 新建，失败分析 + 参数调整逻辑
- `apps/core/src/brain/planner.js` — 修改，调用 retry-analyzer 替代原有简单重试
- `apps/core/src/brain/tick.js` — 修改，autoFailTimedOutTasks 时写入结构化 error 信息
- `apps/core/src/brain/routes.js` — 修改，在 brain/status 中添加 retry 分析摘要

**成功标准**:
- [ ] 失败任务被分析并归类为 timeout / code_error / infra_error / prd_unclear 之一
- [ ] timeout 类重试时 dispatch_timeout 增加 50%；infra_error 类延迟 10 分钟后入队；prd_unclear 类标记 abandoned 不重试
- [ ] retry 任务的 payload 包含 failure_analysis 字段（category、reason、adjustments 对象）
- [ ] 超过 max_retries(2) 的任务标记为 abandoned，不再创建重试任务
- [ ] GET /api/brain/status 返回的 task_digest 包含 retry_summary（failed_count、retrying_count、abandoned_count）

**非目标**:
- 不修改 circuit-breaker 逻辑
- 不引入 LLM 分析（纯规则匹配）
- 不修改前端 UI

---
id: prd-trd-template-engine-kr
version: 1.0.0
created: 2026-01-31
updated: 2026-01-31
changelog:
  - 1.0.0: 初始版本
---

# PRD - TRD 模板引擎 KR 上下文增强

## 需求来源

KR2: PRD/TRD 自动生成（标准化）- Task: 基于 KR 上下文自动生成 TRD markdown 结构，包含里程碑分解。
自动生成于 Nightly Planner (plan_daily_20260131)。

## 功能描述

当前 `templates.js` 已有 `generateTrdFromGoal(params)` 函数，但它不支持 KR（Key Result）上下文。相比之下，`generatePrdFromGoalKR(params)` 已支持 KR 上下文生成 PRD。

本任务补齐 TRD 的 KR 上下文支持：
1. 新增 `generateTrdFromGoalKR(params)` 函数 - 基于 Goal + KR 上下文生成 TRD，输出包含 KR 来源信息、里程碑分解、与 KR 对齐的测试策略
2. 新增 API 端点 `POST /api/brain/generate/trd-from-kr` - 通过 KR 信息生成 TRD
3. 导出新函数，保持与 `generatePrdFromGoalKR` 对称的 API 设计

## 涉及文件

- `apps/core/src/brain/templates.js` - 新增 `generateTrdFromGoalKR` 函数并导出
- `apps/core/src/brain/routes.js` - 新增 `POST /api/brain/generate/trd-from-kr` 端点
- `apps/core/src/brain/__tests__/templates.test.js` - 测试 generateTrdFromGoalKR

## 成功标准

- [ ] `generateTrdFromGoalKR({title, description, kr, project})` 返回包含 KR 上下文的 TRD markdown 字符串
- [ ] 生成的 TRD 包含 YAML frontmatter（id, version, created, updated, changelog）
- [ ] 生成的 TRD 技术背景章节包含 KR 来源（标题、进度、优先级）
- [ ] `validateTrd()` 对生成的 TRD 返回 `{ valid: true }`
- [ ] `POST /api/brain/generate/trd-from-kr` 接受 `{title, description, kr, project, milestones, format}` 返回 200
- [ ] 单元测试覆盖：无 KR 时退化、有 KR 时包含来源、有 milestones 时生成任务分解

## 非目标

- 不修改现有 `generateTrdFromGoal` 函数
- 不修改 PRD 相关函数
- 不修改 TRD decomposer
- 不修改前端

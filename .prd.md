---
id: prd-trd-template-engine
version: 1.0.0
created: 2026-01-31
updated: 2026-01-31
changelog:
  - 1.0.0: 初始版本
---

# PRD - TRD 模板引擎（KR 上下文感知）

## 需求来源

KR2: PRD/TRD 自动生成（标准化）- P0
Task: 实现 TRD 模板引擎，基于 KR 上下文自动生成 TRD markdown 结构，包含里程碑分解。
当前 `generateTrdFromGoal()` 只生成硬编码的 5 节通用 TRD，不包含 KR 上下文信息。

## 功能描述

新增 `generateTrdFromGoalKR()` 函数，类似于已有的 `generatePrdFromGoalKR()`，但生成 TRD 文档。

1. 接收 Goal + KR + Project + Milestones 上下文
2. 生成符合 `TRD-TEMPLATE.md` 8 节结构的 TRD markdown
3. 里程碑自动分解为 PRD 依赖图
4. KR 进度和优先级信息嵌入文档元数据

具体变更：
- `templates.js`: 新增 `TRD_FULL_TEMPLATE` 常量（8 节结构匹配 TRD-TEMPLATE.md）
- `templates.js`: 新增 `generateTrdFromGoalKR(params)` 函数
- `templates.js`: 导出新增函数和常量
- `routes.js`: 新增 `POST /api/brain/generate/trd-from-kr` 端点
- `templates.test.js`: 新增对应测试

## 涉及文件

- `apps/core/src/brain/templates.js` - 新增函数和模板常量
- `apps/core/src/brain/routes.js` - 新增 API 端点
- `apps/core/src/brain/__tests__/templates.test.js` - 新增测试

## 成功标准

- [ ] `generateTrdFromGoalKR({title, description, kr, project, milestones})` 返回包含 8 个节的 TRD markdown（概述、系统架构、数据模型、PRD 拆解、接口设计、技术决策、验收标准、附录）
- [ ] 生成的 TRD 包含 KR 上下文信息（kr.title, kr.progress, kr.priority）
- [ ] milestones 数组自动生成 PRD 依赖图和清单表格
- [ ] `POST /api/brain/generate/trd-from-kr` 端点返回 `{success: true, data: {trd_content, metadata}}`
- [ ] 所有新增测试通过（validateTrd 验证生成的 TRD 结构有效）
- [ ] 不破坏现有 `generateTrdFromGoal()` 和其他函数

## 非目标

- 不修改现有 `generateTrdFromGoal()` 函数签名或行为
- 不修改 decomposer.js
- 不引入新的外部依赖
- 不修改前端

---
id: prd-trd-template-engine-kr
version: 1.2.0
created: 2026-01-31
updated: 2026-01-31
changelog:
  - 1.2.0: 根据 gate:prd 第二轮反馈修复可验收性和边界清晰度
  - 1.1.0: 根据 gate:prd 反馈修复完整性
  - 1.0.0: 初始版本
---

# PRD - 实现 TRD 模板引擎（KR 上下文感知）

## 需求来源

Task ID: 5a13cc83-a365-4688-b323-bd4dcf37410c
自动生成于 Nightly Planner，P0 优先级。技术改进。

现有 `generateTrdFromGoal`（templates.js:431）生成的 TRD 内容过于通用。需要类似 `generatePrdFromGoalKR`（templates.js:460）的 KR 上下文感知版本。

## 功能描述

在 `apps/core/src/brain/templates.js` 中新增 `generateTrdFromGoalKR(params)` 函数。

### 参数

```typescript
{
  title: string,           // 必填
  description?: string,    // 可选，默认使用 title
  kr?: { title: string, progress: number, priority: string },  // KR 上下文
  project?: { name: string, repo_path: string },              // 项目上下文
  milestones?: Array<{ title: string, description?: string }> // 里程碑
}
```

### 行为

1. 生成 frontmatter（调用 generateFrontmatter）
2. 生成 TRD_TEMPLATE 的 5 个必需章节 + 实施计划章节
3. 在"技术背景"的"需求来源"子节中注入：`KR: {kr.title} (progress: {kr.progress}%, priority: {kr.priority})`，格式与 generatePrdFromGoalKR:478 一致
4. 在"架构设计"的"组件设计"子节中注入：`Project: {project.repo_path}`
5. milestones 非空时在"实施计划"中逐条列出；为空时使用 renderTrd 的默认 4 步计划
6. 内部调用 renderTrd（通过构造 parsedIntent），与 generateTrdFromGoal 模式一致

### API 端点

`POST /api/brain/generate/trd-from-kr`，参考现有 `/api/brain/generate/trd`（routes.js:1300）。

请求体：`{ title, description?, kr?, project?, milestones? }`

响应体：`{ success: true, trd: <markdown>, metadata: { title, milestones_count, generated_at } }`

### 导出

在 templates.js 末尾 export 中添加 generateTrdFromGoalKR。routes.js:11 的 import 中添加 generateTrdFromGoalKR。

## 涉及文件

- `apps/core/src/brain/templates.js` — 新增函数 + 修改 export
- `apps/core/src/brain/routes.js` — 新增端点 + 修改 import
- `apps/core/src/brain/__tests__/templates.test.js` — 新增测试

## 成功标准

- [ ] `generateTrdFromGoalKR({ title: 'Test' })` 返回 TRD markdown，`validateTrd()` 返回 `valid: true`（warnings 允许存在）
- [ ] 传入 `kr: { title: 'KR2', progress: 50, priority: 'P1' }` 时，TRD 技术背景章节包含文本 `KR: KR2 (progress: 50%, priority: P1)`
- [ ] 传入 `project: { name: 'test', repo_path: '/home/xx/dev/test' }` 时，TRD 包含文本 `Project: /home/xx/dev/test`
- [ ] `POST /api/brain/generate/trd-from-kr` 传入 `{ title: 'Test' }` 返回 HTTP 200，body 含 `success: true` 和 `trd` 字段
- [ ] 测试覆盖：①仅 title、②title+kr+project+milestones

## 非目标

- 不修改现有 generateTrdFromGoal 函数
- 不修改 renderTrd 函数
- 不修改 validateTrd 函数
- 不修改 decomposer.js
- 不修改数据库 schema
- 不修改前端

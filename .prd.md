---
id: prd-phase5-memory-schema
version: 1.0.0
created: 2026-01-30
---

# PRD: Phase 5.1 - Structured Memory Schema

## 背景

当前 Memory 是简单的 key-value 存储，缺乏：
- 类型约束（任何 JSON 都能塞进去）
- 时间维度（不知道什么时候写的、过期没）
- 层级结构（工作记忆 vs 长期记忆）
- 查询能力（只能按 key 精确匹配）

## 目标

建立结构化记忆系统，为 Planning/Review/Persona 提供基座。

## Memory 三层模型

```
┌─────────────────────────────────────────┐
│  Layer 3: Long-term Memory (长期记忆)    │
│  - 用户偏好、历史决策模式、学到的经验      │
│  - 持久化，跨会话保留                     │
│  - 例：preferred_coding_style, lessons   │
└─────────────────────────────────────────┘
                    ↑ 沉淀
┌─────────────────────────────────────────┐
│  Layer 2: Working Memory (工作记忆)      │
│  - 当前任务上下文、临时状态               │
│  - 会话级，任务完成后清理或沉淀           │
│  - 例：current_task, current_branch     │
└─────────────────────────────────────────┘
                    ↑ 加载
┌─────────────────────────────────────────┐
│  Layer 1: Episodic Memory (情景记忆)     │
│  - 具体事件记录（谁在什么时候做了什么）    │
│  - 自动记录，用于回溯和学习               │
│  - 例：task_completed, error_occurred   │
└─────────────────────────────────────────┘
```

## Schema 定义

### 1. Memory Entry 结构

```typescript
interface MemoryEntry {
  id: string;                    // UUID
  layer: 'episodic' | 'working' | 'longterm';
  category: string;              // 分类：task, decision, preference, lesson
  key: string;                   // 唯一键
  value: Record<string, any>;    // 结构化数据

  // 时间维度
  created_at: timestamp;
  updated_at: timestamp;
  expires_at?: timestamp;        // 可选过期时间

  // 关联
  task_id?: string;              // 关联任务
  session_id?: string;           // 关联会话

  // 元数据
  source: string;                // 来源：user, system, inference
  confidence?: number;           // 置信度 0-1（推断记忆用）
}
```

### 2. 预定义 Category Schema

| Category | Layer | 用途 | 示例 Key |
|----------|-------|------|----------|
| `context` | working | 当前上下文 | current_task, current_focus |
| `state` | working | 临时状态 | task_progress, pending_actions |
| `event` | episodic | 事件记录 | task_started, error_occurred |
| `decision` | episodic | 决策记录 | chose_approach, rejected_option |
| `preference` | longterm | 用户偏好 | coding_style, review_frequency |
| `lesson` | longterm | 学到的经验 | common_errors, best_practices |
| `pattern` | longterm | 行为模式 | work_hours, task_types |

### 3. API 设计

```
# 写入（带 schema 验证）
POST /api/brain/memory
{
  "layer": "working",
  "category": "context",
  "key": "current_task",
  "value": {...},
  "expires_at": "2026-01-30T20:00:00Z"  // 可选
}

# 读取（支持查询）
GET /api/brain/memory?layer=working
GET /api/brain/memory?category=context
GET /api/brain/memory/{key}

# 批量读取（Planning 用）
POST /api/brain/memory/batch
{
  "keys": ["current_task", "current_focus", "pending_actions"]
}

# 沉淀（working → longterm）
POST /api/brain/memory/consolidate
{
  "key": "task_lesson_123",
  "from_layer": "working",
  "to_layer": "longterm"
}

# 清理过期
POST /api/brain/memory/gc
```

## 实现范围

### Phase 5.1a: Schema + 基础 API
- [ ] 定义 MemoryEntry 表结构
- [ ] 实现 POST /api/brain/memory（带验证）
- [ ] 实现 GET /api/brain/memory（支持 layer/category 过滤）
- [ ] 迁移现有 key-value 数据到新结构

### Phase 5.1b: 高级功能
- [ ] 批量读取 API
- [ ] 过期自动清理（GC）
- [ ] 沉淀 API（consolidate）
- [ ] 查询优化（索引）

## 成功标准

1. 新 API 可区分 working/longterm 记忆
2. 写入时自动验证 category 是否合法
3. 旧的 set-memory action 兼容新结构
4. Planning Engine 可批量读取上下文

## 依赖

- cecelia-semantic-brain（Memory 存储在 Brain）
- PostgreSQL（cecelia_tasks 数据库）

## 风险

- 迁移旧数据可能有格式不兼容
- 需要 Brain 侧配合改动

## PRD - OKR 系统三层架构优化

**需求来源**: 用户需要完整的 OKR 三层管理体系（个人/业务/部门），支持预期 vs 实际时间追踪，关联 Area 和 Project。

**功能描述**:

### 1. 数据库层优化

#### 新建 businesses 表（业务管理）
- 管理业务实体：Stock, ZenithJoy 等
- 字段：id, name, description, owner, status, created_at, updated_at
- 用途：业务成为"一等公民"，可独立管理、统计、改名

#### 新建 departments 表（部门管理）
- 管理部门实体：Content Team, Tech Team 等
- 字段：id, business_id, name, lead, description, created_at, updated_at
- 关系：departments 属于 businesses（多对一）

#### 增强 goals 表
新增字段：
- `scope` VARCHAR(20) - 'personal', 'business', 'department'（三层区分）
- `cycle` VARCHAR(20) - '3months', '1month', '2weeks'（周期标记）
- `business_id` UUID - 关联 businesses 表
- `department_id` UUID - 关联 departments 表
- `area_id` UUID - 关联 workspaces 表（用户的 7 个生活领域）
- `expected_start_date` DATE - 预期开始日期
- `expected_end_date` DATE - 预期结束日期
- `actual_start_date` DATE - 实际开始日期
- `actual_end_date` DATE - 实际结束日期

### 2. 后端 API

#### /api/tasks/businesses
- GET /api/tasks/businesses - 获取所有业务
- GET /api/tasks/businesses/:id - 获取单个业务
- POST /api/tasks/businesses - 创建业务
- PATCH /api/tasks/businesses/:id - 更新业务
- DELETE /api/tasks/businesses/:id - 删除业务

#### /api/tasks/departments
- GET /api/tasks/departments - 获取所有部门
- GET /api/tasks/departments?business_id=xxx - 按业务筛选部门
- GET /api/tasks/departments/:id - 获取单个部门
- POST /api/tasks/departments - 创建部门
- PATCH /api/tasks/departments/:id - 更新部门
- DELETE /api/tasks/departments/:id - 删除部门

#### /api/tasks/goals 增强
- 支持新字段的 CRUD
- 支持按 scope 筛选（personal/business/department）
- 支持按 business_id, department_id 筛选
- 支持按 area_id 筛选
- 返回数据包含关联的 business, department, area 信息

### 3. OKR 层级连接逻辑

```
个人 O (scope=personal, cycle=3months)
  └─ 个人 KR 1
      └─ 业务 O (scope=business, cycle=1month, parent_id=个人KR1, business_id=Stock)
          └─ 业务 KR 1
              └─ 部门 O (scope=department, cycle=2weeks, parent_id=业务KR1, department_id=ContentTeam)
```

通过 `parent_id` 实现跨层连接，通过 `scope` 区分层级。

**涉及文件**:
- `apps/core/migrations/xxx-add-okr-tables.ts` - 数据库 migration
- `apps/core/src/routes/tasks.routes.ts` - 路由定义
- `apps/core/src/controllers/businesses.controller.ts` - 业务 CRUD
- `apps/core/src/controllers/departments.controller.ts` - 部门 CRUD
- `apps/core/src/controllers/goals.controller.ts` - 修改支持新字段

**成功标准**:
1. businesses 表创建成功，有完整的 CRUD API
2. departments 表创建成功，有完整的 CRUD API，支持按 business_id 筛选
3. goals 表新增字段成功，API 支持新字段查询和更新
4. 可以创建三层 OKR 结构（个人 → 业务 → 部门）
5. 可以通过 API 查询某个业务下所有 OKR
6. 可以查询某个 OKR 的时间信息（预期 vs 实际）
7. Build 通过，无 TypeScript 错误

**非目标**:
- 不做前端页面（Phase 2）
- 不做 OKR 拆解逻辑（秋米的职责）
- 不做数据迁移（现有 goals 数据保持不变）

**技术方案**:

### Migration SQL
```sql
-- 创建 businesses 表
CREATE TABLE businesses (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name VARCHAR(100) NOT NULL,
  description TEXT,
  owner VARCHAR(100),
  status VARCHAR(20) DEFAULT 'active',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 创建 departments 表
CREATE TABLE departments (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  business_id UUID REFERENCES businesses(id) ON DELETE CASCADE,
  name VARCHAR(100) NOT NULL,
  lead VARCHAR(100),
  description TEXT,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- goals 表新增字段
ALTER TABLE goals
  ADD COLUMN scope VARCHAR(20),
  ADD COLUMN cycle VARCHAR(20),
  ADD COLUMN business_id UUID REFERENCES businesses(id) ON DELETE SET NULL,
  ADD COLUMN department_id UUID REFERENCES departments(id) ON DELETE SET NULL,
  ADD COLUMN area_id UUID REFERENCES workspaces(id) ON DELETE SET NULL,
  ADD COLUMN expected_start_date DATE,
  ADD COLUMN expected_end_date DATE,
  ADD COLUMN actual_start_date DATE,
  ADD COLUMN actual_end_date DATE;

-- 索引优化
CREATE INDEX idx_goals_scope ON goals(scope);
CREATE INDEX idx_goals_business_id ON goals(business_id);
CREATE INDEX idx_goals_department_id ON goals(department_id);
CREATE INDEX idx_goals_area_id ON goals(area_id);
CREATE INDEX idx_departments_business_id ON departments(business_id);
```

### API 响应示例
```json
// GET /api/tasks/businesses
[
  {
    "id": "uuid-1",
    "name": "Stock",
    "description": "股票投资业务",
    "owner": "你自己",
    "status": "active",
    "created_at": "2026-02-07T08:00:00Z",
    "updated_at": "2026-02-07T08:00:00Z"
  }
]

// GET /api/tasks/goals?scope=business&business_id=uuid-1
[
  {
    "id": "goal-1",
    "parent_id": "personal-kr-1",
    "scope": "business",
    "cycle": "1month",
    "business_id": "uuid-1",
    "business": {  // 关联数据
      "name": "Stock",
      "owner": "你自己"
    },
    "title": "完成交易系统升级",
    "type": "objective",
    "status": "in_progress",
    "progress": 80,
    "expected_start_date": "2026-02-01",
    "expected_end_date": "2026-03-01",
    "actual_start_date": "2026-02-03",  // 晚了2天
    "actual_end_date": null  // 未完成
  }
]
```

---
id: prd-kr2-prd-trd-standardization
version: 1.1.0
created: 2026-01-31
updated: 2026-01-31
changelog:
  - 1.0.0: 初始版本
  - 1.1.0: 补充成功标准细节和验证规则
---

# PRD - PRD/TRD 自动生成标准化（KR2 推进）

## 需求来源

Brain Planner 自动调度。KR2（PRD/TRD 自动生成标准化）progress=0%。当前 `planner.js:generateTaskPRD()` 生成的 PRD 仅含标题和"任务完成"作为成功标准，导致 Cecelia 无头执行缺乏上下文，频繁失败。

## 功能描述

### 1. 统一 PRD 生成入口

`planner.js:generateTaskPRD()` 不再内联硬编码 markdown，改为调用 `templates.js:renderPrd()`。`renderPrd()` 新增可选参数 `context`，包含 `{ kr, project, completedTasks }` 信息。

数据流：
```
KR metadata + Project info → renderPrd(parsedIntent, { context }) → PRD markdown
```

### 2. PRD 质量验证

新增 `validatePrd(markdownContent)` 函数（在 templates.js 中导出），检查：
- frontmatter 存在且包含 id、version、created
- 必填 section 存在：需求来源、功能描述、涉及文件、成功标准、非目标
- 每个 section 内容不为空（至少 10 个字符）

返回值：`{ valid: boolean, score: number, missing_fields: string[] }`
- `score` = 已填充字段数 / 总检查字段数（8 个字段）
- `valid` = score >= 0.6 且"需求来源"和"成功标准"不缺失

### 3. 验证 API 端点

新增 `POST /api/brain/validate/prd`，body: `{ content: string }`，返回 validatePrd 结果。

## 涉及文件

- `apps/core/src/brain/planner.js` - 修改 `generateTaskPRD()` 调用 renderPrd
- `apps/core/src/brain/templates.js` - renderPrd 增加 context 参数 + 新增 validatePrd
- `apps/core/src/brain/routes.js` - 新增 POST /api/brain/validate/prd
- `apps/core/src/brain/__tests__/templates.test.js` - 新增 validatePrd 和 context 测试

## 成功标准

- [ ] `planner.js:generateTaskPRD()` 内部调用 `renderPrd()` 生成内容，不包含硬编码 markdown 模板字符串
- [ ] `renderPrd({ ..., kr, project })` 生成的 PRD 包含 KR 标题、进度、项目名称和 repo 路径
- [ ] `validatePrd(content)` 对完整 PRD 返回 `{ valid: true, score: 1.0, missing_fields: [] }`
- [ ] `validatePrd("")` 对空内容返回 `{ valid: false, score: 0, missing_fields: [...] }`
- [ ] `POST /api/brain/validate/prd` 返回 200 + JSON 格式的验证结果
- [ ] 现有 `npm test -- templates` 测试全部通过

## 非目标

- 不改动 decomposer.js（TRD 分解流水线）
- 不改动前端代码
- 不改动 Notion 同步逻辑
- 不引入 LLM 调用（纯规则验证）
- 不改变 PRD_TEMPLATE 的 sections 定义

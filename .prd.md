## PRD - 失败任务自动重试：分析失败原因 + 调整参数 + 重新入队

**需求来源**: Brain 自动调度系统。当前失败任务依赖 planner 下一轮周期创建 `[Retry]` 任务，延迟高且不分析失败原因。需要在 execution-callback 中立即分析并重试。

**功能描述**: 当任务执行失败时，立即分析失败原因、调整重试参数、创建重试任务入队。

### 1. 失败分析模块 (`retry-analyzer.js`)

分析 `last_run_result` 和任务 payload，归类失败原因：

| 失败类型 | 识别条件 | 参数调整 | 可重试 |
|----------|----------|----------|--------|
| `timeout` | status 包含 "timeout" 或 elapsed_minutes > 25 | `retry_hints.timeout_extended: true` | 是 |
| `ci_failure` | result_summary 包含 "CI"/"ci"/"check" | `retry_hints.ci_context: <错误摘要>` | 是 |
| `code_error` | result_summary 包含 "error"/"fail" 且不匹配上述 | `retry_hints.error_context: <错误摘要>` | 是 |
| `env_error` | result_summary 包含 "npm"/"permission"/"ENOENT" | `retry_hints.env_issue: true` | 否 |
| `unknown` | 以上都不匹配 | `retry_hints.previous_failure: <原始状态>` | 是 |

函数签名：`analyzeFailure(task, runResult) → { failureType, retryable, adjustedPayload, reason }`

### 2. 自动重新入队

在 execution-callback 中失败时：
1. 调用 `analyzeFailure()` 分析
2. 如果 `retryable && retry_count < 2`：创建新任务，status=`queued`，payload 含 `retry_of`(原任务ID)、`retry_count`(+1)、`retry_hints`
3. 新任务优先级与原任务相同，title 加 `[Retry]` 前缀
4. 如果不可重试或超限：原任务保持 `failed`，不创建新任务
5. 通过 EventBus emit `task_retried` 事件

**与 planner.js 的协调**：planner 检查 `retry_count < 2`，新系统创建的重试任务 retry_count 已递增，planner 不会重复创建。

### 3. tick.js autoFailTimedOutTasks 集成

超时自动失败时，同样调用 `analyzeFailure()` 分析并决定是否重试。

### 4. 重试 API

- `GET /api/brain/retry-policy` — 返回 `{ max_retries: 2, retryable_types: ["timeout","ci_failure","code_error","unknown"], non_retryable_types: ["env_error"] }`
- `POST /api/brain/tasks/:id/retry` — 手动触发：忽略 retry_count 限制，强制创建重试任务，返回新任务对象

### 数据存储

不新增数据库列。所有重试信息存储在 tasks 表已有的 `payload` JSONB 字段中：
- `payload.retry_of` — 原任务 ID
- `payload.retry_count` — 重试次数
- `payload.retry_hints` — 调整后的参数

**涉及文件**:
- `apps/core/src/brain/retry-analyzer.js` — 新建，失败分析 + 参数调整
- `apps/core/src/brain/routes.js` — 修改 execution-callback + 新增 2 个 API
- `apps/core/src/brain/tick.js` — 修改 autoFailTimedOutTasks

**成功标准**:
- [ ] `analyzeFailure({}, {status:"timeout"})` 返回 `failureType: "timeout", retryable: true`
- [ ] `analyzeFailure({}, {result_summary:"CI check failed"})` 返回 `failureType: "ci_failure", retryable: true`
- [ ] `analyzeFailure({}, {result_summary:"npm ERR"})` 返回 `failureType: "env_error", retryable: false`
- [ ] execution-callback 收到 `status: "AI Failed"` 且 retry_count=0 时，tasks 表新增一条 status=queued 的记录，payload 含 retry_of 和 retry_count=1
- [ ] execution-callback 收到 `status: "AI Failed"` 且 retry_count=2 时，不创建新任务
- [ ] autoFailTimedOutTasks 超时任务自动分析并创建重试任务（retry_count < 2）
- [ ] `GET /api/brain/retry-policy` 返回 JSON 含 max_retries、retryable_types、non_retryable_types
- [ ] `POST /api/brain/tasks/:id/retry` 创建新任务并返回 `{ success: true, task: {id, status: "queued", ...} }`
- [ ] 重试时 EventBus 收到 `task_retried` 事件

**非目标**:
- 不修改 planner.js 已有重试逻辑（通过 retry_count 自然协调）
- 不实现 ML 失败分类，用字符串匹配
- 不修改 circuit-breaker 逻辑
- 不修改通知逻辑（notifyTaskFailed 继续正常触发）
- 不处理手动中止（abort）的重试

---
id: prd-trd-template-engine-kr
version: 1.0.0
created: 2026-01-31
updated: 2026-01-31
changelog:
  - 1.0.0: 初始版本
---

# PRD - TRD 模板引擎（KR 上下文感知）

## 需求来源

Nightly Planner 自动生成任务（task ID: 5a13cc83）。当前有 `generatePrdFromGoalKR` 从 KR 上下文生成 PRD，但缺少对应的 `generateTrdFromGoalKR`。现有 `generateTrdFromGoal` 不接受 KR/project 上下文，生成内容为纯通用占位符。

## 功能描述

在 `apps/core/src/brain/templates.js` 中新增 `generateTrdFromGoalKR(params)` 函数，接受 KR 和 project 上下文，生成带有 frontmatter、KR 来源信息、里程碑分解的 TRD markdown。同时增强 `routes.js` 中 `/api/brain/generate/trd` 端点以支持 KR 上下文参数。

具体实现：

### 1. generateTrdFromGoalKR 函数

参数签名：
```javascript
function generateTrdFromGoalKR({ title, description, milestones, kr, project })
```

- `title` (required): TRD 标题
- `description` (optional): 描述，默认使用 title
- `milestones` (optional): 里程碑数组 `[{ title, description }]`
- `kr` (optional): KR 上下文 `{ title, progress, priority }`
- `project` (optional): 项目上下文 `{ name, repo_path }`

输出 TRD markdown 包含：
- frontmatter（id: `trd-auto-<slug>`, version, created, updated）
- 技术背景节：引用 KR 来源和 project 信息
- 架构设计节：使用 project 上下文
- API 设计节：基于 project name 生成
- 数据模型节：基于 title 生成
- 测试策略节：基于 milestones 生成测试覆盖
- 实施计划节：milestones 映射为有序任务

### 2. 路由增强

增强 `POST /api/brain/generate/trd`，在现有 `title, description, milestones` 之外支持可选的 `kr` 和 `project` 参数。当有 KR 参数时调用 `generateTrdFromGoalKR`，否则继续调用原有 `generateTrdFromGoal`。

## 涉及文件

- `apps/core/src/brain/templates.js` - 新增 `generateTrdFromGoalKR` 函数和导出
- `apps/core/src/brain/routes.js` - 增强 `/api/brain/generate/trd` 路由
- `apps/core/src/brain/__tests__/templates.test.js` - 新增测试

## 成功标准

- [ ] `generateTrdFromGoalKR({ title, kr, project })` 返回包含 `KR:` 来源信息的 TRD markdown
- [ ] 生成的 TRD 通过 `validateTrd()` 验证返回 `valid: true`
- [ ] 函数接受 milestones 参数并映射为实施计划中的有序任务列表
- [ ] 无 KR 参数时，函数输出仍包含所有 5 个必需 TRD 节（技术背景/架构设计/API 设计/数据模型/测试策略）
- [ ] `/api/brain/generate/trd` 端点接受 kr 和 project 可选参数并返回 `success: true`
- [ ] 新增测试覆盖：全参数、无 KR、无 project、空 milestones 四种场景

## 非目标

- 不修改现有 `generateTrdFromGoal` 或 `renderTrd` 的行为
- 不修改 TRD decomposer 逻辑
- 不修改 PRD 相关功能
- 不修改前端

# PRD: TaskDatabase 容错性修复

## 问题背景

当前 TaskDatabase 使用 `Promise.all` 同时获取所有 API 数据：
- 核心数据：`/api/tasks/tasks`, `/api/tasks/goals`, `/api/tasks/projects`
- Brain 数据：`/api/brain/quarantine`, `/api/brain/focus`

**问题**：任何一个 API 失败都会导致整个页面显示 "Failed to load: 504"

**影响**：Brain 服务挂掉时，即使任务数据正常，整个 TaskDatabase 也无法使用

## 目标

修复 `fetchAll()` 函数的容错逻辑，确保：
1. 核心数据（tasks/goals/projects）必须成功加载
2. Brain 数据（quarantine/focus）失败时不影响页面显示
3. Brain API 失败时设置空值，页面正常渲染

## 技术方案

### 修改文件

`apps/core/features/planning/pages/TaskDatabase.tsx`

### 当前实现

```typescript
const fetchAll = useCallback(async () => {
  try {
    const [t, g, p, q, f] = await Promise.all([
      fetchJson<Task[]>('/api/tasks/tasks'),
      fetchJson<Goal[]>('/api/tasks/goals'),
      fetchJson<Project[]>('/api/tasks/projects'),
      fetchJson<{ success: boolean; tasks: QuarantineTask[] }>('/api/brain/quarantine'),
      fetchJson<FocusData>('/api/brain/focus'),
    ]);
    // ... 设置状态
  } catch (e: any) {
    setError(e.message); // ← 任何一个失败都显示错误
  }
}, []);
```

### 新实现

```typescript
const fetchAll = useCallback(async () => {
  try {
    // 核心数据必须成功
    const [t, g, p] = await Promise.all([
      fetchJson<Task[]>('/api/tasks/tasks'),
      fetchJson<Goal[]>('/api/tasks/goals'),
      fetchJson<Project[]>('/api/tasks/projects'),
    ]);

    setTasks(t);
    setGoals(g);
    setProjects(p);

    // Brain 数据可选，失败不影响整体显示
    try {
      const q = await fetchJson<{ success: boolean; tasks: QuarantineTask[] }>('/api/brain/quarantine');
      setQuarantine(q.tasks || []);
    } catch {
      setQuarantine([]); // 静默失败
    }

    try {
      const f = await fetchJson<FocusData>('/api/brain/focus');
      setFocus(f);
    } catch {
      setFocus(null); // 静默失败
    }

    setError(null);
    setLastUpdate(new Date());
  } catch (e: any) {
    setError(e.message); // 只有核心数据失败才显示错误
  } finally {
    setLoading(false);
  }
}, []);
```

## 验收标准

1. Brain 服务挂掉时，TaskDatabase 仍显示任务列表
2. Quarantine section 和 Focus badge 不显示（数据为空）
3. 核心功能（Table/Board 视图、拖拽、编辑）正常工作
4. 核心 API 失败时仍显示错误页面

## 测试场景

| 场景 | 核心 API | Brain API | 预期结果 |
|------|---------|-----------|----------|
| 正常 | ✅ | ✅ | 完整显示所有数据 |
| Brain 挂 | ✅ | ❌ | 显示任务数据，无 quarantine/focus |
| Core 挂 | ❌ | ✅/❌ | 显示错误页面 |

## 影响范围

- 仅修改前端错误处理逻辑
- 不修改 API 接口
- 不影响其他页面

# PRD: Goal Comparison + Iterative Decision (Stage 3)

## 背景

Stage 1 实现了 Tick 机制和 cecelia-run 集成，Stage 2 实现了 TRD 分解器。

Stage 3 需要实现目标对比和迭代决策能力，让系统能够：
1. 对比当前进度与目标状态
2. 识别偏差和阻塞
3. 自动调整执行策略

## 功能描述

### 1. Goal Progress Comparison

对比 Goal 的期望进度与实际进度：
- 计算每个 Goal 的完成百分比
- 识别落后的 Goals（实际 < 期望）
- 识别阻塞的 Tasks（长时间 in_progress）

### 2. Deviation Detection

检测执行偏差：
- Task 失败率统计
- 平均完成时间 vs 预期时间
- 依赖阻塞检测

### 3. Decision Engine

基于偏差生成决策建议：
- 重新排序 Tasks（提升阻塞项优先级）
- 标记需要人工干预的 Tasks
- 生成下一步 Action 建议

### 4. Iteration Loop

迭代决策循环：
- 每次 Tick 时评估进度
- 记录决策历史到 decision_log
- 支持回滚错误决策

## API 设计

### POST /api/brain/goal/compare
对比目标进度，返回偏差报告

Request:
```json
{
  "goal_id": "uuid" // 可选，不传则对比所有活跃 Goals
}
```

Response:
```json
{
  "goals": [{
    "id": "uuid",
    "title": "string",
    "expected_progress": 50,
    "actual_progress": 30,
    "deviation": -20,
    "status": "behind",
    "blocked_tasks": ["task_id"],
    "recommendations": ["提升 task_x 优先级"]
  }],
  "overall_health": "warning",
  "next_actions": []
}
```

### POST /api/brain/decide
基于当前状态生成决策

Request:
```json
{
  "context": {
    "trigger": "tick" | "manual" | "deviation"
  }
}
```

Response:
```json
{
  "decision_id": "uuid",
  "actions": [{
    "type": "reprioritize" | "escalate" | "retry" | "skip",
    "target_id": "task_id",
    "reason": "string"
  }],
  "confidence": 0.85,
  "requires_approval": false
}
```

### POST /api/brain/decision/:id/execute
执行决策

### GET /api/brain/decisions
查看决策历史

## 数据库设计

### decisions 表
```sql
CREATE TABLE decisions (
  id UUID PRIMARY KEY,
  trigger VARCHAR(50),
  context JSONB,
  actions JSONB,
  confidence DECIMAL(3,2),
  status VARCHAR(50), -- pending, executed, rolled_back
  executed_at TIMESTAMP,
  created_at TIMESTAMP
);
```

## 成功标准

- [ ] POST /api/brain/goal/compare 可用
- [ ] POST /api/brain/decide 可用
- [ ] POST /api/brain/decision/:id/execute 可用
- [ ] GET /api/brain/decisions 可用
- [ ] 决策记录正确存入 decisions 表
- [ ] Tick 时自动触发 goal comparison
